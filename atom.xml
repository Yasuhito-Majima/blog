<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2023-10-19T03:16:45.259Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure 既定の送信アクセスの動作変更のアナウンスに関する補足 (Tracking ID:3T84-PZZ) </title>
    <link href="https://jpaztech.github.io/blog/network/default-outbound-access-for-vms-will-be-retired/"/>
    <id>https://jpaztech.github.io/blog/network/default-outbound-access-for-vms-will-be-retired/</id>
    <published>2023-10-11T06:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.259Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>2023 年 9 月末、Azure が既定で提供しているインターネット向けへの外部接続用の送信アクセスのサービス提供を、2025 年 9 月 30 日の翌日から限定的に終了することがアナウンスされました(Tracking ID:3T84-PZZ)。<br>アナウンスされた内容は英語でのご案内であったり、対象方法のご説明などを省略させていただいた概要でのご案内となっておりますので、この記事にて補足させていただきます。</p><h2 id="アナウンスの概要"><a href="#アナウンスの概要" class="headerlink" title="[アナウンスの概要]"></a>[アナウンスの概要]</h2><p>2025 年 10 月 1 日以降に作成された新しい Azure VM は、Azure 既定の送信アクセス (既定の SNAT) を利用してインターネット宛へのアウトバウンド通信ができなくなります。<br>インターネット宛へのアウトバウンド接続が必要な場合には、明示的な送信接続の設定が必要となります。<br><strong>2025 年 10 月 1 日よりも前に作成している既存の Azure VM は、現状、本通知の対象外となるため影響を受けませんが明示的に送信接続の設定を加えていただくことを推奨としています。</strong><br>既定の送信アクセスとは、ユーザーが明示的に送信接続の指定をしていない場合でも、Azure VM がインターネットにアクセスできるようにする仕組みです。具体的には、Azure プラットフォーム上で使われていないパブリック IP アドレスを一時的に借りて SNAT を行います。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="[FAQ]"></a>[FAQ]</h2><p>Q1. 既存の VM で影響が無いとのことですが、VM の停止や VM のリサイズによって、既定の送信アクセスが利用できなることはありますか？</p><p>A1. いいえ。2025 年 10 月 1 日よりも前に作成している既存の Azure VM については、Azure VM の停止、リサイズ作業を行ったとしても、既定の送信アクセスが利用できなくなることはございません。<br>ただし、上述の通り、明示的に送信接続の設定を加えていただくことを推奨としています。</p><p>Q2. Azure 既定の送信アクセスを利用しているかはどのように判断すればよいですか？</p><p>A2. 当ブログサイトの以下の記事に記載されている「判定フローチャート」をご確認の上、Azure 既定の送信アクセスをご利用いただいているか判断ください。</p><p><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/#%E5%88%A4%E5%AE%9A%E3%83%95%E3%83%AD%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88">Azure VM の外部接続 (SNAT) オプション まとめ - 判定フローチャート | Japan Azure IaaS Core Support Blog</a></p><p>Q3. 明示的な送信接続方法が様々ありますが、どの送信接続方法を利用すればよいですか？</p><p>A3. 現在、明示的な送信接続方法は、4 パターンございますが、各構成パターンによって特性が異なります。<br>当ブログサイトの以下の記事に記載されている「構成の比較」をご確認の上、お客様の通信要件に合った明示的な送信接続方法をご利用下さい。</p><p><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/#%E6%A7%8B%E6%88%90%E3%81%AE%E6%AF%94%E8%BC%83">Azure VM の外部接続 (SNAT) オプション まとめ - 構成の比較 | Japan Azure IaaS Core Support Blog</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;2023 年 9 月末、Azure が既定で提供しているインターネット向けへの外部接続用の送信アクセスのサービス提供を、2025 年 9 月 30 日の翌日から限定的に終了することがアナウンスされまし</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
    <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
    <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
    <category term="SNAT" scheme="https://jpaztech.github.io/blog/tags/SNAT/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の送信接続 (SNAT) オプション まとめ</title>
    <link href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/"/>
    <id>https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/</id>
    <published>2023-09-30T09:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.267Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポート チームの山口です。</p><p>Azure では、インターネット宛てのアウトバウンド方向の接続 (送信接続) をいくつかの方法で実装できます。選択の幅があることは喜ばしいですが、一方で内容の把握のが難しい側面も否めません。そこで本記事では、Azure VM に使える送信接続の構成をまとめて説明します。また、ある Azure VM がどの構成に該当しているか判定するためのフローチャートや、各構成の特徴についても併せて紹介します。</p><div class="alert is-info"><p class="alert-title">Note</p><p><span style="color: #c00000;">2023 年 9 月、送信接続の構成の一つである<a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/default-outbound-access">既定の送信アクセス</a>の提供終了がアナウンスされました。</span></p><p>これは、2025 年 9 月 30 日以降に作成された Azure VM は、後述の Azure 既定の SNAT が廃止され、明示的な外部接続ポリシーを設定しない限り、Azure 仮想ネットワークからの外部送信が行えなくなるという内容です。廃止アナウンスに関する補足については、当ブログサイトの以下の記事をご参照の上、技術的な内容については併せて本記事をご確認いただけますと幸いでございます。</p><p><a href="https://jpaztech.github.io/blog/network/default-outbound-access-for-vms-will-be-retired/">Azure 既定の送信アクセスの動作変更のアナウンスに関する補足 (Tracking ID:3T84-PZZ)</a></p></div><span id="more"></span><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure VM をはじめとする仮想ネットワーク (VNet) のコンピューティング リソースは、必要に応じてインターネット上のサーバーにアクセスします。たとえば、Web ブラウザが TLS/SSL 証明書の失効を検証する場合や、外部の権威 DNS サーバーに再帰問い合わせを実施する場合などです。この接続は、Azure から外部に出ていくように見えることから、アウトバウンド方向の接続あるいは <strong>送信接続</strong> と呼ばれます。</p><p>インターネット上のホストと通信するために、パケットの送信元と宛先 IP アドレスは共にパブリック IP アドレス (グローバル IP アドレス) である必要があります。特に、送信接続の文脈では、宛先はパブリック IP アドレスであることが確定しているため、送信元のパブリック IP アドレスをいかにして確保するかが重要となります。</p><p>一般に、これを実現する方法は大きく２つあります。</p><ol><li>送信元のホスト (オペレーティング システムのネットワーク インターフェイス) に、パブリック IP アドレスを割り当てます。これで送信元ホストはグローバル アドレス帯のセグメントに参加している状態となり、インターネットを介して宛先ホストとエンド・ツー・エンドな通信が行えます。</li><li>送信元のホストには、プライベート IP アドレスのみを割り当てます。その代わり、送信元ホストの外部にあるネットワーク装置で、送信元 IP アドレスをパブリック IP アドレスに変換します。</li></ol><p>このうち、Azure でサポートされているのは 2 番目の方法です。これは、ネットワークのアドレス変換 (Network Address Translation; NAT) と呼ばれる技術を使っています。特に送信元を変換するので送信元 NAT (Source NAT; SNAT) と呼ばれることもあります。Azure では、仮想化基盤に実装された仮想的なルーター (各サブネットの最初のユーザブル アドレスでホストされるデフォルトゲートウェイ) が、Azure VM のパケットに対して SNAT を実施します。このようなルーターを NAT 装置と呼びます。</p><p>SNAT の実現方法は、さらに 2 つの方式に細分化できます。</p><ul><li><strong>Basic NAT</strong>: 2 つの IP アドレスを 1 対 1 の関係で変換する NAT です。狭義の NAT と呼ばれることもあります。NAT 装置上では、単純にアドレスの対応付けを覚えておくだけで良いので、それ以上のステート管理が不要です。</li><li><strong>NAPT (Network Address Port Translation)</strong>: プロトコルやポート番号の情報を利用することで、アドレスを 1 対多の関係で変換できる NAT です。たとえば、複数のクライアントに同じパブリック IP アドレスでの SNAT を提供できます。NAT 装置は、5 タプル (プロトコル、送信元アドレス、送信元ポート番号、宛先アドレス、宛先ポート番号) でフローを一意に識別し、フローごとのアドレスの対応付けを NAT テーブルと呼ばれるデータベースに記録します。</li></ul><p>特に、後者の NAPT による SNAT では<strong>SNAT ポート枯渇</strong>に留意する必要があります。</p><p>NAPT を使用して複数のクライアントに共通の SNAT アドレスを割り当てると、当然 SNAT 後の送信元アドレスは同じものになります。さらに、通信先のエンドポイント (プロトコル、宛先アドレス、宛先ポート番号) が同じである場合は、フローを識別できる情報は 5 タプルのうち送信元ポート番号 (SNAT ポート) だけです。したがって、同一エンドポイント宛ての接続が発生するたびに SNAT ポートを割り当てる (消費する) 必要があり、ポート番号を使い切るとそれ以降の送信接続が失敗します。</p><p>SNAT ポートがどのように消費されるかを示すため、次のようなシナリオを考えます。SNAT 装置が、あるパブリック IP アドレス (<code>SNAT</code>) を使って、プライベート IP アドレスだけが割り当てられた Azure VM #1 (<code>10.0.0.4</code>) と #2 (<code>10.0.0.5</code>) に対して NAPT による SNAT を提供します。VM 間で SNAT ポートの奪い合いが発生しないよう、各 VM に 100 個ずつ SNAT ポートを事前に割り当てることにします。</p><p><img src="/blog/network/snat-options-for-azure-vm/snat-port-exhaustion.png" alt="snat-port-exhaustion"></p><p>ここで、VM から Web サーバー (<code>WEB</code>) に対する大量の HTTP アクセスを発生させました。この通信は、[プロトコル、宛先 IP アドレス、宛先ポート] がすべて同一 (<code>TCP, WEB:80</code>) であることに留意してください。コネクションを識別しなければならない SNAT 装置は、SNAT ポートをコネクションごとに消費していきながら SNAT を行います。</p><p>そして、VM #1 からの 101 個目の接続を受け付けた時、使える SNAT ポートが存在しないことに気が付きます。なぜなら、VM #1 には 100 個の SNAT ポートのみを割り当てたからです。これが SNAT ポートが枯渇した状態です。一度消費した SNAT ポートを再利用するには、既存のコネクションを VM か WEB サーバーが FIN/RST で終了するか、SNAT 装置上のアイドルタイムアウトで強制切断するのを待つ必要があります。</p><p>ただし、SNAT ポート枯渇が発生したからと言って、他のプロトコルや宛先の通信に影響がでるわけではありません。あくまで SNAT ポートはコネクションを識別するための一要素にすぎず、5 タプルの他の値で識別できれば SNAT ポートが重複しても問題ないためです。たとえば、この状況でも VM #1 から DNS サーバー (<code>DNS:53</code>) に対する UDP の接続要求は成功します。</p><p>SNAT ポート枯渇は、同じエンドポイントへのアクセスを繰り返すワークロードで発生する可能性が高まります。たとえば次のようなシナリオです。</p><ul><li>外部の DNS サーバーへの問い合わせ</li><li>インターネット上のプロキシ サーバーの利用</li><li>コネクションプーリングを使わないデータベース アクセス</li><li>ファイル共有 サーバーとの連携</li></ul><p>枯渇を防止するためには、SNAT ポート数の十分な確保だけでなく、アプリケーションでコネクションを再利用したり不要なコネクションをこまめに切断することが効果的です。</p><h2 id="構成パターンの一覧"><a href="#構成パターンの一覧" class="headerlink" title="構成パターンの一覧"></a>構成パターンの一覧</h2><p>それでは、具体的にどのような構成を取れば、送信接続 (SNAT) が可能になるのでしょうか。2023 年 9 月現在、Azure VM の送信接続に使える構成パターンは次の通りです。</p><ul><li>サブネットに NAT ゲートウェイを関連付ける</li><li>NIC にパブリック IP アドレスを関連付ける</li><li>パブリック ロードバランサーで送信規則を定義する</li><li>パブリック ロードバランサーで自動アウトバウンド NAT が有効な負荷分散規則を定義する</li><li>既定の送信アクセスを利用する ※ 2025 年 9 月で廃止、非推奨</li></ul><h2 id="判定フローチャート"><a href="#判定フローチャート" class="headerlink" title="判定フローチャート"></a>判定フローチャート</h2><p>ここでは、ある Azure VM がどの構成パターンで送信接続を実現しているか判定するためのフローチャートを示します。</p><p>より厳密に言えば、これは NIC に対しての判定チャートです。なぜなら、同一 Azure VM にアタッチされた NIC であっても、NIC ごとに異なる送信接続を構成できるためです。たとえば、異なる二つのサブネットに足を出す Azure VM に対し、片方のサブネットでは NAT ゲートウェイを使った送信接続を、もう一方のサブネットでは Azure Firewall を使った送信接続を構成することが可能です。</p><p>また、構成間の優先度も考慮して作成されています。たとえば、ある NIC に対して NAT ゲートウェイとインスタンス レベルのパブリック IP アドレスが両方構成された場合、NAT ゲートウェイによる SNAT で送信接続が行われます。当該のフローチャートを使うと、このような依存関係を判断できます。</p><p><img src="/blog/network/snat-options-for-azure-vm/flowchart-to-determine-snat-scenario.png" alt="flowchart"></p><h3 id="各ステップの詳細"><a href="#各ステップの詳細" class="headerlink" title="各ステップの詳細"></a>各ステップの詳細</h3><h4 id="ルートのネクストホップがインターネット？"><a href="#ルートのネクストホップがインターネット？" class="headerlink" title="ルートのネクストホップがインターネット？"></a>ルートのネクストホップがインターネット？</h4><p>本ステップは、トラフィックが SNAT の対象であるか判定します。</p><p>Azure では、パブリック IP アドレスに宛てた通信が必ずしもパブリック IP アドレスで SNAT されるとは限りません。ルートテーブル上でインターネットにルーティングされる通信だけが、SNAT の対象です (SNAT の対象であることと SNAT に成功することは別である点に注意してください。フローチャートの接続不可に相当する構成であれば SNAT に失敗します)。一方で、SNAT の対象にならないパブリック IP アドレス宛てのトラフィックは、次のような状況で発生します。</p><ul><li>VNet のアドレス範囲にパブリック IP アドレスを使用している場合</li><li>強制トンネリング (オンプレミス拠点にインターネット トラフィックを引き込むネットワーク構成) を採用している場合</li><li>Azure Firewall などのネットワーク仮想アプライアンスをインターネット ゲートウェイとして利用している場合</li><li>サービス エンドポイントを利用している場合</li></ul><p>こうしたシナリオの判断は、Azure VM に設定された<a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/diagnose-network-routing-problem#diagnose-using-azure-portal">有効なルート</a>で確認できます。具体的には、ルートのネクストホップが [インターネット] となっている場合は  SNAT の対象で、そうでない場合は対象外です。</p><p>初期状態では、デフォルトルート (0.0.0.0/0) のネクストホップが [インターネット] に向けられているため、仮想ネットワークやオンプレミス拠点のアドレス範囲以外に宛てられたトラフィック、つまりほとんどのトラフィックが SNAT の対象です。当該ステップの判定では、この既定のデフォルトルートを無効化あるいは上書きするようなルートが定義されていないかを重点的に確認していただくのが良いでしょう。</p><p>たとえば、次のような状況について考えてみます。</p><p><img src="/blog/network/snat-options-for-azure-vm/effective-routes-afw.png" alt="effective-routes-afw"></p><ul><li>既定のデフォルトルートが無効となり、代わりにネクストホップが [仮想アプライアンス] のユーザー定義ルートが設定されています。したがって、Azure VM では SNAT を試みず、仮想アプライアンス側でインターネット トラフィックを処理 (フィルタリングや SNAT) する構成だと判断できます。</li><li>ただし、<a href="https://jpaztech.github.io/blog/vm/azure-kms-update/">KMS サーバーをホストする 3 つのアドレス</a> のネクストホップが [インターネット] に設定されています。これらのエンドポイントに関しては、仮想アプライアンスを使わず Azure VM 側で SNAT することが意図されているようです。</li></ul><p>したがって、この例での当該ステップへの回答は次の通りです。</p><ul><li>KMS サーバー宛てのトラフィック: はい (SNAT の対象)</li><li>それ以外のインターネット宛てのトラフィック: いいえ (SNAT の対象外)</li></ul><h4 id="NAT-ゲートウェイがサブネットに関連付けられている？"><a href="#NAT-ゲートウェイがサブネットに関連付けられている？" class="headerlink" title="NAT ゲートウェイがサブネットに関連付けられている？"></a>NAT ゲートウェイがサブネットに関連付けられている？</h4><p>本ステップでは、NAT ゲートウェイによる SNAT 構成であるか判定します。これは、NIC がデプロイされているサブネットのプロパティで確認できます。以下に、Azure Portal での確認方法の例を示します。</p><ol><li>対象の Azure VM の [ネットワーク] メニューで、 NIC がデプロイされている仮想ネットワーク/サブネットを確認する</li><li>対象の仮想ネットワークの [サブネット] メニューから、対象サブネットを開く</li><li>[NAT ゲートウェイ] の項目に NAT ゲートウェイの名前が存在すれば、本ステップの回答は「はい」です</li></ol><h4 id="パブリック-IP-が-NIC-に関連付けられている？"><a href="#パブリック-IP-が-NIC-に関連付けられている？" class="headerlink" title="パブリック IP が NIC に関連付けられている？"></a>パブリック IP が NIC に関連付けられている？</h4><p>本ステップでは、NIC に関連付けたパブリック IP アドレス (インスタンス レベルのパブリック IP アドレス) による SNAT 構成であるか判定します。NIC プロパティを見て、プライマリ IP 構成にパブリック IP アドレスが紐づけられているか確認してください。</p><p>Azure Portal で確認する場合は。<a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/associate-public-ip-address-vm?tabs=azure-portal">パブリック IP アドレスの関連付けの手順</a>を参考に、次のような手順で実行します。</p><ol><li>対象の NIC の [IP 構成] メニューで、プライマリの IP 構成を確認する</li><li>パブリック IP アドレスの欄にアドレスが表示されていれば、本ステップの回答は「はい」です</li></ol><h4 id="送信規則を定義している？"><a href="#送信規則を定義している？" class="headerlink" title="送信規則を定義している？"></a>送信規則を定義している？</h4><p>本ステップでは、送信規則を使った SNAT 構成であるか判定します。送信規則は Standard SKU のパブリック ロードバランサーでのみ利用できる機能で、送信接続を定義したバックエンド プールの VM に対して SNAT を提供します。Azure Portal での確認方法の例は次の通りです。</p><ol><li>対象の Azure VM の [ネットワーク] メニューで、対象の NIC を確認します</li><li>[負荷分散] タブを開き、所属しているロードバランサーとバックエンド プールの一覧を確認します。</li><li>種別がパブリックで SKU が Standard であるロードバランサーのみを抽出します。</li><li>対象のロードバランサーの [送信規則] メニューを開き、対象のバックエンド プールに関連付けられた送信規則がある場合、本ステップの回答は「はい」です</li></ol><h4 id="自動アウトバウンド-NAT-が有効な負荷分散規則を定義している？"><a href="#自動アウトバウンド-NAT-が有効な負荷分散規則を定義している？" class="headerlink" title="自動アウトバウンド NAT が有効な負荷分散規則を定義している？"></a>自動アウトバウンド NAT が有効な負荷分散規則を定義している？</h4><p>本ステップでは、アウトバウンド NAT の自動プログラミングが有効な負荷分散規則による SNAT 構成であるか判定します。</p><p>パブリック ロードバランサーでは、負荷分散規則を定義すると同時に送信接続を有効化できます。この暗黙的な SNAT は、自動アウトバウンド NAT などと呼ばれます。Azure Portal での確認方法の例は次の通りです。</p><ol><li>対象の Azure VM の [ネットワーク] メニューで、対象の NIC を確認します</li><li>[負荷分散] タブを開き、所属しているロードバランサーとバックエンド プールの一覧を確認します。</li><li>種別がパブリックであるロードバランサーのみを抽出します。</li><li>対象のロードバランサーの [負荷分散規則] メニューを開き、対象のバックエンド プールに定義された負荷分散規則が次のいずれかに該当していれば本ステップの回答は「はい」です</li></ol><ul><li>Basic SKU のパブリック ロードバランサーの負荷分散規則が定義されている</li><li>Standard SKU のパブリックロードバランサーの負荷分散規則が定義されており、その負荷分散規則で自動アウトバウンド NAT が有効化されている</li></ul><h4 id="既定の送信アクセスの条件を満たしている？"><a href="#既定の送信アクセスの条件を満たしている？" class="headerlink" title="既定の送信アクセスの条件を満たしている？"></a>既定の送信アクセスの条件を満たしている？</h4><p>本ステップでは、<a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/default-outbound-access">既定の送信アクセス</a> が有効なシナリオであるか確認します。</p><p>既定の送信アクセスとは、明示的に送信接続の設定をしていない Azure VM に最低限の送信接続を提供する Azure プラットフォームの SNAT 機能です。次の 2 つの条件をすべて満たす Azure VM は、既定の送信アクセスでの送信接続が有効です。</p><ul><li><strong>条件1</strong>: 同一の可用性セット(※) に含まれるすべての NIC が、Standard SKU のパブリック IP アドレス、ロードバランサーのいずれにも関連付けられていない。</li><li><strong>条件2</strong>: フレキシブル オーケストレーション モードで動作する VMSS のインスタンスではない。</li></ul><p>※ 可用性セットを作成していない場合は、「可用性セット」と「Azure VM」を置き替えてください (遺体台の Azure VM だけが所属する疑似的な可用性セットを考える)。同様に、VMSS のインスタンスの場合は、「可用性セット」と「VMSS」を置き替えてください。</p><p><img src="/blog/network/snat-options-for-azure-vm/default-snat-condition.png" alt="default-snat-condition-1"></p><h4 id="送信接続-不可"><a href="#送信接続-不可" class="headerlink" title="送信接続 不可"></a>送信接続 不可</h4><p>最後に「送信接続 不可」のシナリオについて補足します。</p><p>フローチャートからもわかるように、Azure では多くの SNAT オプションがあり、多くの状況で送信接続が可能です。特に、まったく SNAT の構成を意識せず、Azure VM をデプロイするだけで送信接続が勝手にできるようになる「既定の送信アクセス」は、特筆すべき機能です。それだけに、いざ送信接続ができなくなった時にパニックに陥ってしまうという、諸刃の剣としての側面もあります。</p><p>実際、技術サポートでも「Azure VM が送信接続できない、できなくなった」という類のお問い合わせは、頻繁に目にするシナリオのひとつです。中でも、ロードバランサーの構成変更作業を契機として事象が発生するケースが多く、過去にロードバランサー関連の TIPS としてブログ記事を公開しています。</p><blockquote><p>ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった<br>こちらの事象についてよくある原因としては以下があります。</p><ol><li>Standard SKU の内部ロードバランサーのバックエンドプールに所属している</li></ol><p>引用: <a href="https://jpaztech.github.io/blog/archive/azurelb-tips/">Azure ロードバランサー利用時の注意点 &gt; ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった</a></p></blockquote><p>もし、送信接続ができない場合や、あるタイミングを境に送信接続できない状況になってしまった場合は、以下のような対応で事象が緩和するかご確認ください。</p><ul><li>NAT ゲートウェイを Azure VM が配置されているサブネットに関連付ける</li><li>パブリック IP アドレスを Azure VM の NIC に関連付ける</li><li>Standard SKU のパブリック ロードバランサーを利用して送信規則を構成する</li></ul><h2 id="構成の比較"><a href="#構成の比較" class="headerlink" title="構成の比較"></a>構成の比較</h2><p>次の表は、各構成にどのような特性があるかを示したものです。詳細は後述のセクションで確認していただければと思いますが、横ぐしで比較する際に参考となれば幸いです。</p><table><thead><tr><th align="left"></th><th align="left">NAT ゲートウェイ</th><th align="left">インスタンスレベル パブリック IP アドレス</th><th align="left">送信規則</th><th align="left">負荷分散規則</th><th align="left">既定の送信アクセス</th></tr></thead><tbody><tr><td align="left">構成単位</td><td align="left">サブネット</td><td align="left">NIC</td><td align="left">バックエンド プール</td><td align="left">バックエンド プール</td><td align="left">可用性セット</td></tr><tr><td align="left">アドレスの割り当て</td><td align="left">固定</td><td align="left">固定</td><td align="left">固定</td><td align="left">固定</td><td align="left">ランダム</td></tr><tr><td align="left">NAT 方式</td><td align="left">NAPT</td><td align="left">Basic NAT</td><td align="left">NAPT</td><td align="left">NAPT</td><td align="left">NAPT</td></tr><tr><td align="left">最大 SNAT ポート数</td><td align="left">~64,512*16</td><td align="left"></td><td align="left">64,000</td><td align="left">1,024</td><td align="left">1,024</td></tr><tr><td align="left">アイドル タイムアウト[分]</td><td align="left">4~120</td><td align="left">4</td><td align="left">4~100</td><td align="left">4</td><td align="left">4</td></tr><tr><td align="left">プロトコル</td><td align="left">TCP/UDP</td><td align="left">TCP/UDP/ICMP/ESP</td><td align="left">TCP/UDP</td><td align="left">TCP/UDP</td><td align="left">TCP/UDP</td></tr><tr><td align="left">インバウンド接続</td><td align="left">なし</td><td align="left">あり</td><td align="left">なし</td><td align="left">あり</td><td align="left">なし</td></tr></tbody></table><ul><li><strong>構成単位</strong>: 同じ送信接続が構成されるスコープです。たとえば、サブネットが構成単位である場合、サブネット内のすべての NIC は同じ方法で送信接続されます。</li><li><strong>アドレスの割り当て</strong>: “固定” の構成では、特定の SNAT アドレス プールから送信元 IP アドレスが払い出されることを保証できます。これにより、宛先側のホストで送信元を使った ACL を利用できます。”ランダム” の構成では、SNAT アドレスを限定できません。Azure VM の割り当てを停止すると、パブリック IP アドレスが変化します。</li><li><strong>NAT 方式</strong>: “Basic NAT” は、1対1 のステートレス NAT によって実装されていることを表します。これが採用されているのは、インスタンスレベルのパブリック IP アドレスだけです。”NAPT” は、NAPT を利用した SNAT であることを表します。この方式では、SNAT ポートを使い切ると同じ宛先ホストへの同時接続が制限される「ポート枯渇」の問題が発生する可能性があります。</li><li><strong>最大 SNAT ポート数</strong>: NIC が利用できる最大の SNAT ポート数を表します。NAT ゲートウェイでは、利用状況に応じて SNAT ポートを動的に分配するため、他の Azure VM の稼働状況にも左右されます。理論上、NAT ゲートウェイ全体で最大 64,512 * 16 = 1,032,192 個の SNAT ポートが確保できます。</li><li><strong>アイドルタイムアウト</strong>: TCP コネクションをアウトバウンド向けに確立した時のアイドル タイムアウト値 (分) です。タイムアウト値よりも長くアイドル状態が続くコネクションに関しては、それ以降の接続が保証されません。範囲が記載されているものに関しては、設定により変動できます。ロードバランサーの場合、タイムアウト時に RST を通知する機能があります。</li><li><strong>プロトコル</strong>: 送信接続でサポートされているプロトコルです。すべてのオプションで TCP/UDP はサポートされています。ICMP が利用できないオプションもあるので、外部サーバーへの ping 監視のシナリオでは注意してください。</li><li><strong>インバウンド接続</strong>: 「なし」の場合、送信接続のためだけにパブリック IP アドレスが使用されます。「あり」の場合、外部からの接続エンドポイントとしてもパブリック IP アドレスが利用されます。</li></ul><p>また、送信接続の構成を選択する際は、以下の公式ドキュメントも併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/well-architected/mission-critical/mission-critical-networking-connectivity#internet-egress">Azure でのミッション クリティカルなワークロードのネットワークと接続 - Microsoft Azure Well-Architected Framework | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections">アウトバウンド接続の送信元ネットワーク アドレス変換 (SNAT) - Azure Load Balancer | Microsoft Learn</a></li></ul><h2 id="構成の詳細"><a href="#構成の詳細" class="headerlink" title="構成の詳細"></a>構成の詳細</h2><p>ここからは、送信接続の構成ごとに特徴・ユースケース・注意事項を紹介していきます。</p><h3 id="NAT-ゲートウェイ"><a href="#NAT-ゲートウェイ" class="headerlink" title="NAT ゲートウェイ"></a>NAT ゲートウェイ</h3><p><img src="/blog/network/snat-options-for-azure-vm/nat-gateway-snat.png" alt="nat-gateway"></p><p>NAT ゲートウェイは、送信接続の SNAT を主な目的として設計されたネットワーク サービスです。専門的なサービスなだけあって、送信元アドレスの固定化はもちろん、動的なポート確保によりるポート資源の有効活用など、他の SNAT 方式にはない機能を有します。</p><p><strong>特徴</strong></p><ul><li>フルマネージドな PaaS サービスで、高い可用性を有します。最新の SLA では、可用性が 99.99% を下回ると一部料金の返金 (サービス クレジット) を受け取ることができます。</li><li>複数の VM で SNAT ポート プールを共有し、動的に SNAT ポートを確保できるのは NAT ゲートウェイだけです。[<a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-gateway-snat">参考</a>]</li><li>NAT ゲートウェイに追加できるパブリック IP アドレスの最大数は 16 個です。パブリック IP アドレスあたり 64,152 の SNAT ポートが確保されるため、NAT ゲートウェイ全体で最大 64,512 * 16 = 1,032,192 の SNAT ポートを確保できます。[<a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-gateway-resource#snat-ports">参考</a>]</li><li>送信接続の TCP アイドル タイムアウトを 4 分から最大 120 分まで伸ばせます。[<a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-gateway-resource#tcp-idle-timeout">参考</a>]</li><li>Azure Monitor のメトリックで NAT ゲートウェイで処理されたデータサイズ、パケット数、現在の接続数を確認することができます。[<a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-metrics">参考</a>]</li></ul><p><strong>構成方法</strong></p><ol><li>NAT ゲートウェイ リソースを作成する。</li><li>対象のサブネットに NAT ゲートウェイを関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>一般的な送信接続のシナリオ全般</li><li>大量のインターネットへの接続が必要となる場合</li><li>複数の Azure VM で SNAT 用のパブリック IP アドレス (SNAT ポート) を共有したい場合</li></ul><p><strong>注意事項</strong></p><ul><li>NAT ゲートウェイを使用する NIC は、Basic SKU のインスタンス レベル パブリック IP アドレスを関連付けたり、Basic SKU のロードバランサーのバックエンドに配置できません。</li><li>仮想ネットワーク内の通信に対する一般的な NAT 装置として利用できません。あくまで、インターネットへの送信接続における SNAT 機能だけを提供します。</li><li>インバウンド方向のインターネット接続を受け付けることはできません。インバウンド接続性が必要な場合、Application Gateway やロードバランサーなどの利用を検討してください。</li><li>NAT ゲートウェイの可用性オプションは、特定可用性ゾーンへの固定 (zonal) または非ゾーン (regional) のいずれかです。可用性ゾーン レベルの冗長性が必要なシステムに組み込む場合は、可用性ゾーンごとにサブネットを作成し、複数の NAT ゲートウェイを各サブネットに関連付けるようにします。[<a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-availability-zones">参考</a>]</li><li>ICMP プロトコルはサポートされません。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-overview">Azure NAT Gateway とは | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/nat-gateway-resource">Azure NAT Gateway リソース | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/nat-gateway/troubleshoot-nat">Azure NAT Gateway のトラブルシューティング - Azure Virtual Network | Microsoft Learn</a></li></ul><h3 id="インスタンス-レベルのパブリック-IP-アドレス"><a href="#インスタンス-レベルのパブリック-IP-アドレス" class="headerlink" title="インスタンス レベルのパブリック IP アドレス"></a>インスタンス レベルのパブリック IP アドレス</h3><p><img src="/blog/network/snat-options-for-azure-vm/public-ip-address-snat.png" alt="public-ip-address"></p><p>Azure VM の NIC にパブリック IP アドレス (インスタンス レベルのパブリック IP アドレス) を関連付けると、そのパブリック IP アドレスで通信が SNAT されるようになります。1 対 1 のステートレス NAT (Basic NAT) として実装されるため、基盤側では SNAT ポートを管理しません。</p><p><strong>特徴</strong></p><ul><li>基盤に備わる SNAT 機能の中で、唯一 NAPT を利用しない (SNAT ポートを使わない) 方式による SNAT です。SNAT ポートの枯渇を心配する必要はありません。</li><li>SNAT アドレスが一つの VM に占有され、他の VM に使われないことを保証できます。</li><li>構成が非常にシンプルです。</li></ul><p><strong>構成方法</strong></p><ol><li>パブリック IP アドレス リソースを作成する。</li><li>対象の Azure VM の NIC に関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>単一の Azure VM に対する送信接続の確保 (NAT ゲートウェイなどを導入するまでの一時的な対策)</li><li>送信接続だけでなく、Azure VM へのインバウンド接続も確保したい場合</li></ul><p><strong>注意事項</strong></p><ul><li>Basic SKU だと NAT Gateway と共存出来ない等、SKU 依存の制限が存在します。可用性ゾーンへの対応も考慮すると、基本的には Standard SKU の使用が推奨されます。</li><li>SNAT ポートの消費を気にしなくて済む反面、OS のネットワーク スタックでエフェメラル ポートが枯渇する可能があります。エフェメラルポートの枯渇が疑われる場合は、次のような情報を参考にしてください。<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/windows-client/networking/tcp-ip-port-exhaustion-troubleshooting">TCP/IP ポート枯渇のトラブルシューティング - Windows Client | Microsoft Learn</a></li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections">アウトバウンド接続の送信元ネットワーク アドレス変換 (SNAT) - Azure Load Balancer | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/virtual-network-public-ip-address">Azure パブリック IP アドレスを作成、変更、または削除する - Azure Virtual Network | Microsoft Learn</a></li></ul><h3 id="送信規則"><a href="#送信規則" class="headerlink" title="送信規則"></a>送信規則</h3><p><img src="/blog/network/snat-options-for-azure-vm/auzre-load-balancer-snat.png" alt="auzre-load-balancer-snat"></p><p>送信規則は Standard SKU のパブリック ロードバランサーで利用可能な送信接続構成です。バックエンド プールに Azure VM を配置して送信規則を定義すると、フロントエンドのパブリック IP アドレスを使った SNAT が提供されます。</p><p>NAT の方式には NAPT が利用されています。バックエンド プール内の Azure VM に対して、各々どの程度の SNAT ポート数を割り与えるか、予め設定しておきます。パブリック IP アドレスあたり 64,000 の SNAT ポートを持つので、これをバックエンド プール内の Azure VM で分配する形になります。たとえば、8 台なら 8,000 ポートずつ割り振ることができます。</p><p><strong>特徴</strong></p><ul><li>バックエンド プールの単位で構成されるため、サブネットをまたいで複数の Azure VM を同じ方法で SNAT できる。</li><li>送信規則で制御できるパラメータが豊富。<ul><li>バックエンド プール (どの Azure VM を対象とするか)</li><li>フロントエンド IP 構成 (どのパブリック IP アドレスで SNAT するか)</li><li>SNAT ポート数の割り当て (各 Azure VM へ自動的に均等に割り当てる方式か、明示的に値を入力する方式が選択できます)</li><li>SNAT の対象とするプロトコル (TCP、UDP、または両方)</li><li>TCP アイドルタイムアウト (4 分から最大 100 分まで)</li><li>アイドル タイムアウト時の TCP リセット送信の有無</li></ul></li><li>インバウンド接続性も、負荷分散規則やインバウンド NAT 規則を作成すれば確保できる。作成しなければ、単に送信接続のみを行う SNAT 装置として使うことも可能。</li></ul><p><strong>構成方法</strong></p><ol><li>パブリック IP アドレスをフロントエンドに付与したパブリック ロードバランサーを作成する。</li><li>バックエンド プールに対象の Azure VM の NIC を追加する。</li><li>送信規則を作成する。</li></ol><p><strong>ユースケース</strong></p><ul><li>SNAT と同時に、インバウンド方向の負荷分散も同時に構成したい場合 (例: 外部への DB アクセスが必要となるアプリケーション サーバー)</li><li>サブネット以外の単位で、複数の Azure VM の送信接続を制御したい場合 (例: サブネット内の一部の Azure VM に、まとめてインターネット接続を許可する)</li></ul><p><strong>注意事項</strong></p><ul><li>複数のパブリック IP アドレス (フロントエンド IP 構成) をまとめて指定すると、バックエンド プール全体としては 64,000 x &lt;IP アドレスの数&gt; だけ SNAT ポートが用意されます。しかし、どれだけパブリック IP アドレスを追加しても、各 Azure VM に割り当てられる最大の SNAT ポート数は 64,000 までです。</li><li>負荷分散規則には、既定の送信アクセスによって SNAT を構成するオプションがあります。これを有効化すると、同じバックエンドプールには送信規則が作成できなくなります。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections">アウトバウンド接続の送信元ネットワーク アドレス変換 (SNAT) - Azure Load Balancer | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/outbound-rules">Azure Load Balancer のアウトバウンド規則 | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/egress-only">送信専用のロード バランサーの構成 - Azure Load Balancer | Microsoft Learn</a></li></ul><h3 id="自動アウトバウンド-NAT-が有効な負荷分散規則"><a href="#自動アウトバウンド-NAT-が有効な負荷分散規則" class="headerlink" title="自動アウトバウンド NAT が有効な負荷分散規則"></a>自動アウトバウンド NAT が有効な負荷分散規則</h3><p>パブリック ロードバランサーの負荷分散規則で自動アウトバウンド NAT が有効な場合、バックエンド プールに配置している Azure VM に対して送信接続の機能が提供されます。SNAT アドレスは、負荷分散規則に紐づいたフロントエンド IP 構成 (フロントエンドのパブリック IP アドレス) です。</p><p>Basic SKU のロードバランサーでは、負荷分散規則の自動アウトバウンド NAT は必ず有効です。一方で、Standard SKU のロードバランサーの場合、自動アウトバウンド NAT の ON/OFF を設定するフラグ項目が負荷分散規則に存在します。具体的には、<code>disableOutboundSnat</code> パラメータを false に設定すると自動アウトバウンド NAT が有効となります。</p><p><strong>特徴</strong></p><ul><li>負荷分散規則と合わせて構成する性質上、インバウンドとアウトバウンド両方の接続性を確保できます。</li><li>NAT ゲートウェイや送信規則より古くから存在する送信接続構成の一つです。歴史的な経緯から、現在でもこの構成を利用して SNAT を実施している Azure VM は少なくありません。</li></ul><p><strong>構成方法</strong></p><ul><li>パブリック ロードバランサーを作成する</li><li>バックエンド プールを作成し、対象の Azure VM を配置する</li><li>バックエンド プールに負荷分散規則を定義する (Standard SKU の場合、自動アウトバウンド NAT を有効化するオプションを指定する)</li></ul><p><strong>ユースケース</strong></p><ul><li>負荷分散規則と同時に簡易的な送信接続を構成する場合</li></ul><p><strong>注意事項</strong></p><ul><li>Standard SKU の場合、送信規則との併用はできません。つまり、負荷分散規則の自動アウトバウンド NAT を使用しているバックエンド プールには、送信規則を定義することが出来ません。</li><li>SNAT ポートの割り当ては、バックエンド プール内の Azure VM のサイズに応じて、自動で 32 から 1,024 まで変化します。[<a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports">参考</a>]</li><li>最大 SNAT ポートが 1,024 であるため、容易にポート枯渇が発生する可能性があります。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/outbound-rules#preventoutbound">Azure Load Balancer のアウトバウンド規則 | Microsoft Learn</a></li></ul><h3 id="Azure-既定の送信アクセス"><a href="#Azure-既定の送信アクセス" class="headerlink" title="Azure 既定の送信アクセス"></a>Azure 既定の送信アクセス</h3><p><span style="color: #c00000;"> 本記事の冒頭で追記している通り、2025 年 10 月 1 日以降、新規 Azure VM に対して既定の送信アクセスは無効化されます。具体的な内容や対応方法は、追記部分をご参照下さい。</span></p><p><img src="/blog/network/snat-options-for-azure-vm/azure-default-snat.png" alt="azure-default-snat"></p><p>これまでの送信接続の構成は、明示的にリソースを作成したり、関連付けることで SNAT をプログラミングするものでした。しかし、Azure には送信接続の方法をユーザーが指定していない場合でも、Azure VM がインターネット接続できるようにする仕組みが存在します。これを Azure 既定の送信アクセスと呼びます。</p><p>具体的には、Azure プラットフォーム上で使われていないパブリック IP アドレスを一時的に借りて SNAT を行います。そのため、Azure VM を割り当て解除 &amp; 起動するたびに、SNAT に利用されるパブリック アドレスが変動します。</p><p>なお、割り当てられる可能性のある IP アドレスはある程度絞り込むことができます。なぜなら、Azure リージョンで使用されているパブリック IP アドレスの一覧が、以下のダウンロード サイトから提供されているためです。対象の Azure VM が存在するリージョンを確認し、<code>AzureCloud.&lt;リージョン名&gt;</code> で検索すると候補の IP アドレスを取得できます。</p><ul><li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519">Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center</a></li></ul><p><strong>特徴</strong></p><ul><li>唯一パブリック IP アドレス リソースを作らずに SNAT が出来る送信接続の構成です。</li><li>NAPT により実現されており、確保される SNAT ポート数は NIC (Azure VM) あたり 1024 で固定されています。</li></ul><p><strong>構成方法</strong></p><p>典型的には、次のような状況で既定の送信アクセスが利用されます。条件の詳細は、判定フローチャートの「既定の送信アクセスの条件を満たしている？」をご覧ください。</p><ul><li>NAT ゲートウェイ、インスタンス レベルのパブリック IP アドレス、パブリック ロードバランサーの送信規則を使わず、スタンドアロンな Azure VM をデプロイしている。</li><li>Azure VM を Basic SKU の内部ロードバランサーのバックエンド プールに配置している。</li></ul><p><strong>ユースケース</strong></p><ul><li>テスト/開発用の Azure VM で送信接続が必要になる場合</li></ul><p><strong>注意事項</strong></p><ul><li>既定の送信アクセスでは最大でも 1024 までしか SNAT ポートが確保されず、SNAT ポート枯渇の問題が顕在化しやすい問題があります。</li><li>また、明示的な SNAT 方法の指定がないことが、セキュリティや管理上の問題となることもあります。</li><li>以上のような背景から、本番環境での利用は推奨されていません。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/default-outbound-access">Azure での既定の送信アクセス - Azure Virtual Network | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections">アウトバウンド接続の送信元ネットワーク アドレス変換 (SNAT) - Azure Load Balancer | Microsoft Learn</a></li></ul><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>今回の記事では、インターネット送信を実現する SNAT の仕組みと、Azure で利用できる SNAT の方式を紹介しました。</p><p>「判定フローチャート」を使うと、対象の Azure VM (NIC) がどの方式の送信接続で構成されているのか簡単に調べられます。送信接続できない時のトラブルシューティングにも、ぜひこのフローチャートを活用していただければと思います。</p><p>また、各送信接続構成の比較には「機能の比較」で示した表もご利用ください。それぞれのオプションのすべての側面を映し出しているわけではありませんが、大まかにどのような違いがあるのかを把握するための参考にしていただければ幸いです。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;Azure Networking テクニカル サポート チームの山口です。&lt;/p&gt;
&lt;p&gt;Azure では、インターネット宛てのアウトバウンド方向の接続 (送信接続) をいくつかの方法で実装できます。選択の幅があることは喜ばしいですが、一方で内容の把握のが難しい側面も否めません。そこで本記事では、Azure VM に使える送信接続の構成をまとめて説明します。また、ある Azure VM がどの構成に該当しているか判定するためのフローチャートや、各構成の特徴についても併せて紹介します。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!NOTE]&lt;br&gt;&lt;span style=&quot;color: #c00000;&quot;&gt;2023 年 9 月、送信接続の構成の一つである&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/default-outbound-access&quot;&gt;既定の送信アクセス&lt;/a&gt;の提供終了がアナウンスされました。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これは、2025 年 9 月 30 日以降に作成された Azure VM は、後述の Azure 既定の SNAT が廃止され、明示的な外部接続ポリシーを設定しない限り、Azure 仮想ネットワークからの外部送信が行えなくなるという内容です。廃止アナウンスに関する補足については、当ブログサイトの以下の記事をご参照の上、技術的な内容については併せて本記事をご確認いただけますと幸いでございます。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://jpaztech.github.io/blog/network/default-outbound-access-for-vms-will-be-retired/&quot;&gt;Azure 既定の送信アクセスの動作変更のアナウンスに関する補足 (Tracking ID:3T84-PZZ)&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
    <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
    <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
    <category term="SNAT" scheme="https://jpaztech.github.io/blog/tags/SNAT/"/>
    
  </entry>
  
  <entry>
    <title>クラシック VM で使用していた VHD から ARM VM を作成する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/classic-vhd-to-arm-vm/"/>
    <id>https://jpaztech.github.io/blog/vm/classic-vhd-to-arm-vm/</id>
    <published>2023-09-01T00:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.355Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>Azure のクラシック VM は 2023 年 9 月 6 日を持ちまして廃止となりました。<br>そのためこれ以降サポートされる VM は ARM（Azure Resource Manager）の VM となります。<br>クラシック VM の ARM VM への移行については以下の通りドキュメント等がございます。  </p><p>■ご参考：2023 年 9 月 6 日までに IaaS リソースを Azure Resource Manager に移行する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation">https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation</a>  </p><p>■ご参考：Classic VM から ARM への移行についての注意事項 (VM、ストレージ編)<br><a href="https://jpaztech.github.io/blog/vm/migrate_classic_vm_and_storage">https://jpaztech.github.io/blog/vm/migrate_classic_vm_and_storage</a>  </p><p>他方、上記とは別の方法としてクラシック VM で使用していた OS ディスクの VHD から ARM VM を作成することも可能でございますので、今回はこの手順についてご説明させていただきます。  </p><div class="alert is-info"><p class="alert-title">Note</p><p>クラシック VM で使用していた VHD はクラシックストレージアカウントに保存されておりますが、クラシックストレージアカウントも 2024 年 8 月 31 日に完全に廃止されます。</p><p>クラシックストレージアカウントの移行については以下のドキュメントをご参照くださいませ。</p><p>　</p><p>■ご参考：クラシック ストレージ アカウントを Azure Resource Manager へ 2024 年 8 月 31 日までに移行する</p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/classic-account-migration-overview">https://learn.microsoft.com/ja-jp/azure/storage/common/classic-account-migration-overview</a></p></div><hr><h2 id="手順の大まかな流れ"><a href="#手順の大まかな流れ" class="headerlink" title="手順の大まかな流れ"></a>手順の大まかな流れ</h2><p>クラシック VM で使用していた OS ディスクの VHD から ARM VM を作成する手順についてご紹介させていただきます。<br>クラシックストレージアカウントに保存されている VHD からそのままでは ARM VM の作成が叶いませんため、以下の手順を踏む必要がございます。  </p><ol><li>クラシックストレージアカウントから ARM ストレージアカウントへ VHD をコピーする。（AzCopy コマンド実行）</li><li>ARM ストレージアカウント内の VHD からディスクリソースを作成する。</li><li>ディスクリソースから ARM VM を作成する。</li></ol><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-11-01-20.png"></p><p>ディスクリソースの作成のためには ARM ストレージアカウントに VHD を一旦コピーする必要があるため少し手順が多いですが一つずつ解説させていただきます。<br>それでは、それぞれの手順の詳細をご案内させていただきます。</p><hr><h2 id="1-クラシックストレージアカウントから-ARM-ストレージアカウントへ-VHD-をコピーする。（AzCopy-コマンド実行）"><a href="#1-クラシックストレージアカウントから-ARM-ストレージアカウントへ-VHD-をコピーする。（AzCopy-コマンド実行）" class="headerlink" title="1. クラシックストレージアカウントから ARM ストレージアカウントへ VHD をコピーする。（AzCopy コマンド実行）"></a>1. クラシックストレージアカウントから ARM ストレージアカウントへ VHD をコピーする。（AzCopy コマンド実行）</h2><p>AzCopy コマンドを用いてクラシックストレージアカウントから ARM ストレージアカウントへ VHD をコピーします。<br>コマンド実行のために <strong>&lt;①コピー元ディスクの Blob URI&gt;&lt;②コピー元 SAS トークン&gt;&lt;③コピー先 URL&gt;</strong> の 3 つが必要となりますので、以下の順で用意をします。</p><hr><h3 id="1-1-クラシック-VM-で使用していた-VHD-の-Blob-URI-を特定する。"><a href="#1-1-クラシック-VM-で使用していた-VHD-の-Blob-URI-を特定する。" class="headerlink" title="1-1. クラシック VM で使用していた VHD の Blob URI を特定する。"></a>1-1. クラシック VM で使用していた VHD の Blob URI を特定する。</h3><p>ポータルの上部の検索ボックスより「仮想マシン (クラシック)」を検索して、クラシック VM の一覧を表示します。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-14-32-30.png"></p><p>表示されたクラシック VM の一覧から対象となる VM を選択します。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-14-33-57.png"></p><p>クラシック VM のリージョンをメモしておきます。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-15-49-14.png"></p><p>左側のメニューより「ディスク」を選択して、OS ディスクの名前をクリックします。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-14-34-57.png"></p><p>ディスクの Blob URI が「場所」として表示されますので、この URI を <strong>&lt;①コピー元ディスクの Blob URI&gt;</strong> としてメモします。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-14-36-48.png"></p><p>データディスクがある場合は同じ手順でデータディスクについても URI をメモしておいてください。</p><hr><h3 id="1-2-コピー元クラシックストレージアカウントの準備"><a href="#1-2-コピー元クラシックストレージアカウントの準備" class="headerlink" title="1-2. コピー元クラシックストレージアカウントの準備"></a>1-2. コピー元クラシックストレージアカウントの準備</h3><p>先の手順でクラシック VM のディスクの Blob URI を <strong>&lt;①ディスクの Blob URI&gt;</strong> としてメモしていると思います。<br>Blob URI より以下の通り、クラシックストレージアカウント名が判別可能です。</p><blockquote><p>https://<strong>&lt;クラシックストレージアカウント名&gt;</strong>.blob.core.windows.net/&lt;コンテナー名&gt;/&lt;VHD名&gt;.vhd</p></blockquote><p>こちらで確認したクラシックストレージアカウント名を、ポータルの上部の検索ボックスより検索して、クラシックストレージアカウントの画面を表示します。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-16-27-20.png"></p><p>表示されたクラシックストレージアカウントの画面にて、左側のメニューより「Shared Access Signature」を選択し、以下の画像の例のように SAS トークンを生成し <strong>&lt;②コピー元 SAS トークン&gt;</strong> としてメモします。<br>この際 SAS の有効期限等を適切に設定をお願いいたします。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-09-20-13.png"></p><p>以上でコピー元の準備は完了です。</p><hr><h3 id="1-3-コピー先-ARM-ストレージアカウントの準備"><a href="#1-3-コピー先-ARM-ストレージアカウントの準備" class="headerlink" title="1-3. コピー先 ARM ストレージアカウントの準備"></a>1-3. コピー先 ARM ストレージアカウントの準備</h3><p>コピー先の ARM ストレージアカウントを作成します。<br>既に ARM ストレージアカウントがある場合は、そちらをご利用いただいても大丈夫です。</p><p>ポータルの上部の検索ボックスより「ストレージアカウント」を検索して、ストレージアカウントの一覧画面を表示します。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-15-46-00.png"></p><p>ストレージアカウント一覧画面の左上にある「作成」より ARM ストレージアカウントを作成します。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-15-46-57.png"></p><p>ストレージアカウント作成の際、リージョン（地域）はクラシック VM と同じリージョンに作成します。<br>一時的なものですので冗長性は「LRS」で良いかと存じます。その他の設定項目は既定のままで問題ないものと存じます。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-15-57-23.png"></p><p>作成したストレージアカウントを表示し、左側のメニューより「コンテナー」を選択し、上部の「＋コンテナー」から新規 Blob コンテナーを作成します。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-16-03-53.png"></p><p>作成したコンテナーを選択し、コンテナーの画面の左側のメニューより「共有アクセス トークン」を選択の上、以下の図の例のようにコピー先の URL を生成します。<br>この際も SAS の有効期限等を適切に設定をお願いいたします。<br>以下のように表示された「BLOB SAS URL」が <strong>&lt;③コピー先 URL&gt;</strong> となります。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-15-16-19-19.png"></p><p>以上でコピー先の準備も完了しました。</p><hr><h3 id="1-4-AzCopy-コマンドを組み立てる"><a href="#1-4-AzCopy-コマンドを組み立てる" class="headerlink" title="1-4. AzCopy コマンドを組み立てる"></a>1-4. AzCopy コマンドを組み立てる</h3><p>用意した <strong>&lt;①コピー元ディスクの Blob URI&gt;&lt;②コピー元 SAS トークン&gt;&lt;③コピー先 URL&gt;</strong> を使って、コピーを実行する AzCopy コマンドを組み立てましょう。<br>以下の順で並べます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">azcopy copy &#x27;&lt;①コピー元ディスクの Blob URI&gt;&lt;②コピー元 SAS トークン&gt;&#x27; &#x27;&lt;③コピー先 URL&gt;&#x27; --blob-type PageBlob</span><br></pre></td></tr></table></figure><p>実際の文字列の例としては以下のような形となります。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">azcopy copy &#x27;https://classicsasample8.blob.core.windows.net/vhds/os-disk.vhd?sv=2022-11-02&amp;ss=b&amp;srt=sco&amp;sp=rl&amp;se=2023-08-16T10:08:35Z&amp;st=2023-08-16T02:08:35Z&amp;spr=https&amp;sig=saskeyverylongsaskeyverylongsaskeyverylong%3D&#x27; &#x27;https://armsasample8.blob.core.windows.net/newvhd?sp=racwl&amp;st=2023-08-16T02:09:36Z&amp;se=2023-08-16T10:09:36Z&amp;spr=https&amp;sv=2022-11-02&amp;sr=c&amp;sig=hereisasykeyhereisasykeyhereisasykey%3D&#x27; --blob-type PageBlob</span><br></pre></td></tr></table></figure><p>これにて実行する AzCopy のコマンドが用意できました。</p><hr><h3 id="1-5-Cloud-Shell-にて-AzCopy-コマンドで-VHD-コピーを実行する"><a href="#1-5-Cloud-Shell-にて-AzCopy-コマンドで-VHD-コピーを実行する" class="headerlink" title="1-5. Cloud Shell にて AzCopy コマンドで VHD コピーを実行する"></a>1-5. Cloud Shell にて AzCopy コマンドで VHD コピーを実行する</h3><p>AzCopy はコマンドベースでファイルのコピーなどを行えるコマンドライン ユーティリティです。<br>今回は既定で AzCopy がインストールされている Cloud Shell を利用した手順をご紹介させていただきます。<br>既に AzCopy がインストールされている環境をお持ちの場合はそちらをご利用いただいても問題ございません。  </p><p>■ご参考：AzCopy を使ってみる<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10</a></p><p>まず、ポータル右上の Cloud Shell 起動ボタンを選択します。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-09-24-27.png"></p><p>初めて Cloud Shell をご利用頂く場合はセットアップの画面が表示されますので、表示された内容に沿ってセットアップをお願いいたします。<br>なお、Cloud Shell の Bash / PowerShell どちらにも AzCopy はインストールされていますのでどちらをご利用いただいても大丈夫です。  </p><p>Cloud Shell が起動したら用意した AzCopy コマンドを実行します。<br>正常完了した場合は以下のように「Number of Transfers Completed: 1」が記録されます。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-11-19-12.png"></p><p>これにて ARM ストレージアカウントに VHD のコピーが完了しました。<br>データディスクも合わせて移行する場合は、同様の手順でデータディスクもご対応をお願いいたします。  </p><hr><h2 id="2-ARM-ストレージアカウント内の-VHD-からディスクリソースを作成する。"><a href="#2-ARM-ストレージアカウント内の-VHD-からディスクリソースを作成する。" class="headerlink" title="2. ARM ストレージアカウント内の VHD からディスクリソースを作成する。"></a>2. ARM ストレージアカウント内の VHD からディスクリソースを作成する。</h2><p>次に ARM VM を作成するためのディスクリソースを作成します。<br>ポータルの上部の検索ボックスより「ディスク」を検索して、ディスクの一覧画面を表示します。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-11-22-38.png"></p><p>左上の「作成」ボタンを選択します。</p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-11-23-42.png"></p><p>ディスクの新規作成画面に遷移するので、以下の形でディスクを作成します。</p><table><thead><tr><th align="left">項目</th><th align="left">選択する内容</th></tr></thead><tbody><tr><td align="left">サブスクリプション</td><td align="left">当該のサブスクリプションを選択します。</td></tr><tr><td align="left">リソースグループ</td><td align="left">任意で構いません。</td></tr><tr><td align="left">ディスク名</td><td align="left">任意で構いません。</td></tr><tr><td align="left">地域</td><td align="left">元のクラシック VM と同一リージョンにします。</td></tr><tr><td align="left">可用性ゾーン</td><td align="left">ゾーンを使用しない場合は「必要ありません」を選択します。</td></tr><tr><td align="left">ソースの種類</td><td align="left">「ストレージ BLOB」を選択します。</td></tr><tr><td align="left">ソース サブスクリプション</td><td align="left">当該のサブスクリプションを選択します。</td></tr><tr><td align="left">ソース BLOB</td><td align="left">「参照」ボタンを選択し、コピーした ARM ストレージアカウント内の VHD ファイルを選択します。この際サイズも確認できます。</td></tr><tr><td align="left">OS の種類</td><td align="left">VHD の内容に合わせてご選択ください。</td></tr><tr><td align="left">VM の世代</td><td align="left">元がクラシック VM なので「第 1 世代」を選択します。</td></tr><tr><td align="left">VM アーキテクチャ</td><td align="left">既定の「x64」となります。</td></tr><tr><td align="left">サイズ</td><td align="left">VHD より大きなサイズに設定します。ストレージの種類は任意で構いません。</td></tr></tbody></table><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-11-41-10.png"></p><p>その他のオプションは既定のままで大丈夫ですので、ディスクの作成を行ってください。<br>データディスクがある場合は同様の手順でデータディスクもご対応をお願いいたします。  </p><hr><h2 id="3-ディスクリソースから-ARM-VM-を作成する。"><a href="#3-ディスクリソースから-ARM-VM-を作成する。" class="headerlink" title="3. ディスクリソースから ARM VM を作成する。"></a>3. ディスクリソースから ARM VM を作成する。</h2><p>最後に作成した OS ディスクのリソースの画面をポータルで表示します。<br>上部に「VM の作成」ボタンがございますので、こちらを選択します。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-11-44-29.png"></p><p>新規 ARM VM の作成画面に遷移いたしますので、お客様の環境に合わせて ARM VM の作成を実施くださいませ。<br>作成時に「ディスク」のタブよりデータディスクのアタッチも可能でございます。  </p><p><img src="/blog/vm/classic-vhd-to-arm-vm/2023-08-16-14-38-17.png"></p><hr><p>以上で ARM VM の作成ができました。必要に応じて不要となった VHD などは削除くださいませ。<br>上記の内容がお役に立てますと幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;Azure のクラシック VM は 2023 年 9 月 6 日を持ちまして廃止となりました。&lt;br&gt;そのためこれ以降サポートされる VM は ARM（Azure Resource Manager）の </summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>セルフサービスメンテナンスについて（FAQ）</title>
    <link href="https://jpaztech.github.io/blog/vm/self-service-maintenance/"/>
    <id>https://jpaztech.github.io/blog/vm/self-service-maintenance/</id>
    <published>2023-08-18T03:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.595Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回はよくお問い合わせいただく VM（仮想マシン）の「再起動を伴うメンテナンス」に伴い、事前にメンテナンスが可能となるセルフサービスメンテナンスについて、以下のような内容を解説させていただきます。</p><ul><li><a href=".#%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AE%E6%A6%82%E8%A6%81">セルフサービスメンテナンスの概要</a></li><li><a href=".#%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%92%E4%BC%B4%E3%81%86%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E5%AF%BE%E8%B1%A1-VM-%E3%81%AE%E7%A2%BA%E8%AA%8D%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E8%A1%8C%E3%81%88%E3%81%B0%E3%82%88%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F">再起動を伴うメンテナンス対象 VM の確認はどのように行えばよいですか？</a></li><li><a href=".#%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%92%E4%BC%B4%E3%81%86%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AE%E8%A8%88%E7%94%BB%E3%82%92%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%9A%E7%9F%A5%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%82%88%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F">再起動を伴うメンテナンスの計画をメール通知するにはどうすればよいですか？</a></li><li><a href=".#%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%92%E4%BC%B4%E3%81%86%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AE%E9%80%9A%E7%9F%A5%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F">再起動を伴うメンテナンスの通知のサンプルはありますか？</a></li><li><a href=".#%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8C%E3%81%B0%E3%82%88%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F">セルフサービスメンテナンスはどのように実行すればよいですか？</a></li><li><a href=".#%E9%80%9A%E5%B8%B8%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E8%A7%A3%E9%99%A4%E3%82%84%E5%86%8D%E8%B5%B7%E5%8B%95%E7%AD%89%E3%81%A7%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AF%E5%AE%8C%E4%BA%86%E3%81%97%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F">通常の割り当て解除や再起動等でセルフサービスメンテナンスは完了しますか？</a></li><li><a href=".#%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%92%E4%BC%B4%E3%81%86%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E5%AF%BE%E8%B1%A1%E4%B8%80%E8%A6%A7%E3%81%8B%E3%82%89%E5%AF%BE%E8%B1%A1-VM-%E3%81%8C%E6%B6%88%E3%81%88%E3%81%A6%E3%81%84%E3%81%9F%E3%81%AE%E3%81%A7%E3%81%99%E3%81%8C%E4%BD%95%E6%95%85%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F">再起動を伴うメンテナンス対象一覧から対象 VM が消えていたのですが何故ですか？</a></li><li><a href=".#%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%92%E4%BC%B4%E3%81%86%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AE%E5%AE%8C%E4%BA%86%EF%BC%88%E6%88%90%E5%8A%9F%EF%BC%89%E3%81%AE%E7%A2%BA%E8%AA%8D%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F">再起動を伴うメンテナンスの完了（成功）の確認方法はありますか？</a></li><li><a href=".#%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E5%AE%9F%E8%A1%8C%E6%99%82%E3%81%AF-VM-%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F">セルフサービスメンテナンス実行時は VM が起動している必要がありますか？</a></li><li><a href=".#%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E6%9C%9F%E9%96%93%E4%B8%AD%E3%81%AB%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%82%92%E3%81%97%E3%81%AA%E3%81%84%E3%81%A8%E3%81%A9%E3%81%86%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F">セルフサービスメンテナンス期間中にメンテナンスをしないとどうなりますか？</a></li><li><a href=".#%E5%88%A5%E3%81%AE%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A7%E3%81%AF%E3%81%93%E3%81%AE%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%8C%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8C%E4%BD%95%E6%95%85%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F">別のサブスクリプションではこのメンテナンスが通知されませんが何故ですか？</a></li><li><a href=".#%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%AE%E3%81%BF%E5%AF%BE%E8%B1%A1-VM-%E3%81%8C%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%82%8B%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%92%E4%BC%B4%E3%81%86%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">メールでのみ対象 VM が通知される再起動を伴うメンテナンスについて</a></li></ul><hr><h2 id="セルフサービスメンテナンスの概要"><a href="#セルフサービスメンテナンスの概要" class="headerlink" title="セルフサービスメンテナンスの概要"></a>セルフサービスメンテナンスの概要</h2><p>Azure ではお客様の安全のためセキュリティの対応や機能改修等として日々メンテナンスを行っております。<br>そのメンテナンスの中で、稀にお客様の VM の再起動を伴う場合がございます。<br>このようなメンテナンスは「再起動を伴うメンテナンス」と呼ばれております。</p><p>■ご参考：Azure での仮想マシンのメンテナンス<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates</a></p><p>■ご参考：計画メンテナンスの通知の処理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications</a></p><p>■ご参考：Azure IaaS VM で実施されるメンテナンスについて<br><a href="https://jpaztech.github.io/blog/vm/vm-maintenance/">https://jpaztech.github.io/blog/vm/vm-maintenance/</a></p><p>VM 再起動を伴うメンテナンスについては原則として、事前にお客様の方で任意の時間にメンテナンスを実施することができる、セルフサービスメンテナンスが提供されます。<br>以下にセルフサービスメンテナンスについてよく寄せられる質問のご案内をさせていただきます。  </p><div class="alert is-success"><p class="alert-title">ヒント</p><p>セルフサービスメンテナンスを実行しても、実際は Azure 基盤側にてハードウェアのメンテナンスがトリガーされるわけではございません。</p><p>セルフサービスメンテナンスが実行された場合、お客様の VM がメンテナンス対象の物理ホストサーバーからメンテナンス対象外の物理ホストサーバーに移動されるものとなります。</p></div><hr><h2 id="再起動を伴うメンテナンス対象-VM-の確認はどのように行えばよいですか？"><a href="#再起動を伴うメンテナンス対象-VM-の確認はどのように行えばよいですか？" class="headerlink" title="再起動を伴うメンテナンス対象 VM の確認はどのように行えばよいですか？"></a>再起動を伴うメンテナンス対象 VM の確認はどのように行えばよいですか？</h2><p>以下のドキュメントに記載の通り、Azure ポータル / Azure PowerShell / Azure CLI より確認することが可能です。</p><p>■ご参考：ポータルを使用した計画済みメンテナンスの通知の処理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-portal</a></p><p>■ご参考：PowerShell を使用した計画メンテナンスの処理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-powershell">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-powershell</a></p><p>■ご参考：Azure CLI に対する計画済みメンテナンスの通知の処理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-cli">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-cli</a></p><p>では、実際にメンテナンスをポータルから確認する例を 2 つの方法よりスクリーンショット交えて紹介させていただきます。  </p><h3 id="方法-1-サービス正常性よりメンテナンス対象-VM-を確認する"><a href="#方法-1-サービス正常性よりメンテナンス対象-VM-を確認する" class="headerlink" title="方法 1: サービス正常性よりメンテナンス対象 VM を確認する"></a>方法 1: サービス正常性よりメンテナンス対象 VM を確認する</h3><p>ポータル上部の検索ボックスより「サービス正常性」を検索して選択します。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-07-11.png"></p><p>表示されたサービス正常性の画面の、左側のメニューより「計画メンテナンス」を表示します。<br>サブスクリプション等のフィルタリングを設定し、対象のメンテナンスを選択すると、メンテナンスの概要が表示されます。</p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-12-02.png"></p><p>下部の「影響を受けるリソース」タブを表示することで、メンテナンス対象となる VM が確認できます。<br>「状態」の列が「先行メンテナンスの管理」になっている VM はメンテナンス対象となっております。<br>「状態」の列が「更新済み」の VM、もしくはそもそも「影響を受けるリソース」表示されていない VM はメンテナンス対象外となっております。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-34-21.png"></p><h3 id="方法-2-VM-一覧よりメンテナンス対象-VM-を確認する"><a href="#方法-2-VM-一覧よりメンテナンス対象-VM-を確認する" class="headerlink" title="方法 2: VM 一覧よりメンテナンス対象 VM を確認する"></a>方法 2: VM 一覧よりメンテナンス対象 VM を確認する</h3><p>ポータル上部の検索ボックスより「Virtual Machines」を検索して選択します。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-23-02.png"></p><p>上部の「メンテナンス」ボタンより「仮想マシンのメンテナンス」を選択します。</p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-25-33.png"></p><p>仮想マシンのメンテナンス一覧の画面が表示されますので、メンテナンス対象となっている VM があるか確認ができます。</p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-26-41.png"></p><hr><h2 id="再起動を伴うメンテナンスの計画をメール通知するにはどうすればよいですか？"><a href="#再起動を伴うメンテナンスの計画をメール通知するにはどうすればよいですか？" class="headerlink" title="再起動を伴うメンテナンスの計画をメール通知するにはどうすればよいですか？"></a>再起動を伴うメンテナンスの計画をメール通知するにはどうすればよいですか？</h2><p>一部のメンテナンスについては、設定をしなくとも管理者にメール通知されることがございますが、原則として再起動が伴うメンテナンスが計画された際にメールで通知を行うには、サービス正常性のアラート設定を行う必要がございます。  </p><p>■ご参考：ポータルの通知とアラート<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-portal#notification-and-alerts-in-the-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-portal#notification-and-alerts-in-the-portal</a></p><blockquote><p>ーーーーーー抜粋ーーーーーー<br>仮想マシン関連のメンテナンス通知は、Azure portal の [サービスの正常性] で使用できます。<br>一部の特定の仮想マシンの計画メンテナンス シナリオでは、Azure が従来のサブスクリプション管理者、共同管理者、およびサブスクリプション所有者グループに追加のメール (Service Health 以外) を送信して、スケジュールを通知する場合があります。<br>ーーーーーーーーーーーーーー  </p></blockquote><p>メンテナンスに限らず、サービス正常性アラートは Azure サービス自体の正常性を監視するのに役立ちます。<br>サービス正常性アラートについては別途弊社の解説ブログ記事もございますので、参考としてご案内させていただきます。  </p><p>■ご参考：サービス正常性アラートの設定手順と推奨設定について<br><a href="https://jpazmon-integ.github.io/blog/ame/HowToSetUpServiceHealthAlertsAndRecommendedSettings/">https://jpazmon-integ.github.io/blog/ame/HowToSetUpServiceHealthAlertsAndRecommendedSettings/</a></p><p>では、実際にメール通知を行うための手順についてスクリーンショットを交えて紹介させていただきます。  </p><p>ポータル上部の検索ボックスより「サービス正常性」を検索して選択します。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-07-11.png"></p><p>上部の「サービス正常性アラートの作成」をボタンを選択します。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-29-10.png"></p><p>スコープにて対象とするサブスクリプションを選択します。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-30-10.png"></p><p>条件にて、VM および VMSS に関する再起動を伴うメンテナンスの通知を行うため、以下の設定を行います。</p><ul><li>サービス：Virtual Machines および Azure Virtual Machine Scale Sets を選択。  </li><li>地域：任意のリージョンを選択。</li><li>イベントの種類：計画メンテナンスを選択。</li></ul><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-30-54.png"></p><p>アクションにて、メンテナンスが計画された際にどのように通知アクションを行うのか設定します。<br>既にアクション グループが存在する場合は「アクション グループの選択」を選んでください。<br>新規にメール通知を行うアクション グループを作成する際は、「アクション グループの作成」を選択いただき、任意のメールアドレスへ通知を行うアクショングループを新規作成してください。</p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-31-57.png"></p><p>最後に詳細にて、このアラートの名前を設定してアラートを作成します。 </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-32-53.png"></p><p>これで再起動を伴うメンテナンスが計画された際に、メール通知を行うアラートが作成できました。</p><hr><h2 id="再起動を伴うメンテナンスの通知のサンプルはありますか？"><a href="#再起動を伴うメンテナンスの通知のサンプルはありますか？" class="headerlink" title="再起動を伴うメンテナンスの通知のサンプルはありますか？"></a>再起動を伴うメンテナンスの通知のサンプルはありますか？</h2><p>以下は、再起動を伴うメンテナンスの通知のサンプルとなります。<br>「サービス正常性」の「計画メンテナンス」より確認頂くことが可能でございます。<br><strong>メンテナンス毎に内容は変わりますので、実際に通知されたメンテナンス通知内容のご確認をお願い申し上げます。</strong> </p><blockquote><p>Dear Azure customer,</p><p>One or more Azure Virtual Machines (VMs) associated with your subscription require a maintenance update to migrate these VMs to newer hardware. While the vast majority of platform maintenance causes no interruption to your services, this update will require a reboot.  </p><p>This maintenance has two phases: the self-service phase and a scheduled maintenance phase.  </p><p>Azure Service Health provides you with the current status of each VM that requires maintenance and allows you to initiate the self-service maintenance proactively – any time between now and July 26, 2023 (23:59 UTC). If self-service maintenance has not been completed by then, Azure will automatically initiate maintenance on any VM that still requires it, sometime between July 27, 2023 (00:00 UTC) to August 02, 2023 (23:59 UTC). This scheduled maintenance will be performed one update domain at a time, to limit impact to environments configured for high availability.  </p><p>You can view a list of Affected Resources for this event under the ServiceHealth/PlannedMaintenance tab in the Azure portal  </p><p>You should expect each VM to be unavailable for up to 15 minutes after initiating the maintenance and note that operating system and data disks will be retained, but temporary storage will be lost during this maintenance. If you are using Dv1 or DSv1 VM sizes, please refer to the documentation <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-previous-gen">here</a> to understand performance changes if any.  </p><p>If you are using Proximity Placement Groups, please refer to the documentation <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/co-location#planned-maintenance-and-proximity-placement-groups">here</a> to understand how to verify the alignment of your resources and to take appropriate action if some resources are not aligned.  </p><p>We apologize for any impact that this maintenance may have. We strive to minimize the impact of platform maintenance, and to provide you with as much visibility and control as possible.  </p></blockquote><hr><h2 id="セルフサービスメンテナンスはどのように実行すればよいですか？"><a href="#セルフサービスメンテナンスはどのように実行すればよいですか？" class="headerlink" title="セルフサービスメンテナンスはどのように実行すればよいですか？"></a>セルフサービスメンテナンスはどのように実行すればよいですか？</h2><p>セルフサービスメンテナンスを実行するためには、通常の再起動操作とは別の操作が必要となります。<br>具体的な実行方法としては、以下のドキュメントに記載の通り、Azure ポータル / Azure PowerShell / Azure CLI より実行することが可能です。<br>セルフサービスメンテナンスを開始すると VM が再起動しますのでご留意ください。  </p><p>■ご参考：ポータルから VM に対するメンテナンスを開始する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-portal#start-maintenance-on-your-vm-from-the-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-portal#start-maintenance-on-your-vm-from-the-portal</a></p><p>■ご参考：PowerShell を使用して VM に対するメンテナンスを開始する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-powershell#start-maintenance-on-your-vm-using-powershell">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-powershell#start-maintenance-on-your-vm-using-powershell</a></p><p>■ご参考：メンテナンスを開始する（Azure CLI）<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-cli#start-maintenance">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications-cli#start-maintenance</a></p><p>ポータルから実行する例として、先述のサービス正常性の計画メンテナンスの対象 VM 確認画面より、「先行メンテナンスの管理」ボタンを推すことでメンテナンス開始画面に遷移することができます。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-34-58.png"></p><p>以下がメンテナンス開始画面の例となります。<br>「メンテナンスを開始する」ボタンを選択頂くことで、セルフサービスメンテナンスが開始されます。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-35-59.png"></p><p>なお、メンテナンス対象となっている VM については対象 VM の概要画面にも、以下のようなリボンが上部に表示されており、このリボンを選択頂くことでメンテナンス開始に進むことができます。  </p><p><img src="/blog/vm/self-service-maintenance/2023-07-26-13-38-00.png"></p><hr><h2 id="通常の割り当て解除や再起動等でセルフサービスメンテナンスは完了しますか？"><a href="#通常の割り当て解除や再起動等でセルフサービスメンテナンスは完了しますか？" class="headerlink" title="通常の割り当て解除や再起動等でセルフサービスメンテナンスは完了しますか？"></a>通常の割り当て解除や再起動等でセルフサービスメンテナンスは完了しますか？</h2><p>まずセルフサービスメンテナンスが実行され、完了時にメンテナンス対象外の物理ホストサーバーに VM が移動することを保証している方法としては、上記の「セルフサービスメンテナンスの開始」の方法となっております。  </p><p>他方、「割り当て解除」および「再デプロイ」操作を行っていただいた場合は、メンテナンス対象外の物理ホストサーバーに VM が移動することがあり、結果としてメンテナンス完了状態となる可能性がございます。<br>しかしながら、引き続きメンテナンス対象の物理ホストサーバーで VM が稼働することもございます。</p><p>なお、「ポータルでの再起動」や「OS 内部のシャットダウン / 再起動」の場合、VM の物理ホストサーバー移動は起きませんため、メンテナンス完了とはならないものと存じます。  </p><p>すなわち、セルフサービスメンテナンスを行う場合は先述の「セルフサービスメンテナンスの開始」の方法で実施をお願いいたします。  </p><hr><h2 id="再起動を伴うメンテナンス対象一覧から対象-VM-が消えていたのですが何故ですか？"><a href="#再起動を伴うメンテナンス対象一覧から対象-VM-が消えていたのですが何故ですか？" class="headerlink" title="再起動を伴うメンテナンス対象一覧から対象 VM が消えていたのですが何故ですか？"></a>再起動を伴うメンテナンス対象一覧から対象 VM が消えていたのですが何故ですか？</h2><p>以下のドキュメントに記載の通り、VM がメンテナンス対象から外れることがございます。<br>よくあるシナリオとしては、お客様の方で VM の割り当て解除および起動が行われたことで、メンテナンス対象外の物理ホストサーバーに VM が移動したことによりメンテナンス対象外となるといったパターンです。<br>メンテナンス対象から表示が消えている VM については、セルフサービスメンテナンスが不要となっておりますので、特にご対応をいただく必要はございません。</p><p>■ご参考：よく寄せられる質問<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications#faq">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications#faq</a></p><blockquote><p>ーーーーーー抜粋ーーーーーー<br>Q: VM のメンテナンス情報が表示されません。 問題の原因  </p><p>A: VM のメンテナンス情報が表示されない理由はいくつかあります。  </p><p>1.Microsoft 社内としてマークされたサブスクリプションを使用している。<br>2.VM のメンテナンスがスケジュールされていない。 メンテナンス ウェーブが終了しているか、取り消し&gt;または変更が行われたため、VM が影響を受けなくなっていると考えられます。<br><strong>3.あなたは VM の割り当てを解除し、その後、VM を起動しました。 それを行うと、メンテナンス ウェーブを計画していない場所に VM が移動する可能性があります。 そのため、VM にはメンテナンス情報が表示されません。</strong><br>4.VM リスト ビューに [メンテナンス] 列が追加されていない。 この列は既定のビューに追加されていますが、既定以外の列を表示するように構成しているお客様は、VM リスト ビューに [メンテナンス] 列を手動で追加する必要があります。<br>ーーーーーーーーーーーーーー  </p></blockquote><hr><h2 id="再起動を伴うメンテナンスの完了（成功）の確認方法はありますか？"><a href="#再起動を伴うメンテナンスの完了（成功）の確認方法はありますか？" class="headerlink" title="再起動を伴うメンテナンスの完了（成功）の確認方法はありますか？"></a>再起動を伴うメンテナンスの完了（成功）の確認方法はありますか？</h2><p>先述のサービス正常性の計画メンテナンスの対象 VM 確認画面上で、「影響を受けるリソース」の一覧をご確認いただき、以下のいずれかの状態であればメンテナンスが完了（成功）していると考えていただいて差し支えございません。</p><ul><li>対象の VM　について「状態」の列が「更新済み」と表示さていている。</li><li>もしくは、対象の VM が「影響を受けるリソース」の一覧表示から消えている。</li></ul><p><img src="/blog/vm/self-service-maintenance/2023-07-26-14-46-32.png"></p><hr><h2 id="セルフサービスメンテナンス実行時は-VM-が起動している必要がありますか？"><a href="#セルフサービスメンテナンス実行時は-VM-が起動している必要がありますか？" class="headerlink" title="セルフサービスメンテナンス実行時は VM が起動している必要がありますか？"></a>セルフサービスメンテナンス実行時は VM が起動している必要がありますか？</h2><p>セルフサービスメンテナンスは VM が「割り当て解除済み」の状態では実行が叶いません。<br>「実行中」や「停止済み（OS 内部からのシャットダウン完了）」の状態であればセルフサービスメンテナンスは実行可能となります。  </p><hr><h2 id="セルフサービスメンテナンス期間中にメンテナンスをしないとどうなりますか？"><a href="#セルフサービスメンテナンス期間中にメンテナンスをしないとどうなりますか？" class="headerlink" title="セルフサービスメンテナンス期間中にメンテナンスをしないとどうなりますか？"></a>セルフサービスメンテナンス期間中にメンテナンスをしないとどうなりますか？</h2><p>セルフサービスメンテナンスの実行可能な期間が終了すると、予定メンテナンス フェーズになります。<br>セルフサービスメンテナンス期間中にセルフサービスメンテナンスを実行せずに、予定メンテナンス フェーズに入った場合は、自動的に再起動を伴うメンテナンスが実行されます。<br>この場合、予定メンテナンス フェーズではお客様の方でメンテナンス実行のタイミングを制御することは叶いません点、ご了承くださいませ。  </p><hr><h2 id="別のサブスクリプションではこのメンテナンスが通知されませんが何故ですか？"><a href="#別のサブスクリプションではこのメンテナンスが通知されませんが何故ですか？" class="headerlink" title="別のサブスクリプションではこのメンテナンスが通知されませんが何故ですか？"></a>別のサブスクリプションではこのメンテナンスが通知されませんが何故ですか？</h2><p>再起動を伴うメンテナンスの通知は、あくまでメンテナンス対象があるサブスクリプションにのみ通知されます。<br>そのため、メンテナンスの通知がされていないサブスクリプションに関してはメンテナンス対象が無いと考えて頂いて差し支えございません。</p><hr><h2 id="メールでのみ対象-VM-が通知される再起動を伴うメンテナンスについて"><a href="#メールでのみ対象-VM-が通知される再起動を伴うメンテナンスについて" class="headerlink" title="メールでのみ対象 VM が通知される再起動を伴うメンテナンスについて"></a>メールでのみ対象 VM が通知される再起動を伴うメンテナンスについて</h2><p>稀ではございますが、再起動を伴うメンテナンスについて、Azure ポータル等では対象 VM の確認が叶わず、メールでのみメンテナンス対象 VM が通知される場合がございます。<br>この場合は、そのメール内に対象 VM の通知を行った旨やどのような対応が必要かといった内容が記載されておりますため、通知に記載の内容をご確認いただきご対応をお願い申し上げます。</p><hr><p>以上の通り、セルフサービスメンテナンスについて解説をさせていただきました。<br>メンテナンスについてご不明点がございます場合は、対象のメンテナンスに割り振られている TrackingID（追跡 ID）を添えて、Azure 技術サポート窓口にお問い合わせを頂けますと幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回はよくお問い合わせいただく VM（仮想マシン）の「再起動を伴うメンテナンス」に伴い、事前にメンテナンスが可能となるセルフサービスメンテナンスについて、以下のような内容を解説させていただきます。&lt;/p</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure Windows VM の KMS ライセンス認証トラブルシューティングについて</title>
    <link href="https://jpaztech.github.io/blog/vm/kms-troubleshooting/"/>
    <id>https://jpaztech.github.io/blog/vm/kms-troubleshooting/</id>
    <published>2023-08-17T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.523Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>Azure 上で稼働する Windows VM のライセンス認証のためにマイクロソフトが KMS サーバー（KMS ホスト サーバー）を提供しております。<br>KMS サーバーへのライセンス認証要求は KMS クライアント (Windows VM) から KMS サーバーに対して定期的かつ自動的に実行されます。<br>Azure Windows VM から Azure の KMS サーバーに対して適切な経路で通信が行えない環境等においては、KMS のライセンス認証が失敗し続け、ライセンス認証切れに関する警告が表示されることがございます。<br>本件について多くのお問い合わせをいただきますため、KMS のライセンス認証のトラブルシューティング等について以下の内容をご紹介させていただきます。</p><ul><li><p><a href="./#KMS-%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E8%A7%A3%E8%AA%AC">KMS ライセンス認証についての解説</a></p><ul><li><a href="./#KMS-%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%81%AE%E6%A6%82%E8%A6%81">KMS ライセンス認証の概要</a></li><li><a href="./#KMS-%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E8%A8%AD%E5%AE%9A%E3%81%8A%E3%82%88%E3%81%B3%E9%80%9A%E4%BF%A1%E8%A6%81%E4%BB%B6">KMS ライセンス認証に必要な設定および通信要件</a></li><li><a href="./#%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AA%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%81%8A%E3%82%88%E3%81%B3%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">自動的なライセンス認証および有効期限について</a></li><li><a href="./#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E5%88%87%E3%82%8C%E3%81%AE%E5%BD%B1%E9%9F%BF">ライセンス認証切れの影響</a></li></ul></li><li><p><a href="./#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E6%96%B9%E6%B3%95">トラブルシューティング方法</a></p><ul><li><a href="./#%E6%89%8B%E5%8B%95%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E5%AE%9F%E8%A1%8C">手動ライセンス認証のコマンド実行</a></li><li><a href="./#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E7%8A%B6%E6%85%8B%E3%81%8A%E3%82%88%E3%81%B3%E8%A8%AD%E5%AE%9A%E7%A2%BA%E8%AA%8D">ライセンス状態および設定確認</a></li><li><a href="./#KMS-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%B8%E3%81%AE%E5%90%8D%E5%89%8D%E8%A7%A3%E6%B1%BA%E3%81%8A%E3%82%88%E3%81%B3%E7%96%8E%E9%80%9A%E7%A2%BA%E8%AA%8D%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AE%E5%AE%9F%E8%A1%8C">KMS サーバーへの名前解決および疎通確認コマンドの実行</a></li><li><a href="./#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%83%AD%E3%82%B0%E3%81%A7%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%83%AD%E3%82%B0%E3%82%92%E8%A6%8B%E3%82%8B">イベントログでライセンスログを見る</a></li></ul></li><li><p><a href="./#%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%81%AE%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3">よくあるトラブルのパターン</a></p><ul><li><a href="./#KMS-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E4%B8%80%E6%99%82%E7%9A%84%E3%81%AA%E8%B2%A0%E8%8D%B7">KMS サーバーの一時的な負荷</a></li><li><a href="./#%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E8%A3%BD%E5%93%81%E3%81%A7%E9%80%9A%E4%BF%A1%E3%82%92%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B">ファイアウォール製品で通信をブロックしている</a></li><li><a href="./#%E5%BC%B7%E5%88%B6%E3%83%88%E3%83%B3%E3%83%8D%E3%83%AA%E3%83%B3%E3%82%B0%E7%92%B0%E5%A2%83%EF%BC%88%E3%82%AA%E3%83%B3%E3%83%97%E3%83%AC%E3%83%9F%E3%82%B9%E7%AD%89%E3%82%92%E7%B5%8C%E7%94%B1%E3%81%97%E7%9B%B4%E6%8E%A5%E9%80%9A%E4%BF%A1%E3%81%A8%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%EF%BC%89">強制トンネリング環境（オンプレミス等を経由し直接通信となっていない）</a></li><li><a href="./#Standard-SKU-%E3%81%AE-Azure-Load-Balancer-%E9%85%8D%E4%B8%8B%E3%81%AE-VM-%E3%81%A7%E5%A4%96%E9%83%A8%E6%8E%A5%E7%B6%9A%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84">Standard SKU の Azure Load Balancer 配下の VM で外部接続ができない</a></li><li><a href="./#Tokens-dat-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%A0%B4%E6%90%8D">Tokens.dat ファイルの破損</a></li></ul></li><li><p><a href="./#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB%EF%BC%88%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%A6%81%E5%9B%A0%E7%AD%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%EF%BC%89">さいごに（その他の要因等について）</a></p></li></ul><hr><h2 id="KMS-ライセンス認証についての解説"><a href="#KMS-ライセンス認証についての解説" class="headerlink" title="KMS ライセンス認証についての解説"></a>KMS ライセンス認証についての解説</h2><p>先述の通り、Azure 上の Windows VM は定期的かつ自動的に KMS ライセンス認証が行われます。<br>KMS ライセンス認証についてどのように行われるのかといった概要などをご紹介させていただきます。  </p><hr><h3 id="KMS-ライセンス認証の概要"><a href="#KMS-ライセンス認証の概要" class="headerlink" title="KMS ライセンス認証の概要"></a>KMS ライセンス認証の概要</h3><p>Azure 上で稼働する Windows VM は従量課金制となっており、原則稼働時の従量課金にライセンス料が含まれております。<br>ゲスト OS となる Windows からは KMS（Key Management Services）サーバーに、定期的なライセンス認証が行われます。<br>このライセンス認証先の KMS サーバーは Azure 上にマイクロソフトがご用意しております。<br>そのため、お客様のご利用の Windows VM から KMS サーバーへのライセンス認証の通信経路が確保されている必要がございます。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure 上にお客様ご自身で KMS ホストサーバーの役割を担う KMS ホストを構築いただく場合は、そのサーバーではオンプレミス環境と同様に KMS ホストサーバー用の MAK キー（KMS ホスト キー）を使用してライセンス認証を実施する手順が必要となります。  </p></div><hr><h3 id="KMS-ライセンス認証に必要な設定および通信要件"><a href="#KMS-ライセンス認証に必要な設定および通信要件" class="headerlink" title="KMS ライセンス認証に必要な設定および通信要件"></a>KMS ライセンス認証に必要な設定および通信要件</h3><p>Azure VM から KMS サーバーへの通信は、<strong>TCP 宛先ポート 1688</strong> で以下のドメインに対して行われます。</p><blockquote><p><strong>kms.core.windows.net</strong> もしくは <strong>azkms.core.windows.net</strong></p></blockquote><p>このドメインは以下の IP アドレスのいずれかに名前解決されます。</p><blockquote><p><strong>20.118.99.224, 40.83.235.53, 23.102.135.246</strong></p></blockquote><p>なお、KMS ライセンスサーバー自体は Azure 上にご用意をしておりますが、上記の通りグローバル IP アドレスで名前解決されますので、VM からは Internet 方向としてルーティングされる必要がございます。  </p><p>重要な点として、原則 VM から直接 KMS サーバーへの通信を行っていただく必要がございます。<br>オンプレミス環境を経由したライセンス認証の通信ではライセンス認証が失敗することがございます。<br>この点については後述の「強制トンネリング環境（直接通信となっていない）」をご参照ください。<br>下図は KMS ライセンス認証の成功・失敗の例を表した図となります。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-04-16-23-05.png"></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>KMS ライセンスサーバーへのライセンス認証通信については、NSG（ネットワークセキュリティグループ）の影響を受けないよう暗黙的なルールが存在します。</p><p>例外的にサブネットに対して 0.0.0.0/0 のルールがある場合は、暗黙的なルールがスキップされ、明示的に許可ルールが必要となります。  </p></div><p>また、OS 毎に KMS 専用のプロダクトキーの設定が必要です。<br>Azure マーケットプレイスからデプロイした VM 等では既定でこのプロダクトキーが設定されており、対応は不要でございますが、以下のシナリオに該当する場合は手動でライセンスキーの入力が必要となります。</p><ul><li>コンピューターをマルチ ライセンス認証キー (MAK) の使用から KMS クライアントに変換する</li><li>Windows の製品版 (OEM/Retail) ライセンスを KMS クライアントに変換する</li><li>コンピューターが以前に KMS ホストであった場合 KMS クライアントに変換する</li></ul><p>■ご参考：キー管理サービス (KMS) クライアントのライセンス認証とプロダクト キー<br><a href="https://learn.microsoft.com/ja-jp/windows-server/get-started/kms-client-activation-keys">https://learn.microsoft.com/ja-jp/windows-server/get-started/kms-client-activation-keys</a></p><hr><h3 id="自動的なライセンス認証および有効期限について"><a href="#自動的なライセンス認証および有効期限について" class="headerlink" title="自動的なライセンス認証および有効期限について"></a>自動的なライセンス認証および有効期限について</h3><p>ライセンス認証は既定では以下の間隔で自動的に認証されます。  </p><ul><li>ライセンス認証がされていない状態：2 時間に 1 回の頻度</li><li>ライセンス認証がされている状態：7 日に 1 回の頻度</li></ul><p>また、ライセンス認証は毎回必ず成功する必要はなく、一度認証されれば 180 日の有効期限が付与されます。<br>認証に成功する度に有効期限が再び 180 日からカウントされます。  </p><p>つまり、正常な状況であれば定期的なライセンス認証によって、180 日の有効期限が毎回更新されるという形となります。</p><hr><h3 id="ライセンス認証切れの影響"><a href="#ライセンス認証切れの影響" class="headerlink" title="ライセンス認証切れの影響"></a>ライセンス認証切れの影響</h3><p>Windows 8 / Windows Server 2012 以降の OS の場合のライセンス認証の影響について記載させていただきます。<br>上記期間内にライセンス認証が成功しない場合は、通知モード（ライセンス認証切れ状態）となります。<br>この際の影響は以下のようなものとなり VM への接続不可や使用不可になるといった影響はございません。<br>しかしながら、ライセンス認証が切れる前にライセンス認証が成功となるようご対応をお願いいたします。  </p><ol><li>画面の右下にライセンス認証が必要であることを示すウォーターマーク（透かし文字） が表示されます。</li><li>壁紙の右下に OS の情報を示す文字が表示されます。（Windows 8 / Windows Server 2012 及び 2012 R2 のみ）</li><li>パーソナル設定内の項目は設定変更不可となります。</li><li>自身が KMS ホストの場合、KMS クライアントの認証が行えません。</li></ol><hr><h2 id="トラブルシューティング方法"><a href="#トラブルシューティング方法" class="headerlink" title="トラブルシューティング方法"></a>トラブルシューティング方法</h2><p>ライセンス有効期限が近づくと、以下のようなライセンス認証を促すメッセージなどが表示されることがございます。  </p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-11-38-39.png" alt="Windows のライセンスの有効期限がもうすぐ切れます [設定] で Windows のライセンス認証を行う必要があります"></p><p>また、ライセンス認証が切れた際にメッセージが表示されるものと存じます。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-11-39-40.png" alt="Windows ライセンスの有効期限が切れています"></p><p>この場合は、何からの理由で自動的なライセンス認証が繰り返し失敗しており、ライセンス認証がまもなく切れる / 切れてしまっているといった状況が考えられます。 </p><p>よくあるライセンス認証の失敗のエラーコードとして「0xC004F074」や「0x8007139F」が表示されることがございます。<br>エラーコードから一発で原因究明ができるのが望ましいですが、恐縮ながら KMS ライセンス認証のトラブルシューティングは 1 つずつ原因切り分け等を行う必要がございます。<br>そのため、まずは先述の必要な通信要件等が可能な状況かご確認いただくことが必要です。<br>以下に正常なライセンス認証を行うためのトラブルシューティング方法を解説させていただきます。  </p><p>■ご参考：Azure Windows 仮想マシンのライセンス認証に関する問題のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-activation-problems">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-activation-problems</a></p><hr><h3 id="手動ライセンス認証のコマンド実行"><a href="#手動ライセンス認証のコマンド実行" class="headerlink" title="手動ライセンス認証のコマンド実行"></a>手動ライセンス認証のコマンド実行</h3><p>まずは、手動でのライセンス認証コマンドを実行し、ライセンス認証が正常に成功するかご確認頂くのが良いかと存じます。<br>別途設定などの修正等を行った後にライセンス認証が成功するか確認する際にもこちらのコマンドをご利用いただけます。<br>管理者特権の Windows PowerShell プロンプトにて以下のコマンドの実行をお願いいたします。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>..<span class="number">12</span> | <span class="built_in">ForEach-Object</span> &#123; <span class="built_in">Invoke-Expression</span> <span class="string">&quot;<span class="variable">$env:windir</span>\system32\cscript.exe <span class="variable">$env:windir</span>\system32\slmgr.vbs /ato&quot;</span> ; <span class="built_in">start-sleep</span> <span class="number">5</span> &#125;</span><br></pre></td></tr></table></figure><p>こちらのコマンドは、KMS サーバーに対しライセンス認証を 5 秒毎に 12 回実行するコマンドとなっております。<br>1 回のみの実行の場合、一時的な問題で失敗することがございますため複数回の実行としております。<br>成功した場合は以下のようなメッセージが表示されます。  </p><blockquote><p>Windows(R)、ServerDatacenter エディションのアクティブ化 (12345678-1234-1234-1234-1234-12345678) … 製品が正常にアクティブ化されました。</p></blockquote><hr><h3 id="ライセンス状態および設定確認"><a href="#ライセンス状態および設定確認" class="headerlink" title="ライセンス状態および設定確認"></a>ライセンス状態および設定確認</h3><p>ライセンス状態および設定確認を行うには PowerShell で以下のコマンドを実行します。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript c:\windows\system32\slmgr.vbs /dlv</span><br></pre></td></tr></table></figure><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-11-37-28.png"></p><p>上記のように、ライセンスの状態やライセンス認証先の情報の確認が可能でございます。  </p><p>なお、ライセンスの有効期限が切れた状態などでは上記コマンドでライセンス認証先 KMS サーバーの情報が表示されないことがございます。<br>そのような場合は以下のいずれか方法でライセンス認証先 KMS サーバーの情報を確認することが可能です。  </p><ul><li><strong>Event Viewer (Local) &gt; Windows Logs &gt; Application</strong> アプリケーションイベントログのイベント ID 12288 でライセンス認証先を確認する。</li><li>以下のコマンドを実行する。</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 設定されているライセンス認証先 KMS サーバーのドメインを確認</span></span><br><span class="line">reg query <span class="string">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform&quot;</span> /v KeyManagementServiceName</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設定されているライセンス認証先 KMS サーバーのポート番号を確認</span></span><br><span class="line">reg query <span class="string">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform&quot;</span> /v KeyManagementServicePort</span><br></pre></td></tr></table></figure><p>もしライセンス認証先 KMS サーバーを IP アドレスを固定で指定してしまっている場合など、KMS ライセンス認証先の修正が必要な場合は以下のコマンドで修正可能です。<br>なお、修正後に設定を反映させるために先述の手動のライセンス認証のコマンド実行も合わせてお願いいたします。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript c:\windows\system32\slmgr.vbs /skms azkms.core.windows.net:<span class="number">1688</span></span><br></pre></td></tr></table></figure><hr><h3 id="KMS-サーバーへの名前解決および疎通確認コマンドの実行"><a href="#KMS-サーバーへの名前解決および疎通確認コマンドの実行" class="headerlink" title="KMS サーバーへの名前解決および疎通確認コマンドの実行"></a>KMS サーバーへの名前解決および疎通確認コマンドの実行</h3><p>KMS ライセンス認証が失敗している原因として、名前解決ができていないといった事や、疎通が失敗している可能性がございます。<br>この点の原因切り分けのためには以下の PowerShell コマンドを実行します。</p><ul><li>DNS での名前解決の確認</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 古い情報での名前解決を抑止するため DNS キャッシュをクリア</span></span><br><span class="line">ipconfig /flushdns</span><br><span class="line"></span><br><span class="line"><span class="comment"># KMS サーバーの名前解決が可能か確認する</span></span><br><span class="line">nslookup kms.core.windows.net</span><br><span class="line">nslookup azkms.core.windows.net</span><br></pre></td></tr></table></figure><p>成功した場合は、以下のように KMS サーバーの IP アドレスが名前解決されます。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-11-43-58.png"></p><p>名前解決ができていない場合は、DNS サーバーの設定の見直しやポート 53 UDP での DNS の通信ができているかといった点を確認する必要がございます。</p><ul><li>KMS サーバーへのポート 1688 での疎通確認</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Test-NetConnection</span> <span class="literal">-ComputerName</span> kms.core.windows.net <span class="literal">-Port</span> <span class="number">1688</span></span><br><span class="line"><span class="built_in">Test-NetConnection</span> <span class="literal">-ComputerName</span> azkms.core.windows.net <span class="literal">-Port</span> <span class="number">1688</span></span><br></pre></td></tr></table></figure><p>成功した場合は、以下のような <strong>TcpTestSucceeded : True</strong> の結果が表示されます。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-11-43-05.png"></p><p>こちらの通信が成功しない場合は、OS 内部や経由しているファイアウォールでの通信がブロックされている等の原因が考えられますため、後述のトラブルシューティングなどでこの通信を成功させるように修正が必要です。</p><hr><h3 id="イベントログでライセンスログを見る"><a href="#イベントログでライセンスログを見る" class="headerlink" title="イベントログでライセンスログを見る"></a>イベントログでライセンスログを見る</h3><p>ライセンス認証の成功・失敗については Windows OS 内の Event Viewer を用いて、<br> <strong>Event Viewer (Local) &gt; Windows Logs &gt; Application</strong><br>よりアプリケーションイベントログよりご確認いただくことが可能でございます。<br>以下にトラブルシューティングで使われるイベント ID をご紹介させていただきます。</p><ul><li>12288：KMS クライアントから KMS サーバーに認証を要求した際のログ</li></ul><p>イベント ID 12288 は KMS クライアントが KMS サーバーに対してライセンス認証を要求した際のログとなります。<br>後述の「12289：ライセンス認証の結果表示」と対になるログでございますので、「12288：ライセンス認証開始」はあるが「12289：ライセンス認証の結果表示」が無いといった場合は、以下のいずれかの状況を意味します。  </p><ol><li>KMS クライアントが KMS サーバーに接続できなかったこと</li><li>KMS サーバーが応答しなかったこと</li><li>KMS クライアントが KMS サーバーからの応答を受信しなかったこと</li></ol><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-13-40-29.png"></p><ul><li>12289：ライセンス認証の結果表示</li></ul><p>イベント ID 12289 は KMS ライセンス認証の結果を表示します。<br>以下の図の通り Info に表示されている 3 個目のフラグが「1」の場合はライセンス認証成功です。<br>「0」となっとる場合はライセンス認証失敗となります。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-13-40-57.png"></p><p>■ご参考：便利な KMS クライアント イベント<br><a href="https://learn.microsoft.com/ja-jp/windows-server/get-started/activation-troubleshoot-kms-general#useful-kms-client-events">https://learn.microsoft.com/ja-jp/windows-server/get-started/activation-troubleshoot-kms-general#useful-kms-client-events</a></p><ul><li>8198, 8200：ライセンス認証の失敗</li></ul><p>イベント ID 8198, 8200 は KMS ライセンス認証の失敗時に表示されることのあるログとなります。  </p><p>後述の<a href="./#KMS-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E4%B8%80%E6%99%82%E7%9A%84%E3%81%AA%E8%B2%A0%E8%8D%B7">「KMS サーバーの一時的な負荷」</a>のセクションに記載の通り、一時的な KMS サーバーの負荷の問題で表示される可能性がございますが、「12289：ライセンス認証の結果表示」にて正常にライセンス認証がされている場合は無視可能となります。<br>そのため、「8198, 8200：ライセンス認証の失敗」は常に発生しておらず単発的な場合は、無視いただいて問題ございません。</p><hr><h2 id="よくあるトラブルのパターン"><a href="#よくあるトラブルのパターン" class="headerlink" title="よくあるトラブルのパターン"></a>よくあるトラブルのパターン</h2><p>お客様から「ライセンス認証が失敗する」といった場合に、よくあるトラブルのパターンおよびその対処方法についてご案内をさせていただきます。  </p><hr><h3 id="KMS-サーバーの一時的な負荷"><a href="#KMS-サーバーの一時的な負荷" class="headerlink" title="KMS サーバーの一時的な負荷"></a>KMS サーバーの一時的な負荷</h3><p>Azure のKMS サーバーは全世界の Azure 上の Windows OS を認証している関係で、稀に負荷が集中するといったタイミングで応答ができない場合がございます。<br>一般的には、エラーイベントが数日に１回、といった頻度で記録されるに留まりますが、場合によっては丸 1 日継続するようなケースもあります。<br>Azure データセンターでも、随時 KMS の補強作業を行っていますが、常時 100 ％成功を目指しているものではございません。<br>この理由としては、先述の通り Windows のライセンス認証はその後リトライされ、ライセンス失効期間内で毎回失敗し続けなければライセンスが失効することはありません。<br>つまりライセンス認証失敗のエラーイベントが恒常的にではなく、一時的に記録されるだけである場合、無視可能です。  </p><p>他方、一時的ではなく常に毎回ライセンス認証失敗が失敗している場合は別の原因があるものと考えられますため、別途トラブルシューティングが必要でございます。</p><hr><h3 id="ファイアウォール製品で通信をブロックしている"><a href="#ファイアウォール製品で通信をブロックしている" class="headerlink" title="ファイアウォール製品で通信をブロックしている"></a>ファイアウォール製品で通信をブロックしている</h3><p>KMS の通信が Azure Firewall 等のファイアウォール製品を経由している場合、このファイアウォールでライセンス認証の通信がブロックされている可能性がございます。  </p><p><img src="/blog/vm/kms-troubleshooting/2023-08-04-16-25-28.png"></p><p>このような場合は以下のいずれかの方法でご対応をお願いいたします。  </p><ul><li>解決方法 1：UDR を用いてファイアウォールを経由しないルーティングを行う</li></ul><p>UDR を用いて KMS サーバーへのライセンス認証の通信についてファイアウォールを経由しないようなルーティングとする方法となります。<br>設定方法については、<a href="./#%E5%BC%B7%E5%88%B6%E3%83%88%E3%83%B3%E3%83%8D%E3%83%AA%E3%83%B3%E3%82%B0%E7%92%B0%E5%A2%83%EF%BC%88%E3%82%AA%E3%83%B3%E3%83%97%E3%83%AC%E3%83%9F%E3%82%B9%E7%AD%89%E3%82%92%E7%B5%8C%E7%94%B1%E3%81%97%E7%9B%B4%E6%8E%A5%E9%80%9A%E4%BF%A1%E3%81%A8%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%EF%BC%89">「強制トンネリング環境（オンプレミス等を経由し直接通信となっていない）」</a> セクションの解決方法と同じになりますので、そちらをご参照ください。  </p><p><img src="/blog/vm/kms-troubleshooting/2023-08-04-16-27-07.png"></p><ul><li>解決方法 2：ファイアウォール製品でライセンス認証の通信を許可する</li></ul><p>先述の通り、ライセンス認証には以下の通信要件が必要でございますので、お使いのファイアウォール製品で Azure VM からの以下の通信を許可する設定をお願いいたします。  </p><table><thead><tr><th>項目</th><th>通信要件</th></tr></thead><tbody><tr><td>ドメイン</td><td>kms.core.windows.net および azkms.core.windows.net</td></tr><tr><td>IP アドレス</td><td>20.118.99.224, 40.83.235.53, 23.102.135.246</td></tr><tr><td>ポート</td><td>1688</td></tr><tr><td>プロトコル</td><td>TCP</td></tr></tbody></table><p><img src="/blog/vm/kms-troubleshooting/2023-08-04-16-29-13.png"></p><p>上手く改善されない場合は原因切り分けのために「解決方法 1：UDR を用いてファイアウォールを経由しないルーティングを行う」の方を実施していただけますと幸いです。</p><hr><h3 id="強制トンネリング環境（オンプレミス等を経由し直接通信となっていない）"><a href="#強制トンネリング環境（オンプレミス等を経由し直接通信となっていない）" class="headerlink" title="強制トンネリング環境（オンプレミス等を経由し直接通信となっていない）"></a>強制トンネリング環境（オンプレミス等を経由し直接通信となっていない）</h3><p>KMS サーバーは Azure 上の VM からの直接通信のみを受け付ける動作となっております。<br>そのため、Azure VM から送信される通信を強制トンネリングを用いて VPN / ExpressRoute を通過し、オンプレミス環境を経由するような設定を頂いている場合は、ライセンス認証が失敗いたします。  </p><p><img src="/blog/vm/kms-troubleshooting/2023-08-07-09-11-09.png"></p><p>このオンプレミス環境で KMS サーバーに接続できるような設定をしたとしても、実際のライセンス認証実行にて認証ができない状況となりますので留意ください。</p><p>■ご参考：強制トンネリングを使用したライセンス認証の問題<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/custom-routes-enable-kms-activation">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/custom-routes-enable-kms-activation</a></p><ul><li>解決方法：UDR を用いてファイアウォールを経由しないルーティングを行う</li></ul><p>Azure 上の VNET に属する Subnet 単位で UDR（User Defined Route）を用いて、特定 IP アドレスへの通信のルーティングを変更することが可能です。<br>すなわち、KMS サーバー（20.118.99.224, 40.83.235.53, 23.102.135.246）への通信のみ、直接通信とするために Next Hop を Internet にします。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-07-09-13-02.png"></p><p>ポータルからこの設定を行う、具体的な手順をご紹介させていただきます。  </p><p>まずは対象の Azure VM の画面にて右側のメニューより「ネットワーク」を選択肢し、対象の仮想ネットワーク / サブネットのリンクを選択します。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-15-26-12.png"></p><p>対象の Subnet に設定されているルート テーブル名を選択します。</p><p><img src="/blog/vm/kms-troubleshooting/2023-08-02-16-26-20.png"></p><p>左側のメニューより「ルート」を選択し「追加」より、KMS サーバーへの通信のみ、直接通信とするために Next Hop を Internet とするルートを 3 つそれぞれ作成します。<br>アドレス プレフィックスには、それぞれ以下の値をご入力ください。  </p><table><thead><tr><th>アドレス プレフィックス</th></tr></thead><tbody><tr><td>20.118.99.224/32</td></tr><tr><td>40.83.235.53/32</td></tr><tr><td>23.102.135.246/32</td></tr></tbody></table><p><img src="/blog/vm/kms-troubleshooting/2023-08-03-11-26-51.png"></p><p>これで、KMS ライセンス認証の通信を直接 KMS サーバーと通信するルーティングテーブルの設定ができました。</p><hr><h3 id="Standard-SKU-の-Azure-Load-Balancer-配下の-VM-で外部接続ができない"><a href="#Standard-SKU-の-Azure-Load-Balancer-配下の-VM-で外部接続ができない" class="headerlink" title="Standard SKU の Azure Load Balancer 配下の VM で外部接続ができない"></a>Standard SKU の Azure Load Balancer 配下の VM で外部接続ができない</h3><p>Standard SKU の Azure Load Balancer 配下の VM の場合、外部接続ができない状態となっていることに伴い KMS ライセンス認証の通信ができない場合がございます。<br>また、可用性セットの VM の場合、同一可用性セット内の別の VM が Standard SKU の Azure Load Balancer 配下にあると、同じく外部通信ができない状況が発生します。  </p><p>このような Standard SKU の Azure Load Balancer 配下の VM の場合は、KMS サーバーへの通信ができるように明示的に外部接続のポリシーを構成する必要がございます。<br>こちらのシナリオについては別途解説を行っているブログ記事がございますので、こちらをご参照くださいませ。</p><p>■ご参考：Azure VM の外部接続 (SNAT) オプション まとめ<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/">https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/</a></p><hr><h3 id="Tokens-dat-ファイルの破損"><a href="#Tokens-dat-ファイルの破損" class="headerlink" title="Tokens.dat ファイルの破損"></a>Tokens.dat ファイルの破損</h3><p>ライセンス認証を行ったところ以下のように「エラー コード: 0xC004E015 / 0xC004D301 / 0xC004E002」といったエラーが表示される場合がございます。  </p><p><img src="/blog/vm/kms-troubleshooting/2023-08-07-09-13-40.png" alt="現在 Windows のライセンス認証を行えません。後でもう一度実行してください。問題が解決しない場合は、システム管理者にお問い合わせください。 エラー コード: 0xC004E015"></p><p>この場合は Tokens.dat ファイルの破損が発生している可能性がございます。<br>以下の公開情報の手順で、Tokens.dat ファイルの再構築を行った後に、手動のライセンス認証が成功するかお試しいただけますと幸いです。</p><p>■ご参考：Tokens.dat ファイルの再構築<br><a href="https://learn.microsoft.com/ja-jp/windows-server/get-started/activation-rebuild-tokens-dat-file">https://learn.microsoft.com/ja-jp/windows-server/get-started/activation-rebuild-tokens-dat-file</a></p><hr><h2 id="さいごに（その他の要因等について）"><a href="#さいごに（その他の要因等について）" class="headerlink" title="さいごに（その他の要因等について）"></a>さいごに（その他の要因等について）</h2><p>以上がトラブルシューティングおよび、よくあるトラブルのパターンとなりますが、稀に上記以外の要因でもライセンス認証の失敗の可能性もございます。  </p><p>【例】</p><ul><li>OS 内部のファイアウォールでの KMS ライセンス認証通信のブロック</li><li>ライセンスキーが正常に登録されていない</li></ul><p>これらのシナリオに該当しない可能性もございますので、上記のトラブルシューティングで改善しない場合は、実施したトラブルシューティングの内容や対象の VM の情報などを添えて弊社の技術サポート窓口にお問い合わせをいただけますと幸いでございます。<br>上述の内容が皆様のお役に立つことを願っております。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;Azure 上で稼働する Windows VM のライセンス認証のためにマイクロソフトが KMS サーバー（KMS ホスト サーバー）を提供しております。&lt;br&gt;KMS サーバーへのライセンス認証要求は</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="KMS" scheme="https://jpaztech.github.io/blog/tags/KMS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Files はユーザー毎のマウントが必要です</title>
    <link href="https://jpaztech.github.io/blog/vm/azure-files-user-mount/"/>
    <id>https://jpaztech.github.io/blog/vm/azure-files-user-mount/</id>
    <published>2023-08-16T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.343Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回はタイトルの通り、Azure Files はユーザー毎のマウントが必要となっております点についてご案内させていただきます。  </p><p>お客様より「Windows 環境でユーザー A でマウントした Azure Files についてユーザー B より参照ができない。」というお問い合わせをいただくことがございます。<br>こちらは仕様となっており、マウントを行ったユーザー以外のユーザーからは Azure Files のマウント先を参照できないものとなっております。<br>そのためユーザー毎にマウントを行っていただく必要がございます点、ご留意くださいませ。</p><p>なお、IIS といったミドルウェアで Azure Files を参照させる場合は、System アカウントで Azure Files のマウントが必要な場合がございます。<br>しかしながら、System アカウントでの Azure Files のマウントは永続化が叶いませんため、起動の度にマウントが必要となります点ご留意くださいませ。  </p><p>簡単ではございますが、Azure Files のマウントについて解説をさせていただきました。<br>Azure Files 自体についての詳細は公式ドキュメントをご参照くださいませ。  </p><p>■ご参考：Azure Files とは<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction">https://learn.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回はタイトルの通り、Azure Files はユーザー毎のマウントが必要となっております点についてご案内させていただきます。  &lt;/p&gt;
&lt;p&gt;お客様より「Windows 環境でユーザー A でマウン</summary>
      
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Azure Files" scheme="https://jpaztech.github.io/blog/tags/Azure-Files/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の作成/起動/停止ユーザーを確認する方法</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-create-activity-log/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-create-activity-log/</id>
    <published>2023-07-31T09:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.639Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの前田です。</p><p>今回は、よくお問い合わせをいただいております、Azure VM の作成者が不明な場合の確認方法についてご紹介いたします。<br>本ブログでは Azure VM を例に紹介いたしますが、ストレージ アカウントなど他のリソースでも応用が可能な内容となりますので、皆様のご参考となりましたら幸いでございます。</p><hr><h2 id="使用する機能について"><a href="#使用する機能について" class="headerlink" title="使用する機能について"></a>使用する機能について</h2><p>Azure VM の作成者の特定には、アクティビティ ログを利用いたします。<br>アクティビティ ログとは、Azure のプラットフォーム ログであり、様々な操作、イベントに関する情報を記録しております。<br>本件でご紹介いたします Azure VM 等リソースの作成の他、VM の起動、停止などの履歴も記録されますので、一度は目にしたことのある方も多い機能かと存じます。<br>今回は数あるイベントの中から、VM の作成時に記録される内容についてご紹介いたします。</p><p>参考) Azure Monitor アクティビティ ログ<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell</a></p><hr><h2 id="アクティビティ-ログの確認方法"><a href="#アクティビティ-ログの確認方法" class="headerlink" title="アクティビティ ログの確認方法"></a>アクティビティ ログの確認方法</h2><p>では早速、VM 作成時のアクティビティ ログを確認してまいります。<br>今回は特定の Azure VM のアクティビティ ログより確認を行いますが、アクティビティ ログはリソース グループおよびサブスクリプション単位での確認も可能でございますので、状況に合わせスコープを選定いただければと存じます。</p><p>また、アクティビティ ログは絞り込んだ期間内のログに関し、CSV 形式にてダウンロードすることも可能でございますので、ご都合の良い手法にてご確認をお願いいたします。</p><p>[Virtual Machine] より [アクティビティ ログ] を選択します。<br><img src="/blog/vm/vm-create-activity-log/activitylog001.png"></p><p>検索期間がデフォルトでは直近 6 時間となっているため、VM を作成したおおよその日時で [カスタム] より絞り込みを行います。<br>絞り込みが難しい場合、ログの保存期間である 90 日間となるよう日時を指定します。<br><img src="/blog/vm/vm-create-activity-log/activitylog002.png"></p><p>最も古い [Create or Update Virtual Machine] の項目をクリックします。<br><img src="/blog/vm/vm-create-activity-log/activitylog003.png"></p><p>表示された項目のうち、[イベント開始者] のユーザーが VM の作成者となります。<br><img src="/blog/vm/vm-create-activity-log/activitylog004.png"></p><p>なお、上記確認方法について注意点が 2 点ございます。</p><ol><li><p>アクティビティ ログの保存期間について<br>このアクティビティ ログは単独での保存期間が 90 日となりますため、これを超過しており、かつ別の場所へのログの退避を実施していない場合、ご利用いただくことが叶いませんので、予めご了承いただければと存じます。</p></li><li><p>[Create or Update Virtual Machine] の該当項目について<br>上記の項目につきましては、VM の作成の他、VM のサイズ変更等の際にも表示されるログとなります。<br>このため、上記名称のより古いログがございます場合は、再度ご確認をいただく必要がございます。</p></li></ol><hr><h2 id="その他、よく利用されるアクティビティ-ログ"><a href="#その他、よく利用されるアクティビティ-ログ" class="headerlink" title="その他、よく利用されるアクティビティ ログ"></a>その他、よく利用されるアクティビティ ログ</h2><p>VM の作成者のほか、VM の起動、割り当て解除を実施したユーザーの確認方法につきましても多くお問い合わせをいただきますことから、併せてアクティビティ ログの出力内容についてご紹介いたします。</p><h3 id="■-VM-の起動ユーザー"><a href="#■-VM-の起動ユーザー" class="headerlink" title="■ VM の起動ユーザー"></a>■ VM の起動ユーザー</h3><p>アクティビティ ログの出力のうち、Start Virtual Machine が該当します。<br>イベント開始者が VM を起動したユーザーです。<br><img src="/blog/vm/vm-create-activity-log/activitylog005.png"></p><h3 id="■-VM-の割り当て解除の実施ユーザー"><a href="#■-VM-の割り当て解除の実施ユーザー" class="headerlink" title="■ VM の割り当て解除の実施ユーザー"></a>■ VM の割り当て解除の実施ユーザー</h3><p>アクティビティ ログの出力のうち、Deallocate Virtual Machine が該当します。<br>イベント開始者が VM の割り当て解除を実施したユーザーです。<br> <img src="/blog/vm/vm-create-activity-log/activitylog006.png"></p><hr><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>いかがでしたでしょうか。<br>以上が Azure VM の作成者をアクティビティ ログから特定する方法でございました。<br>この他にも Azure VM のアクティビティ ログには様々な内容が記録されますので、添付いたしました弊社ドキュメントを含めぜひご活用いただければと存じます。<br>本記事が皆様のお役に立つ内容となっておりましたら幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの前田です。&lt;/p&gt;
&lt;p&gt;今回は、よくお問い合わせをいただいております、Azure VM の作成者が不明な場合の確認方法についてご紹介いたします。&lt;br&gt;本ブログでは Azure VM を例に紹介いたしますが、ストレージ</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>ゲスト OS 内からネットワーク接続のプロパティを変更しないでください</title>
    <link href="https://jpaztech.github.io/blog/vm/avoiding-changes-to-DNS-and-IP-in-GuestOS/"/>
    <id>https://jpaztech.github.io/blog/vm/avoiding-changes-to-DNS-and-IP-in-GuestOS/</id>
    <published>2023-07-31T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.343Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの新見です。</p><p>Azure VM のゲスト OS 内から DNS サーバーの設定や ゲスト OS 自体の IP アドレスなどのようなネットワーク接続のプロパティを変更した際に、Azure VM への接続に失敗してしまったというお問い合わせをいただくことがあります。<br>本記事では、Azure VM のゲスト OS 内からネットワーク接続のプロパティを変更することは非推奨であることと、変更してしまった場合の対処法と、推奨している手順についてご紹介いたします。   </p><p>以下公開資料にもございますように、 Azure VM ではゲスト OS 内部で DNS サーバーの設定や ゲスト OS 自体の IP アドレスなどのネットワーク接続のプロパティの設定は原則変更しないようお願いしています。   </p><blockquote><p>ご参考) <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#specify-dns-servers">DNS サーバーの指定 </a><br>ーーーーーーーーー抜粋ーーーーーーーーー<br>DNS サーバーの IP などのネットワーク接続プロパティは、VM 内で直接編集しないでください。<br>これは、仮想ネットワーク アダプターを交換したときのサービス回復時にネットワーク接続プロパティが消去される可能性があるためです。<br>これは、Windows VM と Linux VM の両方に適用されます。<br>ーーーーーーーーーーーーーーーーーーーー</p></blockquote><blockquote><p>ご参考) <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-network-network-interface-addresses#private">Azure ネットワーク インターフェイスの IP アドレスの追加、変更、削除</a><br>ーーーーーーーーー抜粋ーーーーーーーーー<br>必要がない限り、仮想マシンのオペレーティング システム内のネットワーク インターフェイスの IP アドレスを手動で設定しないでください。<br>ーーーーーーーーーーーーーーーーーーーー </p></blockquote><p>Azure VM には、必ず 1 個以上のネットワーク インターフェイス(NIC) が接続されている必要があります。<br>Azure VM のゲスト OS 側の NIC に設定される IP アドレスは、デフォルトで DHCP サーバーから Azure 側の NIC で指定した IP アドレスが割り振られるように設定されています。<br>もし、Azure VM のゲスト OS 内でネットワーク接続のプロパティを変更した場合、Azure 側で保持している NIC のプロパティと整合性が取れなくなり、一切の通信が出来なくなることがあります。   </p><h1 id="ゲスト-OS-から直接設定を変更したことで接続不可となってしまった場合の対処策"><a href="#ゲスト-OS-から直接設定を変更したことで接続不可となってしまった場合の対処策" class="headerlink" title="ゲスト OS から直接設定を変更したことで接続不可となってしまった場合の対処策"></a>ゲスト OS から直接設定を変更したことで接続不可となってしまった場合の対処策</h1><p> <br>Azure VM のゲスト OS 内で ネットワーク設定の変更をしたことにより接続に失敗した際の対処法としては、まず、再起動をすることで解決する場合があります。 </p><p>再起動後も復旧しない場合は、一般的に NIC をリセットすることで復旧可能です。<br>NIC リセットの手順は、以下の公開情報をご参照ください。<br> <br>ご参考) <a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/reset-network-interface">Azure Windows VM のネットワーク インターフェイスをリセットする方法</a>  </p><h1 id="推奨している-DNS-サーバーの変更手順"><a href="#推奨している-DNS-サーバーの変更手順" class="headerlink" title="推奨している DNS サーバーの変更手順"></a>推奨している DNS サーバーの変更手順</h1><p> <br>DNS サーバーの設定は Azure 上で変更することで、自動的にAzure VM のゲスト OS 内の情報も変更されます。<br>そのため、DNS サーバーの設定を変更する場合は、Azure 上で DNS サーバーを変更するようお願いいたします。<br>DNS サーバーの設定変更の手順は、以下の公開情報をご参照ください。 </p><p>ご参考) <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-network-interface?tabs=network-interface-portal#change-dns-servers">ネットワーク インターフェイスの作成、変更、削除 | DNS サーバーの変更</a>  </p><h1 id="推奨しているプライベート-IP-アドレスの変更手順"><a href="#推奨しているプライベート-IP-アドレスの変更手順" class="headerlink" title="推奨しているプライベート IP アドレスの変更手順"></a>推奨しているプライベート IP アドレスの変更手順</h1><p>プライベート IP アドレスも Azure 上で変更することで ゲスト OS 内の情報も変更されるため、Azure 上で変更するようお願いいたします。<br>プライベート IP アドレスは、静的割り当てに変更することで、サブネットの範囲内での任意の IP アドレスを割り当てられます。<br>同じネットワークに割り当てたいプライベート IP アドレスが存在する場合は指定できないので、割り当てられている VM のプライベート IP アドレスを予め別のものに変更するなどして対応いただくようお願いいたします。<br>プライベート IP の設定変更の手順は、以下の公開資料をご参照ください。 </p><p>ご参考) <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/ip-services/virtual-networks-static-private-ip-arm-pportal#change-private-ip-address-to-static">静的プライベート IP アドレスを持つ VM を作成する</a></p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p> <br>この記事では、Azure VM のゲスト OS からネットワーク接続のプロパティを変更することが非推奨であることと、変更してしまった場合の対処法についてお伝えしました。<br>接続失敗の発生を防ぐためにネットワーク接続のプロパティを変更したい場合は、原則 Azure 上から変更するようお願いします。<br>本稿が少しでも皆様の一助となれば幸いです。 </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの新見です。&lt;/p&gt;
&lt;p&gt;Azure VM のゲスト OS 内から DNS サーバーの設定や ゲスト OS 自体の IP アドレスなどのようなネットワーク接続のプロパティを変更した際に、Azure VM への接続に失敗し</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>強制トンネリング利用時の VPN ゲートウェイの動作変更についてのアナウンス</title>
    <link href="https://jpaztech.github.io/blog/network/vpn-defaultsite-update-2022feb/"/>
    <id>https://jpaztech.github.io/blog/network/vpn-defaultsite-update-2022feb/</id>
    <published>2023-05-26T04:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.271Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure の仮想ネットワーク ゲートウェイ (以下「ゲートウェイ」) を用いたサイト間 VPN 接続について、2022 年 2 月 24 日以降に、強制トンネリングに関する一部の動作の変更が行われることがアナウンスされました。</p><p>影響が生じる可能性のあるお客様には通知がすでに送信されているか、近日中に送信されることが想定されます。しかしながら、通知に含まれる説明は要点のみとなっているため、本記事にてその補足をさせていただきます。</p><p><strong>※追記</strong><br>2023 年 5 月 再度、強制トンネリング利用時の仮想ネットワーク ゲートウェイの動作変更のアナウンス (Tracking ID:VK3J-580)が通知されました。<br>これは、2022 年に通知されたアナウンス (Tracking ID:ZTPX-19Z)と同様の内容となりますが、動作変更の延期により今回あらためて仮想ネットワーク ゲートウェイ は、2023/6/12 ~ 6/16 の間に動作変更が実施されるという旨のアナウンスとなります。<br>2022 年に通知を受け取ったお客様の中で、下記の対応を行っていない環境については、動作変更の影響を受ける条件や合致確認の方法、動作変更の内容および変更の影響を受けないようにする対処方法をご確認の上、2023/6/12 より前にご対応いただけますと幸いでございます。</p><span id="more"></span><p><br><br></p><h2 id="本記事の内容"><a href="#本記事の内容" class="headerlink" title="本記事の内容"></a>本記事の内容</h2><p>本記事では、動作変更の影響を受ける条件やその合致確認の方法、動作変更の内容および変更の影響を受けないようにする対処方法ついてまとめております。本記事を参考に影響有無を確認するとともに、影響が想定される場合は 2 月 24 日までにあらかじめ対処を実施いただければと思います。</p><p>前半ではリソース マネージャー モデル（新しいモデル）のための手順、後半ではクラシック モデル（古いモデル）のための手順をおまとめしておりますので、それぞれご利用の環境に合わせて確認ください。</p><p><br><br></p><h2 id="今回の動作変更の背景"><a href="#今回の動作変更の背景" class="headerlink" title="今回の動作変更の背景"></a>今回の動作変更の背景</h2><p>Azure のゲートウェイには、「SKU」と呼ばれるパラメーターがあり、ゲートウェイの性能や冗長構成を指定することができます。ゲートウェイの SKU には、大きくわけて以下の 2 種類があります。</p><ul><li>末尾に AZ がつく SKU: VpnGw1AZ、VpnGw2AZ、VpnGw3AZ、VpnGw4AZ、VpnGw5AZ<br></li><li>末尾に AZ がつかない SKU: VpnGw1、VpnGw2、VpnGw3、VpnGw4、VpnGw5、Basic、Standard、HighPerformance</li></ul><p>AZ がつく SKU とつかない SKU では、冗長性確保のためのデータセンター内部の配置が少し違うのみで、そのほかに機能面での基本的な違いはありません。</p><p>しかし今回、特定の条件下において、AZ がつく SKU と AZ がつかない SKU で強制トンネリングに関する一部の動作 (詳細は後述) に差異があることが判明しました。AZ がつかない SKU を対象に動作変更を行い、AZ がつく SKU の動作を正として動作を揃えるというのが、今回のアナウンスの内容です。</p><p><br><br></p><h2 id="動作変更の内容"><a href="#動作変更の内容" class="headerlink" title="動作変更の内容"></a>動作変更の内容</h2><h3 id="強制トンネリングを実現する-2-種類の方法"><a href="#強制トンネリングを実現する-2-種類の方法" class="headerlink" title="強制トンネリングを実現する 2 種類の方法"></a>強制トンネリングを実現する 2 種類の方法</h3><p>Azure のサイト間 VPN においては、Azure 仮想ネットワークから送信されるすべての通信を、データセンターのバックボーンネットワークではなく、VPN にルーティングする「強制トンネリング」という構成が可能です。サイト間 VPN で強制トンネリングを構成するためには、以下の 2 種類の方法があります。</p><ul><li>方法 1. 対向のルーターと BGP で経路交換を行い、対向のルーターからデフォルト ルート 0.0.0.0/0 (を広報する)</li><li>方法 2. BGP は利用せず、ゲートウェイに DefaultSite の設定を行う</li></ul><h3 id="動作が変更される対象となる方法"><a href="#動作が変更される対象となる方法" class="headerlink" title="動作が変更される対象となる方法"></a>動作が変更される対象となる方法</h3><p>このうち、方法 2 を利用している場合は、SKU によって強制トンネリングのために必要な作業が少し異なります。SKU に AZ がつく場合は、DefaultSite の設定を行うだけで、仮想ネットワーク内の全てのサブネットに対して、デフォルト ルートを VPN に向けるルートが反映されます。</p><p>しかし AZ がつかない場合は、DefaultSite の設定を行うだけでは強制トンネリングのためのルートが適用されません。DefaultSite の設定に加えて、0.0.0.0/0 のネクストホップをゲートウェイにしたユーザー定義ルート (UDR) を各サブネットに適用することで、はじめて強制トンネリングがそのサブネットで有効になります。</p><p>今回の動作変更では、この動作を AZ がつく SKU に合わせます。つまり、DefaultSite の設定がされている環境では、0.0.0.0/0 をゲートウェイに向ける UDR が適用されていなくても、強制トンネリングが有効になります。対象の環境においては、強制トンネリングが現状有効になっていないサブネットで、2 月 24 日以降に突然強制トンネリングが有効になる、ということが起こり得ます。</p><p>※ 方法 1 (BGP) を利用している場合は、今回の動作変更による影響はありません。</p><p><br><br></p><h2 id="動作変更による影響が生じる条件"><a href="#動作変更による影響が生じる条件" class="headerlink" title="動作変更による影響が生じる条件"></a>動作変更による影響が生じる条件</h2><p>以下の 5 つの条件に <strong>すべて</strong> 合致した場合に、今回の動作変更の影響を受けます。</p><ul><li>A. VPN 用の仮想ネットワーク ゲートウェイがある</li><li>B. ゲートウェイの SKU は末尾に AZ がつかないものである</li><li>C. サイト間 VPN を利用している</li><li>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していない</li><li>E. DefaultSiteの設定がされている</li></ul><p>それぞれの条件についての合致確認の方法は、本記事の末尾にまとめております。</p><p><br><br></p><h2 id="条件にすべて合致した場合の対応"><a href="#条件にすべて合致した場合の対応" class="headerlink" title="条件にすべて合致した場合の対応"></a>条件にすべて合致した場合の対応</h2><p>上記の 5 つの条件に <strong>すべて</strong> 合致した場合、動作変更の影響が生じる可能性があります。つまり、0.0.0.0/0 をゲートウェイに向けるユーザー定義ルートが適用されていなくても、2 月 24 日以降の動作変更によって、強制トンネリングがそのサブネットで有効になります。</p><p>予期せず強制トンネリングが有効になることを防ぐためには、あらかじめ 0.0.0.0/0 のネクストホップをインターネットに向ける UDR を適用することが有効です。2 月 24 日よりも前にこの UDR を適用しておくことで、その UDR が適用されたサブネットでは、動作変更によって強制トンネリングが突然有効になる状況を回避することができます。</p><p>（したがって、現状ですでに 0.0.0.0/0 のネクストホップをインターネットに設定する UDR が適用されているサブネットについては、影響を受けません）</p><h3 id="対応手順の例"><a href="#対応手順の例" class="headerlink" title="対応手順の例"></a>対応手順の例</h3><p>具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><ol><li><p><b>Azure ポータルを開きます。<br></b><br><a href="https://portal.azure.com/">https://portal.azure.com/</a></p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている場合は、手順 5) までスキップします。</b></p></li><li><p><b>[ルート テーブル] を開き、[+作成] をクリックします。</b></p></li><li><p><b>以下のパラメーターを入力し、[確認および作成] をクリックします。(詳細なパラメーターは環境に合わせてください)</b><br><br>　リソース グループ: 任意<br><br>　リージョン: ルート テーブルの適用対象の仮想ネットワークと合わせる<br><br>　名前: ルート テーブルの任意の名前<br><br>　ゲートウェイのルートを伝達する: Yes</p></li><li><p><b>4) で作成したルート テーブルか、既存のルート テーブルを開きます。</b></p></li><li><p><b>[ルート] メニューをクリックし、[+追加] をクリックします。</b></p></li><li><p><b>以下のパラメーターでルートを追加して [OK] をクリックします。</b><br><br>　ルート名: 任意の名前<br><br>　アドレス プレフィックス: 0.0.0.0/0<br><br>　ネクスト ホップの種類: インターネット<br></p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている状態で作業を行った場合は、これで終了です。</b></p></li><li><p><b>[サブネット] メニューをクリックし、[+関連付け] をクリックします。</b></p></li><li><p><b>ルート テーブルの適用対象の仮想ネットワークとサブネットを選択して、[OK] をクリックします。</b></p></li></ol><p>※ ルート テーブルの設定手順は <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table">公開資料</a> でも説明されておりますので、あわせてご覧ください。</p><p><br>　<br>　<br></p><h2 id="条件に合致しているかどうかを確認するための詳細手順"><a href="#条件に合致しているかどうかを確認するための詳細手順" class="headerlink" title="条件に合致しているかどうかを確認するための詳細手順"></a>条件に合致しているかどうかを確認するための詳細手順</h2><p>A～E それぞれの条件について、合致しているかどうかを確認するための手順の一例をご紹介いたします。</p><h3 id="A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認"><a href="#A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認" class="headerlink" title="A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認"></a>A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認</h3><p>Azure ポータルで [仮想ネットワーク ゲートウェイ] メニューを開き、[ゲートウェイの種類] が [Vpn] のものがあれば、この条件に合致しています。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-a01.png" alt="画面イメージ"></p><h3 id="B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認"><a href="#B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認" class="headerlink" title="B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認"></a>B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認</h3><p>A. でみつけたゲートウェイをクリックし、[SKU] 欄を確認して「AZ」が含まれていないものであれば、この条件に合致しています。（以下の画像は「AZ」が含まれる場合の例、つまり条件に合致しない例です）</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-b01.png" alt="画面イメージ"></p><h3 id="C-サイト間-VPN-を利用していることの確認"><a href="#C-サイト間-VPN-を利用していることの確認" class="headerlink" title="C. サイト間 VPN を利用していることの確認"></a>C. サイト間 VPN を利用していることの確認</h3><p>A. でみつけたゲートウェイをクリックし、[接続] メニューをクリックします。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-c01.png" alt="画面イメージ"></p><p>[接続] オブジェクトが表示されれば、この条件に合致しています。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-c02.png" alt="画面イメージ"></p><h3 id="D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認"><a href="#D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認" class="headerlink" title="D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認"></a>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認</h3><p>A. でみつけたゲートウェイをクリックし、[BGP ピア] メニューをクリックします。</p><p>[学習したルート] に 0.0.0.0/0 が含まれて <strong>いなければ</strong>、この条件に合致しています。（0.0.0.0/0 が含まれていたら、この条件に合致しませんので今回の変更の影響も受けません。少し紛らわしいのでご注意ください）</p><h3 id="E-DefaultSiteの設定がされていることの確認"><a href="#E-DefaultSiteの設定がされていることの確認" class="headerlink" title="E. DefaultSiteの設定がされていることの確認"></a>E. DefaultSiteの設定がされていることの確認</h3><p>この確認は PowerShell での作業が必要になります。</p><ol><li><p><b>Azure PowerShell を起動するか、<a href="https://shell.azure.com/">Cloud Shell</a> (PowerShell を選択) を開きます。</b></p></li><li><p><b>Azure PowerShell の場合、以下のコマンドを実行してサインインします。</b><br><br>Login-AzAccount</p></li><li><p><b>A. でみつけたゲートウェイが構築されているサブスクリプション ID を確認し、以下のコマンドを実行して操作対象のサブスクリプションを指定します。</b><br><br>Select-AzSubscription -SubscriptionId &lt;確認したサブスクリプション ID&gt;</p></li><li><p><b>以下のコマンドを実行し、対象のゲートウェイの構成情報を取得・表示します。</b><br><br>Get-AzVirtualNetworkGateway -Name &lt;ゲートウェイの名前&gt; -ResourceGroupName &lt;ゲートウェイのリソース グループ名&gt;</p></li><li><p><b>出力結果の中から、GatewayDefaultSite という行を探します。サイト名の情報が入っている場合は、この条件に合致します。「null」となっている場合は合致しません。</b></p></li></ol><br><hr><p><br>　<br>　<br>　<br><br><b>※ 以下は、クラシック デプロイ モデルをご利用の方に向けた手順です。</b><br><br></p><hr><h2 id="クラシックの場合-条件にすべて合致した場合の対応"><a href="#クラシックの場合-条件にすべて合致した場合の対応" class="headerlink" title="(クラシックの場合) 条件にすべて合致した場合の対応"></a>(クラシックの場合) 条件にすべて合致した場合の対応</h2><p>クラシック デプロイ モデルをご利用の場合における具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><h3 id="事前準備-Azure-PowerShell-の利用"><a href="#事前準備-Azure-PowerShell-の利用" class="headerlink" title="事前準備: Azure PowerShell の利用"></a>事前準備: Azure PowerShell の利用</h3><p>クラシック デプロイ モデルにおける対処のためには、Azure PowerShell をご利用いただくことができます。対処用のコマンドを実行するためには、事前に以下のコマンドを実行する必要があります。</p><ol><li><p><b>以下のコマンドを実行し、サインインします。</b><br><br>Add-AzureAccount</p></li><li><p><b>以下のコマンドを実行し、対象のサブスクリプションを指定します。</b><br><br>Select-AzureSubscription -SubscriptionId &lt;サブスクリプション ID&gt;</p></li></ol><h3 id="対応手順の例-1"><a href="#対応手順の例-1" class="headerlink" title="対応手順の例"></a>対応手順の例</h3><p>具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><ol><li><p><b>対象のサブネットにすでにルート テーブルが適用されているかどうかを確認します。</b><br><br>Get-AzureSubnetRouteTable -VirtualNetworkName “仮想ネットワーク名” -SubnetName “サブネット名”</p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている場合は、手順 4) までスキップします。</b></p></li><li><p><b>任意の名前でルート テーブルを作成します。</b><br><br>New-AzureRouteTable -Name “ルート テーブルの名前” -Location “リージョン名”</p></li><li><p><b>ルート テーブルに、0.0.0.0/0 のネクストホップを Internet に指定したルートを追加します。</b><br><br>Get-AzureRouteTable -Name “ルート テーブルの名前” | Set-AzureRoute -RouteName “DefaultRoute” -AddressPrefix “0.0.0.0/0” -NextHopType Internet</p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている状態で作業を行った場合は、これで終了です。</b></p></li><li><p><b>ルート テーブルをサブネットに適用します。</b><br><br>Set-AzureSubnetRouteTable -VirtualNetworkName “仮想ネットワーク名” -SubnetName “サブネット名” -RouteTableName “ルート テーブルの名前”</p></li></ol><br><hr><br><h2 id="クラシックの場合-条件に合致しているかどうかを確認するための詳細手順"><a href="#クラシックの場合-条件に合致しているかどうかを確認するための詳細手順" class="headerlink" title="(クラシックの場合) 条件に合致しているかどうかを確認するための詳細手順"></a>(クラシックの場合) 条件に合致しているかどうかを確認するための詳細手順</h2><p>クラシック デプロイ モデルをご利用の場合において、A～E それぞれの条件について、合致しているかどうかを確認するための手順の一例をご紹介いたします。</p><h3 id="事前準備-Azure-PowerShell-の利用-1"><a href="#事前準備-Azure-PowerShell-の利用-1" class="headerlink" title="事前準備: Azure PowerShell の利用"></a>事前準備: Azure PowerShell の利用</h3><p>クラシック デプロイ モデルにおける合致確認には、Azure PowerShell をご利用いただくことができます。合致確認用のコマンドを実行するためには、事前に以下のコマンドを実行する必要があります。</p><ol><li><p><b>以下のコマンドを実行し、サインインします。</b><br><br>Add-AzureAccount</p></li><li><p><b>以下のコマンドを実行し、対象のサブスクリプションを指定します。</b><br><br>Select-AzureSubscription -SubscriptionId &lt;確認したサブスクリプション ID&gt;</p></li></ol><h3 id="A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認-1"><a href="#A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認-1" class="headerlink" title="A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認"></a>A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認</h3><p>(確認不要) 下記 E. の手順に包含されるため、本手順は割愛します。</p><h3 id="B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認-1"><a href="#B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認-1" class="headerlink" title="B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認"></a>B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認</h3><p>(確認不要) クラシックでは、必ず AZ がつかない SKU となりますので、本手順は割愛します。</p><h3 id="C-サイト間-VPN-を利用していることの確認-1"><a href="#C-サイト間-VPN-を利用していることの確認-1" class="headerlink" title="C. サイト間 VPN を利用していることの確認"></a>C. サイト間 VPN を利用していることの確認</h3><p>(確認不要) 下記 E. の手順に包含されるため、本手順は割愛します。</p><h3 id="D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認-1"><a href="#D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認-1" class="headerlink" title="D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認"></a>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認</h3><p>(確認不要) クラシックでは BGP は利用できないため、本手順は割愛します。</p><h3 id="E-DefaultSiteの設定がされていることの確認-1"><a href="#E-DefaultSiteの設定がされていることの確認-1" class="headerlink" title="E. DefaultSiteの設定がされていることの確認"></a>E. DefaultSiteの設定がされていることの確認</h3><ol><li><p><b>Azure PowerShell で以下のコマンドを実行します。</b><br><br>Get-AzureVirtualNetworkGateway</p></li><li><p><b>表示されたゲートウェイの一覧から、以下のように DefaultSite に値が入っているものがあれば、合致しています。</b><br></p><blockquote><p>GatewayId            : xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<br><br>GatewayName          : Default<br><br>LastEventData        :<br><br>GatewayType          : DynamicRouting<br><br>LastEventTimeStamp   : xx/xx/xxxx xx:xx:xx<br><br>LastEventMessage     : Successfully updated the gateway for the following virtual network: xxxx <b>← 通常、ここに対象の仮想ネットワーク名が入ります。</b><br><br>LastEventID          : xxxxx<br><br>State                : Provisioned<br><br>VIPAddress           : x.x.x.x<br><br>DefaultSite          : Site01 <b>← ここにサイト名が入っていれば該当しています。該当しない場合空欄です。</b><br><br>GatewaySKU           : Standard<br><br>Location             : Japan East<br><br>VnetId               : xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<br><br>SubnetId             :<br><br>EnableBgp            : False<br><br>Asn                  : xxxxx<br><br>BgpPeeringAddress    : x.x.x.x<br><br>PeerWeight           : 0<br><br>OperationDescription :<br><br>OperationId          :<br><br>OperationStatus      :<br></p></blockquote></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure の仮想ネットワーク ゲートウェイ (以下「ゲートウェイ」) を用いたサイト間 VPN 接続について、2022 年 2 月 24 日以降に、強制トンネリングに関する一部の動作の変更が行われることがアナウンスされました。&lt;/p&gt;
&lt;p&gt;影響が生じる可能性のあるお客様には通知がすでに送信されているか、近日中に送信されることが想定されます。しかしながら、通知に含まれる説明は要点のみとなっているため、本記事にてその補足をさせていただきます。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;※追記&lt;/strong&gt;&lt;br&gt;2023 年 5 月 再度、強制トンネリング利用時の仮想ネットワーク ゲートウェイの動作変更のアナウンス (Tracking ID:VK3J-580)が通知されました。&lt;br&gt;これは、2022 年に通知されたアナウンス (Tracking ID:ZTPX-19Z)と同様の内容となりますが、動作変更の延期により今回あらためて仮想ネットワーク ゲートウェイ は、2023/6/12 ~ 6/16 の間に動作変更が実施されるという旨のアナウンスとなります。&lt;br&gt;2022 年に通知を受け取ったお客様の中で、下記の対応を行っていない環境については、動作変更の影響を受ける条件や合致確認の方法、動作変更の内容および変更の影響を受けないようにする対処方法をご確認の上、2023/6/12 より前にご対応いただけますと幸いでございます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM のディスクパフォーマンス状況の確認方法について</title>
    <link href="https://jpaztech.github.io/blog/vm/disk-metrics/"/>
    <id>https://jpaztech.github.io/blog/vm/disk-metrics/</id>
    <published>2023-05-10T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.387Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>期待したディスクパフォーマンスが得られないといったお問い合わせをいただくことがあります。<br>そのため、今回この記事以下の内容について解説をさせていただきます。  </p><ol><li>Azure 側にて VM サイズとディスクサイズ毎に設定されている上限について解説</li><li>ディスクに関するメトリックでパフォーマンスを確認する方法</li><li>VM サイズとディスクサイズを変更する方法</li></ol><div class="alert is-info"><p class="alert-title">Note</p><p>本記事では各種の上限について数値を交えて解説しておりますが、こちらは理論値となっており実際の計測では OS レイヤ以上の影響等もございますので、必ずしも記載の理論値が計測可能であることを保証するものではございません点について予めご了承くださいませ。</p></div><hr><h2 id="1-1-VM-サイズとディスクサイズ毎に設定されている上限について解説"><a href="#1-1-VM-サイズとディスクサイズ毎に設定されている上限について解説" class="headerlink" title="1-1.VM サイズとディスクサイズ毎に設定されている上限について解説"></a>1-1.VM サイズとディスクサイズ毎に設定されている上限について解説</h2><p>まずは、Azure VM におけるディスクのパフォーマンスの上限値について解説させていただきます。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>ディスク性能の上限はオンプレミス上の物理ディスクでも勿論あるものであり、OS から高負荷な I/O 要求が発生し、ディスク性能の上限に達した場合、 I/O に遅延等が発生することはご理解いただけるかと存じます。</p><p>Azure のディスク性能も同じような考え方となります。上限に達した場合は、オンプレミス環境と同様に I/O の遅延等が発生しますが、これは Azure 特有のものでは無く、オンプレミス環境と同じように発生するものであると考えていただけますと幸いです。</p></div><p>オンプレミス環境のサーバーや私たちが普段使用しているパソコンと同様に、Azure VM でもディスクアクセスが行われます。<br>Azure ではこの VM とディスク間のディスクアクセスについて、「VMサイズ」と「ディスクサイズ」のそれぞれ両方で「MBps」と「IOPS」の上限値を設定しています。  </p><p>なお、この上限は Read / Write の合計で適用されます。<br>つまり Read が 100 MBps、Write が 50 MBps 同時に発生していたら、150 MBps のディスクアクセスとして合算されます。  </p><p>重要な点として、ディスクアクセスの上限は「VMサイズ」と「ディスクサイズ」に設定されている低い方の上限値が適用されます。<br>ホストキャッシュやバーストは無効と考えて、VM とデータディスク間の通信について以下に例を記載します。  </p><p><img src="/blog/vm/disk-metrics/bisk-base.png"></p><p>上記の例では Standard_D2s_v5 の VM サイズに P20 のデータディスクのサイズを組み合わせています。</p><ul><li>Standard_D2s_v5 の VM サイズでの上限：85 MBps / 3750 IOSP</li><li>P20 のディスクサイズでの上限：150 MBps / 2300 IOPS</li></ul><p>という設定がございます。<br>先に解説した通り低い値の方（赤字）が適用されますので、実際に想定される速度の上限値としては「85 MBps / 2300 IOPS」となります。</p><p>なお、この「Standard_D2s_v5 の VM サイズでの上限：85 MBps / 3750 IOSP」という VM の上限値については、ディスク 1 つごとでは無く、ホストキャッシュ無効な全てのデータディスク全体で共有されます。<br>すなわち、複数のホストキャッシュ無効なデータディスク合算で 85 MBps / 3750 IOSP が上限となります。 </p><p>ホストキャッシュの有効なディスク・無効なディスクで上限値が別に設定されている VM サイズもございます。<br>各 VM サイズおよびディスクサイズにおけるディスクアクセスの上限値は、公式ドキュメントをご確認くださいませ。  </p><blockquote><p>■ご参考：Azure の仮想マシンのサイズ<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes">https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes</a></p></blockquote><blockquote><p>■ご参考：Azure マネージド ディスクの種類<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-types">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-types</a></p></blockquote><hr><h2 id="1-2-一時的に通信の上限を上げる「ディスクバースト」という機能がございます"><a href="#1-2-一時的に通信の上限を上げる「ディスクバースト」という機能がございます" class="headerlink" title="1-2.一時的に通信の上限を上げる「ディスクバースト」という機能がございます"></a>1-2.一時的に通信の上限を上げる「ディスクバースト」という機能がございます</h2><p>先に記載した通り、「VMサイズ」と「ディスクサイズ」それぞれにディスクアクセスの上限が設定されています。<br>しかしながら、特定の「VMサイズ」と「ディスクサイズ」には、このディスクアクセスの上限を一時的に上げられる「ディスクバースト」という機能がございます。</p><ul><li>VM サイズに設定されているディスクアクセスの上限値が一時的に上がること = VM レベルのバースト</li><li>ディスクサイズに設定されているディスクアクセスの上限値が一時的に上がること = ディスクレベルのバースト</li></ul><p>ディスクバーストの詳細については公式ドキュメントをご参照くださいませ。</p><blockquote><p>■ご参考：マネージド ディスクのバースト<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disk-bursting">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disk-bursting</a></p></blockquote><p>なお、クレジットベースのバーストの場合、VM レベルのバーストとディスクレベルのバーストは独立しており、<br>以下のように 6 種類のクレジットが独立している点、ご留意くださいませ。</p><ul><li>VM レベルに関する MBps のバーストクレジット（キャッシュ無し）</li><li>VM レベルに関する IOPS のバーストクレジット（キャッシュ無し）</li><li>VM レベルに関する MBps のバーストクレジット（キャッシュあり）</li><li>VM レベルに関する IOPS のバーストクレジット（キャッシュあり）</li><li>ディスクレベルに関する MBps のバーストクレジット</li><li>ディスクレベルに関する IOPS のバーストクレジット</li></ul><p>では、ホストキャッシュは無しとして、バーストが発生した際の例を見てみましょう。</p><p><img src="/blog/vm/disk-metrics/disk-burst.png"></p><p>上記は、Standard_D2s_v5 の VM サイズに P20 のデータディスクのサイズを組み合わせて、VM レベルのバースト・ディスクレベルのバースト両方が働いた場合の例です。<br>一時的に「170 MBps / 3500 IPOS」までバースト可能なことが分かりましたね。</p><hr><h2 id="2-1-ディスクに関するメトリックでパフォーマンスを確認する方法"><a href="#2-1-ディスクに関するメトリックでパフォーマンスを確認する方法" class="headerlink" title="2-1.ディスクに関するメトリックでパフォーマンスを確認する方法"></a>2-1.ディスクに関するメトリックでパフォーマンスを確認する方法</h2><p>Azure では、ディスクアクセスに関してどの程度のパフォーマンスが出ているかといったことを記録しており、メトリックとして確認を行うことが可能です。<br>パフォーマンスが上限で頭打ちしている場合は、スペックアップが必要である可能性があるといったことを確認することができます。</p><p>パフォーマンスが上限で頭打ちしていないにも関わらず、期待したパフォーマンスを得られていない場合は、<br>OS やアプリケーションが適切なディスクアクセスを発生させていない可能性がございます。<br>ディスクパフォーマンスの詳細については以下の記事もご参照くださいませ。  </p><blockquote><p>■ご参考：Azure Premium Storage: 高パフォーマンス用に設計する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/premium-storage-performance">https://learn.microsoft.com/ja-jp/azure/virtual-machines/premium-storage-performance</a></p></blockquote><p>Azure ではこの調査に役立つ多くのディスクに関するメトリックがございますので、一覧形式でご紹介させていただきます。</p><div class="alert is-info"><p class="alert-title">Note</p><p>これらの記録された値については Azure 基盤上で観測された値となりますため、OS 上で観測した値と差異がある可能性がございます点、予めご了承ください。</p><p>また、メトリック表示の最小の粒度は 1 分でございますため、瞬間的な状況等は確認が叶いません点、ご留意ください。</p></div><h3 id="OS-ディスクの-Read-Write-に関して何-MBps-IOPS-が記録されたか確認する"><a href="#OS-ディスクの-Read-Write-に関して何-MBps-IOPS-が記録されたか確認する" class="headerlink" title="OS ディスクの Read / Write に関して何 MBps / IOPS が記録されたか確認する"></a>OS ディスクの Read / Write に関して何 MBps / IOPS が記録されたか確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">OS ディスクの Read が何 MBps 記録されたか確認</td><td align="left">OS Disk Read Bytes/Sec</td></tr><tr><td align="left">OS ディスクの Write が何 MBps 記録されたか確認</td><td align="left">OS Disk Write Bytes/Sec</td></tr><tr><td align="left">OS ディスクの Read が何 IOPS 記録されたか確認</td><td align="left">OS Disk Read Operations/Sec</td></tr><tr><td align="left">OS ディスクの Write が何 IOPS 記録されたか確認</td><td align="left">OS Disk Write Operations/Sec</td></tr></tbody></table><h3 id="データディスクの-Read-Write-に関して何-MBps-IOPS-が記録されたか確認する"><a href="#データディスクの-Read-Write-に関して何-MBps-IOPS-が記録されたか確認する" class="headerlink" title="データディスクの Read / Write に関して何 MBps / IOPS が記録されたか確認する"></a>データディスクの Read / Write に関して何 MBps / IOPS が記録されたか確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">データディスクの Read が何 MBps 記録されたか確認</td><td align="left">Data Disk Read Bytes/Sec</td></tr><tr><td align="left">データディスクの Write が何 MBps 記録されたか確認</td><td align="left">Data Disk Write Bytes/Sec</td></tr><tr><td align="left">データディスクの Read が何 IOPS 記録されたか確認</td><td align="left">Data Disk Read Operations/Sec</td></tr><tr><td align="left">データディスクの Write が何 IOPS 記録されたか確認</td><td align="left">Data Disk Write Operations/Sec</td></tr><tr><td align="left"></td><td align="left"></td></tr></tbody></table><h3 id="VM-レベルのディスクバーストのクレジットの残りがどれくらいか確認する"><a href="#VM-レベルのディスクバーストのクレジットの残りがどれくらいか確認する" class="headerlink" title="VM レベルのディスクバーストのクレジットの残りがどれくらいか確認する"></a>VM レベルのディスクバーストのクレジットの残りがどれくらいか確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">VM レベルの MBps の残バーストクレジット量（キャッシュ有効であるディスク）</td><td align="left">VM Cached Used Burst BPS Credits Percentage</td></tr><tr><td align="left">VM レベルの IOPS の残バーストクレジット量（キャッシュ有効であるディスク）</td><td align="left">VM Cached Used Burst IO Credits Percentage</td></tr><tr><td align="left">VM レベルの MBps の残バーストクレジット量（キャッシュ<strong>無効</strong>なディスク）</td><td align="left">VM Uncached Used Burst BPS Credits Percentage</td></tr><tr><td align="left">VM レベルの IOPS の残バーストクレジット量（キャッシュ<strong>無効</strong>なディスク）</td><td align="left">VM Uncached Used Burst IO Credits Percentage</td></tr><tr><td align="left"></td><td align="left"></td></tr></tbody></table><h3 id="ディスクレベルのディスクバーストのクレジットの残りがどれくらいか確認する"><a href="#ディスクレベルのディスクバーストのクレジットの残りがどれくらいか確認する" class="headerlink" title="ディスクレベルのディスクバーストのクレジットの残りがどれくらいか確認する"></a>ディスクレベルのディスクバーストのクレジットの残りがどれくらいか確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">ディスクレベルの MBps の残バーストクレジット量（OS ディスク）</td><td align="left">OS Disk Used Burst BPS Credits Percentage</td></tr><tr><td align="left">ディスクレベルの IOPS の残バーストクレジット量（OS ディスク）</td><td align="left">OS Disk Used Burst IO Credits Percentage</td></tr><tr><td align="left">ディスクレベルの MBps の残バーストクレジット量（データディスク）</td><td align="left">Data Disk Used Burst BPS Credits Percentage</td></tr><tr><td align="left">ディスクレベルの IOPS の残バーストクレジット量（データディスク）</td><td align="left">Data Disk Used Burst IO Credits Percentage</td></tr></tbody></table><h3 id="ディスクレベルのベースパフォーマンスに対して何-のパフォーマンスが記録されたか確認する"><a href="#ディスクレベルのベースパフォーマンスに対して何-のパフォーマンスが記録されたか確認する" class="headerlink" title="ディスクレベルのベースパフォーマンスに対して何 % のパフォーマンスが記録されたか確認する"></a>ディスクレベルのベースパフォーマンスに対して何 % のパフォーマンスが記録されたか確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">ディスクレベルのベースパフォーマンスに対して計測された MBps のパーセント表示（OS ディスク）</td><td align="left">OS Disk Bandwidth Consumed Percentage</td></tr><tr><td align="left">ディスクレベルのベースパフォーマンスに対して計測された IOPS のパーセント表示（OS ディスク）</td><td align="left">OS Disk IOPS Consumed Percentage</td></tr><tr><td align="left">ディスクレベルのベースパフォーマンスに対して計測された MBps のパーセント表示（データディスク）</td><td align="left">Data Disk Bandwidth Consumed Percentage</td></tr><tr><td align="left">ディスクレベルのベースパフォーマンスに対して計測された IOPS のパーセント表示（データディスク）</td><td align="left">Data Disk IOPS Consumed Percentage</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>※Premium ストレージをサポートする VM シリーズ上でのみ使用できます。</p><p>※バースト時の上限ではなくベースパフォーマンスを 100 % として記録されます。バーストしている場合も 100 % で記録されます。</p></div><h3 id="VM-レベルのベースパフォーマンスに対して何-のパフォーマンスが記録されたか確認する"><a href="#VM-レベルのベースパフォーマンスに対して何-のパフォーマンスが記録されたか確認する" class="headerlink" title="VM レベルのベースパフォーマンスに対して何 % のパフォーマンスが記録されたか確認する"></a>VM レベルのベースパフォーマンスに対して何 % のパフォーマンスが記録されたか確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">VMレベルのベースパフォーマンスに対して計測された MBps のパーセント表示（キャッシュ有効であるディスク）</td><td align="left">VM Cached Bandwidth Consumed Percentage</td></tr><tr><td align="left">VMレベルのベースパフォーマンスに対して計測された IOPS のパーセント表示（キャッシュ有効であるディスク）</td><td align="left">VM Cached IOPS Consumed Percentage</td></tr><tr><td align="left">VMレベルのベースパフォーマンスに対して計測された MBps のパーセント表示（キャッシュ<strong>無効</strong>なディスク）</td><td align="left">VM Uncached Bandwidth Consumed Percentage</td></tr><tr><td align="left">VMレベルのベースパフォーマンスに対して計測された IOPS のパーセント表示（キャッシュ<strong>無効</strong>なディスク）</td><td align="left">VM Uncached IOPS Consumed Percentage</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>※Premium ストレージをサポートする VM シリーズ上でのみ使用できます。</p><p>※バースト時の上限ではなくベースパフォーマンスを 100 % として記録されます。バーストしている場合も 100 % で記録されます。</p></div><h3 id="ディスクのキューの深さを確認する"><a href="#ディスクのキューの深さを確認する" class="headerlink" title="ディスクのキューの深さを確認する"></a>ディスクのキューの深さを確認する</h3><table><thead><tr><th align="left">確認できる内容</th><th align="left">メトリック名</th></tr></thead><tbody><tr><td align="left">OS ディスクのキューの深さを確認</td><td align="left">OS Disk Queue Depth</td></tr><tr><td align="left">データ ディスクのキューの深さを確認</td><td align="left">Data Disk Queue Depth</td></tr></tbody></table><p>ディスク パフォーマンス メトリックについては公式ドキュメントもございますので、合わせてご参照くださいませ。</p><blockquote><p>■ご参考：ディスク パフォーマンス メトリック<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-metrics">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-metrics</a></p></blockquote><hr><h2 id="2-2-実際に-Azure-ポータルでメトリックを確認する（データディスク毎に確認する方法）"><a href="#2-2-実際に-Azure-ポータルでメトリックを確認する（データディスク毎に確認する方法）" class="headerlink" title="2-2.実際に Azure ポータルでメトリックを確認する（データディスク毎に確認する方法）"></a>2-2.実際に Azure ポータルでメトリックを確認する（データディスク毎に確認する方法）</h2><p>メトリックを見る際は以下のように、Azure ポータルで対象の VM の画面より「メトリック」のブレードを選択いただくことでメトリック表示画面になります。</p><p><img src="/blog/vm/disk-metrics/disk-metric.png"></p><p>メトリックの表示自体の詳細を確認したい場合は、以下の公開ドキュメントをご参照ください。</p><blockquote><p>■ご参考: Azure Monitor メトリックの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics">https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics</a></p></blockquote><blockquote><p>■ご参考：Azure Monitor のサポートされるメトリック<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-supported">https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-supported</a></p></blockquote><p>データディスクのメトリックでは、既定の表示では全データディスクの値が合算されたりした状態で表示されてしまいます。<br>各データディスク毎にメトリックを確認したい場合は、以下の手順に沿う必要がございます。<br>まず、以下のように VM のディスクブレードからデータディスクの LUN 番号を確認しましょう。  </p><p><img src="/blog/vm/disk-metrics/disk-lun.png"></p><p>以下のようにメトリック画面でディメンションを LUN で分割すると、各データディスク毎のメトリックの表示が可能になります。<br>下図では 2 つのデータディスクの情報がそれぞれ表示されていますね。</p><p><img src="/blog/vm/disk-metrics/disk-metric-lun.png"></p><p>また、LUN でフィルターをすることで、特定のデータディスクのみ表示することも可能です。</p><p><img src="/blog/vm/disk-metrics/disk-metric-filter.png"></p><hr><h2 id="3-VM-サイズ-ディスクサイズを変更する"><a href="#3-VM-サイズ-ディスクサイズを変更する" class="headerlink" title="3.VM サイズ / ディスクサイズを変更する"></a>3.VM サイズ / ディスクサイズを変更する</h2><p>上記のメトリックなどを確認の上、更に高パフォーマンスなディスクアクセスが必要となった場合は、VM サイズ / ディスクサイズを変更することが可能です。<br>オンプレミス環境の場合は新しいハードウェアの調達などが必要でしたが Azure では簡単に変更をすることが可能です。<br>手順については以下のドキュメントをご確認いただけますと幸いです。  </p><blockquote><p>■ご参考：仮想マシンのサイズの変更<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/resize-vm">https://learn.microsoft.com/ja-jp/azure/virtual-machines/resize-vm</a></p></blockquote><blockquote><p>■ご参考：マネージド ディスクをある特定のディスクの種類から別のものに切り替える<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/convert-disk-storage#switch-managed-disks-from-one-disk-type-to-another">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/convert-disk-storage#switch-managed-disks-from-one-disk-type-to-another</a></p></blockquote><p>VM サイズ / ディスクサイズ変更には VM 停止が必要となります点、ご留意くださいませ。</p><hr><p>以上の通り、ディスクのディスクメトリックの確認について解説をさせていただきました。<br>お客様の調査等の一助となれば幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;期待したディスクパフォーマンスが得られないといったお問い合わせをいただくことがあります。&lt;br&gt;そのため、今回この記事以下の内容について解説をさせていただきます。  &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Azur</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
  </entry>
  
  <entry>
    <title>yum/dnf update に失敗する場合の原因と解決方法</title>
    <link href="https://jpaztech.github.io/blog/vm/rhui-yum-update/"/>
    <id>https://jpaztech.github.io/blog/vm/rhui-yum-update/</id>
    <published>2023-05-02T02:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.567Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure テクニカル サポート チームの高橋です。<br>今回はよく、お問い合わせを頂く<br>Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の仮想マシンにおいて<br>yum / dnf update やパッケージのインストールに失敗する場合の<br>よくある原因とその解決方法についてご紹介いたします。</p><span id="more"></span><hr><h2 id="Azure-RHUI-リポジトリ-とは？"><a href="#Azure-RHUI-リポジトリ-とは？" class="headerlink" title="Azure RHUI (リポジトリ) とは？"></a>Azure RHUI (リポジトリ) とは？</h2><p>Azure RHUI  (Red Hat Update Infrastructure) は、Azure Marketplace にある<br>Red Hat Enterprise Linux (RHEL) の従量課金 (PAYG) イメージから作成した VM を更新するために<br>提供されているリポジトリサーバーです。</p><p>Azure Marketplace から 作成した RHEL VM は、規定で Azure RHUI へのアクセスする構成が設定されているため<br>追加の設定は不要となります。</p><p>VM から、Azure RHUI にアクセスするためには、下記の IP アドレスに対する送信規則の 443 ポートの通信許可を設定する必要があります。<br>Azure RHUI の IP アドレスは下記公開ドキュメントにおまとめしておりますのでご確認ください。<br>RHEL 7、RHEL 8 は RHUI 3、RHEL 9 は RHUI 4 が利用されております。</p><blockquote><p> □ 参考 : RHUI コンテンツ配信サーバーの IP アドレス<br>   <a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui#the-ips-for-the-rhui-content-delivery-servers">https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui#the-ips-for-the-rhui-content-delivery-servers</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p>※Azure RHUI へのアクセスは、弊社バックボーンネットワーク経由にて接続されており、</p><p>Azure VM から、オンプレミスのネットワークインフラストラクチャや、プロキシ、NVA (仮想アプライアンス) 経由でのアクセスはサポートされておらず、</p><p>Azure VM から直接、Azure RHUI に接続する必要がある点に注意してください。</p></div><hr><h2 id="Azure-RHUI-への接続確認"><a href="#Azure-RHUI-への接続確認" class="headerlink" title="Azure RHUI への接続確認"></a>Azure RHUI への接続確認</h2><p>yum / dnf update やパッケージのインストールに失敗する場合、<br>Azure RHUI への接続ができていない可能性がございます。<br>Azure VM 内から、curl コマンド等を使うことで、Azure RHUI への接続状況を確認することができます。<br>下記のコマンドをお試しください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line"><span class="comment"># curl -v https://rhui-2.microsoft.com:443</span></span><br><span class="line"><span class="comment"># curl -v https://rhui-3.microsoft.com:443</span></span><br></pre></td></tr></table></figure><p>&lt; 実行結果例 (成功時) &gt;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@rheltest ~]# curl -v https://rhui-1.microsoft.com:443</span><br><span class="line">* Rebuilt URL to: https://rhui-1.microsoft.com:443/</span><br><span class="line">*   Trying 52.187.75.218...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to rhui-1.microsoft.com (52.187.75.218) port 443 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">*   CAfile: /etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">CApath: none</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server finished (14):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span><br><span class="line">* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Finished (20):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Finished (20):</span><br><span class="line">* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384</span><br><span class="line">* ALPN, server did not agree to a protocol</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: C=US; ST=WA; L=Redmond; O=Microsoft Corporation; CN=rhui-1.microsoft.com</span><br><span class="line">*  start date: Dec  7 11:14:49 2021 GMT</span><br><span class="line">*  expire date: Dec  2 11:14:49 2022 GMT</span><br><span class="line">*  subjectAltName: host &quot;rhui-1.microsoft.com&quot; matched cert&#x27;s &quot;rhui-1.microsoft.com&quot;</span><br><span class="line">*  issuer: C=US; O=Microsoft Corporation; CN=Microsoft Azure TLS Issuing CA 01</span><br><span class="line">*  SSL certificate verify ok.</span><br><span class="line">&gt; GET / HTTP/1.1</span><br><span class="line">&gt; Host: rhui-1.microsoft.com</span><br><span class="line">&gt; User-Agent: curl/7.61.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Date: Mon, 24 Jan 2022 06:51:00 GMT</span><br><span class="line">&lt; Server: Apache/2.4.6 (Red Hat Enterprise Linux)</span><br><span class="line">&lt; X-Served-By: southeastasia-cds0</span><br><span class="line">&lt; X-Content-Type-Options: nosniff</span><br><span class="line">&lt; Last-Modified: Thu, 20 Jun 2019 06:37:48 GMT</span><br><span class="line">&lt; ETag: &quot;0-58bbb9592306b&quot;</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; Connection: close</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt;</span><br><span class="line">* Closing connection 0</span><br><span class="line">* TLSv1.2 (OUT), TLS alert, close notify (256):</span><br></pre></td></tr></table></figure><p>&lt; 実行結果例 (失敗時) &gt; </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]# curl -v https://rhui-1.microsoft.com:443</span><br><span class="line">* Rebuilt URL to: https://rhui-1.microsoft.com:443/</span><br><span class="line">*   Trying 52.187.75.218...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* connect to 52.187.75.218 port 443 failed: Connection timed out</span><br><span class="line">* Failed to connect to rhui-1.microsoft.com port 443: Connection timed out</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed to connect to rhui-1.microsoft.com port 443: Connection timed out</span><br></pre></td></tr></table></figure><p>Azure RHUI への接続確認が失敗する場合には、NSG やプロキシ等のネットワーク設定を確認する必要がございます。<br>よくお問い合わせを頂くエラー原因と解決方法は、以下のようになります。</p><hr><h2 id="エラーの原因その-1-Azure-RHUI-への接続ができない-NSG"><a href="#エラーの原因その-1-Azure-RHUI-への接続ができない-NSG" class="headerlink" title="エラーの原因その 1 : Azure RHUI への接続ができない (NSG)"></a>エラーの原因その 1 : Azure RHUI への接続ができない (NSG)</h2><p>セキュリティ上の理由から、Network Security Group (NSG) を利用して、<br>Azure VM からインターネットへのアクセスを制限を設定している場合があるかと存じます。<br>Azure portal から対象の仮想マシンを選択後、[ネットワーク] から確認することができます。<br>下記画像の例では、送信ポートの規則で、インターネットへの接続を拒否しています。</p><p><img src="/blog/vm/rhui-yum-update/01.png"></p><p>本設定がある場合には、Azure RHUI への接続確認は、失敗することが想定され、<br>yum update を実施した際や、パッケージのインストール時にはタイムアウトエラーが発生します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]# yum update</span><br><span class="line">Red Hat Enterprise Linux 8 for x86_64 - BaseOS - Extended Update Support from RHUI (RPMs)                                                              0.0  B/s |   0  B     01:30</span><br><span class="line">Failed to download metadata for repo &#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;</span><br><span class="line">Error: Failed to download metadata for repo &#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;</span><br></pre></td></tr></table></figure><p><img src="/blog/vm/rhui-yum-update/02.png"></p><p>この場合の解決方法としては、Azure RHUI へアクセスできるように、<br>Azure RHUI サーバーの IP アドレスに対する送信規則の 443 ポートの通信許可を設定する必要があります。<br>下記画像の通り、”送信セキュリティ規則の追加” から、通信許可の設定を追加する必要があります。<br>また、優先度は、DenyInternet (インターネットへの制限規則) より高くする必要がある点にご注意ください。</p><p><img src="/blog/vm/rhui-yum-update/03.png"></p><hr><h2 id="エラーの原因その-2-Azure-RHUI-への接続ができない-Proxy-等"><a href="#エラーの原因その-2-Azure-RHUI-への接続ができない-Proxy-等" class="headerlink" title="エラーの原因その 2 : Azure RHUI への接続ができない (Proxy 等)"></a>エラーの原因その 2 : Azure RHUI への接続ができない (Proxy 等)</h2><p>Azure VM から、オンプレミスのネットワークインフラストラクチャや、プロキシ、NVA (仮想アプライアンス) 経由での Azure RHUI へのアクセスはサポートされていないため、<br>Azure RHUI へのアクセスは、Azure 内の IP アドレス範囲内の VM から直接アクセスする必要がございます。<br>Azure Firewall をご利用の場合には、適切に Azure RHUI に対してアクセスできるよう設定頂くことで、アクセス可能となります。</p><p>この場合の解決方法としては、Azure VM が Azure RHUI の IP アドレスに直接接続できるようユーザー定義のルートテーブル UDR (User Defined Route) を作成する必要があります。<br>下記画像のように、RHUI コンテンツ配信サーバーの IP アドレス全てに対して、<br>次ホップ (Next hops) の種類に “Internet” を指定した UDR を作成頂く必要があります。</p><p><img src="/blog/vm/rhui-yum-update/04.png"></p><p>Azure VM のルートテーブルの作成手順については、下記公開ドキュメントをご確認ください。</p><blockquote><p>  □ 参考 : ルート テーブルの作成、変更、削除 | ルートの作成<br>   <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/manage-route-table#create-a-route-table">https://learn.microsoft.com/ja-jp/azure/virtual-network/manage-route-table#create-a-route-table</a></p></blockquote><div class="alert is-success"><p class="alert-title">ヒント</p><p>※プロキシの設定を実施している場合は、/etc/yum.conf 内の “proxy=” のプロキシ設定がないかご確認ください。</p><p>  プロキシ設定があった場合、コメントアウト等で無効にしてください。</p></div><hr><h2 id="エラーの原因その-3-Azure-RHUI-への接続ができない-外部接続不可の構成"><a href="#エラーの原因その-3-Azure-RHUI-への接続ができない-外部接続不可の構成" class="headerlink" title="エラーの原因その 3 : Azure RHUI への接続ができない (外部接続不可の構成)"></a>エラーの原因その 3 : Azure RHUI への接続ができない (外部接続不可の構成)</h2><p>ご利用の環境によっては、Standard SKU の内部ロードバランサーのバックエンドにAzure VM を配置し、外部へのインターネット接続を制限している場合もあるかと思います。<br>外部接続不可の環境では、yum update を実施した際や、パッケージのインストール時にタイムアウトエラーが発生します。<br>Azure RHUI に接続するためには、NAT Gateway または VM にパブリック IP アドレスを関連付けいただくといった構成に変更する必要があります。</p><p>ご利用の VM が外部接続不可な構成であるかについての確認手順については、<br>以下の弊社ブログにもお纏めしておりますのでご参照ください。</p><blockquote><p>  □ 参考 : Azure VM の外部接続 (SNAT) オプション まとめ<br>   <a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/">https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p>※内部ロードバランサーのバックエンドに VM がない場合でも、可用性セット内の VM が内部ロードバランサーのバックエンドに配置されている場合、</p><p>可用性セット内の VM は全て外部接続ができなくなり、RHUI に繋がらない事象が発生するのでご注意ください。可用性セットの構成変更等ご検討頂ければと思います。</p></div><hr><h2 id="エラーの原因その-4-クライアント証明書の期限切れ"><a href="#エラーの原因その-4-クライアント証明書の期限切れ" class="headerlink" title="エラーの原因その 4 : クライアント証明書の期限切れ"></a>エラーの原因その 4 : クライアント証明書の期限切れ</h2><p>古い RHEL VM イメージを利用している際には、 TLS/SSL クライアント証明書の期限が切れているために、<br>Azure RHUI に接続できない問題が発生することがあります。<br>クライアント証明書の期限が切れた際には、yum update を実施した際に下記のようなエラーが出力されることがあります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]# yum update</span><br><span class="line">Loaded plugins: langpacks, product-id, search-disabled-repos</span><br><span class="line">rhui-microsoft-azure-rhel7-eus                                                                   | 2.1 kB  00:00:00</span><br><span class="line">https://rhui-1.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span><br><span class="line">Trying other mirror.</span><br><span class="line">https://rhui-2.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span><br><span class="line">Trying other mirror.</span><br><span class="line">https://rhui-3.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span><br><span class="line">Trying other mirror.</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel82 ~]# yum update</span><br><span class="line">Red Hat Enterprise Linux 8 for x86_64 - BaseOS - Extended Update Support from RHUI (RPM 0.0  B/s |   0  B     00:02</span><br><span class="line">Errors during downloading metadata for repository &#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;:</span><br><span class="line">  - Curl error (56): Failure when receiving data from the peer for https://rhui-3.microsoft.com/pulp/repos/content/eus/rhel8/rhui/8.2/x86_64/baseos/os/repodata/repomd.xml [OpenSSL SSL_read: error:14094415:SSL routines:ssl3_read_bytes:sslv3 alert certificate expired, errno 0]</span><br><span class="line">  - Curl error (56): Failure when receiving data from the peer for https://rhui-1.microsoft.com/pulp/repos/content/eus/rhel8/rhui/8.2/x86_64/baseos/os/repodata/repomd.xml [OpenSSL SSL_read: error:14094415:SSL routines:ssl3_read_bytes:sslv3 alert certificate expired, errno 0]</span><br><span class="line">  - Curl error (56): Failure when receiving data from the peer for https://rhui-2.microsoft.com/pulp/repos/content/eus/rhel8/rhui/8.2/x86_64/baseos/os/repodata/repomd.xml [OpenSSL SSL_read: error:14094415:SSL routines:ssl3_read_bytes:sslv3 alert certificate expired, errno 0]</span><br><span class="line">Error: Failed to download metadata for repo &#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;: Cannot download repomd.xml: Cannot download repodata/repomd.xml: All mirrors were tried</span><br></pre></td></tr></table></figure><p>この場合の解決方法としては、下記コマンドを実施頂き、<br>クライアント証明書を更新頂くことで、Azure RHUI へのアクセスができるようになることが想定されます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update -y --disablerepo=<span class="string">&#x27;*&#x27;</span> --enablerepo=<span class="string">&#x27;*microsoft*&#x27;</span></span><br></pre></td></tr></table></figure><p>※本コマンドは、rhui の rpm のみを更新するコマンドとなります。<br>本事象については、以下の公開ドキュメントにもお纏めしております。</p><blockquote><p>□ 参考 : Azure での RHUI 証明書の問題のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-linux-rhui-certificate-issues?tabs=rhel7-eus,rhel7-noneus,rhel7-rhel-sap-apps">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-linux-rhui-certificate-issues?tabs=rhel7-eus%2Crhel7-noneus%2Crhel7-rhel-sap-apps</a></p></blockquote><div class="alert is-success"><p class="alert-title">ヒント</p><p>解消しない場合には、下記コマンドも併せてお試しください</p><p>#キャッシュデータの削除し、キャッシュの更新</p><p>sudo yum clean all</p><p>sudo yum makecache</p></div><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><p>今回ご紹介した方法でも、事象が解消しない場合には、<br>yum repolist all コマンドを実行頂き、有効なリポジトリをご確認頂ければと思います。</p><p>カスタムイメージや、ゴールドイメージの BYOS イメージをご利用されている場合には、<br>RHSM や サテライトに接続する必要があります。</p><blockquote><p>□ 参考 : Azure のオンデマンド Red Hat Enterprise Linux VM 用 Red Hat Update Infrastructure<br>   <a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui">https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui</a></p></blockquote><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure テクニカル サポート チームの高橋です。&lt;br&gt;今回はよく、お問い合わせを頂く&lt;br&gt;Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の仮想マシンにおいて&lt;br&gt;yum / dnf update やパッケージのインストールに失敗する場合の&lt;br&gt;よくある原因とその解決方法についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="RHEL" scheme="https://jpaztech.github.io/blog/tags/RHEL/"/>
    
    <category term="RHUI" scheme="https://jpaztech.github.io/blog/tags/RHUI/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM のシステムリソース高騰の原因調査について</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-highusage/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-highusage/</id>
    <published>2023-04-28T03:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.643Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカルサポートの橋本です。</p><p>Azure VM の CPU 、メモリの使用率およびディスクビジー率が高騰し、原因調査のお問合せをいただくことがございます。<br>システムリソース高騰のトラブルシューティングでは事象発生中の OS のログが必要なことから、<br>事後対応による原因究明はほぼ不可能なため、発生中に OS にログインしてログを取得する、または事象発生に備えて定期的なログ取得設定を実施しておく必要があります。</p><p>本ブログ記事では、複数ございます公式ドキュメントのシステムリソース高騰のトラブルシューティングのご案内をお纏めしつつ、よくあるお問合せとトラブルシューティングの共通事項などを踏まえまして以下をご案内させていただきます。</p><span id="more"></span><p>　・Azure VM システムリソース高騰の一般的な要因<br>　・原因調査の流れ<br>　・問題のプロセスを追跡する</p><p>関連ドキュメント</p><blockquote><p>ご参考：Linux でのパフォーマンスのトラブルシューティングとボトルネックの分離<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-performance-bottlenecks-linux">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-performance-bottlenecks-linux</a></p></blockquote><blockquote><p>ご参考：Azure Windows 仮想マシンでの CPU 使用率の高い問題のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-high-cpu-issues-azure-windows-vm">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-high-cpu-issues-azure-windows-vm</a></p></blockquote><blockquote><p>ご参考：Azure Windows 仮想マシンでのメモリの高い問題のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/azure-windows-vm-memory-issue">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/azure-windows-vm-memory-issue</a></p></blockquote><hr><h2 id="■-Azure-VM-システムリソース高騰の一般的な要因"><a href="#■-Azure-VM-システムリソース高騰の一般的な要因" class="headerlink" title="■ Azure VM システムリソース高騰の一般的な要因"></a>■ Azure VM システムリソース高騰の一般的な要因</h2><p>システムリソース高騰要因の多くはご利用のアプリケーションのワークロードに依存したものとなり、<br>まれにご利用の OS 、アプリケーションのプログラムのエラー又はバグ等の不具合による原因もございます。<br>システムリソースを多く利用するプロセスを特定することがトラブルシューティングにおいて必須の作業となります。</p><p>プロセスが特定できましたら、アプリケーションログなどから、該当プロセスの観点から当時の接続数などの負荷状況を確認、<br>エラーなどによるリトライや処理滞留がリソースひっ迫を起こしていないか、<br>ご利用バージョンより既知不具合発生報告の事例確認等を行います。</p><p>なお、 Microsoft から提供されていない、 OS プロセス以外のサードパーティ製品や、<br>又はお客様作成の業務アプリケーションのプロセスが問題を引き起こしているケースですと、<br>プロセス機能の提供元へ原因調査をお願いさせていただいております。<br>これは、プロセスがなぜ多くのシステムリソースを利用しているか、<br>その妥当性については該当プロセス側の解析調査が必要となり、<br>弊社より  判断することができないためとなります。</p><blockquote><p>ご参考：Azure Windows 仮想マシンでの CPU 使用率の高い問題のトラブルシューティング - 一般的な要因<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-high-cpu-issues-azure-windows-vm#common-factors">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-high-cpu-issues-azure-windows-vm#common-factors</a></p></blockquote><hr><h2 id="■-原因調査の流れ"><a href="#■-原因調査の流れ" class="headerlink" title="■ 原因調査の流れ"></a>■ 原因調査の流れ</h2><p>お客様環境の Azure VM は監視ソフトウェアや Azure のメトリックのアラート設定によって<br>OS レベルのリソース状況を監視しているかと思います。<br>しかしながら、OS 上のプロセスレベルでのシステムリソース利用状況は Azure メトリックではログ取得できず、<br>監視ソフトウェアなどでもプロセスレベルの情報を取得しているケースはそれほど多くないと思います。</p><p>プロセスレベルでのシステムリソースの利用状況を別途取得しておりませんと、<br>事後に問題のプロセスを特定することがほぼ不可能となります。<br>この点を踏まえまして、一般的に Azure VM のシステムリソース高騰の原因調査は以下のような流れとなります。</p><p>  <strong>(1) 事前のログ取得設定</strong><br>  <strong>(2) システムリソース高騰が発生</strong><br>  <strong>(3) (1) で取得設定していたログを回収し、稼働プロセス毎のリソース使用状況を解析</strong><br>  <strong>(4) 特定したプロセスの観点から原因を究明</strong></p><hr><h2 id="■-問題のプロセスを追跡する"><a href="#■-問題のプロセスを追跡する" class="headerlink" title="■ 問題のプロセスを追跡する"></a>■ 問題のプロセスを追跡する</h2><p>ご利用の OS によって問題となっているプロセスの追跡に利用するツールが異なりますため、<br>Windows 、 Linux それぞれのシナリオ毎に記載させていただきます。</p><h4 id="【Windows-環境で問題のプロセスを追跡する】"><a href="#【Windows-環境で問題のプロセスを追跡する】" class="headerlink" title="【Windows 環境で問題のプロセスを追跡する】"></a>【Windows 環境で問題のプロセスを追跡する】</h4><p>Windows 環境では、標準機能のパフォーマンスモニターを利用してプロセスレベルの情報を含む、<br>各システムリソースの利用状況を取得することが可能となります。<br>パフォーマンスモニターでのログ収集方法と、問題プロセスを追跡する方法についてはこちらの記事をご参照ください。</p><blockquote><p>ご参考：パフォーマンス ログ収集<br><a href="https://jpwinsup.github.io/blog/2021/06/07/Performance/SystemResource/PerformanceLogging/">https://jpwinsup.github.io/blog/2021/06/07/Performance/SystemResource/PerformanceLogging/</a></p></blockquote><blockquote><p>ご参考：Azure Windows 仮想マシンでの CPU 使用率の高い問題のトラブルシューティング - プロセスを特定する<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-high-cpu-issues-azure-windows-vm#identify-the-process">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-high-cpu-issues-azure-windows-vm#identify-the-process</a></p></blockquote><h4 id="【Linux-環境で問題のプロセスを追跡する】"><a href="#【Linux-環境で問題のプロセスを追跡する】" class="headerlink" title="【Linux 環境で問題のプロセスを追跡する】"></a>【Linux 環境で問題のプロセスを追跡する】</h4><p>Linux 環境では、プロセスレベルのリソース利用状況を確認するコマンドはありますが、<br>Windows のパフォーマンスモニターのようにスケジュール機能などが組み込まれたものがございません。</p><p>このため、 cron などの機能と組み合わせてコマンドでプロセス利用状況を定期的に取得する形となりますが、<br>公式ドキュメントには ps や top コマンドの説明のみでしたので、cron と合わせてご利用する際のサンプルを<br>以下にご用意させていただきます。</p><p>なお、記事内のサンプルスクリプトは、Microsoft の標準サポートプログラムまたはサービスではサポートされません。<br>サンプル スクリプトは現状有姿で提供され、いかなる保証も行いません。<br>この点についてはご了承のうえでご利用をお願いいたします。</p><p><strong>————————————————————————-</strong><br><strong>統計情報の取得</strong><br><strong>————————————————————————-</strong><br>プロセス毎のシステムリソース利用状況について事象発生前後の傾向を確認するため<br>cron にてプロセス情報の確認コマンドを定期実行します。</p><ul><li>ログ出力先ディレクトリの名前は以下を想定しています。<br>/var/osperf<br>こちらは空き容量の十分にある任意のディレクトリに変更いただいて問題ございません。<br>出力ログのサイズは環境に依存いたしますが検証環境では 1 回あたり 60 KB 程度でございました。</li></ul><ol><li><p>root ユーザにスイッチします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su -</span><br></pre></td></tr></table></figure></li><li><p>ログ取得のスクリプトを作成します</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/osperf</span><br><span class="line">touch /var/osperf/osperf.sh</span><br><span class="line">chmod 700 /var/osperf/osperf.sh</span><br><span class="line">vi /var/osperf/osperf.sh</span><br><span class="line">===</span><br><span class="line">date &gt;&gt; /var/osperf/`date +%y%m%d`.free.out ; /usr/bin/free &gt;&gt; /var/osperf/`date +%y%m%d`.free.out</span><br><span class="line">date &gt;&gt; /var/osperf/`date +%y%m%d`.meminfo.out ; /usr/bin/cat /proc/meminfo &gt;&gt; /var/osperf/`date +%y%m%d`.meminfo.out</span><br><span class="line">date &gt;&gt; /var/osperf/`date +%y%m%d`.slabtop.out ; /usr/bin/slabtop -o &gt;&gt; /var/osperf/`date +%y%m%d`.slabtop.out</span><br><span class="line">date &gt;&gt; /var/osperf/`date +%y%m%d`.psaux.out ; /usr/bin/ps aux --sort -rss &gt;&gt; /var/osperf/`date +%y%m%d`.psaux.out</span><br><span class="line">date &gt;&gt; /var/osperf/`date +%y%m%d`.top.out ; /usr/bin/top -b -n 1 &gt;&gt; /var/osperf/`date +%y%m%d`.top.out</span><br><span class="line">===</span><br><span class="line">※osperf.sh ファイルにこちらの五行を記載</span><br></pre></td></tr></table></figure></li><li><p>root 権限で以下コマンドより root ユーザの crontab を修正します</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crontab -e -u root</span><br><span class="line">===</span><br><span class="line">*/10 * * * * sh /var/osperf/osperf.sh</span><br><span class="line">===</span><br><span class="line">※こちら、10 分毎に一度実行される形としております。</span><br></pre></td></tr></table></figure></li><li><p>システムリソースの高騰の事象が再現しましたら<br>/var/osperf ディレクトリの情報の取得をお願いいたします。</p></li></ol><p>今回ご案内させていただきました内容が、皆様のお役に立てますと幸いでございます。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカルサポートの橋本です。&lt;/p&gt;
&lt;p&gt;Azure VM の CPU 、メモリの使用率およびディスクビジー率が高騰し、原因調査のお問合せをいただくことがございます。&lt;br&gt;システムリソース高騰のトラブルシューティングでは事象発生中の OS のログが必要なことから、&lt;br&gt;事後対応による原因究明はほぼ不可能なため、発生中に OS にログインしてログを取得する、または事象発生に備えて定期的なログ取得設定を実施しておく必要があります。&lt;/p&gt;
&lt;p&gt;本ブログ記事では、複数ございます公式ドキュメントのシステムリソース高騰のトラブルシューティングのご案内をお纏めしつつ、よくあるお問合せとトラブルシューティングの共通事項などを踏まえまして以下をご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="CPU" scheme="https://jpaztech.github.io/blog/tags/CPU/"/>
    
    <category term="Memory" scheme="https://jpaztech.github.io/blog/tags/Memory/"/>
    
  </entry>
  
  <entry>
    <title>サービス エンドポイントとプライベート エンドポイントの違い</title>
    <link href="https://jpaztech.github.io/blog/network/pe-difference-se/"/>
    <id>https://jpaztech.github.io/blog/network/pe-difference-se/</id>
    <published>2023-04-21T03:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.263Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。</p><p>今回はお問い合わせを多くいただくサービス エンドポイントとプライベート エンドポイントの違いについてご紹介します。</p><span id="more"></span><h2 id="機能の違いについて"><a href="#機能の違いについて" class="headerlink" title="機能の違いについて"></a>機能の違いについて</h2><p>サービス エンドポイントとプライベートエンドポイントを端的に紹介すると、サービス エンドポイントは「Azure PaaS のパブリック IP アドレスに対する接続を最適化する」機能であり、プライベート エンドポイントは「プライベート IP アドレスで Azure PaaS に接続する」機能です。<br>サービス エンドポイントとプライベート エンドポイントの機能差分については下記の通りです。</p><table><thead><tr><th align="center"></th><th align="left">サービス エンドポイント (SE)</th><th align="left">プライベート エンドポイント (PE)</th></tr></thead><tbody><tr><td align="center">接続対象のリソース</td><td align="left">Azure PaaS</td><td align="left">Azure PaaS と PLS (*1)</td></tr><tr><td align="center">構成方法</td><td align="left">サブネット単位で有効化</td><td align="left">PE リソースの構成</td></tr><tr><td align="center">利用可能な送信元リソース</td><td align="left">SE を有効化したサブネット上のリソース</td><td align="left">PE に IP 疎通性があるリソース</td></tr><tr><td align="center">接続先の IP アドレス</td><td align="left">Azure PaaS のパブリック IP アドレス</td><td align="left">PE のプライベート IP アドレス</td></tr><tr><td align="center">接続制限</td><td align="left">Azure PaaS の設定でサブネット単位の指定 (*2)</td><td align="left">PE のサブネットの NSG で指定 (*3)</td></tr><tr><td align="center">接続元の IP アドレス(*4)</td><td align="left">サブネット上のリソースのプライベート IP アドレス</td><td align="left">PE に接続するリソースの IP アドレス</td></tr></tbody></table><p>※ 上記の表にあるサブネットは、Azure の仮想ネットワーク上のサブネットを指します。</p><p>(*1)PLS は <a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-link-service-overview">Private Link Service</a> を指す。Azure 内部ロードバランサーに対して関連付けする機能。<br><br>(*2)接続制限の設定については、接続先の Azure PaaS に依存する。<br><br>(*3)PE が構成された VNet のサブネット上における<a href="https://learn.microsoft.com/ja-jp/azure/private-link/disable-private-endpoint-network-policy?tabs=network-policy-portal">ネットワーク ポリシー設定</a>が必要。<br><br>(*4)接続先の Azure PaaS によって出力されるログの形態によって異なります。</p><h2 id="接続構成について"><a href="#接続構成について" class="headerlink" title="接続構成について"></a>接続構成について</h2><p>サービス エンドポイントとプライベート エンドポイントは、Azure PaaS に対する接続を提供する機能であり、どちらのエンドポイントを利用するかは接続元のリソース (クライアント) の動作に依存します。<br>今回は Storage Account の Azure Blob (contoso.blob.windows.net) に対して接続する構成における、3 つのシナリオにおける接続イメージについてご紹介します。</p><p><br><u><strong>シナリオ 1 : サービス エンドポイントとプライベート エンドポイントが構成されていない</strong></u><br><br>この構成では、仮想マシンから Blob に対して、インターネット経由で接続します。<br>接続元のクライアントは、接続先の FQDN に対して名前解決の結果として Azure Blob のパブリック IP アドレスが応答されます。<br>接続元のクライアントは、Azure Blob のパブリック IP アドレスに対して、Azure の既定の経路 (0.0.0.0/0) に従って、インターネット経由で接続します。</p><p>下記の図は説明の便宜上インターネットに接続している構成図としていますが、<a href="https://learn.microsoft.com/ja-jp/azure/networking/microsoft-global-network">Azure の仮想マシンから Azure PaaS へ接続は Microsoft バックボーン ネットワークを経由して接続する</a>ため、実際の通信はパブリック インターネットを経由しません。</p><p><img src="/blog/network/pe-difference-se/01.png"><br><br></p><p><br><u><strong>シナリオ 2 : サービス エンドポイントを有効化</strong></u><br><br>この構成では、仮想マシンから Blob に対して、サービス エンドポイントを介して接続します。<br>接続元のクライアントは、接続先の FQDN に対して名前解決の結果として Azure Blob のパブリック IP アドレスが応答されます。<br>接続元のクライアントは、Azure Blob のパブリック IP アドレスに対して、サービス エンドポイントで追加された内部経路情報 (VirtualNetworkServiceEndpoint) に従って、Azure 内部で最適化された経路で接続します。<br>この時の接続経路は、Microsoft バックボーン ネットワーク内で完結します。</p><p><img src="/blog/network/pe-difference-se/02a.png"><br><br></p><p><br><u><strong>シナリオ 3 : プライベート エンドポイントを有効化</strong></u><br><br>この構成では、仮想マシンから Azure Blob に対して、プライベート エンドポイントを介して接続します。<br>接続元のクライアントは、接続先の FQDN に対して名前解決の結果として Blob 接続用のプライベート エンドポイントの IP アドレス (プライベート IP アドレス) が応答されます。<br>接続元のクライアントは、プライベート エンドポイントの IP アドレスに対して Blob に接続します。</p><p>なお、下記の図では便宜上、簡略していますが、プライベート DNS ゾーンを利用している構成を前提としています。</p><p><img src="/blog/network/pe-difference-se/03.png"><br><br></p><h2 id="使い分けについて"><a href="#使い分けについて" class="headerlink" title="使い分けについて"></a>使い分けについて</h2><p>上記の通り、サービス エンドポイントとプライベート エンドポイントでは、接続元のクライアントからの接続先 IP アドレスが異なるため、DNS 構成により使い分けが可能です。<br>つまり、サービス エンドポイントとプライベート エンドポイントを同時に構成することは可能で、接続先 IP アドレスを DNS レイヤーで切り替えることで接続を切り替えます。<br>サービス エンドポイントとプライベート エンドポイントの使い分けの一例としては、下記の点をご参考にしていただければ幸いです。</p><p>サービス エンドポイントは対象の仮想ネットワークのサブネットに対してのみ適用可能な機能となるため、ExpressRoute や VPN で接続されたオンプレミスのリソースはサービス エンドポイントを利用できません。しかし、強制トンネリング構成において特定の Azure PaaS に対してのパブリック エンドポイントへのアクセスを構成できることや、Azure PaaS 側でサービス エンドポイントを有効化した仮想ネットワーク上のサブネットからの接続に制限できること、これらの機能が追加費用なくご利用いただくことが特徴として挙げられます。</p><p>プライベートエンドポイントでは、プライベート エンドポイントのプライベート IP アドレスに接続性があれば利用可能なため、ExpressRoute や VPN で接続されたオンプレミスのリソースから Azure PaaS に接続するシナリオでご利用いただくことが可能です。なお、サービス エンドポイントとは異なり、<a href="https://azure.microsoft.com/ja-jp/pricing/details/private-link/">プライベート エンドポイントは費用が発生する点</a>にはご留意ください。</p><h2 id="公開情報について"><a href="#公開情報について" class="headerlink" title="公開情報について"></a>公開情報について</h2><p>サービス エンドポイントとプライベート エンドポイントの概要や、構成の手順などについては下記の公開情報に記載がございますので併せてご確認ください。</p><p>仮想ネットワーク サービス エンドポイント<br><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-service-endpoints-overview">https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-service-endpoints-overview</a></p><p>Azure Private Link とは<br><br><a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-link-overview?toc=/azure/virtual-network/toc.json">https://learn.microsoft.com/ja-jp/azure/private-link/private-link-overview?toc=%2Fazure%2Fvirtual-network%2Ftoc.json</a></p><p>クイックスタート: Azure portal を使用してプライベート エンドポイントを作成する<br><br><a href="https://learn.microsoft.com/ja-jp/azure/private-link/create-private-endpoint-portal?tabs=dynamic-ip">https://learn.microsoft.com/ja-jp/azure/private-link/create-private-endpoint-portal?tabs=dynamic-ip</a></p><h2 id="よくいただくご質問"><a href="#よくいただくご質問" class="headerlink" title="よくいただくご質問"></a>よくいただくご質問</h2><p><strong>・プライベート エンドポイントに対してプライベート IP アドレスでアクセスしても接続できません</strong></p><p>Azure PaaS はホスト名を用いて通信を識別しています。プライベート エンドポイントは Azure PaaS への接続経路を提供する機能のみであり、実際のリクエストにはホスト名を含めた FQDN が必要です。</p><p><strong>・サービス エンドポイントとプライベート エンドポイントのどちらを選択しているかわかりません</strong></p><p>Azure の機能では明確に確認することはできませんが、接続元のクライアント上で、対象の FQDN に対する名前解決を実行し、パブリック IP アドレスが応答されればサービス エンドポイント、プライベート IP アドレスが応答されればプライベート エンドポイント経由で接続していると判断できます。</p><p><strong>・Azure PaaS から仮想ネットワークへの接続にサービス エンドポイントやプライベート エンドポイントは使えますか</strong></p><p>いいえ、ご利用いただけません。サービス エンドポイントとプライベート エンドポイントは、仮想ネットワークから Azure PaaS への接続時に利用可能なサービスです。Azure PaaS から仮想ネットワークの接続については、各サービスによって機能の有無がありますが、VNet 統合等の機能で利用できます。</p><p>以上、ご参考になれば幸いです。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。&lt;/p&gt;
&lt;p&gt;今回はお問い合わせを多くいただくサービス エンドポイントとプライベート エンドポイントの違いについてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Private Endpoint" scheme="https://jpaztech.github.io/blog/tags/Private-Endpoint/"/>
    
    <category term="Service Endpoint" scheme="https://jpaztech.github.io/blog/tags/Service-Endpoint/"/>
    
  </entry>
  
  <entry>
    <title>Firewall からインターネットに SNAT して通信する時のパブリック IP の使われ方</title>
    <link href="https://jpaztech.github.io/blog/network/fw-snat/"/>
    <id>https://jpaztech.github.io/blog/network/fw-snat/</id>
    <published>2023-04-16T05:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.259Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Azure Firewall に関連付けたパブリック IP の SNAT 時の使われ方について紹介します。</p><span id="more"></span><h2 id="Azure-Firewall-のパブリック-IP-による-SNAT-について"><a href="#Azure-Firewall-のパブリック-IP-による-SNAT-について" class="headerlink" title="Azure Firewall のパブリック IP による SNAT について"></a>Azure Firewall のパブリック IP による SNAT について</h2><p>Azure Firewall を経由してインターネット宛に通信するときは、関連付けられているパブリック IP へ送信元のアドレス変換（SNAT）が行われます。パブリック IP が 1 つしかない時はそのパブリック IP のアドレスしか使用されませんが、複数のパブリック IP アドレスが Azure Firewall に関連付けられている場合の動作について、以下のドキュメントではランダムに選択する旨の記載がございます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/deploy-multi-public-ip-powershell">Azure PowerShell を使用して複数のパブリック IP アドレスを使用する Azure Firewall をデプロイする</a></p><blockquote><p>SNAT -送信 SNAT 接続に追加のポートを使用できるので、SNAT ポートが不足する可能性が低減されます。 Azure Firewall では、<em><strong>接続に使用する送信元パブリック IP アドレスがランダムに選択されます。</strong></em> ネットワークにダウンストリーム フィルターがある場合、ファイアウォールに関連付けられているすべてのパブリック IP アドレスを許可する必要があります。 この構成を簡略化するには、パブリック IP アドレス プレフィックスを使用することを検討してください。</p></blockquote><p>この記載は通信ごとにランダムにパブリック IP が使用される、つまり確率的に関連付けられている全てのパブリック IP が均等に使用されるかのように読み取れますが、<strong>実際のパブリック IP の使われ方は、基本的にプライマリのパブリック IP から使用されることが多く、そのパブリック IP が継続して使用される傾向があります。つまり、全てのパブリック IP が均等に使用されるようなふるまいではありません。</strong></p><p>通信先への送信元 IP アドレスを分散させたい場合には NAT ゲートウェイが必要となります。</p><h2 id="NAT-ゲートウェイ-による-SNAT-について"><a href="#NAT-ゲートウェイ-による-SNAT-について" class="headerlink" title="NAT ゲートウェイ による SNAT について"></a>NAT ゲートウェイ による SNAT について</h2><p>Azure Firewall Subnet に NAT ゲートウェイを関連付けることにより、Azure Firewall のパブリック IP ではなく、NAT ゲートウェイで SNAT を行うことができるようになります。NAT ゲートウェイによる SNAT では関連付けられているパブリック IP がランダムかつほぼ均等に使用されます。<br>注意点として、NAT ゲートウェイはゾーン冗長をサポートしていないため、利用する場合は Azure Firewall をゾーン冗長しないようにデプロイする必要があります。<br>Azure Firewall と NAT ゲートウェイを組み合わせて使用する方法については以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/integrate-with-nat-gateway">Azure Virtual Network NAT を使用した SNAT ポートのスケーリング | Microsoft Learn</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/nat-gateway/tutorial-hub-spoke-nat-firewall">チュートリアル： ハブ アンド スポーク ネットワークで NAT ゲートウェイと Azure Firewall を統合する - Azure Virtual Network NAT | Microsoft Learn</a></p><h2 id="Azure-Firewall-と-NAT-Gateway-の比較表"><a href="#Azure-Firewall-と-NAT-Gateway-の比較表" class="headerlink" title="Azure Firewall と NAT Gateway の比較表"></a>Azure Firewall と NAT Gateway の比較表</h2><p>以下の表は Azure Firewall のパブリック IP による SNAT と NAT Gateway の機能比較表です。</p><table><thead><tr><th align="left">機能</th><th align="center">Firewall のパブリック IP</th><th align="center">NAT ゲートウェイ</th></tr></thead><tbody><tr><td align="left">SNAT ポート数（パブリック IP 1 つにつき）</td><td align="center">2,496 * FW 内部インスタンス数 ※1</td><td align="center">64,512</td></tr><tr><td align="left">関連付けられる パブリック IP の数</td><td align="center">250</td><td align="center">16</td></tr><tr><td align="left">パブリック IP が使用される順番</td><td align="center">基本的にプライマリから使用され、ポートが枯渇すると次が使用される</td><td align="center">ランダムかつほぼ均等に使用される</td></tr><tr><td align="left">ゾーン冗長のサポート</td><td align="center">○</td><td align="center">×</td></tr><tr><td align="left">価格</td><td align="center">FW と FW のパブリック IP の価格</td><td align="center">FW と FW のパブリック IP, NAT ゲートウェイと NAT ゲートウェイ のパブリック IP の価格</td></tr></tbody></table><p>※1 Azure Firewall の内部インスタンス数は最低 2 となり、負荷に応じてスケールアウトします。</p><p>以上、ご参考になれば幸いです。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Azure Firewall に関連付けたパブリック IP の SNAT 時の使われ方について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の CPU コア数 / CPU の種類 / ターボブーストについての解説</title>
    <link href="https://jpaztech.github.io/blog/vm/azure-vm-cpu-htt-turbo/"/>
    <id>https://jpaztech.github.io/blog/vm/azure-vm-cpu-htt-turbo/</id>
    <published>2023-04-11T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.343Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回はお問い合わせいただくことの多い Azure VM の CPU に関する以下の点を解説させていただきます。  </p><ul><li>CPU の vCPU 数 / 物理コア数 / 論理スレッド数について</li><li>制約付き vCPU 対応の VM サイズについて</li><li>CPU の種類について</li><li>ターボブースト機能について</li></ul><p>まず Azure VM ではそのスペックについて VM サイズとして、<br>搭載 CPU / vCPU 数 / メモリの量 / ディスクやネットワークの帯域などの組み合わせより選んでいただくこととなります。<br>各 VM サイズの情報については、以下の資料をご参照いただけますと幸いでございます。  </p><blockquote><p>■ご参考：Azure の仮想マシンのサイズ<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes">https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes</a></p></blockquote><hr><h2 id="CPU-の-vCPU-数-物理コア数-論理スレッド数について"><a href="#CPU-の-vCPU-数-物理コア数-論理スレッド数について" class="headerlink" title="CPU の vCPU 数 / 物理コア数 / 論理スレッド数について"></a>CPU の vCPU 数 / 物理コア数 / 論理スレッド数について</h2><p>ソフトウェア ライセンスの観点等により、Azure VM における vCPU 数 / 物理コア数 / 論理スレッド数についてお問い合わせをいただくことがございます。  </p><p>Azure VM では VM サイズとして vCPU 数をお客様に選んでいただくことになります。<br>では、8 vCPU の VM サイズを選んだ として、「4 物理コア / 8 論理スレッド」なのか、「8 物理コア / 8 論理スレッド」なのかという点が気になりますね。  </p><p>1 つの物理コアを 2 論理スレッドとして扱う技術として、  </p><ul><li>Intel ハイパースレッディング テクノロジ</li><li>AMD 同時実行マルチスレッド技術</li></ul><p>といった技術がございます。<br> ※ 以下「ハイパースレッド / マルチスレッド化」と記載させていたせていただきます。  </p><p>そのため、8 vCPU の VM サイズ については、  </p><ul><li>ハイパースレッド / マルチスレッド化されている VM サイズの場合は「4 物理コア / 8 論理スレッド」</li><li>ハイパースレッド / マルチスレッド化されて<strong>いない</strong> VM サイズの場合は「8 物理コア / 8 論理スレッド」</li></ul><p>となります。  </p><p>どの VM サイズがハイパースレッド / マルチスレッド化されているのかといった点は、<br>以下の Azure コンピューティング ユニット (ACU) のドキュメントより確認可能です。<br>「vCPU: コア」の表記が「2:1***」「2:1****」になっているものは、<br>ハイパースレッド / マルチスレッド化されており、1 つの物理コアを 2 論理スレッドとして扱われております。  </p><blockquote><p>■ご参考：Azure コンピューティング ユニット (ACU)<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu">https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu</a></p></blockquote><blockquote><p>ーーーーーー抜粋ーーーーーー<br>*** ハイパースレッド化されており、入れ子になった仮想化を実行できます。<br>****AMD 同時実行マルチスレッド技術<br>ーーーーーーーーーーーーーー  </p></blockquote><p>なお、ACU に表記のない VM サイズにつきましては、各 VM サイズにおけるドキュメント等にハイパースレッド / マルチスレッド化されているかという旨が記載されておりますので、それらをご確認いただけますと幸いです。  </p><blockquote><p>■ ハイパースレッド化が有効である場合の表記の例（Dv5 および Dsv5 シリーズ）<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/dv5-dsv5-series">https://learn.microsoft.com/ja-jp/azure/virtual-machines/dv5-dsv5-series</a>  </p></blockquote><blockquote><p>ーーーーーー抜粋ーーーーーー<br>Dv5 および Dsv5 シリーズの仮想マシンは、<strong>ハイパースレッド構成の</strong>第 3 世代 Intel® Xeon® Platinum 8370C (Ice Lake) プロセッサ上で実行されます。<br>ーーーーーーーーーーーーーー</p></blockquote><blockquote><p>■ マルチスレッド化が有効である場合の表記の例（Dasv5 および Dadsv5 シリーズ）<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/dv5-dsv5-series">https://learn.microsoft.com/ja-jp/azure/virtual-machines/dv5-dsv5-series</a>  </p></blockquote><blockquote><p>ーーーーーー抜粋ーーーーーー<br>Dasv5 シリーズおよび Dadsv5 シリーズは、AMD の第 3 世代 EPYCTM 7763v プロセッサを、最大 256 MB の L3 キャッシュを備えた<strong>マルチスレッド構成で</strong>利用し、汎用ワークロードを実行するための顧客オプションを増やします。<br>ーーーーーーーーーーーーーー</p></blockquote><p>また、恐縮ながら物理ホスト サーバー 1 台に搭載された合計物理コア数やソケット数はお客様に公開が叶いません点ご理解賜りますと幸いでございます。  </p><div class="alert is-info"><p class="alert-title">Note</p><p>ソフトウェアについてはパブリック クラウド環境の場合はオンプレミスの物理サーバーと違ったライセンス ルールがある場合がございます。</p><p>「ライセンス上どのように CPU 数などをカウントするか？」「パブリッククラウドとオンプレミス環境でのライセンスの違いはあるか？」など、各ソフトウェア ライセンスの観点については、そのソフトウェア ライセンスを取り扱っている会社様にご確認をお願いいたします。  </p></div><hr><h2 id="制約付き-vCPU-対応の-VM-サイズについて"><a href="#制約付き-vCPU-対応の-VM-サイズについて" class="headerlink" title="制約付き vCPU 対応の VM サイズについて"></a>制約付き vCPU 対応の VM サイズについて</h2><p>ソフトウェアによっては vCPU の数によって、ライセンス料金が決定されるものがございます。<br>例えばその際に、  </p><blockquote><p>「メモリは 256 GB 欲しいので Standard_E32d_v5 サイズ（32 vCPU / 256 GB）が良さそうだけど、32 vCPU もあるとライセンス料金が高くなってしまう。」  </p></blockquote><p>ということがあるかと存じます。  </p><p>このようなご要望にお応えするため、Standard_E32d_v5 サイズ（32 vCPU / 256 GB）から、vCPU の数のみを減らした、<br>Standard_E32-8ds_v5 サイズ（8 vCPU / 256 GB）というサイズのご用意がございます。<br>このように vCPU 数のみを元の VM サイズから減らしているものを <strong>「制約付き vCPU 対応の VM サイズ」</strong> と定義しております。  </p><p>制約付き vCPU 対応の VM サイズには以下のような特徴がございます。  </p><ul><li>元の VM サイズから 1/2 または 1/4 に vCPU 数を減らしています。  </li><li>vCPU 数以外のスペック（メモリ容量・ディスクの仕様・NIC 数・ネットワーク帯域など）は元の VM サイズと同じ仕様です。  </li><li>全ての VM サイズに対し「制約付き vCPU 対応の VM サイズ」がご用意されているわけではございません。  </li><li>命名規則としては vCPU 数の部分が「元のvCPU数-実際のvCPU数」といった表記になっております。  </li></ul><p>制約付き vCPU 対応の VM サイズの一覧・仕様・価格などに関しては以下のドキュメントをご参照ください。  </p><blockquote><p>■ご参考：制約付き vCPU 対応の VM サイズ<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/constrained-vcpu">https://learn.microsoft.com/ja-jp/azure/virtual-machines/constrained-vcpu</a></p></blockquote><blockquote><p>■ご参考：Windows Virtual Machines の料金<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/virtual-machines/windows/">https://azure.microsoft.com/ja-jp/pricing/details/virtual-machines/windows/</a></p></blockquote><hr><h2 id="CPU-の種類について"><a href="#CPU-の種類について" class="headerlink" title="CPU の種類について"></a>CPU の種類について</h2><p>同じ VM サイズでも物理ホスト サーバーに搭載された CPU の種類が異なるため、VM の実行される CPU の種類が変わるといったことがございます。<br>例えば、以下のように Dv4 および Dsv4 シリーズは、ブログ執筆の 2023 年 4 月時点では、以下 2 種類の CPU でご提供をさせていただいております。  </p><blockquote><p>■ご参考：Dv4 および Dsv4 シリーズ<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/dv4-dsv4-series">https://learn.microsoft.com/ja-jp/azure/virtual-machines/dv4-dsv4-series</a></p></blockquote><blockquote><p>ーーーーーー抜粋ーーーーーー<br>Dv4 および Dsv4 シリーズは、ハイパースレッド構成の第 3 世代 Intel® Xeon® Platinum 8370C (Ice Lake) プロセッサまたは Intel® Xeon® Platinum 8272CL (Cascade Lake) プロセッサ上で実行されます。<br>ーーーーーーーーーーーーーー</p></blockquote><p>そのため、ご利用者様から見ると、  </p><ul><li>VM を割り当て解除 / 起動したら CPU の種類が変わった。</li><li>同じ VM サイズの VM を何台が使っているが、それぞれ別の種類の CPU で実行されている。</li></ul><p> ということが発生します。  </p><p>また、「特定の CPU の種類を選んで使いたい。」といったご要望も頂くことがございます。<br>恐縮ながら、後述の Azure Dedicated Host を利用する場合の除き、特定の CPU の種類を選んでご使用いただくことは叶いません.。 </p><p>なお、異なる CPU の種類で実行された場合も大きな性能差が出ないよう、目安として以下の ACU の範囲内での性能差となるように設計されております。  </p><blockquote><p>■ご参考：Azure コンピューティング ユニット (ACU)<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu">https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu</a></p></blockquote><div class="alert is-info"><p class="alert-title">Note</p><p>VM を割り当て解除および再デプロイしない場合は、原則 CPU の種類が変更されませんが、</p><p>予期せぬ物理ホストサーバーの不具合等で、別の CPU の種類の物理ホストサーバーに VM が移動される場合がございます。  </p></div><hr><h2 id="Azure-Dedicated-Host-で-CPU-の種類を選ぶ"><a href="#Azure-Dedicated-Host-で-CPU-の種類を選ぶ" class="headerlink" title="Azure Dedicated Host で CPU の種類を選ぶ"></a>Azure Dedicated Host で CPU の種類を選ぶ</h2><p>Azure Dedicated Host をご利用いただく場合に限り、CPU の種類を選ぶことが可能となります。<br>Azure Dedicated Host は物理ホストサーバー 1 台丸ごとをお客様に占有いただくサービスとなります。<br>物理ホストサーバーを選ぶ際に SKU として、VM ファミリと特定のハードウェア仕様の組み合わせを選択することとなり、この際にハードウェアに搭載される CPU の種類を選択することが可能です。  </p><p>例えば、Dsv4 シリーズを搭載できる Azure Dedicated Host SKU として、ブログ執筆の 2023 年 4 月時点では、以下の 2 種類があることが確認できます。  　</p><ul><li>Dsv4_Type1：Intel® Xeon® Platinum 8272CL (Cascade Lake)</li><li>Dsv4_Type2：Intel® Xeon® Platinum 8370C (Ice Lake) </li></ul><p>この占有されたホストサーバー上で稼働させれば、CPU が変更されることはないものとなります。<br>しかしながら、Azure Dedicated Host は物理ホストサーバー 1 台丸ごとをお客様に占有いただくため、通常の VM より高い利用料金が設定されております。<br>Azure Dedicated Host の概要や価格等については、以下の記事をご参照ください。  </p><blockquote><p>■ご参考：Azure 専用ホスト<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/dedicated-hosts">https://learn.microsoft.com/ja-jp/azure/virtual-machines/dedicated-hosts</a></p></blockquote><blockquote><p>■ご参考：Azure Dedicated Host の価格<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/virtual-machines/dedicated-host/">https://azure.microsoft.com/ja-jp/pricing/details/virtual-machines/dedicated-host/</a></p></blockquote><blockquote><p>■ご参考：汎用 Azure Dedicated Host SKU<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/dedicated-host-general-purpose-skus">https://learn.microsoft.com/ja-jp/azure/virtual-machines/dedicated-host-general-purpose-skus</a></p></blockquote><hr><h2 id="ターボブースト機能について"><a href="#ターボブースト機能について" class="headerlink" title="ターボブースト機能について"></a>ターボブースト機能について</h2><p>一時的に CPU クロックを向上させる技術として、  </p><ul><li>Intel® Turbo テクノロジ</li><li>AMD® Boost テクノロジ</li></ul><p>といった技術がございます。<br> ※ 以下「ターボブースト機能」と記載させていたせていただきます。  </p><p>多くの VM サイズではこのターボブースト機能が有効となっております。<br>しかしながら、ターボブースト機能によって実際に CPU クロックが向上している際も、お客様のゲスト OS からは CPU クロックは固定で表示されることがございます。<br>これは、物理ホストサーバー側にて制御が行われ、ゲスト OS は HW レジスタを直接参照できないことがあるためとなります。  </p><p>そのため恐れ入りますが、ターボブースト機能によってどの程度クロックが向上しているかについては、恐縮ながら確認が叶いません点ご理解賜りますと幸いです。<br>なお、ターボブースト機能は、あくまで余裕がある際にベースクロックよりパフォーマンスを向上させるものでございますので、ターボブースト機能が動作していない場合に性能が低下するものではなく、通常よりも性能が向上するといった機能でございます。  </p><blockquote><p>■ご参考：Azure コンピューティング ユニット (ACU)<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu">https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu</a></p></blockquote><blockquote><p>ーーーーーー抜粋ーーーーーー<br>*ACU は、Intel® Turbo テクノロジを使用して CPU 周波数を上げ、パフォーマンスを向上させます。 パフォーマンス向上の量は、VM のサイズ、ワークロードのほか、同じホストで実行されている他のワークロードによって変動する場合があります。<br>**ACU は、AMD® Boost テクノロジを使用して CPU 周波数を上げ、パフォーマンスを向上させます。 パフォーマンス向上の量は、VM のサイズ、ワークロードのほか、同じホストで実行されている他のワークロードによって変動する場合があります。<br>ーーーーーーーーーーーーーー  </p></blockquote><hr><p>以上の通り今回は Azure VM の CPU についてよくあるご質問の内容を解説させていただきました。<br>上記内容が皆様のお役に立てますと幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回はお問い合わせいただくことの多い Azure VM の CPU に関する以下の点を解説させていただきます。  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPU の vCPU 数 / 物理コア数 / 論理スレッド数</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Azure から OS にコマンドを発行する実行コマンド (RunCommand) 拡張機能について解説</title>
    <link href="https://jpaztech.github.io/blog/vm/runcommand/"/>
    <id>https://jpaztech.github.io/blog/vm/runcommand/</id>
    <published>2023-03-30T04:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.571Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポートチームの井上です。 </p><p>本記事では、Azure VM の拡張機能の一つである実行コマンド (RunCommand) について、<br>利用方法やアクション実行コマンドとマネージド実行コマンドの違い等を解説させていただきます。</p><span id="more"></span> <hr><h2 id="実行コマンドとは"><a href="#実行コマンドとは" class="headerlink" title="実行コマンドとは"></a>実行コマンドとは</h2><p>実行コマンドは、Azure VM の拡張機能の一つで、仮想マシン エージェントを使用して、<br>Windows または Linux の Azure VM 内でコマンドやスクリプトをリモートで実行することができる機能です。<br>特定のコマンドだけでなく、Windows の場合は PowerShell スクリプト、Linux の場合はシェル スクリプトで、<br>任意のカスタム スクリプトを指定して実行することが可能です。</p><p>例えば、接続不調となった VM に対して、疎通の状態等を確認するコマンドをリモートで実行するといったことや、<br>複数の VM に対してメンテナンス用のスクリプトを実行するといった用途にご活用いただけます。</p><blockquote><p><em><strong>実行コマンドを使用してお使いの VM でスクリプトを実行する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/run-command-overview">https://learn.microsoft.com/ja-jp/azure/virtual-machines/run-command-overview</a></p></blockquote><hr><h2 id="アクション実行コマンドとマネージド実行コマンド"><a href="#アクション実行コマンドとマネージド実行コマンド" class="headerlink" title="アクション実行コマンドとマネージド実行コマンド"></a>アクション実行コマンドとマネージド実行コマンド</h2><p>実行コマンドには、現在、アクション実行コマンドとマネージド実行コマンドの 2 種類があります。<br>マネージド実行コマンドは、2023 年 2 月に General Availability (GA) となっており、<br>アクション実行コマンドと比較し、以下の観点で機能が強化されています。<br>今後、実行コマンドの利用を予定されている場合は、まずはマネージド実行コマンドをご利用いただくことをご検討ください。</p><ul><li>ARM デプロイ テンプレートを介して更新された実行コマンドをサポート</li><li>複数のスクリプトの並列実行</li><li>スクリプトの順次実行</li><li>ユーザーが指定したスクリプトのタイムアウト</li><li>実行時間が長い (時間または日単位) のスクリプトをサポート</li><li>安全な方法でシークレット (パラメーター、パスワード) を渡す</li></ul><blockquote><p><em><strong>General Availability: Managed Run Command – Execute PowerShell or shell scripts on Virtual Machines and Scale Sets</strong></em><br><a href="https://azure.microsoft.com/en-us/updates/general-availability-run-command-execute-powershell-or-shell-scripts-on-virtual-machines-and-scale-sets/">https://azure.microsoft.com/en-us/updates/general-availability-run-command-execute-powershell-or-shell-scripts-on-virtual-machines-and-scale-sets/</a></p></blockquote><blockquote><p><em><strong>実行コマンドを使用してお使いの VM でスクリプトを実行する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/run-command-overview#compare-feature-support">https://learn.microsoft.com/ja-jp/azure/virtual-machines/run-command-overview#compare-feature-support</a></p></blockquote><div class="alert is-info"><p class="alert-title">Note</p><p>マネージド実行コマンドは、2023 年 3 月現在、Azure CLI、Azure PowerShell、REST API で使用できます。</p></div><p>基本的な利用方法につきましては、こちらの公開ドキュメントも併せてご確認ください。</p><blockquote><p><em><strong>実行コマンド アクションを使用して Linux VM でスクリプトを実行する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/run-command">https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/run-command</a></p><p><em><strong>アクション実行コマンドを使用して、Windows VM でスクリプトを実行する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command</a></p><p><em><strong>マネージド実行コマンドを使用して Linux VM でスクリプトを実行する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/run-command-managed">https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/run-command-managed</a></p><p><em><strong>マネージド実行コマンドを使用して Windows VM でスクリプトを実行する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed</a></p></blockquote><hr><h2 id="実行コマンドをデプロイする"><a href="#実行コマンドをデプロイする" class="headerlink" title="実行コマンドをデプロイする"></a>実行コマンドをデプロイする</h2><h3 id="仮想マシンで実行する"><a href="#仮想マシンで実行する" class="headerlink" title="仮想マシンで実行する"></a>仮想マシンで実行する</h3><p>マネージド実行コマンドとアクション実行コマンドでは、Azure PowerShell/CLI のコマンドに違いがあり、<br>それぞれのコマンドをご利用いただくことで使い分けることができます。<br>仮想マシンで実行コマンドを利用する際のコマンドについては、こちらの比較表をご参照ください。</p><h4 id="Azure-PowerShell"><a href="#Azure-PowerShell" class="headerlink" title="Azure PowerShell"></a>Azure PowerShell</h4><table><thead><tr><th align="left">操作</th><th align="left">アクション実行コマンド</th><th align="left">マネージド実行コマンド</th></tr></thead><tbody><tr><td align="left">実行<br>作成・更新 ※1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command#powershell"><strong>Invoke</strong>-AzVMRunCommand</a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#execute-a-script-with-the-vm-1"><strong>Set</strong>-AzVMRunCommand</a></td></tr><tr><td align="left">削除</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command#action-run-command-removal"><strong>Invoke</strong>-AzVMRunCommand</a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#delete-runcommand-resource-from-the-vm-1"><strong>Remove</strong>-AzVMRunCommand</a></td></tr><tr><td align="left">一覧表示 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#list-all-deployed-runcommand-resources-on-a-vm-1"><strong>Get</strong>-AzVMRunCommand</a> ※2</td></tr><tr><td align="left">実行状態と結果の取得 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#get-execution-status-and-results-1"><strong>Get</strong>-AzVMRunCommand</a> ※2</td></tr></tbody></table><h4 id="Azure-CLI"><a href="#Azure-CLI" class="headerlink" title="Azure CLI"></a>Azure CLI</h4><table><thead><tr><th align="left">操作</th><th align="left">アクション実行コマンド</th><th align="left">マネージド実行コマンド</th></tr></thead><tbody><tr><td align="left">実行<br>作成・更新 ※1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command#azure-cli">az vm run-command <strong>invoke</strong></a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#execute-a-script-with-the-vm">az vm run-command <strong>create</strong></a><br><a href="https://learn.microsoft.com/ja-jp/cli/azure/vm/run-command?view=azure-cli-latest#az-vm-run-command-update">az vm run-command <strong>update</strong></a></td></tr><tr><td align="left">削除</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command#action-run-command-removal">az vm run-command <strong>invoke</strong></a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#delete-runcommand-resource-from-the-vm">az vm run-command <strong>delete</strong></a></td></tr><tr><td align="left">一覧表示 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#list-all-deployed-runcommand-resources-on-a-vm">az vm run-command <strong>list</strong></a></td></tr><tr><td align="left">実行状態と結果の取得 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#get-execution-status-and-results">az vm run-command <strong>show</strong></a></td></tr></tbody></table><p>※1 : マネージド実行コマンドのみで実行可能な操作です。<br>※2 : パラメータで操作を使い分けます。詳細につきましては、リンク先の公開ドキュメントをご確認ください。</p><p>アクション実行コマンドで、仮想マシン上でカスタム スクリプトを実行する際のコマンド例は、以下のとおりとなります。</p><figure class="highlight powershell"><figcaption><span>Windows 仮想マシンの場合</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-AzVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-Name</span> &lt;仮想マシン リソース名&gt; `</span><br><span class="line">  <span class="literal">-CommandId</span> <span class="string">&#x27;RunPowerShellScript&#x27;</span> `</span><br><span class="line">  <span class="literal">-ScriptPath</span> <span class="string">&#x27;&lt;実行するスクリプトのパス&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>また、アクション実行コマンドは、Azure Portal 上で実行することができます。<br>VM の <strong>[実行コマンド]</strong> ブレードから、カスタム スクリプトや組み込みのスクリプトを実行できます。</p><p><img src="/blog/vm/runcommand/001.png"></p><p>マネージド実行コマンドで、仮想マシン上でカスタム スクリプトを実行する際のコマンド例は、以下のとおりとなります。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-VMName</span> &lt;仮想マシン リソース名&gt; `</span><br><span class="line">  <span class="literal">-Location</span> &lt;リージョン名&gt; `</span><br><span class="line">  <span class="literal">-RunCommandName</span> &lt;任意の実行コマンド名&gt; `</span><br><span class="line">  <span class="literal">-ScriptLocalPath</span> <span class="string">&#x27;&lt;実行するスクリプトのパス&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>なお、実行コマンドをご利用いただく際は、仮想マシンが実行中の状態であることをご確認ください。</p><p>アクション実行コマンドは、一度実行すると、最終的なスクリプトの実行結果が出力されるのみでした。<br>マネージド実行コマンドでは、初回の実行時に実行コマンドが仮想マシンに登録され、<br>実行の進行状況 (最新の出力、開始/終了時刻、終了コード、および実行の終了状態など) を確認することができます。<br>また、登録された実行コマンドは更新して再実行することができ、不要になり次第、削除することができます。</p><p><img src="/blog/vm/runcommand/002.png"></p><h2 id="仮想マシン-スケール-セット-VMSS-で実行する"><a href="#仮想マシン-スケール-セット-VMSS-で実行する" class="headerlink" title="仮想マシン スケール セット (VMSS) で実行する"></a>仮想マシン スケール セット (VMSS) で実行する</h2><p>実行コマンドは、仮想マシン スケール セット (VMSS) で利用することができます。<br>仮想マシンで実行する場合と同様に、アクション実行コマンドとマネージド実行コマンドで、<br>Azure PowerShell/CLI のコマンドに違いがあります。こちらの比較表をご参照ください。</p><h4 id="Azure-PowerShell-1"><a href="#Azure-PowerShell-1" class="headerlink" title="Azure PowerShell"></a>Azure PowerShell</h4><table><thead><tr><th align="left">操作</th><th align="left">アクション実行コマンド</th><th align="left">マネージド実行コマンド</th></tr></thead><tbody><tr><td align="left">実行<br>作成・更新・追加 ※1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/invoke-azvmssvmruncommand"><strong>Invoke</strong>-AzVmssVMRunCommand</a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/set-azvmssvmruncommand"><strong>Set</strong>-AzVmssVMRunCommand</a><br><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/add-azvmssruncommand"><strong>Add</strong>-AzVmssRunCommand</a></td></tr><tr><td align="left">削除</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/invoke-azvmssvmruncommand"><strong>Invoke</strong>-AzVmssVMRunCommand</a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmssvmruncommand"><strong>Remove</strong>-AzVmssVMRunCommand</a><br><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmssruncommand"><strong>Remove</strong>-AzVmssRunCommand</a></td></tr><tr><td align="left">一覧表示 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/get-azvmssvmruncommand"><strong>Get</strong>-AzVmssVMRunCommand</a> ※2</td></tr><tr><td align="left">実行状態と結果の取得 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/get-azvmssvmruncommand"><strong>Get</strong>-AzVmssVMRunCommand</a> ※2</td></tr></tbody></table><h4 id="Azure-CLI-1"><a href="#Azure-CLI-1" class="headerlink" title="Azure CLI"></a>Azure CLI</h4><table><thead><tr><th align="left">操作</th><th align="left">アクション実行コマンド</th><th align="left">マネージド実行コマンド</th></tr></thead><tbody><tr><td align="left">実行<br>作成・更新 ※1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-invoke">az vmss run-command <strong>invoke</strong></a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-create">az vmss run-command <strong>create</strong></a><br><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-update">az vmss run-command <strong>update</strong></a></td></tr><tr><td align="left">削除</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-invoke">az vmss run-command <strong>invoke</strong></a> ※2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-delete">az vmss run-command <strong>delete</strong></a></td></tr><tr><td align="left">一覧表示 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-list">az vmss run-command <strong>list</strong></a></td></tr><tr><td align="left">実行状態と結果の取得 ※1</td><td align="left">-</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/cli/azure/vmss/run-command?view=azure-cli-latest#az-vmss-run-command-show">az vmss run-command <strong>show</strong></a></td></tr></tbody></table><p>※1 : マネージド実行コマンドのみで実行可能な操作です。<br>※2 : パラメータで操作を使い分けます。詳細につきましては、リンク先の公開ドキュメントをご確認ください。</p><p>アクション実行コマンドで、VMSS 内の仮想マシン (インスタンス ID が <code>0</code> ) 上で、<br>カスタム スクリプトを実行する際のコマンド例は、以下のとおりとなります。</p><figure class="highlight powershell"><figcaption><span>Windows 仮想マシンの場合</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-AzVmssVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-VMScaleSetName</span> &lt;VMSS リソース名&gt; `</span><br><span class="line">  <span class="literal">-InstanceId</span> <span class="number">0</span> `</span><br><span class="line">  <span class="literal">-CommandId</span> <span class="string">&#x27;RunPowerShellScript&#x27;</span> `</span><br><span class="line">  <span class="literal">-ScriptPath</span> <span class="string">&#x27;&lt;実行するスクリプトのパス&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>マネージド実行コマンドで、VMSS 内の仮想マシン (インスタンス ID が <code>0</code> ) 上で、<br>カスタム スクリプトを実行する際のコマンド例は、以下のとおりとなります。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVmssVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-VMScaleSetName</span> &lt;VMSS リソース名&gt; `</span><br><span class="line">  <span class="literal">-Location</span> &lt;リージョン名&gt; `</span><br><span class="line">  <span class="literal">-InstanceId</span> <span class="number">0</span> `</span><br><span class="line">  <span class="literal">-RunCommandName</span> &lt;任意の実行コマンド名&gt; `</span><br><span class="line">  <span class="literal">-ScriptLocalPath</span> <span class="string">&#x27;&lt;実行するスクリプトのパス&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>また、マネージド実行コマンドでは、VMSS 内の全ての仮想マシンに実行コマンドを追加する<br><code>Add-AzVmssRunCommand</code> が利用できます。<br><code>Remove-AzVmssRunCommand</code> で実行コマンドを削除することも可能です。</p><p>なお、実行コマンドをご利用いただく際は、VMSS 内の仮想マシンが実行中の状態であることをご確認ください。</p><div class="alert is-info"><p class="alert-title">Note</p><p>仮想マシン スケール セット (VMSS) のオーケストレーション モードが Uniform の場合に、VMSS のコマンド (<code>Set-AzVmssVMRunCommand</code> 等) が利用できます。</p><p>Flexible の場合は、VMSS 内の各仮想マシンに対して、仮想マシンのコマンド (<code>Set-AzVMRunCommand</code> 等) を実行する必要があります。</p></div><hr><h2 id="実行するスクリプトを指定する"><a href="#実行するスクリプトを指定する" class="headerlink" title="実行するスクリプトを指定する"></a>実行するスクリプトを指定する</h2><p>実行コマンドでは、実行するコマンドをパラメータで直接指定することができます。<br>また、カスタム スクリプトを指定する場合は、<br>アクション実行コマンドとマネージド実行コマンドで指定可能なソースに違いがあり、<br>マネージド実行コマンドでは、BLOB ストレージの SAS URL が指定可能となっています。</p><p>アクション実行コマンドの場合は、<code>Invoke-AzVMRunCommand</code> の以下のいずれかのパラメータで指定します。</p><ul><li><code>-ScriptString</code> : 実行するコマンド<br>例 : ping 10.0.0.1</li><li><code>-ScriptPath</code> : <code>Invoke-AzVMRunCommand</code> を実行する環境のローカル ファイル パス<br>例 : C:\work\test.ps1</li></ul><p>マネージド実行コマンドの場合は、<code>Set-AzVMRunCommand / Set-AzVmssVMRunCommand</code> の以下のいずれかのパラメータで指定します。</p><ul><li><code>-SourceScript</code> : 実行するコマンド<br>例 : ping 10.0.0.1</li><li><code>-ScriptLocalPath</code> : <code>Set-AzVMRunCommand / Set-AzVmssVMRunCommand</code> を実行する環境のローカル ファイル パス<br>例 : C:\work\test.ps1</li><li><code>-SourceScriptUri</code> : スクリプトを配置した BLOB ストレージ の SAS URL<br>例 : https://{ストレージ アカウント名}.blob.core.windows.net/{BLOB コンテナ名}/test.ps1?{SAS}</li></ul><hr><h2 id="スクリプトの出力内容を確認する"><a href="#スクリプトの出力内容を確認する" class="headerlink" title="スクリプトの出力内容を確認する"></a>スクリプトの出力内容を確認する</h2><p>Azure テクニカル サポートチームでは、実行コマンドの拡張機能を有効または無効とされた際のエラーや<br>拡張機能のアップデート時のエラー等につきまして、調査をご支援させていただくことが可能です。<br>その一方で、お客様にて作成されたスクリプトにつきましては、<br>お客様がご自身でトラブルシューティングを実施していただくことが必要となります。</p><p>トラブルシューティングの際に、コマンドの実行結果やエラー等を確認したい場合は、<br>アクション実行コマンドでは実行時の出力結果をご確認いただきます。<br>マネージド実行コマンドでは、状態を取得した上で、InstanceView からご確認いただけます。<br>ただし、これらの出力結果は、実際の出力内容の最後の 4 KB のみとなります。</p><p>マネージド実行コマンドで出力結果を確認する際のコマンド例は以下のとおりとなります。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-AzVMRunCommand</span> <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; <span class="literal">-VMName</span> &lt;仮想マシン リソース名&gt; <span class="literal">-RunCommandName</span> &lt;実行コマンド名&gt; <span class="literal">-Expand</span> InstanceView).InstanceView</span><br></pre></td></tr></table></figure><p>InstanceView の出力例はこちらになります。<br><code>ExecutionState</code> にスクリプトの実行が成功したかどうかが表示されます。<br><code>Output</code> でスクリプトが正常に終了した場合の出力結果、<br><code>Error</code> でスクリプトの途中でエラーとなった場合の出力結果が確認できます。<br><code>StartTime/EndTime</code> でスクリプトの実行開始時刻および終了時刻が確認できます。</p><p><img src="/blog/vm/runcommand/003.png" alt="デスクトップにファイルを生成するスクリプトを実行した場合の出力例"></p><blockquote><p><em><strong>実行コマンドの作成または更新後に VM の実行コマンド インスタンス ビューを取得する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#get-a-run-command-instance-view-for-a-vm-after-creating-or-updating-run-command">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#get-a-run-command-instance-view-for-a-vm-after-creating-or-updating-run-command</a></p></blockquote><p>4 KB を超える出力内容をご確認いただく方法として、マネージド実行コマンドでは、<br>標準出力と標準エラー メッセージを追加 BLOB にストリーミングして、ご確認いただくことが可能です。<br>ストリーミング先の追加 BLOB は、BLOB の SAS URL を指定することができます。<br>コマンド例は、以下のとおりとなります。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-VMName</span> &lt;仮想マシン リソース名&gt; `</span><br><span class="line">  <span class="literal">-Location</span> &lt;リージョン名&gt; `</span><br><span class="line">  <span class="literal">-RunCommandName</span> &lt;実行コマンド名&gt; `</span><br><span class="line">  <span class="literal">-ScriptLocalPath</span> <span class="string">&quot;&lt;実行するスクリプトのパス&gt;&quot;</span> `</span><br><span class="line">  <span class="literal">-OutputBlobUri</span> <span class="string">&quot;https://&#123;出力先のストレージ アカウント名&#125;.blob.core.windows.net/&#123;BLOB コンテナ名&#125;/output.txt?&#123;SAS&#125;&quot;</span> `</span><br><span class="line">  <span class="literal">-ErrorBlobUri</span> <span class="string">&quot;https://&#123;出力先のストレージ アカウント名&#125;.blob.core.windows.net/&#123;BLOB コンテナ名&#125;/error.txt?&#123;SAS&#125;&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p><em><strong>OutputBlobUri、ErrorBlobUri を使用して VM で実行コマンドを作成または更新し、標準出力と標準エラー メッセージを出力およびエラー追加 BLOB にストリーミングする</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#create-or-update-run-command-on-a-vm-using-outputbloburi-errorbloburi-to-stream-standard-output-and-standard-error-messages-to-output-and-error-append-blobs">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#create-or-update-run-command-on-a-vm-using-outputbloburi-errorbloburi-to-stream-standard-output-and-standard-error-messages-to-output-and-error-append-blobs</a></p></blockquote><hr><h2 id="スクリプトを実行するユーザについて"><a href="#スクリプトを実行するユーザについて" class="headerlink" title="スクリプトを実行するユーザについて"></a>スクリプトを実行するユーザについて</h2><p>アクション実行コマンドでは、Windows の場合はシステム アカウント、Linux の場合はルート ユーザで実行されます。</p><p>マネージド実行コマンドでは、実行するユーザを指定することができます。<br>ユーザを指定しない場合は、アクション実行コマンドと同様に、<br>Windows の場合はシステム アカウント、Linux の場合はルート ユーザで実行されます。<br>実行するユーザを指定する際のコマンド例は、以下のとおりとなります。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-VMName</span> &lt;仮想マシン リソース名&gt; `</span><br><span class="line">  <span class="literal">-Location</span> &lt;リージョン名&gt; `</span><br><span class="line">  <span class="literal">-RunCommandName</span> &lt;任意の実行コマンド名&gt; `</span><br><span class="line">  <span class="literal">-ScriptLocalPath</span> <span class="string">&quot;&lt;実行するスクリプトのパス&gt;&quot;</span> `</span><br><span class="line">  <span class="literal">-RunAsUser</span> &lt;実行ユーザ名&gt; `</span><br><span class="line">  <span class="literal">-RunAsPassword</span> &lt;実行ユーザのパスワード&gt;</span><br></pre></td></tr></table></figure><blockquote><p><em><strong>RunAsUser および RunAsPassword パラメーターを使用して別のユーザーとして VM で実行コマンドを作成または更新する</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#create-or-update-run-command-on-a-vm-as-a-different-user-using-runasuser-and-runaspassword-parameters">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/run-command-managed#create-or-update-run-command-on-a-vm-as-a-different-user-using-runasuser-and-runaspassword-parameters</a></p></blockquote><hr><h2 id="複数の仮想マシンでスクリプトを実行する"><a href="#複数の仮想マシンでスクリプトを実行する" class="headerlink" title="複数の仮想マシンでスクリプトを実行する"></a>複数の仮想マシンでスクリプトを実行する</h2><p>複数の仮想マシンで同じスクリプトを実行したい場合は、スクリプトを実行する仮想マシンのリストを取得して、<br>Azure CLI または Azure PowerShell のコマンドを繰り返し実行することで実現できます。<br>REST API をご利用いただく場合も同様に実現可能です。</p><p>例えば、<code>testtag</code> というタグの値が <code>y</code> となっている全ての仮想マシンでスクリプトを実行したい場合、<br>コマンド例は以下のとおりとなります。</p><figure class="highlight powershell"><figcaption><span>マネージド実行コマンド コマンド例 (Azure PowerShell/PowerShell 7)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$VMList</span> = <span class="selector-tag">@</span>(<span class="built_in">Get-AzResource</span> <span class="literal">-Tag</span> <span class="selector-tag">@</span>&#123;<span class="string">&#x27;testtag&#x27;</span>=<span class="string">&#x27;y&#x27;</span>&#125;) </span><br><span class="line"><span class="variable">$VMList</span> | <span class="built_in">Foreach-Object</span> <span class="literal">-Parallel</span> &#123;<span class="built_in">Set-AzVMRunCommand</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$_</span>.ResourceGroupName <span class="literal">-VMName</span> <span class="variable">$_</span>.name <span class="literal">-Location</span> &lt;リージョン名&gt; <span class="literal">-RunCommandName</span> <span class="string">&#x27;&lt;任意の実行コマンド名&gt;&#x27;</span> <span class="literal">-ScriptLocalPath</span> <span class="string">&#x27;&lt;実行するスクリプトのパス&gt;&#x27;</span>&#125;  </span><br></pre></td></tr></table></figure><div class="alert is-info"><p class="alert-title">Note</p><p>実行コマンドを繰り返し実行する際、Azure Resource Manager (ARM) の要求スロットルの上限に達して、要求がエラーとなる可能性があります。</p><p>複数の VM でスクリプトをリモート実行される要件がある場合は、検証等を実施していただき、問題なくスクリプトが実行できることを予めご確認いただくことを推奨します。</p><p>&emsp;</p><p><em><strong>Resource Manager の要求のスロットル</strong></em></p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/request-limits-and-throttling#error-code">https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/request-limits-and-throttling#error-code</a></p><p><em><strong>API の調整エラーのトラブルシューティング</strong></em></p><p><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshooting-throttling-errors">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshooting-throttling-errors</a></p></div><hr><h2 id="長時間のスクリプトを実行する"><a href="#長時間のスクリプトを実行する" class="headerlink" title="長時間のスクリプトを実行する"></a>長時間のスクリプトを実行する</h2><p>アクション実行コマンドでは、スクリプトを実行可能な最大時間が 90 分という制約がありましたが、<br>マネージド実行コマンドでは、実行時間が 90 分を超えるスクリプトの実行が可能です。<br>マネージド実行コマンドにおいて、長時間のスクリプトを実行する際には、<br>Azure PowerShell の場合は、以下のパラメータを指定する必要があります。</p><ul><li><code>timeoutInSeconds</code> パラメータを予測される実行時間よりも大きく指定する。</li><li><code>asyncExecution</code> パラメータを <code>true</code> とする。</li></ul><div class="alert is-info"><p class="alert-title">Note</p><p><code>timeoutInSeconds</code> パラメータでは、スクリプトのタイムアウト値を秒で指定します。</p><p><code>asyncExecution</code> パラメータは、デフォルトでは false となっており、スクリプトが完了するまでプロビジョニングが待機する設定となっていますので、90 分でプロビジョニングのタイムアウトが発生します。回避するためには、<code>true</code> を指定します。</p></div><p>タイムアウト値を 5 時間に指定する際のコマンド例は以下のとおりです。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVMRunCommand</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> &lt;リソース グループ名&gt; `</span><br><span class="line">  <span class="literal">-VMName</span> &lt;仮想マシン リソース名&gt; `</span><br><span class="line">  <span class="literal">-Location</span> &lt;リージョン名&gt; `</span><br><span class="line">  <span class="literal">-RunCommandName</span> &lt;任意の実行コマンド名&gt; `</span><br><span class="line">  <span class="literal">-ScriptLocalPath</span> <span class="string">&quot;&lt;実行するスクリプトのパス&gt;&quot;</span> `</span><br><span class="line">  <span class="literal">-TimeoutInSecond</span> <span class="number">18000</span> `</span><br><span class="line">  <span class="literal">-AsyncExecution</span> true</span><br></pre></td></tr></table></figure><hr><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>この記事では、 実行コマンドの利用方法について解説しました。<br>Azure VM にてスクリプトをリモートで実行されるご要件がある場合や、<br>アクション実行コマンドからマネージド実行コマンドに運用を移行される際のご参考としていただけますと幸いでございます。 </p><p>マネージド実行コマンドでは、本記事で解説した機能に加え、<br>1 台の VM で複数のスクリプトを同時実行する機能 (ARM テンプレート利用)やギャラリー機能等がご利用いただけます。<br>記事内でご案内いたしました公開ドキュメントも併せてご確認ください。</p><p>上記の解説内容が、皆様のお役に立てますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポートチームの井上です。 &lt;/p&gt;
&lt;p&gt;本記事では、Azure VM の拡張機能の一つである実行コマンド (RunCommand) について、&lt;br&gt;利用方法やアクション実行コマンドとマネージド実行コマンドの違い等を解説させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure マーケットプレイスのイメージの OS ディスクサイズの確認・拡張・縮小について</title>
    <link href="https://jpaztech.github.io/blog/vm/os-disk-size-of-image/"/>
    <id>https://jpaztech.github.io/blog/vm/os-disk-size-of-image/</id>
    <published>2023-02-22T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.543Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの富田です。<br>今回はお問い合わせいただくことの多い、Azure マーケットプレイスのイメージの OS ディスクサイズについて、<br>確認方法・拡張方法・縮小不可などの点について解説させていただきます。  </p><span id="more"></span><hr><h2 id="1-イメージの-URN-を把握する"><a href="#1-イメージの-URN-を把握する" class="headerlink" title="1.イメージの URN を把握する"></a>1.イメージの URN を把握する</h2><p>イメージの OS ディスクサイズを確認や、コマンドベースでイメージを指定してデプロイを行う場合は、<br>まずは当該イメージの URN（Uniform Resource Name）を把握する必要があります。<br>イメージの URN は以下のような 4 つの情報の組み合わせで構成されています。  </p><ul><li>Publisher</li><li>Offer</li><li>Sku</li><li>Version</li></ul><p>この 4 つの情報を組み合わせることで、特定のイメージが指定できるということになります。<br>例えば、Azure マーケットプレイス に公開されている 2022/12/29 時点で最新の Windows Server 2022 Datacenter: Azure Edition の URN 以下のようになります。 </p><ul><li>Publisher : microsoftwindowsserver</li><li>Offer : windowsserver</li><li>Sku : 2022-datacenter-azure-edition</li><li>Version : 20348.1366.221207</li></ul><p>ここでひとつ注意したい点は、Azure マーケットプレイスのイメージにおける Version は、あくまでイメージの Version であって、<br>「Windows Server 2012」「Windows Server 2019」といった OS の違いは、Sku の方で定義されているということです。  </p><p>同じ Windows Server 2022 Datacenter: Azure Edition でも、イメージの Version が古いものはビルド等が古いといったこととなります。  </p><p>では、実際にこの URN をどうやって確認するのか、「Azure ポータル」「Azure PowerShell」「Azure CLI」それぞれで確認する方法から見ていきましょう。  </p><hr><h2 id="1-1-Azure-ポータルでイメージの-URN-を把握する"><a href="#1-1-Azure-ポータルでイメージの-URN-を把握する" class="headerlink" title="1-1.Azure ポータルでイメージの URN を把握する"></a>1-1.Azure ポータルでイメージの URN を把握する</h2><p>Azure ポータルにログインし、「リソースの作成」を選択します。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-11-32-56.png"></p><p>「リソースの作成」画面の検索ボックスより、Azure マーケットプレイスのイメージを検索します。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-11-33-57.png"></p><p>対象のイメージを選択します。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-11-34-57.png"></p><p>対象のイメージの画面上で、「プラン」を選択の上、「使用状況確認とサポート」タブを選択します。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-11-43-09.png"></p><p>上記のように、URN が表示されます。<br>恐縮ながら Azure ポータルでは Version の一覧の確認は叶いませんため、Version について確認が必要な場合は、後述のコマンドベースでのご確認をお願いいたします。<br>稀に上記のポータルの表示が URN と一致しないケースがございますので、その際は後述の「Azure PowerShell」「Azure CLI」でご確認くださいませ。</p><hr><h2 id="1-2-Azure-PowerShell-でイメージの-URN-を把握する"><a href="#1-2-Azure-PowerShell-でイメージの-URN-を把握する" class="headerlink" title="1-2.Azure PowerShell でイメージの URN を把握する"></a>1-2.Azure PowerShell でイメージの URN を把握する</h2><p>基本的に以下の公式ドキュメントの方法となりますが、実際にコマンドの実行結果と共に見ていきましょう。<br>Publisher → Offer → Sku → Version の順で絞り込んで検索していくような形となります。</p><blockquote><p>■ご参考：Azure PowerShell を使用して Azure Marketplace VM イメージを検索して使用する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/cli-ps-findimage">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/cli-ps-findimage</a></p></blockquote><p>まずは、リージョンを指定して Publisher の一覧を取得します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>リージョン名は下記コマンドで Location として表示されるものを使います。</p><p>Get-AzLocation | select Location, DisplayName</p></div><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$locName = &quot;リージョン名&quot;</span><br><span class="line">Get-AzVMImagePublisher -Location $locName | Select PublisherName</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。Publisher の一覧が表示されていますね。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-12-20-08.png"></p><p>次に、確認した Publisher を指定してその Publisher が公開している Offer の一覧を表示しましょう。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$locName = &quot;リージョン名&quot;</span><br><span class="line">$pubName = &quot;パブリッシャー名&quot;</span><br><span class="line">Get-AzVMImageOffer -Location $locName -PublisherName $pubName | Select Offer</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。Publisher が公開している Offer の一覧が表示されました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-12-04-16.png"></p><p>次に、確認した Offer を指定してその Offer 内の Sku の一覧を表示しましょう。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$locName = &quot;リージョン名&quot;</span><br><span class="line">$pubName=&quot;パブリッシャー名&quot;</span><br><span class="line">$offerName = &quot;オファー名&quot;</span><br><span class="line">Get-AzVMImageSku -Location $locName -PublisherName $pubName -Offer $offerName | Select Skus</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。指定した Offer 内の Sku の一覧が表示されました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-12-06-44.png"></p><p>最後に、Sku を指定してその Sku 内の Version の一覧を調べましょう。  </p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$locName = &quot;リージョン名&quot;</span><br><span class="line">$pubName=&quot;パブリッシャー名&quot;</span><br><span class="line">$offerName = &quot;オファー名&quot;</span><br><span class="line">$skuName = &quot;SKU 名&quot;</span><br><span class="line">Get-AzVMImage -Location $locName -PublisherName $pubName -Offer $offerName -Sku $skuName | Select PublisherName, Offer, Skus, Version</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。<br>無事に Version 一覧も取得でき、Publisher, Offer, Sku, Version の組み合わせでイメージの URN が把握できました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-12-11-28.png"></p><hr><h2 id="1-3-Azure-CLI-でイメージの-URN-を把握する"><a href="#1-3-Azure-CLI-でイメージの-URN-を把握する" class="headerlink" title="1-3.Azure CLI でイメージの URN を把握する"></a>1-3.Azure CLI でイメージの URN を把握する</h2><p>基本的に以下の公式ドキュメントの方法となりますが、実際にコマンドの実行結果と共に見ていきましょう。<br>Publisher → Offer → Sku → Version の順で絞り込んで検索していくような形となります。</p><blockquote><p>■ご参考：Azure CLI を使用して Azure Marketplace イメージ情報を検索する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/cli-ps-findimage">https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/cli-ps-findimage</a></p></blockquote><p>まずは、リージョンを指定して Publisher の一覧を取得します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>リージョン名は下記コマンドで name として表示されるものを使います。</p><p>az account list-locations</p></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-publishers --location ＜リージョン名＞ --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。Publisher の一覧が表示されていますね。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-13-38-26.png"></p><p>次に、確認した Publisher を指定してその Publisher が公開している Offer の一覧を表示しましょう。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-offers --location ＜リージョン名＞ --publisher ＜パブリッシャー名＞ --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。Publisher が公開している Offer の一覧が表示されました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-13-39-16.png"></p><p>次に、確認した Offer を指定してその Offer 内の Sku の一覧を表示しましょう。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-skus --location ＜リージョン名＞ --publisher ＜パブリッシャー名＞ --offer ＜オファー名＞ --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。指定した Offer 内の Sku の一覧が表示されました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-13-40-26.png"></p><p>最後に、Sku を指定してその Sku 内の Version の一覧を調べましょう。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">az vm image list \</span><br><span class="line">    --location ＜リージョン名＞ \</span><br><span class="line">    --publisher ＜パブリッシャー名＞ \</span><br><span class="line">    --offer ＜オファー名＞  \</span><br><span class="line">    --sku ＜SKU 名＞ \</span><br><span class="line">    --all --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。<br>無事に Version 一覧も取得でき、Publisher, Offer, Sku, Version の組み合わせでイメージの URN が把握できました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-13-43-57.png"></p><hr><h2 id="2-イメージの-OS-ディスクサイズを確認する"><a href="#2-イメージの-OS-ディスクサイズを確認する" class="headerlink" title="2.イメージの OS ディスクサイズを確認する"></a>2.イメージの OS ディスクサイズを確認する</h2><p>上述の方法でイメージ URN を把握すれば、 Azure CLI の下記コマンド使用することで、そのイメージの OS ディスクサイズを確認することが可能です。<br>なお恐縮ながら Azure PowerShell では確認が叶いませんものと存じます。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image show --location ＜リージョン名＞ --urn ＜パブリッシャー名＞:＜オファー名＞:＜SKU 名＞:＜バージョン番号＞</span><br></pre></td></tr></table></figure><div class="alert is-success"><p class="alert-title">ヒント</p><p>最新のバージョンとして ＜バージョン番号＞ に latest という文字列を使用することが可能です。</p></div><p>コマンドの実行結果を見ると以下の通り、OS ディスクサイズに関する表記が確認できます。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-14-03-40.png"></p><hr><h2 id="3-Windows-のイメージの既定-OS-ディスクサイズについて"><a href="#3-Windows-のイメージの既定-OS-ディスクサイズについて" class="headerlink" title="3.Windows のイメージの既定 OS ディスクサイズについて"></a>3.Windows のイメージの既定 OS ディスクサイズについて</h2><p>2023 年 1 月時点で、Azure マーケットプレイスで Microsoft より公開されている Windows のイメージについては、<br>OS ディスクサイズは既定で 127 GB となっております。  </p><p>しかしながら、これよりも小さな OS ディスクが必要なお客様のために、Windows Server については、<br>smalldisk というプラン（Offer）で OS ディスクが 30 GB となっているイメージをご用意しております。<br>基本的にディスクサイズが違う点以外、イメージの内容は通常版と差異は無いものと存じますため、<br>Windows Server で小さな OS ディスクが必要な場合は smalldisk のイメージをご利用くださいませ。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-14-32-25.png"></p><blockquote><p>■ご参考：New smaller Windows Server IaaS Image<br><a href="https://azure.microsoft.com/ja-jp/blog/new-smaller-windows-server-iaas-image/">https://azure.microsoft.com/ja-jp/blog/new-smaller-windows-server-iaas-image/</a></p></blockquote><hr><h2 id="4-OS-ディスクサイズの拡張について"><a href="#4-OS-ディスクサイズの拡張について" class="headerlink" title="4.OS ディスクサイズの拡張について"></a>4.OS ディスクサイズの拡張について</h2><div class="alert is-success"><p class="alert-title">ヒント</p><p>2023 年 10 月頃に、Azure ポータルでもイメージによっては新規 VM デプロイ時に OS ディスクのサイズが選択できるようになりました。  </p></div><p>OS ディスクサイズは以下の通り、VM デプロイ後に後から拡張することが可能です。</p><blockquote><p>■ご参考：Windows 仮想マシンに接続されている仮想ハード ディスクを拡張する方法<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/expand-os-disk">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/expand-os-disk</a></p></blockquote><blockquote><p>■ご参考：Linux VM の仮想ハード ディスクを拡張する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/expand-disks">https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/expand-disks</a></p></blockquote><p>また、Azure CLI を用いた場合、 az vm create コマンドで新規 VM をデプロイする際に、<br>–os-disk-size-gb オプションに数値を指定いただくと、指定いただいた GB のサイズで OS ディスクが作成されます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm create --resource-group ＜リソースグループ名＞ --name ＜VM 名＞ --image ＜パブリッシャー名＞:＜オファー名＞:＜SKU 名＞:＜バージョン番号＞ --os-disk-size-gb ＜OS ディスクサイズ GB の数値＞ </span><br></pre></td></tr></table></figure><blockquote><p>■ご参考：az vm create<br><a href="https://learn.microsoft.com/ja-jp/cli/azure/vm?view=azure-cli-latest#az-vm-create">https://learn.microsoft.com/ja-jp/cli/azure/vm?view=azure-cli-latest#az-vm-create</a></p></blockquote><div class="alert is-info"><p class="alert-title">Note</p><p>既定の OS ディスクサイズより小さな値を指定することはできません。</p><p>また、サードパーティ様のイメージでは OS ディスクの拡張がサポートされない可能性もございます点、ご了承くださいませ。</p></div><p>例としてこちらのコマンドで以下のように、300 GB の OS ディスクを持つ Windows Server がデプロイできました。</p><p><img src="/blog/vm/os-disk-size-of-image/2022-12-29-15-07-19.png"></p><p>なお恐縮ながら Azure PowerShell ではこのような VM デプロイ時の OS ディスクサイズ指定が叶いませんものと存じますため、<br>Azure PowerShell の場合はデプロイ後に OS ディスクサイズをご変更いただけますと幸いです。</p><hr><h2 id="5-OS-ディスクサイズの縮小について"><a href="#5-OS-ディスクサイズの縮小について" class="headerlink" title="5.OS ディスクサイズの縮小について"></a>5.OS ディスクサイズの縮小について</h2><p>恐縮ではございますが、OS ディスク・データディスク共に、<br>現在 Azure マネージドディスクの縮小はサポートされておりませんものとなります。</p><blockquote><p>■ご参考：マネージド ディスクを縮小またはダウンサイズできますか?<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks#----------------------------">https://learn.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks#—————————-</a></p></blockquote><p>そのため小さな OS ディスクが必要なときは、Windows Server の場合は先述の smalldisk を使用することや、<br>Linux の場合オンプレミス環境等で任意の VHD のサイズをご用意いただき、Azure へアップロードしてご利用いただくといったことをご検討いただけますと幸いです。</p><p>上記の解説内容が、皆様のお役に立てますと幸いでございます。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの富田です。&lt;br&gt;今回はお問い合わせいただくことの多い、Azure マーケットプレイスのイメージの OS ディスクサイズについて、&lt;br&gt;確認方法・拡張方法・縮小不可などの点について解説させていただきます。  &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
  </entry>
  
  <entry>
    <title>AKS 1.24 アップグレード時にAzure Load Balancer の正常性プローブプロトコルが変更される</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/</id>
    <published>2023-02-02T04:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.223Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポートチームの小沢です。 </p><p>AKS の Kubernetes バージョンを 1.24 へアップグレードをした際に、Azure Load Balancer の正常性プローブがTCPプロ―ブから HTTP/HTTPS プローブに変更されることがあります。<br>本記事では、プローブの構成が変更された理由と影響、および対応方法について紹介します。 </p><span id="more"></span> <hr><h2 id="Azure-Load-Balancer正常性プローブ"><a href="#Azure-Load-Balancer正常性プローブ" class="headerlink" title="Azure Load Balancer正常性プローブ"></a>Azure Load Balancer正常性プローブ</h2><p>AKS クラスターに Type LoadBalancer の Service を作成すると、自動的に Azure Load Balancer に負荷分散規則が構成され、バックエンドには AKS ノードが割り当てられます。<br>また、Load Balancer のヘルスチェック機能である正常性プローブが構成されます。 </p><p>正常性プローブは、一定の間隔でバックエンドの VM インスタンスに対してヘルスチェック用のアクセスをします。<br>ヘルスチェックのアクセスが、プローブに設定された回数成功しなかった場合は、バックエンドが異常とみなされ、異常なバックエンドにはリクエストが送信されなくなります。<br>正常性プローブで利用できるプロトコルには、TCP、HTTP、HTTPSの3つがあります (Load Balancer の SKU が Standardの場合)。<br>正常性プローブで利用可能なプロトコルの種類や動作につきましては、以下のドキュメントをご参照ください。 </p><blockquote><p>ご参考) Azure Load Balancer の正常性プローブ<br><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-custom-probe-overview">https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-custom-probe-overview</a> </p></blockquote><h2 id="Service-Type-LoadBalancer-に設定される正常性プローブ"><a href="#Service-Type-LoadBalancer-に設定される正常性プローブ" class="headerlink" title="Service (Type LoadBalancer) に設定される正常性プローブ"></a>Service (Type LoadBalancer) に設定される正常性プローブ</h2><p>AKS 上で Service (Type LoadBalancer) を作成した場合には、Service オブジェクトに設定された値に基づいて、Azure Load Balancer の正常性プローブが自動的に構成されます。 </p><p>正常性プローブで使用するプロトコルは、Service の <code>spec.ports.appProtocol</code> フィールドの設定値 (tcp, http, https) が使用されます。<br>また、プロトコルが http/https の場合、<code>service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path</code> アノテーションで指定されたパスに対して、正常性プローブのリクエストが送信されます。<br><code>spec.ports.appProtocol</code> が設定されていない場合は、アノテーションによるリクエスト パスの指定は無視され、tcp プロトコルを使用する正常性プローブが構成されます。</p><p>Kubernetes バージョン 1.24以降では、Service のアノテーション <code>service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path</code> が設定されて<strong>いない場合</strong>に、正常性プローブの既定の構成が変更されました。<br>Kubernetes バージョン 1.23 以前と 1.24 以降では、次のような違いがあります。 </p><ul><li>Kubernetes バージョン &lt;= 1.23 の場合 <ul><li>Service のアノテーションが設定されていない場合、<strong>プローブのプロトコルに TCP が使用されます</strong> </li><li>アノテーションが設定されている場合は、プロトコルは <code>spec.ports.appProtocol</code> (http/https) が使用され、アノテーションで指定されたパスにプローブのリクエストが送信されます </li></ul></li><li>Kubernetes バージョン &gt; 1.24 の場合 <ul><li>Service のアノテーションが設定されていない場合、<strong>プローブのプロトコルに <code>spec.ports.appProtocol</code> (http/https) が使用され、リクエスト パスには <code>/</code> が使用されます</strong> </li><li>アノテーションが設定されている場合は、プロトコルは <code>spec.ports.appProtocol</code> (http/https) が使用され、アノテーションで指定されたパスにプローブのリクエストが送信されます </li></ul></li></ul><p>Load Balancer の正常性プローブで、どのプロトコルとリクエスト パスが使用されるかについては、Cloud Provider Azure のドキュメントで確認できます。 </p><blockquote><p>ご参考) Cloud Provider Azure - Custom Load Balancer health probe<br><a href="https://cloud-provider-azure.sigs.k8s.io/topics/loadbalancer/#custom-load-balancer-health-probe">https://cloud-provider-azure.sigs.k8s.io/topics/loadbalancer/#custom-load-balancer-health-probe</a> </p></blockquote><h2 id="正常性プローブの構成が変更された場合の影響"><a href="#正常性プローブの構成が変更された場合の影響" class="headerlink" title="正常性プローブの構成が変更された場合の影響"></a>正常性プローブの構成が変更された場合の影響</h2><p>Service (type: LoadBalancer) の YAML マニフェストにおいて、Service のアノテーション <code>service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path</code> を記述せずに、<code>spec.ports.appProtocol</code> のみを記述している場合に、Kubernetes バージョンをアップグレードしたあとにアプリケーションへアクセスできない事象が発生する可能性があります。 </p><p>Kubernetes &lt;= 1.23 では、<code>spec.ports.appProtocol</code> にプロトコル名が記述されている場合でも、正常性プローブのプロトコルには TCP が使用されます。<br>TCP プローブでは、対象の TCP ポートへの疎通性のみをチェックします。<br>HTTP/HTTPS のリクエスト/レスポンスの成否や、レスポンスの内容 (エラーステータスであるかどうか) は、プローブの結果に影響をしません。 </p><p>一方 Kubernetes &gt; 1.24 では、<code>spec.ports.appProtocol</code> に <code>http (または　https)</code>が記述されていると、正常性プローブのプロトコルは <code>http (または https)</code> に設定されます。<br>また、アノテーションでプローブのリクエスト パスが設定されていない場合には、既定で <code>/</code> が使用されます。<br>AKS クラスターで稼働しているアプリケーションが、<code>/</code> のパスでリクエストを受け付けていない場合や、<code>/</code> にアクセスした結果、エラーステータスの HTTP レスポンスを返した場合には、正常性プローブが失敗します。 </p><p>このように、Kubernetes バージョンによって、正常性プローブで使用されるプロトコルとパスが異なります。 </p><p>Kubernetes 1.23 では、TCP プロトコルによる疎通チェックによって正常性プローブが成功していたものの、Kubernetes 1.24 にアップグレードしたあとに正常性プローブが HTTP(S) によるチェックに切り替わり、プローブの条件を満たさなくなったことでバックエンドから切り離され、Load Balancer を介したアプリケーションへのアクセスが成功しない事象が発生します。 </p><h2 id="事例-NGINX-Ingress-Controller-にアクセスできなくなる"><a href="#事例-NGINX-Ingress-Controller-にアクセスできなくなる" class="headerlink" title="事例: NGINX Ingress Controller にアクセスできなくなる"></a>事例: NGINX Ingress Controller にアクセスできなくなる</h2><p>NGINX Ingress Controller を使用しているクラスターで、Kubernetes バージョンのアップグレードを実施したあとに、本事象の影響を受ける場合があります。 </p><p>NGINX Ingress Controller では、Ingress でマッピングされていないリクエストは、全て default backend で処理されます。<br>default backend は2つのパスを公開しており、<code>/healthz</code> では HTTP 200 ステータスを返し、<code>/</code> は HTTP 404 ステータスを返します。 </p><blockquote><p>ご参考) NGINX Ingress Controller - Default backend<br><a href="https://kubernetes.github.io/ingress-nginx/user-guide/default-backend/">https://kubernetes.github.io/ingress-nginx/user-guide/default-backend/</a> </p></blockquote><p>Kubernetes 1.23 では、正常性プローブは TCP プロトコルによる疎通チェックのみを行います。<br>そのため、Ingress Controller に用意されているパスや、そのレスポンス内容にかかわらず、TCP ポートに到達できる状態であれば、正常性プローブが成功します。<br>しかし、Kubernetes 1.24 では、<code>spec.ports.appProtocol</code> が <code>http/https</code> の場合、正常性プローブは既定で <code>/</code> へリクエストを送信し、その HTTP レスポンスの結果によってプローブの結果を決定します。<br>default backend の <code>/</code> は HTTP 404 ステータスを返すために、正常性プローブは失敗の状態となり、Load Balancer からバックエンドの AKS ノードにトラフィックが流されなくなるために、アプリケーションへアクセスできなくなる事象が発生します。 </p><p>NGINX Ingress Controller の Helm Chart では、既定で Service の <code>spec.ports.appProtocol</code> を出力するように values.yaml が構成されています。<br>一方、Service のアノテーションは <code>annotations: &#123;&#125;</code> のように、値が空となっていいます。 </p><blockquote><p>ご参考) Helm Chart の該当箇所<br>values.yaml<br><a href="https://github.com/kubernetes/ingress-nginx/blob/f90f37bed66d343e6c57ea981d6c4e90e4955975/charts/ingress-nginx/values.yaml#L460-L468">https://github.com/kubernetes/ingress-nginx/blob/f90f37bed66d343e6c57ea981d6c4e90e4955975/charts/ingress-nginx/values.yaml#L460-L468</a><br>controller-service.yaml テンプレート<br><a href="https://github.com/kubernetes/ingress-nginx/blob/f90f37bed66d343e6c57ea981d6c4e90e4955975/charts/ingress-nginx/templates/controller-service.yaml#L53-L71">https://github.com/kubernetes/ingress-nginx/blob/f90f37bed66d343e6c57ea981d6c4e90e4955975/charts/ingress-nginx/templates/controller-service.yaml#L53-L71</a></p></blockquote><p>そのため、Kubernetes 1.23 以前に NGINX Ingress Controller をインストールしていた場合には、Kubernetes 1.24 にアップグレードする前に、Ingress Controller の Service に対して、プローブのリクエスト パスが <code>/heathz</code> になるように、事前にアノテーションを追加しておく必要があります。 </p><h2 id="NGINX-Ingress-Controller-にアクセスできない事象の再現"><a href="#NGINX-Ingress-Controller-にアクセスできない事象の再現" class="headerlink" title="NGINX Ingress Controller にアクセスできない事象の再現"></a>NGINX Ingress Controller にアクセスできない事象の再現</h2><p>実際に、Kubernetes 1.23 の AKS クラスターに NGINX Ingress Controller をインストールして、その後 Kubernetes 1.24 へアップグレードすることで、本事象の影響を確認します。 </p><p>まず ingress-nginx-controller Service の YAML マニフェストの内容を確認します。<br><code>metadata.annotations</code> に <code>service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path</code> の設定がなく、<code>spec.ports.appProtocol</code> では <code>http/https</code> が使用されていることが確認できました。 </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">ingress-nginx-controller</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">-n</span> <span class="string">ingress-basic</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="comment"># リクエスト パスのアノテーションがない </span></span><br><span class="line">    <span class="attr">meta.helm.sh/release-name:</span> <span class="string">ingress-nginx</span> </span><br><span class="line">    <span class="attr">meta.helm.sh/release-namespace:</span> <span class="string">ingress-basic</span> </span><br><span class="line">    <span class="string">…</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">　<span class="string">…</span> </span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">appProtocol:</span> <span class="string">http</span>       <span class="comment"># http が指定されている </span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span> </span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">32271</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">appProtocol:</span> <span class="string">https</span>      <span class="comment"># https が指定されている </span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span> </span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30569</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https</span> </span><br></pre></td></tr></table></figure><p>AKS クラスターで使用される Azure Load Balancer のリソースは、kubernetes という名前で、ノードリソースグループ (既定では MC_* という名前) に配置されています。<br>Azure Portal で Load Balancer を開き、左メニューの正常性プローブのページを開きます。<br>プローブの一覧を確認すると、プロトコル がTCP のプローブとなっていることがわかります。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-01.png"></p><p>また、左メニューの分析情報のページを開くと、ネットワーク構成の図が表示され、正常性プローブは成功していることが確認できます。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-02.png"></p><p>そのあと、対象の AKS クラスターの Kubernetes バージョンを 1.24 にアップグレードします。<br>アップグレードをした後に Azure Portal 画面から正常性プローブを確認すると、プロトコルが <code>HTTP/S</code> のプローブが作成されており、リクエスト パスが <code>/</code> に設定されていることが確認できました。<br>この場合、NGINX Ingress Controller の default Backend は、<code>/</code> に対するアクセスに HTTP 404 ステータスを返すため、正常性プローブが失敗してしまいます。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-03.png"></p><p>Azure Portal画面の分析情報の図からも、正常性プローブが失敗していることが確認できます。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-04.png"> </p><h2 id="対応方法"><a href="#対応方法" class="headerlink" title="対応方法"></a>対応方法</h2><p>Kubernetes 1.24 のクラスターで、正常性プローブの状態を回復させる対応方法について説明します。 </p><div class="alert is-important"><p class="alert-title">重要</p><p>AKS で使用される Load Balancer の正常性プローブは、 クラスター上に作成された Service の内容をもとに、自動的に構成される仕組みです。</p><p>そのため、Azure CLI や Azure Portal で Load Balancerを直接変更するのではなく、Service の設定値を変えます。 </p></div><p>Service にアノテーションを追加し、カスタム ヘルスプローブ パスを設定することで、Kubernetes 1.23 から 1.24 へアップグレードした際にも正常性プローブが成功します。 </p><figure class="highlight yaml"><figcaption><span>Service にアノテーションを設定する例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path:</span> <span class="string">/healthz</span>  <span class="comment"># HTTP 200 ステータスを返すパスを指定します </span></span><br><span class="line"><span class="string">…</span> </span><br></pre></td></tr></table></figure><p>Helm を使ってインストールした NGINX Ingress Controller は、<code>helm upgrade</code> コマンドで Service のアノテーションが設定できます。<br><code>helm ugprade</code> コマンドに <code>--set</code> オプションを付与し、<code>controller.service.annotations</code> value の値を <code>&quot;service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path&quot;=/healthz</code> に設定します。 </p><p>すでに Kubernetes 1.24 にアップグレードしたクラスターや、これからアップグレードをするクラスターでは、<code>helm upgrade</code> コマンドでアノテーションを設定しましょう。<br>また、この <code>--set</code> オプションは、新規に Ingress Controller をインストールする際にも、<code>helm install</code> コマンドに付与することで利用できます。<br>今後新規に Ingress Controller をインストールする場合には、オプションでアノテーションの値を指定したうえで、インストールしましょう。 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade ingress-nginx ingress-nginx/ingress-nginx \ </span><br><span class="line">  --create-namespace \ </span><br><span class="line">  --namespace <span class="variable">$NAMESPACE</span> \ </span><br><span class="line">  --<span class="built_in">set</span> controller.service.annotations.<span class="string">&quot;service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path&quot;</span>=/healthz </span><br><span class="line">Release <span class="string">&quot;ingress-nginx&quot;</span> has been upgraded. Happy Helming! </span><br><span class="line">NAME: ingress-nginx </span><br><span class="line">LAST DEPLOYED: Mon Jan 16 15:16:54 2023 </span><br><span class="line">NAMESPACE: ingress-basic </span><br><span class="line">STATUS: deployed </span><br><span class="line">REVISION: 2 </span><br><span class="line">TEST SUITE: None </span><br><span class="line">NOTES: </span><br><span class="line">The ingress-nginx controller has been installed. </span><br><span class="line">It may take a few minutes <span class="keyword">for</span> the LoadBalancer IP to be available. </span><br><span class="line">You can watch the status by running <span class="string">&#x27;kubectl --namespace ingress-basic get services -o wide -w ingress-nginx-controller&#x27;</span> </span><br></pre></td></tr></table></figure><p>Service の YAML マニフェストの内容を確認してみましょう。<br><code>metadata.annotations</code> フィールド内に、<code>service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz</code> が追加されたことを確認できました。 </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">ingress-nginx-controller</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">-n</span> <span class="string">ingress-basic</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="attr">meta.helm.sh/release-name:</span> <span class="string">ingress-nginx</span> </span><br><span class="line">    <span class="attr">meta.helm.sh/release-namespace:</span> <span class="string">ingress-basic</span> </span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path:</span> <span class="string">/healthz</span> </span><br><span class="line">  <span class="string">...</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">　<span class="string">...</span> </span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">appProtocol:</span> <span class="string">http</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span> </span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">32271</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">appProtocol:</span> <span class="string">https</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span> </span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30569</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https</span> </span><br></pre></td></tr></table></figure><p>Azure Portal の画面上でも、プローブのリクエスト パスが <code>/</code> から <code>/healthz</code> に変わりました。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-05.png"> </p><p>また、分析情報の画面においても、正常性プローブも成功していることが確認できました。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-06.png"></p><p>このように、<code>HTTP/HTTPS</code> プローブのリクエスト先を、<code>/</code> (404 ステータスが返される) から、<code>/healthz</code> (200 ステータスが返される) に変更することで、正常性プローブの状態を回復させることが確認できました。 </p><p>今回は NGINX Ingress Controller を例に説明をしたため、リクエスト パスは <code>/healthz</code> を指定しました。<br>アプリケーションが用意するヘルスチェック用のエンドポイントは、アプリケーションの実装によってエンドポイントの有無や名称が異なる場合がございます。<br>トラブルシューティングの際は、対象のアプリケーションの仕様・実装をご確認いただき、リクエスト パスをご指定ください。 </p><h2 id="正常性プローブが失敗した時のトラブルシューティング"><a href="#正常性プローブが失敗した時のトラブルシューティング" class="headerlink" title="正常性プローブが失敗した時のトラブルシューティング"></a>正常性プローブが失敗した時のトラブルシューティング</h2><p>さいごに、正常性プローブが成功しない場合の、一般的なトラブルシューティング観点について紹介します。 </p><h3 id="1-ノードの-VM-インスタンスが起動しているか？"><a href="#1-ノードの-VM-インスタンスが起動しているか？" class="headerlink" title="1. ノードの VM インスタンスが起動しているか？"></a>1. ノードの VM インスタンスが起動しているか？</h3><p>Load Balancer の正常性プローブは、バックエンドプールのインスタンスの状態を監視しています。<br>インスタンスが起動していない場合にはヘルスチェックのリクエストが成功しないことが想定されますので、プローブの失敗を検知した際は、VM インスタンスが正常に起動しているかを確認します。<br>AKS では、ノードのステータスが NotReady となっていないかをあわせて確認しましょう。 </p><h3 id="2-NodePort-および正常性プローブのリクエスト-パス"><a href="#2-NodePort-および正常性プローブのリクエスト-パス" class="headerlink" title="2. NodePort および正常性プローブのリクエスト パス"></a>2. NodePort および正常性プローブのリクエスト パス</h3><p>Load Balancer の正常性プローブが、AKS に作成した Service の設定値と一致しているかを確認します。<br>本記事で上述したように、プローブで利用するプロトコルと、プローブのリクエスト パスが正しいかを確認しましょう。 </p><p>また、type LoadBalancer の Service を作成すると、各ノードに NodePort のポートが設定されます。ポート番号は既定で 30000-32767 の範囲となります。<br>Kubectl get svc コマンドで Service 名と NodePort のポート番号を確認し、プローブのリクエスト先と一致しているかを確認しましょう。 </p><h3 id="3-Service-の-Selector-と-Pod-の-label"><a href="#3-Service-の-Selector-と-Pod-の-label" class="headerlink" title="3. Service の Selector と Pod の label"></a>3. Service の Selector と Pod の label</h3><p>Service で指定している selector が、Pod に設定されている label と一致しているかを確認します。<br>また、selector/label が一致している場合は、Pod が正常に稼働しているかどうかを確認します。 </p><h3 id="4-Load-Balancer-からの正常性プローブの通信をブロックしていないかどうか"><a href="#4-Load-Balancer-からの正常性プローブの通信をブロックしていないかどうか" class="headerlink" title="4. Load Balancer からの正常性プローブの通信をブロックしていないかどうか"></a>4. Load Balancer からの正常性プローブの通信をブロックしていないかどうか</h3><p>正常性プローブの設定に問題がなく、ノードや Pod が起動しているにもかかわらず、正常性プローブが失敗している場合には、Load Balancer から送信された正常性プローブの通信がブロックされている可能性が考えられます。 </p><p>NetworkPolicyなどでネットワーク通信を制限している場合には、Load Balancer からの正常性プローブの通信 (送信元が 168.63.129.16) をブロックしていないか確認します。 </p><blockquote><p>ご参考) Azure Load Balancer の正常性プローブの状態に関するトラブルシューティング<br>「原因 3:ファイアウォール、またはネットワーク セキュリティ グループが Load Balancer バックエンド プール VM 上のポートをブロックしている」をご参照ください。<br><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot-health-probe-status">https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot-health-probe-status</a> </p></blockquote><p>また、Azure Portal の画面では、Load Balancerのメトリックで、正常性プローブの状態を確認できます。<br><code>Health Probe Status</code> メトリックの値から、過去の正常性プローブの状態を確認できますので、事象の発生や解消のタイミングを確認する際にご活用ください。 </p><p><img src="/blog/containers/aks-lb-probe-failed-after-upgraded-to-k8s-1.24/aks-lb-probe-failed-after-upgraded-to-k8s-1.24-07.png"></p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>この記事では、AKS の Kubernetes バージョンを 1.24 にアップグレードした際に、Load Balancer Service の正常性プローブが成功しなくなる事象と、その対処方法について解説しました。<br>Kubernetes バージョンのアップグレード作業や、Load Balancer サービスへのアクセスが成功しない場合のトラブルシューティングのご参考にいただけますと幸いでございます。 </p><p>本稿が少しでも皆様のご参考となれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポートチームの小沢です。 &lt;/p&gt;
&lt;p&gt;AKS の Kubernetes バージョンを 1.24 へアップグレードをした際に、Azure Load Balancer の正常性プローブがTCPプロ―ブから HTTP/HTTPS プローブに変更されることがあります。&lt;br&gt;本記事では、プローブの構成が変更された理由と影響、および対応方法について紹介します。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>Project Flash : Azure 仮想マシンの可用性の監視を高める</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-availability-monitoring-with-project-flash/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-availability-monitoring-with-project-flash/</id>
    <published>2023-01-06T03:00:00.000Z</published>
    <updated>2023-10-19T03:16:45.635Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの鳥越です。</p><p>2022年に Azure 仮想マシンの可用性の監視を進化するプロジェクトである Project Flash について、以下のブログで紹介されました。</p><blockquote><p> <strong>Project Flash で Azure 仮想マシンの可用性の監視を進化させる</strong><br> <a href="https://azure.microsoft.com/ja-jp/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash/">https://azure.microsoft.com/ja-jp/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash/</a></p></blockquote><p>このプロジェクトは Azure 仮想マシンに対して、お客様の可用性監視ニーズを満たすために、次のようなことが行えるように進められております。</p><ul><li>VM の可用性障害 (VM のリブートや再起動のほか、ネットワーク ドライバーの更新によるアプリケーションのフリーズ、30 秒間のホスト OS の更新など) に関する正確で実用的なデータ、および障害の詳細 (プラットフォームのものかユーザー操作によるものか、リブートかフリーズか、計画的か非計画的かなど) を入手する。</li><li>VM の可用性の傾向を分析してアラートを生成し、迅速なデバッグと前月比のレポート作成を実現する。</li><li>データを定期的かつ大規模に監視し、カスタム ダッシュボードを作成して、すべてのリソースの最新の可用性状態について常に最新の情報を提供する。</li><li>影響を受けた VM、ダウンタイムの原因および期間、結果的な修正などの詳細を示す自動根本原因分析 (RCA) を受け取り、ターゲットを絞った調査および事後分析を行えるようにする。</li><li>VM の可用性に重大な変化があった場合、即座に通知を受け取り、迅速に修復アクションをトリガーし、エンドユーザーへの影響を防止する。</li><li>刻々と変化するワークロードの感度やフェールオーバーのニーズに基づき、プラットフォームの回復ポリシーを動的に調整し、自動化する。</li></ul><p>その中で、上記ブログではプレビューであった <a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/overview">Azure Resource Graph</a> を用いた VM の可用性情報の監視が GA として公開され、Azure Monitor による VM 可用性メトリックがパブリック プレビューとして公開されました。</p><blockquote><p> <strong>New Project Flash Update: Advancing Azure Virtual Machine availability monitoring</strong><br> <a href="https://azure.microsoft.com/en-us/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash-update/">https://azure.microsoft.com/en-us/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash-update/</a></p></blockquote><p>このブログでは、Azure Resource Graph を用いた VM の可用性情報がどのように利用できるのかを解説します。<br>本内容がお客様の VM の監視に少しでもお役に立てられれば幸いです。</p><span id="more"></span><hr><h2 id="Azure-Resource-Graph-を用いたVMの可用性情報の監視"><a href="#Azure-Resource-Graph-を用いたVMの可用性情報の監視" class="headerlink" title="Azure Resource Graph を用いたVMの可用性情報の監視"></a>Azure Resource Graph を用いたVMの可用性情報の監視</h2><p>Azure Portal より <a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/first-query-portal">Azure Resource Graph エクスプローラー</a>をご利用いただけます。<br>Azure Resource Graph エクスプローラーの画面を開き、テーブルから <code>healthresources</code> を選択します。</p><p><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-01.png"></p><p>たとえば、次のようなクエリで実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">healthresources</span><br><span class="line">| where id contains &quot;eda570ec&quot; //This is subscription id</span><br><span class="line">| project id, type, location, properties</span><br></pre></td></tr></table></figure><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Resource Graph では、<a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/">Kusto Query Language (KQL) クエリ</a>を用いて、情報を出力することが可能です。</p><p>上記は <a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/whereoperator">where 演算子</a>で <code>id</code> の中に <code>&quot;eba570ec&quot;</code> があるものに限定して、<a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/projectoperator">project 演算子</a>で表示される項目を記載しています。  </p></div><p>実行後、次のような結果を得ることができます。</p><p><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-02.png"></p><p>右側の詳細の表示を選択することで値を見やすく見ることが可能となります。</p><p><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-03.png"></p><p>この <code>healthresources</code> テーブルには次の項目が存在します。</p><ul><li><code>&quot;microsoft.resourcehealth/availabilitystatuses&quot;</code></li><li><code>&quot;microsoft.resourcehealth/resourceannotations&quot;</code></li></ul><p>それぞれについて紹介します。</p><p><code>&quot;microsoft.resourcehealth/availabilitystatuses&quot;</code> は、Azure プラットフォームによって実行された正常性チェックに基づいて、VM の最新の可用性状態を示します。<br>VM に対して現在出力されている可用性の状態を次に示します。</p><ul><li><strong>available</strong>: VM は期待どおりに稼働しています。</li><li><strong>unavailable</strong>: VM の正常な機能の中断が検出されたため、アプリケーションは期待どおりに実行されません。</li><li><strong>unknown</strong>: プラットフォームは VM の正常性を正確に検出できません。ユーザーは通常、数分後に更新された状態を確認できます。</li></ul><blockquote><p>ご参考情報:<br><strong>Resource Health の概要</strong><br><a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-overview">https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-overview</a><br>　<br><strong>Microsoft.compute/virtualmachines</strong><br><a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines">https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines</a></p></blockquote><p><code>&quot;microsoft.resourcehealth/resourceannotations&quot;</code>は、VM の可用性に変化があった場合、必要な障害属性を詳細に説明することで、ユーザーが必要に応じて状態を確認調査し、軽減できるようにします。</p><ul><li><strong>Downtime Annotations</strong>: プラットフォームが VM の可用性が Unavailable に遷移したことを検出すると発行されます。<ul><li>たとえば、予期しないホストのクラッシュ、リブートによる修復操作時など</li></ul></li><li><strong>Informational Annotations</strong>: VM の可用性に影響を与えない Azure 基盤に対する処理実施時に発行されます。<ul><li>VM の割り当て / 停止 / 削除 / 開始など</li><li>通常、これに対するお客様の追加アクションは必要ありません。</li></ul></li><li><strong>Degraded Annotations</strong>: VM の可用性が危険にさらされていることが検出されると発行されます。<ul><li>たとえば、故障予測モデルが、任意の時点で VM を再起動させる可能性のあるハードウェア・コンポーネントの劣化を予測した場合など</li><li>予期せぬデータ損失やダウンタイムを避けるため、アノテーション メッセージで指定された期限までに再デプロイするよう強く求めます。</li></ul></li></ul><blockquote><p>ご参考情報:<br><strong>Resource Health 仮想マシンの正常性に関する注釈</strong><br><a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-vm-annotation">https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-vm-annotation</a></p></blockquote><p>なお、VM の停止 (割り当て解除) を行った場合には、次のような アノテーション イベントを検知することが可能となります。</p><p><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-04.png"></p><p>これらを用いることによりお客様の仮想マシンの可用性の状態を把握することが可能となります。</p><div class="alert is-info"><p class="alert-title">Note</p><p>将来的には、この HealthResources データセットに表示されるアノテーション・メタデータについて複数の機能強化が予定されています。</p><p>これらの機能強化により、ユーザーはより豊富な障害属性に確認することができるようになり、障害への対応策を決定的に準備することができるようになります。</p><p>これと並行して、履歴のルックバック期間を最低 30 日間に延長し、ユーザーが VM の可用性の過去の変化を包括的に追跡できるようにすることを目標としています。</p></div><h2 id="HealthResources-に対する便利な-クエリ"><a href="#HealthResources-に対する便利な-クエリ" class="headerlink" title="HealthResources に対する便利な クエリ"></a>HealthResources に対する便利な クエリ</h2><h3 id="可用性の状態とサブスクリプション-ID-別の仮想マシンの数"><a href="#可用性の状態とサブスクリプション-ID-別の仮想マシンの数" class="headerlink" title="可用性の状態とサブスクリプション ID 別の仮想マシンの数"></a>可用性の状態とサブスクリプション ID 別の仮想マシンの数</h3><p>各サブスクリプションの可用性の状態で集計された仮想マシン (種類 Microsoft.Compute/virtualMachines) の数を返します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type =~ &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">| summarize count() by subscriptionId, AvailabilityState = tostring(properties.availabilityState)</span><br></pre></td></tr></table></figure><p>実行結果:<br>Unknown の VM が1台あることが確認できます。<br><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-05.png"></p><h3 id="リソース-ID-別の仮想マシンおよび関連する可用性状態の一覧"><a href="#リソース-ID-別の仮想マシンおよび関連する可用性状態の一覧" class="headerlink" title="リソース ID 別の仮想マシンおよび関連する可用性状態の一覧"></a>リソース ID 別の仮想マシンおよび関連する可用性状態の一覧</h3><p>可用性の状態で集計された仮想マシン (種類 Microsoft.Compute/virtualMachines) の最新の一覧を返します。<br>また、このクエリでは、デバッグと軽減を容易にするため、properties.targetResourceId に基づいて関連付けられているリソース ID も提供されます。<br>可用性の状態は、4 つの値、Available、Unavailable、Degraded、Unknown のいずれかです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type =~ &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">| summarize by ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState)</span><br></pre></td></tr></table></figure><p>実行結果:<br>Unknown の対象 VM は先ほど停止を実施した VM であることが確認できました。<br><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-06.png"></p><h3 id="可用性状態と電源状態別の仮想マシンの一覧と、そのリソース-ID-およびリソース-グループ"><a href="#可用性状態と電源状態別の仮想マシンの一覧と、そのリソース-ID-およびリソース-グループ" class="headerlink" title="可用性状態と電源状態別の仮想マシンの一覧と、そのリソース ID およびリソース グループ"></a>可用性状態と電源状態別の仮想マシンの一覧と、そのリソース ID およびリソース グループ</h3><p>仮想マシンの正常性のまとまりのある状態を提供するために、電源状態と可用性状態で集計された仮想マシン (種類 Microsoft.Compute/virtualMachines) の一覧を返します。<br>また、このクエリでは、各エントリに関連付けられているリソース グループとリソース ID に関する詳細も提供され、リソースを詳細に表示できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| where type =~ &#x27;microsoft.compute/virtualmachines&#x27;</span><br><span class="line">| project resourceGroup, Id = tolower(id), PowerState = tostring( properties.extended.instanceView.powerState.code)</span><br><span class="line">| join kind=leftouter (</span><br><span class="line">    HealthResources</span><br><span class="line">    | where type =~ &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">    | where tostring(properties.targetResourceType) =~ &#x27;microsoft.compute/virtualmachines&#x27;</span><br><span class="line">    | project targetResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState))</span><br><span class="line">    on $left.Id == $right.targetResourceId</span><br><span class="line">| project-away targetResourceId</span><br><span class="line">| where PowerState != &#x27;PowerState/deallocated&#x27;</span><br></pre></td></tr></table></figure><p>実行結果:<br>停止 (割り当て解除) 状態の VM が除外され表示されます。<br><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-07.png"></p><h3 id="リソース-ID-別の使用できない仮想マシンの一覧"><a href="#リソース-ID-別の使用できない仮想マシンの一覧" class="headerlink" title="リソース ID 別の使用できない仮想マシンの一覧"></a>リソース ID 別の使用できない仮想マシンの一覧</h3><p>可用性の状態で集計された仮想マシン (種類 Microsoft.Compute/virtualMachines) の最新の一覧を返します。<br>表示された一覧では、可用性の状態が “Available” ではない仮想マシンだけが強調表示され、仮想マシンに関する状態すべてについて確実に認識できます。<br>すべての仮想マシンが使用可能な場合は、結果が表示されないことが想定できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type =~ &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">| where tostring(properties.availabilityState) != &#x27;Available&#x27;</span><br><span class="line">| summarize by ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState)</span><br></pre></td></tr></table></figure><p>実行結果:<br>Unavailable や Unknown ステータスの VM が表示されます。<br><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-08.png"></p><p>その他、次のようなクエリが利用可能です。</p><h3 id="プラットフォーム主導の計画外の正常性イベントによる影響を受けた可用性状態をもつリソースの一覧"><a href="#プラットフォーム主導の計画外の正常性イベントによる影響を受けた可用性状態をもつリソースの一覧" class="headerlink" title="プラットフォーム主導の計画外の正常性イベントによる影響を受けた可用性状態をもつリソースの一覧"></a>プラットフォーム主導の計画外の正常性イベントによる影響を受けた可用性状態をもつリソースの一覧</h3><p>Azure プラットフォームによって予期せず発生した計画外の中断の影響を受けた仮想マシンの最新の一覧を返します。<br>このクエリは、影響を受けたすべての仮想マシンを ID プロパティで集約し、対応する可用性状態と、特定の中断を要約した関連する注釈 (properties.reason) と共に返します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type == &quot;microsoft.resourcehealth/resourceannotations&quot;</span><br><span class="line">| where  properties.category == &#x27;Unplanned&#x27; and  properties.context != &#x27;Customer Initiated&#x27;</span><br><span class="line">| project ResourceId = tolower(tostring(properties.targetResourceId)), Annotation = tostring(properties.reason)</span><br><span class="line">| join (</span><br><span class="line">    HealthResources</span><br><span class="line">    | where type == &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">    | project ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState))</span><br><span class="line">    on ResourceId</span><br><span class="line">| project ResourceId, AvailabilityState, Annotation</span><br></pre></td></tr></table></figure><h3 id="使用できないリソースとそれぞれの注釈詳細の一覧"><a href="#使用できないリソースとそれぞれの注釈詳細の一覧" class="headerlink" title="使用できないリソースとそれぞれの注釈詳細の一覧"></a>使用できないリソースとそれぞれの注釈詳細の一覧</h3><p>現在、使用可能な状態ではない仮想マシンの一覧を、ID プロパティで集約して返します。<br>また、このクエリによって、仮想マシンの実際の可用性状態と、使用できない理由を含む関連する詳細も示されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type == &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">| where  properties.availabilityState != &#x27;Available&#x27;</span><br><span class="line">| project ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState)</span><br><span class="line">| join ( </span><br><span class="line">     HealthResources</span><br><span class="line">    | where type == &quot;microsoft.resourcehealth/resourceannotations&quot;</span><br><span class="line">    | project ResourceId = tolower(tostring(properties.targetResourceId)), Reason = tostring(properties.reason), Context = tostring(properties.context), Category = tostring(properties.category))</span><br><span class="line">    on ResourceId</span><br><span class="line">| project ResourceId, AvailabilityState, Reason, Context, Category</span><br></pre></td></tr></table></figure><p>実行結果:<br><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-09.png"></p><h3 id="可用性の障害による影響を受けたリージョン内のリソースの数と、その影響の種類"><a href="#可用性の障害による影響を受けたリージョン内のリソースの数と、その影響の種類" class="headerlink" title="可用性の障害による影響を受けたリージョン内のリソースの数と、その影響の種類"></a>可用性の障害による影響を受けたリージョン内のリソースの数と、その影響の種類</h3><p>現在、使用可能な状態ではない仮想マシンの数を、ID プロパティで集約して返します。<br>また、クエリによって示される対応する場所と注釈の詳細には、VM が使用可能な状態ではない原因も含まれます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type == &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">| where  properties.availabilityState != &#x27;Available&#x27;</span><br><span class="line">| project ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState), Location = location</span><br><span class="line">| join (</span><br><span class="line">    HealthResources</span><br><span class="line">    | where type == &quot;microsoft.resourcehealth/resourceannotations&quot;</span><br><span class="line">    | project ResourceId = tolower(tostring(properties.targetResourceId)), Context = tostring(properties.context), Category = tostring(properties.category), Location = location)</span><br><span class="line">    on ResourceId</span><br><span class="line">| summarize NumResources = count(ResourceId) by Location, Context, Category</span><br></pre></td></tr></table></figure><h3 id="特定の正常性イベントによる影響を受けるリソースの一覧と、影響時間、影響の詳細、可用性の状態、リージョン"><a href="#特定の正常性イベントによる影響を受けるリソースの一覧と、影響時間、影響の詳細、可用性の状態、リージョン" class="headerlink" title="特定の正常性イベントによる影響を受けるリソースの一覧と、影響時間、影響の詳細、可用性の状態、リージョン"></a>特定の正常性イベントによる影響を受けるリソースの一覧と、影響時間、影響の詳細、可用性の状態、リージョン</h3><p>VirtualMachineHostRebootedForRepair 注釈の影響を受ける仮想マシンの一覧を、その ID プロパティで集約して返します。<br>また、このクエリは、仮想マシンの対応する可用性状態、中断の時間、影響の原因を含む注釈の詳細を返します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type == &quot;microsoft.resourcehealth/resourceannotations&quot;</span><br><span class="line">| where properties.AnnotationName contains &#x27;VirtualMachineHostRebootedForRepair&#x27;</span><br><span class="line">| project ResourceId = tolower(tostring(properties.targetResourceId)), Reason = tostring(properties.reason), Context = tostring(properties.context), Category = tostring(properties.category), Location = location, Timestamp = tostring(properties.occurredTime)</span><br><span class="line">| join ( </span><br><span class="line">    HealthResources</span><br><span class="line">    | where type == &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">    | project ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState), Location = location)</span><br><span class="line">    on ResourceId</span><br><span class="line">| project ResourceId, Reason, Context, Category, AvailabilityState, Timestamp</span><br></pre></td></tr></table></figure><h3 id="計画イベントによる影響を受けたリソースのリージョンごとの一覧"><a href="#計画イベントによる影響を受けたリソースのリージョンごとの一覧" class="headerlink" title="計画イベントによる影響を受けたリソースのリージョンごとの一覧"></a>計画イベントによる影響を受けたリソースのリージョンごとの一覧</h3><p>Azure プラットフォームによって実施された計画的なメンテナンスまたは修復操作の影響を受けた仮想マシンの一覧を、ID プロパティで集約して返します。<br>また、このクエリは、仮想マシンの対応する可用性状態、中断の時間、場所、影響の原因を含む注釈の詳細を返します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type == &quot;microsoft.resourcehealth/resourceannotations&quot;</span><br><span class="line">| where properties.category contains &#x27;Planned&#x27;</span><br><span class="line">| project ResourceId = tolower(tostring(properties.targetResourceId)), Reason = tostring(properties.reason), Location = location, Timestamp = tostring(properties.occuredTime)</span><br><span class="line">| join ( </span><br><span class="line">    HealthResources</span><br><span class="line">    | where type == &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">    | project ResourceId = tolower(tostring(properties.targetResourceId)), AvailabilityState = tostring(properties.availabilityState), Location = location)</span><br><span class="line">    on ResourceId</span><br><span class="line">| project ResourceId, Reason, AvailabilityState, Timestamp, Location</span><br></pre></td></tr></table></figure><h3 id="計画外のプラットフォーム中断の影響を受けたリソースの一覧と、可用性、電力状態、場所"><a href="#計画外のプラットフォーム中断の影響を受けたリソースの一覧と、可用性、電力状態、場所" class="headerlink" title="計画外のプラットフォーム中断の影響を受けたリソースの一覧と、可用性、電力状態、場所"></a>計画外のプラットフォーム中断の影響を受けたリソースの一覧と、可用性、電力状態、場所</h3><p>Azure プラットフォームによって実施された計画的なメンテナンスまたは修復操作の影響を受けた仮想マシンの一覧を、ID プロパティで集約して返します。<br>また、このクエリによって、仮想マシンの対応する可用性状態、電力状態、場所の詳細も示されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HealthResources</span><br><span class="line">| where type =~ &#x27;microsoft.resourcehealth/resourceannotations&#x27;</span><br><span class="line">| where tostring(properties.context) == &#x27;Platform Initiated&#x27; and tostring(properties.category) == &#x27;Planned&#x27;</span><br><span class="line">| project ResourceId = tolower(properties.targetResourceId), Location = location</span><br><span class="line">| join (</span><br><span class="line">    HealthResources</span><br><span class="line">    | where type =~ &#x27;microsoft.resourcehealth/availabilitystatuses&#x27;</span><br><span class="line">    | project ResourceId = tolower(properties.targetResourceId), AvailabilityState = tostring(properties.availabilityState), Location = location)</span><br><span class="line">    on ResourceId</span><br><span class="line">| join (</span><br><span class="line">    Resources</span><br><span class="line">    | where type =~ &#x27;microsoft.compute/virtualmachines&#x27;</span><br><span class="line">    | project ResourceId = tolower(id), PowerState = properties.extended.instanceView.powerState.code, Location = location)</span><br><span class="line">    on ResourceId</span><br><span class="line">| project ResourceId, AvailabilityState, PowerState, Location</span><br></pre></td></tr></table></figure><p>次に Azure Monitor による VM の可用性メトリックを紹介します。</p><h2 id="Azure-Monitor-による-VM-の可用性メトリック-Preview"><a href="#Azure-Monitor-による-VM-の可用性メトリック-Preview" class="headerlink" title="Azure Monitor による VM の可用性メトリック (Preview)"></a>Azure Monitor による VM の可用性メトリック (Preview)</h2><p>VM 可用性についてのメトリックが取得できるようになりました。<br>このメトリックを用いることで、可用性が低下した場合に、しきい値ベースのメトリックアラートを設定し、適切な軽減措置を迅速にトリガーするよう設定することが可能となりました。</p><p><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-10.png"><br><img src="/blog/vm/vm-availability-monitoring-with-project-flash/vm-availability-monitoring-with-project-flash-11.png"></p><p>上記の結果より、VM を停止したことで可用性の低下が発生したことを確認できます。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>Azure ではこの Project Flash を通じて、お客様のエクスペリエンスの継続的な改善を目的とし監視プラットフォームの強化を実施してまいります。</p><p>以前は Azure 基盤で発生した問題について、何が起こったのかわからず大きな不安を抱えることもあったかと存じます。</p><p>Azure 基盤で発生した問題について、お客様の視認性を強化し、可能な限り迅速に情報提供をすることで、お客様への影響とご不安を最小限にするように引き続き信頼性向上に努めてまいります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの鳥越です。&lt;/p&gt;
&lt;p&gt;2022年に Azure 仮想マシンの可用性の監視を進化するプロジェクトである Project Flash について、以下のブログで紹介されました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; &lt;strong&gt;Project Flash で Azure 仮想マシンの可用性の監視を進化させる&lt;/strong&gt;&lt;br&gt; &lt;a href=&quot;https://azure.microsoft.com/ja-jp/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash/&quot;&gt;https://azure.microsoft.com/ja-jp/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;このプロジェクトは Azure 仮想マシンに対して、お客様の可用性監視ニーズを満たすために、次のようなことが行えるように進められております。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;VM の可用性障害 (VM のリブートや再起動のほか、ネットワーク ドライバーの更新によるアプリケーションのフリーズ、30 秒間のホスト OS の更新など) に関する正確で実用的なデータ、および障害の詳細 (プラットフォームのものかユーザー操作によるものか、リブートかフリーズか、計画的か非計画的かなど) を入手する。&lt;/li&gt;
&lt;li&gt;VM の可用性の傾向を分析してアラートを生成し、迅速なデバッグと前月比のレポート作成を実現する。&lt;/li&gt;
&lt;li&gt;データを定期的かつ大規模に監視し、カスタム ダッシュボードを作成して、すべてのリソースの最新の可用性状態について常に最新の情報を提供する。&lt;/li&gt;
&lt;li&gt;影響を受けた VM、ダウンタイムの原因および期間、結果的な修正などの詳細を示す自動根本原因分析 (RCA) を受け取り、ターゲットを絞った調査および事後分析を行えるようにする。&lt;/li&gt;
&lt;li&gt;VM の可用性に重大な変化があった場合、即座に通知を受け取り、迅速に修復アクションをトリガーし、エンドユーザーへの影響を防止する。&lt;/li&gt;
&lt;li&gt;刻々と変化するワークロードの感度やフェールオーバーのニーズに基づき、プラットフォームの回復ポリシーを動的に調整し、自動化する。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;その中で、上記ブログではプレビューであった &lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/overview&quot;&gt;Azure Resource Graph&lt;/a&gt; を用いた VM の可用性情報の監視が GA として公開され、Azure Monitor による VM 可用性メトリックがパブリック プレビューとして公開されました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; &lt;strong&gt;New Project Flash Update: Advancing Azure Virtual Machine availability monitoring&lt;/strong&gt;&lt;br&gt; &lt;a href=&quot;https://azure.microsoft.com/en-us/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash-update/&quot;&gt;https://azure.microsoft.com/en-us/blog/advancing-azure-virtual-machine-availability-monitoring-with-project-flash-update/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;このブログでは、Azure Resource Graph を用いた VM の可用性情報がどのように利用できるのかを解説します。&lt;br&gt;本内容がお客様の VM の監視に少しでもお役に立てられれば幸いです。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Monitoring / Alert" scheme="https://jpaztech.github.io/blog/tags/Monitoring-Alert/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Classic VM から ARM への移行についての注意事項 (VM、ストレージ編)</title>
    <link href="https://jpaztech.github.io/blog/vm/migrate_classic_vm_and_storage/"/>
    <id>https://jpaztech.github.io/blog/vm/migrate_classic_vm_and_storage/</id>
    <published>2022-12-29T08:30:00.000Z</published>
    <updated>2023-10-19T03:16:45.535Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの鳥越です。<br>2014年に Azure Resource Manager モデルがリリースされており、リタイアがアナウンスされた 2020 年 7 月時点ですでに 90% が Azure Resource Manager モデルで利用されておりました。</p><p>Azure 初期で利用されておりました Azure Service Manager (ASM) を介した IaaS 仮想マシン (VM) の管理を 2020 年 2 月 28 日 に 非推奨として <strong>2023 年 9 月 6 日</strong> に完全に廃止される予定です。</p><blockquote><p>■ ご参考: Migrate your IaaS resources to Azure Resource Manager by September 6, 2023<br><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/classic-vm-deprecation">https://learn.microsoft.com/en-us/azure/virtual-machines/classic-vm-deprecation</a><br>(ご参考: 日本語 URL)<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation">https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p><strong>(2023/01/27 Update)</strong>: 当初、2023 年 3 月 1日とご説明しておりました ASM の廃止は <strong>2023 年 9 月 1 日</strong> に延期されました。</p><p>その後、2023 年 9 月 6 日まで更に延期されましたが、現在これ以上の延期は計画されておりません。</p></div><p>そのため、これから 2023 年 9 月 6 日までに移行計画を立てていらっしゃるお客様に対して、移行がスムーズに行えるようにあらかじめ確認しておくべきポイントをお纏めしました。</p><p>本内容がお客様の移行作業に少しでもお役に立てば幸いでございます。</p><span id="more"></span><hr><h2 id="移行作業の全体像"><a href="#移行作業の全体像" class="headerlink" title="移行作業の全体像"></a>移行作業の全体像</h2><blockquote><p>■ ご参考: プラットフォームでサポートされているクラシックから Azure Resource Manager への移行に関する技術的な詳細<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-deep-dive">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-deep-dive</a></p></blockquote><p>Azure ではリソースの管理操作にかかわる Control Plane と実際のリソースに対する Data Plane が存在します。<br>ASM (Azure Service Manager) から ARM (Azure Resource Manager) への移行は Control Plane に対する操作となります。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image1.png"></p><p>原則として Data Plane はそのまま使用可能なので、ユーザー目線から見た場合、VM の動作状況や、ストレージアカウント上へのアクセスには影響がないように見えます。<br>しかしながら、移行非対応の機能のための構成変更に伴い、ユーザー目線でのダウンタイムが発生する可能性はございます。</p><p>たとえば、クラシック VM においては、「仮想ネットワークに配置されていない VM」という構成があり得ましたが、ARM における VM ではすべての仮想マシンが仮想ネットワーク上に配置されます。<br>従いまして、仮想ネットワークに配置されていないクラシック VM を、ARM に移行する場合、移行手順の途上で VM の停止が伴います。</p><p>また、移行中は、管理系の操作が行えないことも合わせてご理解いただく必要がございます。<br>例えば、VMのサイズ変更、開始、停止、再起動、再デプロイ、ディスクの構成変更、ネットワーク的な構成変更が実施できなくなる操作となります。<br>そのため、移行で問題が生じたときに、VM 側の操作ができないといった事態に陥る可能性もゼロではございません。</p><h3 id="移行をサポートしていないリソース"><a href="#移行をサポートしていないリソース" class="headerlink" title="移行をサポートしていないリソース"></a>移行をサポートしていないリソース</h3><p><img src="/blog/vm/migrate_classic_vm_and_storage/image2.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-overview#unsupported-features-and-configurations">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-overview#unsupported-features-and-configurations</a></p><hr><p>全体的な移行の流れは下記の図のようになります。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image3.png"></p><h2 id="移行の事前準備-重要"><a href="#移行の事前準備-重要" class="headerlink" title="移行の事前準備 (重要)"></a>移行の事前準備 (重要)</h2><h3 id="1-クラシックリソースの操作に対応した、クラシック用の-Azure-PowerShell-を実施前にご用意ください。"><a href="#1-クラシックリソースの操作に対応した、クラシック用の-Azure-PowerShell-を実施前にご用意ください。" class="headerlink" title="(1) クラシックリソースの操作に対応した、クラシック用の Azure PowerShell を実施前にご用意ください。"></a>(1) クラシックリソースの操作に対応した、クラシック用の Azure PowerShell を実施前にご用意ください。</h3><p>クラシックリソース用の Azure PowerShell コマンドは、現行の ARM 対応の <code>AzureRM</code> や <code>Az</code> というモジュールではなく、<code>Azure</code> という名称で配布されています。<br>インストール方法は、以下の技術文書をご参照ください。</p><blockquote><p>■ ご参考: Azure PowerShell Service Management モジュールのインストール<br><a href="https://learn.microsoft.com/ja-jp/powershell/azure/servicemanagement/install-azure-ps?view=azuresmps-4.0.0">https://learn.microsoft.com/ja-jp/powershell/azure/servicemanagement/install-azure-ps?view=azuresmps-4.0.0 </a></p></blockquote><p>なお、クラシック Azure PowerShell によるリソース管理には、Azure サブスクリプションにおける <strong>従来の管理者</strong> の割り当てが必要になることにご注意ください。</p><blockquote><p>■ ご参考: Azure の従来のサブスクリプション管理者<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/classic-administrators">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/classic-administrators</a></p></blockquote><p>多くの場合、移行が失敗した場合には、コマンドベースで回復作業を実施します。<br>そのため、事前にクラシックリソース用 Azure PowerShell を利用いただける環境をご用意いただけますと幸いです。</p><h3 id="2-クラシック-Azure-PowerShell-を用いて事前チェックをお願いいたします"><a href="#2-クラシック-Azure-PowerShell-を用いて事前チェックをお願いいたします" class="headerlink" title="(2) クラシック Azure PowerShell を用いて事前チェックをお願いいたします"></a>(2) クラシック Azure PowerShell を用いて事前チェックをお願いいたします</h3><p>たとえば、よくあるお問い合わせとして、ストレージアカウント内にディスクリソースが存在するためクラシックストレージアカウントの移行に失敗するといったお問い合わせがございます。</p><p>Portal 側の手順では、この点が考慮されていない部分がございますので、下記のように PowerShell を利用してチェックをいただけますと幸いです。<br>VM の移行が完了しておらず、クラシックストレージアカウントに VM で利用中のディスクリソースが残ってしまっていないかなどのチェック方法は以下のとおりです。</p><h4 id="2-1-ディスクがストレージ-アカウントに格納されている仮想マシンを移行する。"><a href="#2-1-ディスクがストレージ-アカウントに格納されている仮想マシンを移行する。" class="headerlink" title="(2-1) ディスクがストレージ アカウントに格納されている仮想マシンを移行する。"></a>(2-1) ディスクがストレージ アカウントに格納されている仮想マシンを移行する。</h4><p>次のコマンドは、ストレージ アカウント内のすべての VM ディスクの RoleName および DiskName プロパティを返します。RoleName はディスクが接続される仮想マシンの名前です。<br>このコマンドでディスクが返される場合、ストレージアカウントを移行する前にこれらのディスクが接続されている仮想マシンが移行されている必要があります。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$storageAccountName</span> = <span class="string">&#x27;yourStorageAccountName&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-AzureDisk</span> | <span class="built_in">where-Object</span> &#123;<span class="variable">$_</span>.MediaLink.Host.Contains(<span class="variable">$storageAccountName</span>)&#125; | <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> AttachedTo <span class="literal">-Property</span> DiskName | <span class="built_in">Format-List</span> <span class="literal">-Property</span> RoleName, DiskName</span><br></pre></td></tr></table></figure><h4 id="2-2-ストレージ-アカウントに格納されている、接続されていない-VM-ディスクを削除する。"><a href="#2-2-ストレージ-アカウントに格納されている、接続されていない-VM-ディスクを削除する。" class="headerlink" title="(2-2) ストレージ アカウントに格納されている、接続されていない VM ディスクを削除する。"></a>(2-2) ストレージ アカウントに格納されている、接続されていない VM ディスクを削除する。</h4><p>次のコマンドを使用して、ストレージ アカウントの接続されていない VM のディスクを探します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$storageAccountName</span> = <span class="string">&#x27;yourStorageAccountName&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-AzureDisk</span> | <span class="built_in">where-Object</span></span><br><span class="line">&#123;<span class="variable">$_</span>.MediaLink.Host.Contains(<span class="variable">$storageAccountName</span>)&#125; | <span class="built_in">Where-Object</span> <span class="literal">-Property</span> AttachedTo <span class="operator">-EQ</span> <span class="variable">$null</span> | <span class="built_in">Format-List</span> <span class="literal">-Property</span> DiskName</span><br></pre></td></tr></table></figure><p>上記のコマンドでディスクが返された場合、次のコマンドを使用してこれらのディスクを削除します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Remove-AzureDisk</span> <span class="literal">-DiskName</span> <span class="string">&#x27;yourDiskName&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="2-3-ストレージ-アカウントに格納されている-VM-イメージを削除する。"><a href="#2-3-ストレージ-アカウントに格納されている-VM-イメージを削除する。" class="headerlink" title="(2-3) ストレージ アカウントに格納されている VM イメージを削除する。"></a>(2-3) ストレージ アカウントに格納されている VM イメージを削除する。</h4><p>次のコマンドは、ストレージ アカウントに格納されたすべての VM イメージと OS ディスクを返します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzureVmImage</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.OSDiskConfiguration.MediaLink <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> <span class="variable">$_</span>.OSDiskConfiguration.MediaLink.Host.Contains(<span class="variable">$storageAccountName</span>)&#125; | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> ImageName, ImageLabel</span><br></pre></td></tr></table></figure><p>次のコマンドは、ストレージ アカウントに格納されたすべての VM イメージとデータ ディスクを返します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzureVmImage</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.DataDiskConfigurations <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> (<span class="variable">$_</span>.DataDiskConfigurations | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.MediaLink <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> <span class="variable">$_</span>.MediaLink.Host.Contains(<span class="variable">$storageAccountName</span>)&#125;).Count <span class="operator">-gt</span> <span class="number">0</span> &#125; | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> ImageName, ImageLabel</span><br></pre></td></tr></table></figure><p>次のコマンドを使用して、上記のコマンドによって返されるすべての VM イメージを削除します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Remove-AzureVMImage</span> <span class="literal">-ImageName</span> <span class="string">&#x27;yourImageName&#x27;</span>  </span><br></pre></td></tr></table></figure><hr><h2 id="検証フェーズ-Validate"><a href="#検証フェーズ-Validate" class="headerlink" title="検証フェーズ (Validate)"></a>検証フェーズ (Validate)</h2><p>検証フェーズでは移行対象リソースが前提条件を満たしているのかチェックします。<br>ただし、この検証フェーズですべての前提条件がチェックされる訳ではない点に注意が必要です。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image4.png"><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-deep-dive#checks-not-done-in-the-validate-operation">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-deep-dive#checks-not-done-in-the-validate-operation</a></p><h2 id="準備フェーズ-Prepare"><a href="#準備フェーズ-Prepare" class="headerlink" title="準備フェーズ (Prepare)"></a>準備フェーズ (Prepare)</h2><p>準備フェーズでは、リソースの実体に対して、ASM 側にも ARM 側にもリソースが表示されるようになります。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image5.png"></p><p>このタイミングで管理系操作はロックされるため、Commit で実行フェーズに進むか Abort で強制終了するかのどちらかの作業が必要となります。</p><h3 id="準備フェーズでの重要な注意点"><a href="#準備フェーズでの重要な注意点" class="headerlink" title="準備フェーズでの重要な注意点"></a>準備フェーズでの重要な注意点</h3><p>注意点となりますが、ASM から ARM への移行に際し VM 単位で実施する場合に、Prepare -&gt; Commit の間に 4 分間の間隔を空けないと移行処理が失敗するという報告がございます。</p><p>このような状態に陥った場合、Portal での対処ができず、先にご案内しましたクラシック用の PowerShell により以下のコマンドで Commit を実行いただく必要がございます。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$serviceName</span> = <span class="string">&quot;My Service&quot;</span>   <span class="comment"># クラシック VM が配置されているクラウドサービス名に置き換えてください</span></span><br><span class="line"><span class="variable">$deployment</span> = <span class="built_in">Get-AzureDeployment</span> <span class="literal">-ServiceName</span> <span class="variable">$serviceName</span></span><br><span class="line"><span class="variable">$deploymentName</span> = <span class="variable">$deployment</span>.DeploymentName</span><br><span class="line"><span class="built_in">Move-AzureService</span> <span class="literal">-Commit</span> <span class="literal">-ServiceName</span> <span class="variable">$serviceName</span> <span class="literal">-DeploymentName</span> <span class="variable">$deploymentName</span></span><br></pre></td></tr></table></figure><h2 id="実行フェーズ-Commit"><a href="#実行フェーズ-Commit" class="headerlink" title="実行フェーズ (Commit)"></a>実行フェーズ (Commit)</h2><p>実行フェーズにてリソースの実体に対してクラシック側の参照が切り離される動作となります。</p><p>これにより ARM への移行が完了します。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image6.png"></p><hr><h2 id="ASM-から-ARM-に移行される際の-FAQ"><a href="#ASM-から-ARM-に移行される際の-FAQ" class="headerlink" title="ASM から ARM に移行される際の FAQ"></a>ASM から ARM に移行される際の FAQ</h2><p>公式ドキュメントとしては以下のご用意がございます。</p><blockquote><p>■ ご参考: クラシックから Azure Resource Manager への移行に関してよく寄せられる質問<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-faq">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-faq</a></p></blockquote><p>問題が発生した場合の対処コマンドについては、以下に記載させていただきます。</p><h3 id="Q1-移行の-Abort-はできますか？"><a href="#Q1-移行の-Abort-はできますか？" class="headerlink" title="Q1. 移行の Abort はできますか？"></a>Q1. 移行の Abort はできますか？</h3><p>移行作業をどうしても Abort したい場合には下記コマンドを実施ください。<br>デバッグ出力も併せて表示されますので、何らかのエラーが発生する場合は、デバッグ出力も添えて Azure サポート窓口へのお問い合わせをご検討ください。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$serviceName</span> = <span class="string">&quot;My Service&quot;</span>   <span class="comment"># クラシック VM が配置されているクラウドサービス名に置き換えてください</span></span><br><span class="line"><span class="variable">$deployment</span> = <span class="built_in">Get-AzureDeployment</span> <span class="literal">-ServiceName</span> <span class="variable">$serviceName</span>  </span><br><span class="line"><span class="variable">$deploymentName</span> = <span class="variable">$deployment</span>.DeploymentName  </span><br><span class="line"><span class="built_in">Move-AzureService</span> <span class="literal">-Abort</span> <span class="literal">-ServiceName</span> <span class="variable">$serviceName</span> <span class="literal">-DeploymentName</span> <span class="variable">$deploymentName</span> <span class="literal">-debug</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure><h3 id="Q2-ストレージアカウントを-Azure-PowerShell-で-Commit-する方法はありますか？"><a href="#Q2-ストレージアカウントを-Azure-PowerShell-で-Commit-する方法はありますか？" class="headerlink" title="Q2. ストレージアカウントを Azure PowerShell で Commit する方法はありますか？"></a>Q2. ストレージアカウントを Azure PowerShell で Commit する方法はありますか？</h3><p>移行作業でポータルから操作ができず、Azure PowerShell を利用して Commit が必要なケースが存在します。<br>そのような場合には以下のように Commit の実施をお願いいたします。<br>デバッグ出力も併せて表示されますので、何らかのエラーが発生する場合は、デバッグ出力も添えて Azure サポート窓口へのお問い合わせをご検討ください。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$storageAccountName</span> = <span class="string">&quot;myStorageAccount&quot;</span></span><br><span class="line"><span class="built_in">Move-AzureStorageAccount</span> <span class="literal">-Commit</span> <span class="literal">-StorageAccountName</span> <span class="variable">$storageAccountName</span> <span class="literal">-debug</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure><h3 id="Q3-VNET-を含んだ-VM-の移行で問題が発生したときはどうすればよいですか？"><a href="#Q3-VNET-を含んだ-VM-の移行で問題が発生したときはどうすればよいですか？" class="headerlink" title="Q3. VNET を含んだ VM の移行で問題が発生したときはどうすればよいですか？"></a>Q3. VNET を含んだ VM の移行で問題が発生したときはどうすればよいですか？</h3><p>VNET を含んだ VM の移行については今回割愛しておりますが、移行に問題が発生した際に、PowerShell を利用した切り分け作業の実施が必要となります。</p><p>上記のとおり、PowerShell 環境の事前の準備と問題が発生した際には <code>-debug</code> オプションと <code>-verbose</code> オプションを利用した原因調査の実施が必要となりますのであらかじめご承知おきいただけますと幸いです。</p><h3 id="Q4-移行がスタックした際にクラシック-VM-から新規-の-ARM-の-VM-を手動で作成できますか？"><a href="#Q4-移行がスタックした際にクラシック-VM-から新規-の-ARM-の-VM-を手動で作成できますか？" class="headerlink" title="Q4. 移行がスタックした際にクラシック VM から新規 の ARM の VM を手動で作成できますか？"></a>Q4. 移行がスタックした際にクラシック VM から新規 の ARM の VM を手動で作成できますか？</h3><p>移行が途中でスタックした際には、上述の通り管理操作を行うことができません。<br>そのため、VM の起動再開といった作業が実現できないこととなります。</p><p>この場合、VM で利用されていた VHD を利用して新たに VM を作成することで、スタックの状況を回避することが可能となります。<br>作業としては以下の流れで作業の実施をお願いいたします。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>こちらの手順についてスクリーンショット等を交えた解説ブログ記事が別途公開されましたので、ご参照いただけますと幸いです。  </p><p>■ご参考：クラシック VM で使用していた VHD から ARM VM を作成する手順</p><p><a href="https://jpaztech.github.io/blog/vm/classic-vhd-to-arm-vm/">https://jpaztech.github.io/blog/vm/classic-vhd-to-arm-vm/</a></p></div><h4 id="4-1-コピー先-URL-を準備"><a href="#4-1-コピー先-URL-を準備" class="headerlink" title="(4-1) コピー先 URL を準備"></a>(4-1) コピー先 URL を準備</h4><h5 id="手順A-ARM-仮想マシン用のストレージ-アカウントを作成します。"><a href="#手順A-ARM-仮想マシン用のストレージ-アカウントを作成します。" class="headerlink" title="手順A. ARM 仮想マシン用のストレージ アカウントを作成します。"></a>手順A. ARM 仮想マシン用のストレージ アカウントを作成します。</h5><ol><li>Azure Portal より <strong>[ストレージ アカウント]</strong> を開き、<strong>[追加]</strong> をクリックします。<br>適宜値を設定し、ストレージ アカウントを作成します。</li><li>作成後、<strong>[ストレージ アカウント]</strong> - <strong>[&lt;当該ストレージ アカウント名&gt;]</strong> を選択し、左メニュー <strong>[Blob service]</strong> から <strong>[コンテナー]</strong> を選択します。</li><li><strong>[+ コンテナー]</strong> をクリックし <code>vhds</code> という名前でコンテナーを作成します。</li></ol><h5 id="手順B-VHD-ファイルをコピーするためのコピー先の-SAS-を発行します。"><a href="#手順B-VHD-ファイルをコピーするためのコピー先の-SAS-を発行します。" class="headerlink" title="手順B. VHD ファイルをコピーするためのコピー先の SAS を発行します。"></a>手順B. VHD ファイルをコピーするためのコピー先の SAS を発行します。</h5><ol><li><strong>手順A-1</strong> で作成した <strong>[&lt;当該ストレージ アカウント名&gt;]</strong> を選択し、左メニュー <strong>[設定]</strong> から <strong>[Shared Access Signature]</strong> を選択します。</li><li>適宜設定を行い、<strong>[SAS と接続文字列を生成する]</strong> をクリックします。</li><li><strong>[Blob service の SAS URL]</strong> をテキストエディタ等にコピーしておきます。</li></ol><h5 id="手順C-手順D-3-で取得した-URL-を下記のとおり編集し、テキスト-エディタ等にコピーしておきます。"><a href="#手順C-手順D-3-で取得した-URL-を下記のとおり編集し、テキスト-エディタ等にコピーしておきます。" class="headerlink" title="手順C. 手順D-3 で取得した URL を下記のとおり編集し、テキスト エディタ等にコピーしておきます。"></a>手順C. 手順D-3 で取得した URL を下記のとおり編集し、テキスト エディタ等にコピーしておきます。</h5><p><strong>編集前</strong>: <code>https://&#123;ストレージ アカウント名&#125;.blob.core.windows.net/?&#123;SAS&#125;</code><br><strong>編集後</strong>: <code>https://&#123;ストレージ アカウント名&#125;.blob.core.windows.net/vhds/&#123;コピー後の VHD ファイル名&#125;?&#123;SAS&#125;</code></p><p>コピー後の VHD ファイル名は「.vhd」拡張子となるようにご指定ください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>A から C の手順は、当初より公開しております以下の記事にも記載がございます。</p><p>Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法のページにおける</p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/#1-%E3%82%B3%E3%83%94%E3%83%BC%E5%85%88%E3%81%AE%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%8A%E3%82%88%E3%81%B3%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E2%80%95%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">[1] コピー先のストレージ アカウントおよびコンテナ―を作成する</a></p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/#2-%E3%82%B3%E3%83%94%E3%83%BC%E5%85%88%E3%81%AE-SAS-%E3%82%92%E7%99%BA%E8%A1%8C%E3%81%99%E3%82%8B">[2] コピー先の SAS を発行する</a></p><p>の手順と同様です。</p><p>　</p><p>■ ご参考: Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法</p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/">https://jpaztech.github.io/blog/vm/create-vm-using-vhd/</a></p></div><h4 id="4-2-コピー元のVMの停止"><a href="#4-2-コピー元のVMの停止" class="headerlink" title="(4-2) コピー元のVMの停止"></a>(4-2) コピー元のVMの停止</h4><h5 id="手順D-コピー元の仮想マシンを停止します。"><a href="#手順D-コピー元の仮想マシンを停止します。" class="headerlink" title="手順D. コピー元の仮想マシンを停止します。"></a>手順D. コピー元の仮想マシンを停止します。</h5><h4 id="4-3-コピー元-URL-を準備"><a href="#4-3-コピー元-URL-を準備" class="headerlink" title="(4-3) コピー元 URL を準備"></a>(4-3) コピー元 URL を準備</h4><p>事前に VM のディスクに関してスナップショットを取得します。</p><h5 id="手順E-クラシック仮想マシン-の-VHD-にてスナップショットを取得します。"><a href="#手順E-クラシック仮想マシン-の-VHD-にてスナップショットを取得します。" class="headerlink" title="手順E. クラシック仮想マシン の VHD にてスナップショットを取得します。"></a>手順E. クラシック仮想マシン の VHD にてスナップショットを取得します。</h5><ol><li>Azure Portal にて、<strong>[ストレージ アカウント]</strong> - <strong>[&lt;当該 (クラシック) ストレージアカウント名&gt;]</strong> を選択し、左メニュー <strong>[Blob service]</strong> から <strong>[コンテナー]</strong> を選択します。</li><li>スナップショットを作成します。<br> <strong>[vhds (コンテナー名)]</strong> - <strong>[&lt;ファイル名.vhd&gt;]</strong> の <strong>[…]</strong> をクリックし、<strong>[スナップショットの作成]</strong> をクリックします。</li><li>スナップショットを表示します。<br> <strong>[vhds (コンテナー名)]</strong> - <strong>[&lt;ファイル名.vhd&gt;]</strong> の <strong>[…]</strong> をクリックし、<strong>[スナップショットの表示]</strong> をクリックします。<br> 該当スナップショットの <strong>[…]</strong> をクリックし、ダブルクリックして表示される <strong>[スナップショットのプロパティ]</strong> から URL をテキスト エディタ等にコピーしておきます。</li></ol><h5 id="手順F-クラシック仮想マシンで作成した-VHD-ファイルをコピーするための-SAS-を発行します。"><a href="#手順F-クラシック仮想マシンで作成した-VHD-ファイルをコピーするための-SAS-を発行します。" class="headerlink" title="手順F. クラシック仮想マシンで作成した VHD ファイルをコピーするための SAS を発行します。"></a>手順F. クラシック仮想マシンで作成した VHD ファイルをコピーするための SAS を発行します。</h5><ol><li><strong>手順E-2, 3</strong> と同様に <strong>[vhds (コンテナー名)]</strong> - <strong>[&lt;ファイル名.vhd&gt;]</strong> の <strong>[…]</strong> をクリックし、<strong>[SAS の生成]</strong> をクリックします。</li><li>適宜設定を行い、<strong>[SAS トークンおよび URL を生成]</strong> をクリックします。</li><li><strong>[BLOB SAS トークン]</strong> をテキスト エディタ等にコピーしておきます。</li></ol><h5 id="手順G-コピー元の-URL-を合わせ、テキスト-エディタ等準備しておきます。"><a href="#手順G-コピー元の-URL-を合わせ、テキスト-エディタ等準備しておきます。" class="headerlink" title="手順G. コピー元の URL を合わせ、テキスト エディタ等準備しておきます。"></a>手順G. コピー元の URL を合わせ、テキスト エディタ等準備しておきます。</h5><p>スナップショットを AzCopy で複製する場合に、コピー元 URL を作成する手順は以下のようになります。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image7.png"></p><ol><li><p><strong>手順E-3</strong> で準備した URL を前半 (VHD のパスまで)、後半 (? マークから後ろ) に分けます。<br> <strong>例: 元々のスナップショットの URL が以下の場合</strong><br> <code>https://&#123;コピー元のストレージアカウント&#125;.blob.core.windows.net/vhds/&#123;ファイル名&#125;.vhd?snapshot=YYYY-MM-DDThhmm:ss.nnnnnnnZ</code></p><p> <strong>前半</strong>:<br> <code>https://&#123;コピー元のストレージアカウント&#125;.blob.core.windows.net/vhds/&#123;ファイル名&#125;.vhd</code></p><p> <strong>後半</strong> (? マークから後ろ):<br> <code>snapshot=YYYY-MM-DDThhmm:ss.nnnnnnnZ</code></p></li><li><p>（<strong>手順G-1</strong> の前半部分）＋ (?) + (SAS文字列) + (&amp;) +(<strong>手順G-1</strong> の後半部分）を連結し、以下のようなコピー元 URL を準備します。<br> <code>https://&#123;コピー元のストレージアカウント&#125;.blob.core.windows.net/vhds/&#123;ファイル名&#125;.vhd?&#123;SAS文字列&#125;&amp;snapshot=YYYY-MM-DDThh:mmss.nnnnnnnZ</code></p></li></ol><h4 id="4-4-AzCopy-コマンドで-VHD-ファイルをコピー"><a href="#4-4-AzCopy-コマンドで-VHD-ファイルをコピー" class="headerlink" title="(4-4) AzCopy コマンドで VHD ファイルをコピー"></a>(4-4) AzCopy コマンドで VHD ファイルをコピー</h4><h5 id="手順H-作業環境に-AzCopy-コマンドをダウンロードします。"><a href="#手順H-作業環境に-AzCopy-コマンドをダウンロードします。" class="headerlink" title="手順H. 作業環境に AzCopy コマンドをダウンロードします。"></a>手順H. 作業環境に AzCopy コマンドをダウンロードします。</h5><p>Azure Cloud Shell をご利用の場合、この手順は不要です。</p><blockquote><p>■ ご参考: AzCopy を使ってみる<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10</a></p></blockquote><h5 id="手順I-以下のようにコマンドを実行し、VHD-をコピーします。"><a href="#手順I-以下のようにコマンドを実行し、VHD-をコピーします。" class="headerlink" title="手順I. 以下のようにコマンドを実行し、VHD をコピーします。"></a>手順I. 以下のようにコマンドを実行し、VHD をコピーします。</h5><p><code>azcopy copy &quot;&#123;手順Gで準備したURLとファイル名.vhd?SAS文字列&amp;snapshot=日時を含む文字列&#125;&quot; &quot;&#123;手順CでコピーしたURL?SAS文字列&#125;&quot; --blob-type PageBlob</code></p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image8.png"></p><p>正常に転送が完了した場合は以下のような例の表示となります。</p><p><img src="/blog/vm/migrate_classic_vm_and_storage/image9.png"></p><p>これにより、ARM 環境のストレージアカウントに ASM 環境の VHD ファイルのコピーができました。</p><h4 id="4-5-vhdを元にディスクを作成、仮想マシンを作成"><a href="#4-5-vhdを元にディスクを作成、仮想マシンを作成" class="headerlink" title="(4-5) vhdを元にディスクを作成、仮想マシンを作成"></a>(4-5) vhdを元にディスクを作成、仮想マシンを作成</h4><h5 id="手順J-ARM-環境の仮想マシンを作成します。"><a href="#手順J-ARM-環境の仮想マシンを作成します。" class="headerlink" title="手順J. ARM 環境の仮想マシンを作成します。"></a>手順J. ARM 環境の仮想マシンを作成します。</h5><ol><li>Azure Portal より <strong>[ディスク]</strong> を開き、<strong>[+ 追加]</strong> をクリックします。</li><li>適宜設定を行い、<strong>[確認および作成]</strong> - <strong>[作成]</strong> をクリックします。<ol><li><code>ソースの種類</code> は <strong>[ストレージ BLOB]</strong> を選択します。</li><li><code>ソース BLOB</code> は <strong>手順C</strong> のストレージ アカウントの <code>vhds</code> にコピーした VHD ファイルを選択します。</li><li><code>OS の種類</code> は適宜選択します。<br><img src="/blog/vm/migrate_classic_vm_and_storage/image10.png"></li></ol></li><li>Azure Portal より作成した OS ディスクを開き、<strong>[+ VM の作成]</strong> をクリックします。</li><li>適宜設定を行い、<strong>[確認および作成]</strong> - <strong>[作成]</strong> をクリックします。</li></ol><h5 id="手順K-ARM-仮想マシンに接続し、必要に応じて動作を確認します。"><a href="#手順K-ARM-仮想マシンに接続し、必要に応じて動作を確認します。" class="headerlink" title="手順K. ARM 仮想マシンに接続し、必要に応じて動作を確認します。"></a>手順K. ARM 仮想マシンに接続し、必要に応じて動作を確認します。</h5><p>以上の手順で、移行がスタックした際にクラシック VM から新規 の ARM の VM を手動で作成することが可能となります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>J から K の手順は、当初より公開しております以下の記事にも記載がございます。</p><p>Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法のページにおける</p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/#5-VHD-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E7%AE%A1%E7%90%86%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">[5] VHD ファイルから管理ディスクを作成する</a></p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/#6-VHD-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%A7-VM-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%80%82">[6] VHD ファイルから作成したディスクで VM を作成する。</a></p><p>と同様です。</p><p>　</p><p>■ ご参考: Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法</p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/">https://jpaztech.github.io/blog/vm/create-vm-using-vhd/</a></p></div><p>これらの記事の内容が皆様のお役にたてれば幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの鳥越です。&lt;br&gt;2014年に Azure Resource Manager モデルがリリースされており、リタイアがアナウンスされた 2020 年 7 月時点ですでに 90% が Azure Resource Manager モデルで利用されておりました。&lt;/p&gt;
&lt;p&gt;Azure 初期で利用されておりました Azure Service Manager (ASM) を介した IaaS 仮想マシン (VM) の管理を 2020 年 2 月 28 日 に 非推奨として &lt;strong&gt;2023 年 9 月 6 日&lt;/strong&gt; に完全に廃止される予定です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;■ ご参考: Migrate your IaaS resources to Azure Resource Manager by September 6, 2023&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/azure/virtual-machines/classic-vm-deprecation&quot;&gt;https://learn.microsoft.com/en-us/azure/virtual-machines/classic-vm-deprecation&lt;/a&gt;&lt;br&gt;(ご参考: 日本語 URL)&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation&quot;&gt;https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;[!IMPORTANT]&lt;br&gt;&lt;strong&gt;(2023/01/27 Update)&lt;/strong&gt;: 当初、2023 年 3 月 1日とご説明しておりました ASM の廃止は &lt;strong&gt;2023 年 9 月 1 日&lt;/strong&gt; に延期されました。&lt;br&gt;その後、2023 年 9 月 6 日まで更に延期されましたが、現在これ以上の延期は計画されておりません。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;そのため、これから 2023 年 9 月 6 日までに移行計画を立てていらっしゃるお客様に対して、移行がスムーズに行えるようにあらかじめ確認しておくべきポイントをお纏めしました。&lt;/p&gt;
&lt;p&gt;本内容がお客様の移行作業に少しでもお役に立てば幸いでございます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Migration" scheme="https://jpaztech.github.io/blog/tags/Migration/"/>
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
</feed>
