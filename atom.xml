<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2021-06-04T13:16:36.693Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure 仮想マシンにおける操作 (再起動、停止/起動、再デプロイ、再適用) について</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-operation/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-operation/</id>
    <published>2021-05-24T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.693Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの洪です。</p><p>Azure 仮想マシンで予期せぬ問題が発生した際に、切り分けとして再起動や再デプロイをご案内することがありますが、その際、お客様よりそれぞれの操作の違いや目的についてご質問いただくことがあります。</p><p>そこで本稿では、 Azure 仮想マシンに対して行う操作として、「再起動」、「停止 (割り当て解除) / 起動」、 「再デプロイ」、「再適用」の違いに関して説明します。</p><span id="more"></span><h2 id="■-各操作に関する概要"><a href="#■-各操作に関する概要" class="headerlink" title="■ 各操作に関する概要"></a>■ 各操作に関する概要</h2><p>各操作をご実施いただいた際に、「ゲスト OS の再起動」や「物理ホストの移動」が発生するか否かについて、下記の表の通りおまとめします。</p><table><thead><tr><th>操作</th><th>ゲスト OS の再起動</th><th>物理ホストの移動</th></tr></thead><tbody><tr><td>再起動</td><td>〇</td><td>×</td></tr><tr><td>停止 (割り当て解除) / 起動</td><td>〇</td><td>△ ※1</td></tr><tr><td>再デプロイ</td><td>〇</td><td>〇</td></tr><tr><td>再適用</td><td>△ ※2</td><td>×</td></tr></tbody></table><p>※1 明示的に物理ホスト サーバーの移動を行うわけではございません。可能性として、停止前と同一の物理ホスト サーバーで起動する場合もございます。<br>※2 仮想マシンの再起動が必須となる操作ではありませんが、目標となるあるべき状態 (Goal State) に実体が追いつこうとした動作の結果、再起動が発生する可能性があります。</p><hr><h2 id="■-仮想マシンの再起動"><a href="#■-仮想マシンの再起動" class="headerlink" title="■ 仮想マシンの再起動"></a>■ 仮想マシンの再起動</h2><p>再起動は、<strong>ゲスト OS の再起動</strong> を実施する操作です。ゲスト OS として Graceful Shutdown ※1 を実施し、その後起動します。<br>Graceful Shutdown とは、仮想マシンをシャットダウンする際にシステム内部で決められた手順に従い正常に仮想マシンを終了させることを意味します。<br>再起動による物理ホスト サーバーの移動は発生しません。<br>ゲスト OS 内のプロセスが正常な状態となっていない場合の切り分けとして、再起動の実行をご案内しています。</p><h3 id="Azure-Portal-での操作画面"><a href="#Azure-Portal-での操作画面" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-restart.png"></p><hr><h2 id="■-仮想マシンの停止-割り当て解除-起動"><a href="#■-仮想マシンの停止-割り当て解除-起動" class="headerlink" title="■ 仮想マシンの停止 (割り当て解除) / 起動"></a>■ 仮想マシンの停止 (割り当て解除) / 起動</h2><p>停止 (割り当て解除) は、仮想マシンが稼働する <strong>物理ホスト サーバーから割り当てられているリソースの割り当てを解除</strong> する操作であり、起動は <strong>物理ホスト サーバーからリソースを割り当てる</strong> 操作です。<br>再デプロイと異なり、明示的に別の物理ホスト サーバーでデプロイを行うための手段ではありませんが、起動によって仮想マシンがデプロイされる物理ホスト サーバーは前回と異なる場合がほとんどになります。</p><p>停止 (割り当て解除) では、仮想マシンとしての課金はかかりません。(※ ディスクの課金はかかります。)</p><blockquote><p>ご参考) 仮想マシンの課金の仕組み<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/dsazurejp/23">https://docs.microsoft.com/ja-jp/archive/blogs/dsazurejp/23</a></p></blockquote><h3 id="Azure-Portal-での操作画面-1"><a href="#Azure-Portal-での操作画面-1" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-stop.png"><br><img src="/blog/vm/vm-operation/vm-start.png"></p><p>ゲスト OS 上でのみシャットダウンを実行した場合には、ポータルの画面より仮想マシンの状態が <strong>停止済み (割り当て解除)</strong> ではなく、<strong>停止済み</strong> と表記されます。この場合はリソースがまだ割り当てられている状態との意味ですので課金が続けられます。</p><hr><h2 id="■-仮想マシンの再デプロイ"><a href="#■-仮想マシンの再デプロイ" class="headerlink" title="■ 仮想マシンの再デプロイ"></a>■ 仮想マシンの再デプロイ</h2><p>再デプロイとは、仮想マシンが稼働する <strong>物理ホスト サーバーを明示的に変更</strong> する操作です。<br>つまり、仮想マシンへのリソース割り当てを一度解除し、これまで稼働していた物理ホスト サーバーとは別の物理ホスト サーバーにて、仮想マシンに再度リソース割り当てを行います。<br>割り当ての対象となるリソースとは、vCPU コア、メモリ、NIC、一時ディスクなどの物理リソースです。</p><p>物理ホスト サーバー起因の問題が疑われている場合の切り分けとして、再デプロイの実行をご案内しています。</p><blockquote><p>ご参考) ホスト サーバーの障害<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/understand-vm-reboot#host-server-faults">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/understand-vm-reboot#host-server-faults</a></p></blockquote><h3 id="Azure-Portal-での操作画面-2"><a href="#Azure-Portal-での操作画面-2" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-redeploy.png"><br>なお、再デプロイに関しては、下記ブログ記事にて Azure PowerShell での操作方法などをご紹介しておりますので、ご参考としていただけますと幸いです。</p><blockquote><p>ご参考) Azure 仮想マシンの再デプロイ<br><a href="https://jpaztech.github.io/blog/vm/vm-redeploy/">https://jpaztech.github.io/blog/vm/vm-redeploy/</a></p></blockquote><h3 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h3><p>再デプロイを行う際は、下記の 2 点を注意する必要があります。</p><ul><li>一時ディスクがある仮想マシン サイズをご利用の場合は、既存の一時ディスクは破棄され、新しくデプロイ先となった物理ホスト サーバーより再度割り当てられます。</li><li>仮想マシンに関連付けられた動的な IP アドレスは更新されます。</li></ul><hr><h2 id="■-仮想マシンの再適用"><a href="#■-仮想マシンの再適用" class="headerlink" title="■ 仮想マシンの再適用"></a>■ 仮想マシンの再適用</h2><p>Azure のリソースの変更処理にあたっては、内部的に 「あるべき状態 (Goal State)」 と「実体」 という概念があります。 リソースに何かしらの変更処理が発生する際、まず Goal State が更新され、その後リソースの「実体」が更新された Goal State の状態と合致するように、変更処理が実行されます。つまり、「実体」 が「Goal State」 を追いかける動作になります。</p><p>再適用とは、同一物理ホスト サーバー内で リソースの あるべき状態 (Goal State) の情報を、リソースの実体にもう一度適用させる操作です。 何らかの理由でリソースの実体が Goal State の状態に遷移ができずエラーになってしまった変更処理に対して、もう一度同じ Goal State の情報を流し込む (適用する) ことで、前回の変更処理をやり直すことにより、仮想マシンの実体の状態と Azure 基盤側で保持している Goal Stateとの状態が不一致となっている状況の修正が試みられます。</p><p>この時、物理ホスト サーバーの移動は発生するわけではなく、また、再適用処理自体が VM の再起動を引き起こすわけではありません。しかし、その時点での仮想マシンの実体の状態と Goal State の内容の差によっては、上述の動作の結果、稀ではありますが再起動が発生する可能性があります。そのため、再適用の実行に当たっては、仮想マシンの再起動が発生しても差し支えない時間帯での実行をお勧めいたします。</p><p>仮想マシン プロビジョニング起因の問題が疑われている場合の切り分けとして、再適用の実行をご案内しています。</p><p>なお、再適用に関しては、下記公開情報に記載がございますので、併せてご確認ください。</p><p>新しい GoalState を仮想マシンにトリガーする<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/troubleshoot#trigger-a-new-goalstate-to-the-vm">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/troubleshoot#trigger-a-new-goalstate-to-the-vm</a></p><h3 id="Azure-Portal-での操作画面-3"><a href="#Azure-Portal-での操作画面-3" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-reapply.png"></p><hr><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの洪です。&lt;/p&gt;
&lt;p&gt;Azure 仮想マシンで予期せぬ問題が発生した際に、切り分けとして再起動や再デプロイをご案内することがありますが、その際、お客様よりそれぞれの操作の違いや目的についてご質問いただくことがあります。&lt;/p&gt;
&lt;p&gt;そこで本稿では、 Azure 仮想マシンに対して行う操作として、「再起動」、「停止 (割り当て解除) / 起動」、 「再デプロイ」、「再適用」の違いに関して説明します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Oparation" scheme="https://jpaztech.github.io/blog/tags/Oparation/"/>
    
  </entry>
  
  <entry>
    <title>Azure 仮想マシンの再デプロイ</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-redeploy/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-redeploy/</id>
    <published>2021-05-24T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.701Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの洪です。</p><p>Azure 仮想マシンで接続不可などの問題が発生した際に、Azure 仮想マシンがデプロイされている物理ホスト サーバー起因の問題の切り分けとして再デプロイをご案内することがあります。</p><p>今回は、当サポート チームの旧ブログでご紹介しておりました再デプロイに関する情報を更新した上で、改めて Azure 仮想マシンの再デプロイの概要と、その実施方法（Azure ポータル、Azure Powershell）をご紹介いたします。</p><p>更新元の記事：<a href="https://jpaztech1.z11.web.core.windows.net/%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E6%96%B0%E3%81%97%E3%81%84%E3%83%8E%E3%83%BC%E3%83%89%E3%81%B8%E5%86%8D%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B.html">仮想マシンを新しいノードへ再デプロイする</a></p><span id="more"></span><hr><h2 id="■-再デプロイ"><a href="#■-再デプロイ" class="headerlink" title="■ 再デプロイ"></a>■ 再デプロイ</h2><p>再デプロイとは、仮想マシンが稼働する<strong>物理ホスト サーバーを明示的に移動させる (変更する)</strong> 操作です。<br>仮想マシンが稼働する物理ホスト サーバーからリソースの割り当てを解除し、同じ内容の仮想マシンを他の場所 (前回とは別の物理ホスト サーバー)で展開することを意味します。<br>割り当ての対象となるリソースとは、vCPU コア、メモリ、NIC、一時ディスクなどの物理リソースを示します。</p><p><img src="/blog/vm/vm-redeploy/Redeploy-Virtual-Machine-to-new-Azure-node.jpg"></p><p>仮想マシンへの接続ができない (RDP/SSH) 等の問題が発生した際に、Azure プラットフォームや Azure ネットワークの根底にある問題起因である場合、リソースの再割り当て（再デプロイ）を実行することで接続障害が解消されることがあります。</p><p>再デプロイを行う際は、下記の 2 点を注意する必要があります。</p><ul><li>一時的なディスクのデータが失われるということ</li><li>仮想マシンに関連付けられた動的な IP アドレスが更新されるということ</li></ul><hr><h2 id="■-仮想マシンを新しい物理ホスト-サーバーへ再デプロイする"><a href="#■-仮想マシンを新しい物理ホスト-サーバーへ再デプロイする" class="headerlink" title="■ 仮想マシンを新しい物理ホスト サーバーへ再デプロイする"></a>■ 仮想マシンを新しい物理ホスト サーバーへ再デプロイする</h2><h3 id="■-Azure-ポータルを使用する"><a href="#■-Azure-ポータルを使用する" class="headerlink" title="■ Azure ポータルを使用する"></a>■ Azure ポータルを使用する</h3><ol><li>再デプロイする仮想マシンを選択し、 [ サポート＋トラブルシューティング ] ブレードの [ 再展開と再適用 ] ボタンをクリックします。<br>なお、再デプロイは、リソースの再割り当てを実施する作業であるため、仮想マシンが割り当て解除済みの状態ですと実施することができません。<br>仮想マシンが実行中か、停止中 (ゲスト OS のシャットダウンのみ) であることを確認してご実施ください。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-portal-1.png"></p><ol start="2"><li>[ 再デプロイ ] ボタンをクリックします。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-portal-2.png"></p><ol start="3"><li>“仮想マシンが正常に再デプロイされました” との通知が表示されましたら再デプロイ完了となります。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-portal-3.png"></p><h3 id="■-Azure-PowerShell-を利用して再デプロイを実施する"><a href="#■-Azure-PowerShell-を利用して再デプロイを実施する" class="headerlink" title="■ Azure PowerShell を利用して再デプロイを実施する"></a>■ Azure PowerShell を利用して再デプロイを実施する</h3><p>こちらの手順では下記の PowerShell モジュールを使用しています。最新のモジュールについては各リンクをご確認ください。</p><blockquote><ul><li>PowerShell 7.1<br>(<a href="https://docs.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell">PowerShell をインストールする</a>)</li><li>AzPowerShell 5.9.0<br>(<a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-az-ps">Azure PowerShell をインストールする</a>)</li></ul></blockquote><ol><li>ポータル上で対象仮想マシンの状態が ‘実行中’ または ‘停止済み’ であることを確認します。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-1.png"></p><ol start="2"><li>PowerShell を開き、下記の Azure ログイン コマンド (<a href="https://docs.microsoft.com/en-us/powershell/module/az.accounts/Connect-AzAccount?view=azps-5.9.0">Connect-AzAccount</a>) を実行します。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Connect-AzAccount</span></span><br></pre></td></tr></table></figure><p>表示例 :<br><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-2.png"></p><ol start="3"><li>ログインが成功したら、サブスクリプション情報が表示されます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-3.png"></p><ol start="4"><li>1 つのアカウントに複数のサブスクリプション情報が含まれる場合は、一番最初のサブスクリプションが選択されます。そのため、必要に応じて作業するサブスクリプションを指定 (<a href="https://docs.microsoft.com/en-us/powershell/module/az.accounts/Set-AzContext?view=azps-5.9.0">Set-AzContext</a>) します。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzContext</span> <span class="literal">-Subscription</span> &lt;サブスクリプションID&gt;</span><br></pre></td></tr></table></figure><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-4.png"></p><ol start="5"><li>下記コマンド (<a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/set-azvm?view=azps-5.9.0#:~:text=The%20Set-AzVM%20cmdlet%20marks%20a%20virtual%20machine%20as,and%20use%20Sysprep%20to%20prepare%20the%20hard%20disk.">Set-AzVM</a>) で仮想マシンを再デプロイします。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVM</span> <span class="literal">-Redeploy</span> <span class="literal">-ResourceGroupName</span> &lt;リソースグループ名&gt; <span class="literal">-Name</span> &lt;仮想マシン名&gt;</span><br></pre></td></tr></table></figure><p>  <img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-5.png"></p><ol start="6"><li>ポータル上で仮想マシンの状態が <strong>‘更新中’</strong> となっていることが確認できます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-6.png"></p><ol start="7"><li>しばらく時間がたつと、PowerShell コマンドが成功していることが確認できます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-7.png"></p><ol start="8"><li>ポータル上でも対象仮想マシンの状態が <strong>‘実行中’</strong> に戻っていることが確認できます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-8.png"></p><hr><p>また、本記事は下記の公式ドキュメントを参考しております。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/redeploy-to-new-node-windows">新しい Azure ノードへの Windows 仮想マシンの再デプロイ</a></li><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/redeploy-to-new-node-linux">新しい Azure ノードへの Linux 仮想マシンの再デプロイ</a></li></ul><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの洪です。&lt;/p&gt;
&lt;p&gt;Azure 仮想マシンで接続不可などの問題が発生した際に、Azure 仮想マシンがデプロイされている物理ホスト サーバー起因の問題の切り分けとして再デプロイをご案内することがあります。&lt;/p&gt;
&lt;p&gt;今回は、当サポート チームの旧ブログでご紹介しておりました再デプロイに関する情報を更新した上で、改めて Azure 仮想マシンの再デプロイの概要と、その実施方法（Azure ポータル、Azure Powershell）をご紹介いたします。&lt;/p&gt;
&lt;p&gt;更新元の記事：&lt;a href=&quot;https://jpaztech1.z11.web.core.windows.net/%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E6%96%B0%E3%81%97%E3%81%84%E3%83%8E%E3%83%BC%E3%83%89%E3%81%B8%E5%86%8D%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B.html&quot;&gt;仮想マシンを新しいノードへ再デプロイする&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>カスタム DNS サーバー よくあるお問い合わせ - FAQ</title>
    <link href="https://jpaztech.github.io/blog/network/custom-dns-faq/"/>
    <id>https://jpaztech.github.io/blog/network/custom-dns-faq/</id>
    <published>2021-05-21T02:00:00.000Z</published>
    <updated>2021-06-04T13:16:36.569Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>Azure では、仮想ネットワークや仮想マシンに関連付いているネットワーク インターフェイス毎に、名前解決時の接続先となる DNS サーバーを複数指定することができます。</p><p>仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーの概要については、下記の弊社公開技術情報にも記載がございますので、ご参考になれば幸いです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#specify-dns-servers">DNS サーバーの指定</a></li></ul><p>このブログでは、仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーに関して、度々お問合せ頂く内容をご紹介させて頂きます。</p><span id="more"></span><hr><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><h4 id="Q-仮想マシンに関連付いているネットワーク-インターフェースに設定している-DNS-サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。"><a href="#Q-仮想マシンに関連付いているネットワーク-インターフェースに設定している-DNS-サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。" class="headerlink" title="Q. 仮想マシンに関連付いているネットワーク インターフェースに設定している DNS サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。"></a>Q. 仮想マシンに関連付いているネットワーク インターフェースに設定している DNS サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。</h4><p>A. 仮想ネットワークやネットワーク インターフェースの DNS サーバー設定を変更した後、仮想マシンの再起動を手動で実施いただくことで、お客様のタイミングで DNS サーバーの IP アドレスをご変更頂けます。</p><p>カスタム DNS サーバーの設定を変更すると、仮想マシンの OS に設定を反映させるために、Azure 基盤による任意のタイミングで仮想マシンを再起動することが想定されています。</p><p>但し、Azure 基盤による任意のタイミングで仮想マシンを再起動するため、直ぐに仮想マシンが再起動される可能性はゼロではございませんが、基本的には設定変更後暫く時間が経過してから仮想マシンが再起動されることになります。</p><p>そのため、意図しないタイミングで再起動が発生しないように、お客様のタイミングで Azure ポータルより手動で仮想マシンの再起動を実施頂くことをご検討いただければと存じます (OS の再起動では、カスタム DNS サーバーの設定は反映されません)。</p><p>なお、Azure 基盤側で再起動を実施するより前にお客様側で仮想マシンを再起動していただければ、Azure 基盤による仮想マシンの再起動は行われません。</p><h4 id="Q-可用性セット内の仮想マシンに関連付いているネットワーク-インターフェースのカスタム-DNS-サーバーを変更したいのですが、可用性セットの仮想マシンは-1-台ずつ自動で再起動されるのでしょうか。"><a href="#Q-可用性セット内の仮想マシンに関連付いているネットワーク-インターフェースのカスタム-DNS-サーバーを変更したいのですが、可用性セットの仮想マシンは-1-台ずつ自動で再起動されるのでしょうか。" class="headerlink" title="Q. 可用性セット内の仮想マシンに関連付いているネットワーク インターフェースのカスタム DNS サーバーを変更したいのですが、可用性セットの仮想マシンは 1 台ずつ自動で再起動されるのでしょうか。"></a>Q. 可用性セット内の仮想マシンに関連付いているネットワーク インターフェースのカスタム DNS サーバーを変更したいのですが、可用性セットの仮想マシンは 1 台ずつ自動で再起動されるのでしょうか。</h4><p>A. 仮想ネットワークもしくはネットワークインターフェイスの DNS サーバー設定を変更する場合、可用性セットであることを考慮して、可用性セットの仮想マシンを順番に再起動するとは限りません。</p><p>Azure 基盤による任意のタイミングで仮想マシンを再起動するため、直ぐに仮想マシンが再起動される可能性はゼロではございませんが、基本的には DNS サーバー設定変更後、暫く時間が経過してから仮想マシンが再起動されることになります。</p><p>そのため、可用性セットを構成されている仮想マシンであれば、DNS サーバー設定を変更した後、 Azure ポータルより手動で 1 台ずつ順番に再起動を実施いただくことで、お客様のタイミングで DNS サーバーの IP アドレスの変更が反映されますので、ご検討いただければと存じます。</p><p>なお、Azure 基盤側で再起動を実施するより前にお客様側で仮想マシンを再起動していただければ、Azure 基盤による仮想マシンの再起動は行われません。</p><h4 id="Q-仮想ネットワークやネットワーク-インターフェースにカスタム-DNS-サーバーとして複数の-IP-アドレスを登録しているのですが、名前解決時は各-DNS-サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。"><a href="#Q-仮想ネットワークやネットワーク-インターフェースにカスタム-DNS-サーバーとして複数の-IP-アドレスを登録しているのですが、名前解決時は各-DNS-サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。" class="headerlink" title="Q. 仮想ネットワークやネットワーク インターフェースにカスタム DNS サーバーとして複数の IP アドレスを登録しているのですが、名前解決時は各 DNS サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。"></a>Q. 仮想ネットワークやネットワーク インターフェースにカスタム DNS サーバーとして複数の IP アドレスを登録しているのですが、名前解決時は各 DNS サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。</h4><p>A. 複数のカスタム DNS サーバーの IP アドレスを指定された場合、どの DNS サーバーを参照するかは、仮想マシン上に構成された OS の動作に依存致します。</p><p>Azure の仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーの動作として、設定されたカスタム DNS サーバーの設定値を仮想マシンの OS に構成情報として展開致しますが、Azure の設定値としてカスタム DNS サーバーの優先度を設定する機能は持ち合わせておりません。</p><p>上記の動作より、カスタム DNS サーバーとして指定される DNS サーバーはいずれにおいても、Azure 上の仮想マシンが意図せず通信できない事象などを回避するために、パブリック インターネットに名前解決ができる構成としていただくことを推奨しております。</p><p>お客様の通信要件において、参照する DNS サーバーに優先度をつけて名前解決する場合は、Azure の機能では設定できないため、OS 上の設定において構成頂ければと存じます。</p><h4 id="Q-Azure-PowerShell-のコマンドを用いて、仮想マシン毎にカスタム-DNS-サーバーの-IP-アドレスの一覧を出力する方法はありますでしょうか。"><a href="#Q-Azure-PowerShell-のコマンドを用いて、仮想マシン毎にカスタム-DNS-サーバーの-IP-アドレスの一覧を出力する方法はありますでしょうか。" class="headerlink" title="Q. Azure PowerShell のコマンドを用いて、仮想マシン毎にカスタム DNS サーバーの IP アドレスの一覧を出力する方法はありますでしょうか。"></a>Q. Azure PowerShell のコマンドを用いて、仮想マシン毎にカスタム DNS サーバーの IP アドレスの一覧を出力する方法はありますでしょうか。</h4><p>A. 指定したリソース グループ内において、仮想マシンが関連付いている全てのネットワーク インターフェースの DNS 設定を出力するサンプル コマンドは下記のようになります。</p><p>■ サンプル コマンド</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Get-AzNetworkInterface -ResourceGroupName 【リソース グループ名】 | ForEach-Object &#123;</span><br><span class="line">    if ($_.VirtualMachine -ne $null) &#123;</span><br><span class="line">        $myObject = [PSCustomObject]@&#123;</span><br><span class="line">            NIC = &quot;NIC: &quot; + $_.Name</span><br><span class="line">            VM = &quot; VM: &quot; + $_.VirtualMachine.Id.Substring($_.VirtualMachine.Id.LastIndexOf(&quot;/&quot;) + 1)</span><br><span class="line">            DNS = &quot;DNS: &quot; + $_.DnsSettings.DnsServers</span><br><span class="line">        &#125;</span><br><span class="line">        $myObject.NIC</span><br><span class="line">        $myObject.VM</span><br><span class="line">        $myObject.DNS</span><br><span class="line">        echo &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>【リソース グループ名】は、検索対象のリソース グループの名称に置き換えて実行して下さい。</p><p>■ 例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Get-AzNetworkInterface -ResourceGroupName &quot;rg-myresources&quot; | ForEach-Object &#123;</span><br><span class="line">    if ($_.VirtualMachine -ne $null) &#123;</span><br><span class="line">        $myObject = [PSCustomObject]@&#123;</span><br><span class="line">            NIC = &quot;NIC: &quot; + $_.Name</span><br><span class="line">            VM = &quot; VM: &quot; + $_.VirtualMachine.Id.Substring($_.VirtualMachine.Id.LastIndexOf(&quot;/&quot;) + 1)</span><br><span class="line">            DNS = &quot;DNS: &quot; + $_.DnsSettings.DnsServers</span><br><span class="line">        &#125;</span><br><span class="line">        $myObject.NIC</span><br><span class="line">        $myObject.VM</span><br><span class="line">        $myObject.DNS</span><br><span class="line">        echo &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>■　結果出力例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NIC: kaishiha930</span><br><span class="line"> VM: kaishiha</span><br><span class="line">DNS: 8.8.8.8 1.1.1.1 2.2.2.2 3.3.3.3 4.4.4.4 5.5.5.5</span><br><span class="line"></span><br><span class="line">NIC: server0774</span><br><span class="line"> VM: Server0</span><br><span class="line">DNS: 168.63.129.16</span><br></pre></td></tr></table></figure><p>上から順番に、ネットワーク インターフェースの名称、そのネットワーク インターフェースに関連付いている Azure VM の名称、そのネットワーク インターフェースの DNS 設定の結果になります。</p><p>なお、Get-AzNetworkInterface コマンドの詳細情報に関しては、下記の弊社公開技術情報のドキュメントにございます。ご参考になれば幸いです。</p><ul><li><a href="https://docs.microsoft.com/en-us/powershell/module/az.network/get-aznetworkinterface?view=azps-4.3.0">Get-AzNetworkInterface</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;Azure では、仮想ネットワークや仮想マシンに関連付いているネットワーク インターフェイス毎に、名前解決時の接続先となる DNS サーバーを複数指定することができます。&lt;/p&gt;
&lt;p&gt;仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーの概要については、下記の弊社公開技術情報にも記載がございますので、ご参考になれば幸いです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#specify-dns-servers&quot;&gt;DNS サーバーの指定&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;このブログでは、仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーに関して、度々お問合せ頂く内容をご紹介させて頂きます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure 上の Windows OS が起動しない場合の情報まとめ (2021 年 5 月 14 日更新版)</title>
    <link href="https://jpaztech.github.io/blog/vm/windows-noboot-summary/"/>
    <id>https://jpaztech.github.io/blog/vm/windows-noboot-summary/</id>
    <published>2021-05-14T09:00:00.000Z</published>
    <updated>2021-06-04T13:16:36.717Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。<br>今回は、当サポートチームの旧ブログでご紹介しておりました Windows OS が起動しない (noboot) 場合の情報について、情報を更新した上で改めてご紹介いたします。</p><p>更新元の記事：<a href="https://jpaztech1.z11.web.core.windows.net/Azure%E4%B8%8A%E3%81%AEWindowsOS%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E6%83%85%E5%A0%B1%E3%81%BE%E3%81%A8%E3%82%81(2018%E5%B9%B48%E6%9C%8827%E6%97%A5%E7%89%88).html">Azure 上の Windows OS が起動しない場合の情報まとめ (2018 年 8 月 27 日版)</a></p><span id="more"></span><p>この Windows OS が起動しなくなる事象については、状況把握や復旧手段に関してご支援させていただいている際のポイントを、弊社 Windows サポートチームのブログからご紹介しています。</p><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 概要</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/</a></p></blockquote><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>なお、上記 Windows OS 観点のブログに記載されている [3] - [6] を Azure 環境上でお試しいただく方法については、下記の別記事で紹介しています。</p><blockquote><p><strong>管理ディスクの場合：</strong><br>【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/</a></p></blockquote><blockquote><p><strong>非管理ディスクの場合：</strong><br>【非管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/</a></p></blockquote><p>本記事では、Windows OS が起動しなくなる事象に関する Azure 観点での状況把握や復旧方法に関する Tips のまとめをご紹介します。</p><hr><h2 id="TIPS-1-ブート診断による画面確認"><a href="#TIPS-1-ブート診断による画面確認" class="headerlink" title="TIPS #1 ブート診断による画面確認"></a>TIPS #1 ブート診断による画面確認</h2><p>Windows VM ではブート診断を有効化していただくことで、Azure ポータル上から OS の画面ショットを見ることができます。<br>RDP 接続が出来ない場合には、ブート診断を使ってどのような画面になっているか確認をしましょう。<br>具体的な手順については、下記公開情報をご確認ください。</p><blockquote><p>ブート診断を使用して Azure の仮想マシンのトラブルシューティングを行う方法<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-diagnostics">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-diagnostics</a></p></blockquote><hr><h2 id="TIPS-2-Azure-における復旧方法"><a href="#TIPS-2-Azure-における復旧方法" class="headerlink" title="TIPS #2 Azure における復旧方法"></a>TIPS #2 Azure における復旧方法</h2><p>Windows OS が起動しなくなる事象は原因追及が困難な場合が多く、対処方法を実施しても必ず Windows OS が起動できるようになる保証はないことをご注意下さい。<br>最も確実な方法は <strong>バックアップから復旧させる方法</strong> になりますので、<strong>定期的なバックアップのご取得</strong> をご実施くださいますようお願いいたします。</p><p>もし、バックアップが存在しない場合には、上述の “<a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</a>“ にて記載されているような対処をお試しいただきます。</p><h3 id="■-バックアップからリストアする"><a href="#■-バックアップからリストアする" class="headerlink" title="■ バックアップからリストアする"></a>■ バックアップからリストアする</h3><h4 id="Azure-Backup"><a href="#Azure-Backup" class="headerlink" title="Azure Backup"></a>Azure Backup</h4><p>Azure Backup にて、VM のバックアップを取得しておけば、何かあった場合に正常時の状態からの復元が行える可能性が高いです。<br>Azure Backup に関する公開情報をいくつかご紹介いたしますので、ご参考情報としてご確認いただけますと幸いです。</p><blockquote><p>Azure で仮想マシンをバックアップする<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/quick-backup-vm-portal">https://docs.microsoft.com/ja-jp/azure/backup/quick-backup-vm-portal</a></p></blockquote><blockquote><p>Azure portal で Azure VM データを復元する方法<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a></p></blockquote><blockquote><p>Azure VM バックアップのサポート マトリックス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas</a></p></blockquote><h4 id="スナップショット"><a href="#スナップショット" class="headerlink" title="スナップショット"></a>スナップショット</h4><p>Azure Backup を使用できない場合は、ディスク リソースのスナップショットを取得し、有事の際にはそのスナップショットからディスクを復元する方法もあります。<br>スナップショットの取得に関する詳細な手順に関しましては、下記の公開情報をご確認ください。<br>なお、ディスクのスナップショットは、Azure Backup と異なり VM の稼働状態で取るとデータに不整合が発生する場合があります。<br>スナップショットを作成する前に VM を停止することをお勧めします。</p><blockquote><p>ポータルまたは PowerShell を使用してスナップショットを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk</a><br>※ 管理ディスク用の手順になります。</p></blockquote><h4 id="OS-ディスクのスワップ"><a href="#OS-ディスクのスワップ" class="headerlink" title="OS ディスクのスワップ"></a>OS ディスクのスワップ</h4><p>ディスクを復元した際には、事象が発生した VM の OS ディスクと入れ替えることが可能です。<br>詳細な手順は下記をご確認ください。</p><blockquote><p>VM の OS ディスクをスワップする<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm</a><br>※ 管理ディスク用の手順になります。</p></blockquote><h3 id="■-復旧用の-VM-を使って対応する"><a href="#■-復旧用の-VM-を使って対応する" class="headerlink" title="■ 復旧用の VM を使って対応する"></a>■ 復旧用の VM を使って対応する</h3><p>起動ができない VM の OS ディスクを、他の正常な VM にデータ ディスクとして接続することで、当該 OS ディスクに対する操作が可能となります。</p><p>順序が前後しますが、”<a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</a>“ 内で紹介している “[3] SFC (System File Checker)、[4] regback を用いたレジストリ復旧、[5] 更新プログラムのアンインストール、[6] ファイルシステムの破損チェック” は、この方法で実施することができます。</p><p>Azure 側の具体的な手順に関しては、再掲となりますが、下記の別記事でご紹介していますので、ご利用環境に合わせてご確認ください。</p><blockquote><p>【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/</a></p></blockquote><blockquote><p>【非管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/</a></p></blockquote><p>なお、公開情報としては下記がございますのでご確認ください。</p><blockquote><p>Azure Portal から OS ディスクを復旧 VM にアタッチして Windows VM のトラブルシューティングを行う<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows</a></p></blockquote><h3 id="■-Windows-の回復コンソールを使用する"><a href="#■-Windows-の回復コンソールを使用する" class="headerlink" title="■ Windows の回復コンソールを使用する"></a>■ Windows の回復コンソールを使用する</h3><p>“<a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</a>“ 内で紹介している、”[1] スタートアップ修復、[2] Boot 構成情報の修正” を実施する場合、Windows の回復コンソールの立ち上げが必要となります。<br>回復コンソールは、Azure 上からは直接操作ができませんので、Nested Hyper-V をご利用いただくか、VHD ファイルをオンプレミス環境にダウンロードし Hyper-V 環境を構築することで行います。</p><p>オンプレミス環境に Hyper-V 環境が無い場合、Azure での Nested Hyper-V 用 VM を一時的に作成するということが便利です。<br>具体的な手順に関しては、下記ブログをご確認ください。</p><blockquote><p>Nested Hyper-V を使った VM の復旧<br><a href="https://docs.microsoft.com/en-us/archive/blogs/jpaztech/recover_vm_using_nested_hyperv">https://docs.microsoft.com/en-us/archive/blogs/jpaztech/recover_vm_using_nested_hyperv</a></p></blockquote><!-- 後で更新する --><p>なお、オンプレミス環境で回復コンソールの立ち上げを実施する場合に関しても、オンプレミス環境で行う “Hyper-V 構築 → VHD のダウンロード → VM の起動” といった手順は、Nested Hyper-V を使った手順とほぼ同様となりますので、ご参考となれば幸いです。</p><hr><h2 id="TIPS-3-バックアップ取得に関する-Tips"><a href="#TIPS-3-バックアップ取得に関する-Tips" class="headerlink" title="TIPS #3 バックアップ取得に関する Tips"></a>TIPS #3 バックアップ取得に関する Tips</h2><p>上述の通り、Windows OS としての対処をご実施いただいても、事象が 100％ 復旧するという保証はなく、最も確実な復旧方法はバックアップから復旧させる方法になります。<br>バックアップからのリストアであれば、復旧までの時間がある程度予測できることも利点と言えます。<br>復旧をより確実なものとするために、以下のような点についても心がけてください。</p><h3 id="■-バックアップの基本-Azure-Backup-で複数世代のバックアップを保持する"><a href="#■-バックアップの基本-Azure-Backup-で複数世代のバックアップを保持する" class="headerlink" title="■ バックアップの基本: Azure Backup で複数世代のバックアップを保持する"></a>■ バックアップの基本: Azure Backup で複数世代のバックアップを保持する</h3><p>Windows OS が起動できないという状態に陥った場合、何らかの形で Windows OS のデータ (レジストリやファイル システム、ファイル システムのメタデータ) が破損してしまっている場合があります。<br>このような場合において事例上少なくないのは、「バックアップを取得したその時点で、すでに何らかのデータが壊れてしまっていた」という状況です。</p><p>Azure Backup は、VM を止めずにバックアップを取得するができます。<br>ただし、稼働中の OS は、起動時に必要なファイルの一部が破損しても、次の再起動までは走り続けることができるという場合があります。</p><h4 id="Windows-イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか"><a href="#Windows-イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか" class="headerlink" title="Windows イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか"></a>Windows イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか</h4><p>「Windows VM を再起動したら、OS が正しく起動されなかった。OS の問題が起きているようなので、バックアップからリストアを行った。状況が改善しないため、何世代か前のバックアップを用いてリストアを複数試してみたが、どれをリストアしても同様に OS が正しく起動されない状態になってしまった。」といったシナリオになります。</p><p>もともと Windows OS 内のレジストリやファイル システムが破損していたがそのまま稼働していた場合、再起動時に問題が顕在化し、OS が正しく起動できない事象が発生します。</p><p>Azure Backup は「1 日ごとに 7 世代」といったポリシー設定に基づいて世代管理します。<br>その枠内で無事復旧できるイメージがあればいいですが、そうではない場合、Azure Backup でも復旧できないシナリオもある、ということをご紹介します。<br>稀で不運な事例ではありますが、リスクとしてご認識くださいますようお願いいたします。</p><h3 id="■-ディスクのスナップショットを活用しよう"><a href="#■-ディスクのスナップショットを活用しよう" class="headerlink" title="■ ディスクのスナップショットを活用しよう"></a>■ ディスクのスナップショットを活用しよう</h3><p>VM を再起動して無事に Windows OS が起動できたことが保証できるタイミングまでを含めて確認いただくことが一番安全ではありますが、再起動なんて月に 1 度か、それ以下しかしない、という場合も勿論あります。</p><p>その場合には、「正常な状態の VM を停止し、OS ディスクのスナップショットを作成しておく」ことをお勧めします。</p><p>上述の通り、データに不整合がある状態になることを防ぐため、スナップショットを作成する前に VM を停止することをお勧めします。<br>スナップショット作成のために、VM を停止 / 開始させることで、開始後に OS が正しく起動することを確かめることもできます。<br>(ゲスト OS のシャットダウンを実施してから VM の停止をご実施いただくとより安全です。)<br>(OS 起動が確約されるのであれば、前のバージョンのスナップショットは削除しても問題ないので、1 世代分のスナップショットを保持すればよいということになります。)</p><p>Windows OS にアプリケーションを追加したり、Windows Update を適用する、といったシステム変更に際してディスクのスナップショットを作成しておくと安心です。</p><h4 id="追加コストの話"><a href="#追加コストの話" class="headerlink" title="追加コストの話"></a>追加コストの話</h4><p>スナップショットの課金形態や考え方は、非管理ディスクと管理ディスクで若干異なります。<br>追加でコストが発生する部分となりますので、適切に理解をするため下記の通りご紹介します。</p><h4 id="非管理ディスクのスナップショット"><a href="#非管理ディスクのスナップショット" class="headerlink" title="非管理ディスクのスナップショット"></a>非管理ディスクのスナップショット</h4><p>非管理ディスクのスナップショットは、もとのディスク (VHD ファイル) のコピーではなく、その時点の差分データです。<br>そのため、VHD ファイルを誤って削除してしまうと、スナップショットも削除されてしまうのでご注意ください。<br>ただし課金の面では、差分の容量分のみが課金されます。</p><p>例:</p><ol><li>元々の使用量が 30 GB のVHDでスナップショットを作成する。<br>この時点ではスナップショットぶんの課金ゼロであり、30 GB の VHD の容量分のみの課金となる。</li><li>VHD ファイル上に 1 GB の変更が加わる。<br>この時点で以前のスナップショットとの差分で生じた 1 GB が加算された 31 GB ぶんの課金が発生する。</li></ol><p>上記の詳細については、下記公開情報をご確認ください。</p><blockquote><p>Blob スナップショットの課金方法について<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-how-snapshots-accrue-charges">https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-how-snapshots-accrue-charges</a></p></blockquote><blockquote><p>Managed Disks の価格<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/</a></p><blockquote><p>&lt;抜粋 (2021/5/14) &gt;<br>Premium SSD Managed Disks の完全なスナップショットとイメージを Standard ストレージに格納できます。<br>ローカル冗長 (LRS) とゾーン冗長 (ZRS) スナップショットのいずれかのオプションをお選びいただけます。<br>Standard LRS と Standard ZRS どちらのオプションでも、これらのスナップショットとイメージはディスクの使用量に応じて月々 ¥5.600/GB で課金されます。<br>たとえば、プロビジョニングされた容量が 64 GB のマネージド ディスクのスナップショットを作成し、実際に使用したデータ サイズが 10 GB だった場合、スナップショットは、使用したデータ サイズである 10 GB に対してのみ課金されます。<br>Premium SSD マネージド ディスク ストレージに保存することを選択した場合、1 か月あたり ¥17.024/GB で課金されます。</p></blockquote></blockquote><h4 id="管理ディスクのスナップショット"><a href="#管理ディスクのスナップショット" class="headerlink" title="管理ディスクのスナップショット"></a>管理ディスクのスナップショット</h4><p>管理ディスクのスナップショットは、もとのディスク (VHD ファイル) の完全な複製です。<br>そのため、スナップショットを作成した元のディスクを削除してもスナップショットは削除されず、スナップショットからディスクの作成 (復元) を実施することが可能です。<br>課金の面では、スナップショット元のデータのコピーのため、実使用量分のデータが課金対象になります。</p><p>管理ディスクは、P10 (Premium, 128GiB) や S10 (Standard, 128GiB) といった決まったサイズごとに課金枠が決まっていますが、スナップショットはその中の実容量をベースに課金されます。<br>つまり、128 GiB の VHD 中、10 GiB しか使われていなかったら、10 GiB 分のみがスナップショットの課金額となります。</p><p>なお、Premium ストレージのスナップショットを Standard ストレージに取る、ということも可能です。<br>例えば、P10 の管理ディスクとそのスナップショット (Standard ストレージ) に取得する場合、[もとのディスクの料金 (P10)] と、[Standard スナップショットの容量別課金 × 使用している実容量 GiB] の課金が発生することとなります。</p><h3 id="■-参考資料"><a href="#■-参考資料" class="headerlink" title="■ 参考資料"></a>■ 参考資料</h3><p>バックアップと高可用性、DR との違い、といった点も理解しておくことが重要です。<br>高可用性環境なら、VM 1 台の OS が起動しなかった場合にも復旧のための時間的猶予が生まれます。</p><p>下記ブログのアーカイブにて、Azure において様々に存在するダウンタイムを避けるサービスについて紹介しておりますので、ご参考情報としてご参照下さい。</p><blockquote><p>Azure エンジニアが解説する落ちないサービス入門<br><a href="https://blogs.technet.microsoft.com/jpaztech/2018/05/29/aiming_no_downtime/">https://blogs.technet.microsoft.com/jpaztech/2018/05/29/aiming_no_downtime/</a></p></blockquote><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;br&gt;今回は、当サポートチームの旧ブログでご紹介しておりました Windows OS が起動しない (noboot) 場合の情報について、情報を更新した上で改めてご紹介いたします。&lt;/p&gt;
&lt;p&gt;更新元の記事：&lt;a href=&quot;https://jpaztech1.z11.web.core.windows.net/Azure%E4%B8%8A%E3%81%AEWindowsOS%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E6%83%85%E5%A0%B1%E3%81%BE%E3%81%A8%E3%82%81(2018%E5%B9%B48%E6%9C%8827%E6%97%A5%E7%89%88).html&quot;&gt;Azure 上の Windows OS が起動しない場合の情報まとめ (2018 年 8 月 27 日版)&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
  </entry>
  
  <entry>
    <title>【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順</title>
    <link href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/</id>
    <published>2021-05-14T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.677Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。<br>本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。</p><span id="more"></span><p>Windows OS の復旧手順に関しては、Windows サポートチームのブログからご紹介しています。<br>本記事では、[対処方法] 編に記載されている切り分け [3] - [6] を Azure 環境上でお試しいただく方法について紹介しています。</p><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 概要</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/</a></p></blockquote><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>本記事では、<span style="color:red;"><strong>管理ディスク</strong></span>をご利用の環境用の手順を紹介します。非管理ディスクをご利用の場合は、「<a href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/">【非管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順</a>」をご確認ください。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ol><li>当該仮想マシンの OS ディスクのスナップショットを取得します</li><li>スナップショットから、修復用 OS ディスクを作成します</li><li>復旧作業用仮想マシンに、修復用 OS ディスクを接続します</li><li>復旧作業用仮想マシンにて、切り分けを実施します</li><li>修復用 OS ディスクを、対象仮想マシンの OS ディスクとスワップさせます</li></ol><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-当該仮想マシンの-OS-ディスクのスナップショットを取得します"><a href="#1-当該仮想マシンの-OS-ディスクのスナップショットを取得します" class="headerlink" title="1. 当該仮想マシンの OS ディスクのスナップショットを取得します"></a>1. 当該仮想マシンの OS ディスクのスナップショットを取得します</h3><p>Azure Portal より 仮想マシンを停止できるようであれば、停止してからご実施ください。</p><ol><li>Azure Portal より [Virtual Machine] - [&lt;当該仮想マシン&gt;] を開き、左メニュー “設定” から [ディスク] をクリックします。</li><li>[&lt;当該 OS ディスク&gt;] をクリックし、[スナップショットの作成] をクリックします。</li></ol><p><img src="/blog/vm/noboot-recovery-managed-disk/1.png"></p><ol start="3"><li>適宜、値を設定し、[確認および作成] - [作成] をクリックします。</li></ol><blockquote><p>スナップショットの作成<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk#use-the-azure-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk#use-the-azure-portal</a></p></blockquote><h3 id="2-スナップショットから、修復用-OS-ディスクを作成します"><a href="#2-スナップショットから、修復用-OS-ディスクを作成します" class="headerlink" title="2. スナップショットから、修復用 OS ディスクを作成します"></a>2. スナップショットから、修復用 OS ディスクを作成します</h3><ol><li>Azure Portal にて [リソースの作成] をクリックし、検索窓に “Managed Disks” と入力します。</li><li>[作成] をクリックし、適宜値を設定します。<br>“ソースの種類” を [スナップショット] に指定し、1 にて作成したスナップショットを指定します。</li><li>[確認および作成] - [作成] をクリックします。</li></ol><blockquote><p>管理ディスク (Managed Disks) スナップショットより VM をデプロイする<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/deployvmfromsnapshot">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/deployvmfromsnapshot</a><br>「2. スナップショットより “ディスク” リソースを作成する」をご確認ください。</p></blockquote><h3 id="3-復旧作業用仮想マシンに、修復用-OS-ディスクを接続します"><a href="#3-復旧作業用仮想マシンに、修復用-OS-ディスクを接続します" class="headerlink" title="3. 復旧作業用仮想マシンに、修復用 OS ディスクを接続します"></a>3. 復旧作業用仮想マシンに、修復用 OS ディスクを接続します</h3><ol><li>本事象のトラブルシューティングを行う復旧作業用仮想マシンを別途ご準備いただき、作成した OS ディスクをデータ ディスクとして接続します。</li></ol><p><img src="/blog/vm/noboot-recovery-managed-disk/3.png"></p><ol start="2"><li>復旧作業用仮想マシンに RDP 接続します。</li></ol><h3 id="4-復旧作業用仮想マシンにて、切り分けを実施します"><a href="#4-復旧作業用仮想マシンにて、切り分けを実施します" class="headerlink" title="4.復旧作業用仮想マシンにて、切り分けを実施します"></a>4.復旧作業用仮想マシンにて、切り分けを実施します</h3><p>下記 Windows OS 観点のブログに記載されている [3] - [6] をお試し下さい。</p><blockquote><p>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法<br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>また、事象別のトラブルシューティングについては、下記公開情報に詳細が記載されています。併せてご確認ください。</p><blockquote><p>Azure 仮想マシンのブート エラーのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot</a></p></blockquote><h3 id="5-修復用-OS-ディスクを、対象仮想マシンの-OS-ディスクとスワップさせます"><a href="#5-修復用-OS-ディスクを、対象仮想マシンの-OS-ディスクとスワップさせます" class="headerlink" title="5. 修復用 OS ディスクを、対象仮想マシンの OS ディスクとスワップさせます"></a>5. 修復用 OS ディスクを、対象仮想マシンの OS ディスクとスワップさせます</h3><ol><li>復旧作業用仮想マシンを停止し、データ ディスクとして接続されている修復した OS ディスクをデタッチします。</li><li>対象仮想マシンの OS ディスクを、修復した OS ディスクとスワップします。</li></ol><p><img src="/blog/vm/noboot-recovery-managed-disk/4.png"></p><p><img src="/blog/vm/noboot-recovery-managed-disk/5.png"></p><blockquote><p>VM の OS ディスクをスワップする<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm</a></p></blockquote><ol start="3"><li>復旧対象仮想マシンを起動し、事象が解消されたかをご確認ください。</li></ol><p>手順は以上となります。</p><hr><h2 id="ご参考"><a href="#ご参考" class="headerlink" title="ご参考"></a>ご参考</h2><blockquote><p>Azure Portal から OS ディスクを復旧 VM にアタッチして Windows VM のトラブルシューティングを行う<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows</a></p></blockquote><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;br&gt;本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
  </entry>
  
  <entry>
    <title>【非管理ディスク編】 復旧 VM を使った Windows VM の Noboot 復旧手順</title>
    <link href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/</id>
    <published>2021-05-14T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.681Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。<br>本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。</p><span id="more"></span><p>Windows OS の復旧手順に関しては、Windows サポートチームのブログからご紹介しています。<br>本記事では、[対処方法] 編に記載されている切り分け [3] - [6] を Azure 環境上でお試しいただく方法について紹介しています。</p><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 概要</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/</a></p></blockquote><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>本記事では、<span style="color:red;"><strong>非管理ディスク</strong></span>をご利用の環境用の手順を紹介します。管理ディスクをご利用の場合は、「<a href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/">【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順</a>」をご確認ください。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ol><li>復旧対象仮想マシンの OS ディスク VHD ファイルを複製します</li><li>復旧作業用の仮想マシンにて、複製した VHD ファイルをデータ ディスクとしてアタッチします</li><li>復旧作業用仮想マシンにて、切り分けを実施します。</li><li>修復した VHD を Azure PowerShell にて現在の復旧対象の仮想マシンの VHD と差し替えます。</li></ol><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-復旧対象仮想マシンの-OS-ディスク-VHD-ファイルを複製します"><a href="#1-復旧対象仮想マシンの-OS-ディスク-VHD-ファイルを複製します" class="headerlink" title="1. 復旧対象仮想マシンの OS ディスク VHD ファイルを複製します"></a>1. 復旧対象仮想マシンの OS ディスク VHD ファイルを複製します</h3><p>Azure Storage Explorer または AzCopy をご利用いただく方法にて、復旧対象仮想マシンの OS ディスク VHD ファイルを複製します。　</p><h4 id="Azure-Storage-Explorer-をご利用いただく場合"><a href="#Azure-Storage-Explorer-をご利用いただく場合" class="headerlink" title="Azure Storage Explorer をご利用いただく場合"></a>Azure Storage Explorer をご利用いただく場合</h4><p>Azure Storage Explorer については、下記公開情報をご確認ください。</p><blockquote><p>Azure Storage Explorer<br><a href="https://azure.microsoft.com/ja-jp/features/storage-explorer/">https://azure.microsoft.com/ja-jp/features/storage-explorer/</a></p></blockquote><ol><li><p>復旧対象仮想マシンを停止 (割り当て解除) します。</p></li><li><p>Azure Storage Explorer にて [ストレージ アカウント] - [&lt;ストレージ アカウント名&gt;] - [Blob Containers] - [vhds (コンテナ―名)] を開き、復旧対象仮想マシンの OS ディスクの VHD を選択した状態で、[クローン] をクリックします。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/1.png"></p></li><li><p>“BLOB を新しい名前で複製” 画面にて [&lt;複製後の VHD 名&gt;] を入力し、[複製] をクリックします。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/2.png"></p></li><li><p>複製が完了した際には Azure Storage Explorer の “アクティビティ” に “転送完了” のメッセージが表示されます。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/3.png"></p></li></ol><h4 id="AzCopy-をご利用いただく場合"><a href="#AzCopy-をご利用いただく場合" class="headerlink" title="AzCopy をご利用いただく場合"></a>AzCopy をご利用いただく場合</h4><p>AzCopy については、下記公開情報をご確認ください。</p><blockquote><p>AzCopy を使ってみる<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10</a></p></blockquote><ol><li>復旧対象仮想マシンを停止 (割り当て解除) します。</li><li>AzCopy コマンドを下記の通り実行します。<br>構文：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./azcopy.exe <span class="built_in">copy</span> <span class="string">&quot;https://ストレージアカウント名.blob.core.windows.net/vhds/複製元のディスク名.vhd?SAS&quot;</span> <span class="string">&quot;https://ストレージアカウント名.blob.core.windows.net/vhds/複製後のディスク名.vhd?SAS&quot;</span> -<span class="literal">-overwrite</span>=prompt -<span class="literal">-s2s</span><span class="literal">-preserve</span><span class="literal">-access</span><span class="literal">-tier</span>=false -<span class="literal">-recursive</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="2-復旧作業用の仮想マシンにて、複製した-VHD-ファイルをデータ-ディスクとしてアタッチします"><a href="#2-復旧作業用の仮想マシンにて、複製した-VHD-ファイルをデータ-ディスクとしてアタッチします" class="headerlink" title="2. 復旧作業用の仮想マシンにて、複製した VHD ファイルをデータ ディスクとしてアタッチします"></a>2. 復旧作業用の仮想マシンにて、複製した VHD ファイルをデータ ディスクとしてアタッチします</h3><ol><li><p>復旧作業用の仮想マシンを作成します。<br>Azure Portal から [Virtual Machines] を開き、 [+ 追加] をクリックし、復旧対象仮想マシンと同様のリージョンにて、同様の OS バージョンの非管理ディスクを用いた仮想マシンを作成します。</p></li><li><p>複製した VHD ファイルをデータ ディスクとしてアタッチします。<br>Azure Portal から [Virtual Machines] - [&lt;復旧作業用の仮想マシン名&gt;] を開き、左メニュー “設定” の [ディスク] をクリックします。</p></li><li><p>開いた画面にて [+ データ ディスクの追加] をクリックします。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/4.png"></p><p>[ソースの種類] を [既存の BLOB] とし、[ソース BLOB] を手順 2 にて複製した VHD を選択します。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/5.png"></p><p>[OK] をクリックし、前の画面にて [保存] をクリックします。</p><p><img src="./noboot-recovery-unmsanaged-disk/6.png"></p></li><li><p>復旧作業用仮想マシンに RDP 接続し、追加したデータ ディスクが認識されるかを確認します。</p></li></ol><h3 id="3-復旧作業用仮想マシンにて、切り分けを実施します"><a href="#3-復旧作業用仮想マシンにて、切り分けを実施します" class="headerlink" title="3. 復旧作業用仮想マシンにて、切り分けを実施します"></a>3. 復旧作業用仮想マシンにて、切り分けを実施します</h3><p>下記 Windows OS 観点のブログに記載されている [3] - [6] をお試し下さい。</p><blockquote><p>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法<br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>また、事象別のトラブルシューティングについては、下記公開情報に詳細が記載されています。併せてご確認ください。</p><blockquote><p>Azure 仮想マシンのブート エラーのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot</a></p></blockquote><h3 id="4-修復した-VHD-を-Azure-PowerShell-にて現在の復旧対象の仮想マシンの-VHD-と差し替えます"><a href="#4-修復した-VHD-を-Azure-PowerShell-にて現在の復旧対象の仮想マシンの-VHD-と差し替えます" class="headerlink" title="4. 修復した VHD を Azure PowerShell にて現在の復旧対象の仮想マシンの VHD と差し替えます"></a>4. 修復した VHD を Azure PowerShell にて現在の復旧対象の仮想マシンの VHD と差し替えます</h3><ol><li><p>Azure Portal より復旧作業用仮想マシンを停止 (割り当て解除) します。</p></li><li><p>Azure Portal から [Virtual Machines] - [&lt;復旧作業用の仮想マシン名&gt;] を開き、左メニュー “設定” の [ディスク] をクリックします。</p></li><li><p>データディスクをデタッチし、[保存] をクリックます。</p></li><li><p>復旧対象仮想マシンを停止 (割り当て解除) されていることを確認します。</p></li><li><p>PowerShell にて下記コマンドを実行します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#VM 情報の取得</span></span><br><span class="line"><span class="variable">$VM</span> = <span class="built_in">Get-AzVM</span> <span class="literal">-ResourceGroupName</span> リソースグループ名 <span class="literal">-name</span> 復旧対象仮想マシン名</span><br><span class="line"><span class="comment">#VHD ファイルの内容を差し替え</span></span><br><span class="line"><span class="variable">$VM</span>.StorageProfile.OsDisk.Vhd.Uri = <span class="string">&quot;修復した VHD ファイルのパス&quot;</span></span><br><span class="line"><span class="comment">#VM 情報の更新</span></span><br><span class="line"><span class="built_in">Update-AzVM</span> –VM <span class="variable">$VM</span> –ResourceGroupName リソースグループ名</span><br></pre></td></tr></table></figure><p>結果例：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RequestId IsSuccessStatusCode StatusCode ReasonPhrase</span><br><span class="line">--------- ------------------- ---------- ------------</span><br><span class="line">                         True         OK OK</span><br></pre></td></tr></table></figure><p>Azure PowerShell については、下記公開情報をご確認ください。</p><blockquote><p>Install the Azure Az PowerShell module<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-az-ps?view=azps-5.9.0">https://docs.microsoft.com/ja-jp/powershell/azure/install-az-ps?view=azps-5.9.0</a></p></blockquote></li><li><p>上記コマンド実施後、復旧対象仮想マシンの OS ディスクの参照先が変更されていることを確認します。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/7.png"></p></li><li><p>復旧対象仮想マシンを起動し、事象が解消されたかをご確認ください。</p></li></ol><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;br&gt;本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
  </entry>
  
  <entry>
    <title>オンプレ AD DS 認証を利用した Azure ファイル共有マウント手順</title>
    <link href="https://jpaztech.github.io/blog/storage/addsAuthforAzureFiles/"/>
    <id>https://jpaztech.github.io/blog/storage/addsAuthforAzureFiles/</id>
    <published>2021-05-10T09:00:00.000Z</published>
    <updated>2021-06-04T13:16:36.577Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。</p><p>Azure ファイル共有をマウントする場合、認証方法にはストレージ アカウント キーを使用した認証方法と ID ベース (Active Directory Domain Services / Azure Active Directory Domain Services)の認証方法があります。<br>その中でも今回はお問い合わせのよくある、オンプレ AD DS (Active Directory Domain Services) 認証によるファイル共有のマウント方法とアクセスについてご紹介いたします。</p><span id="more"></span><hr><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>Azure ファイル共有のオンプレ AD DS 認証をご使用いただく場合、以下の前提条件を満たしている必要があります。</p><p><strong>・Azure AD Connect</strong>  </p><p>オンプレ AD は <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-install-roadmap">Azure AD Connect</a> を使って Azure AD と同期している必要があります。</p><p>以下は Azure AD Connect により オンプレ AD と Azure AD が同期した状態の一例となります。</p><p><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles01.png"></p><p><strong>・ドメイン参加</strong>  </p><p>Azure ファイル共有 にアクセスするクライアント端末はドメイン参加またはドメインサーバーと通信できる必要があります。</p><p><strong>・ポート 445 の開放</strong>  </p><p>また、前提条件の詳細に関しては以下の公開情報を必ずご確認ください。</p><p>□参考：<a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-identity-auth-active-directory-enable#prerequisites">概要 - SMB を使用した Azure ファイル共有へのオンプレミスの Active Directory Domain Services 認証 &gt; 前提条件</a></p><hr><p>それでは、さっそくオンプレ AD DS 認証を有効化し、Windows Server へファイル共有をマウントしアクセスする手順をご紹介いたします。</p><h2 id="▼作業手順"><a href="#▼作業手順" class="headerlink" title="▼作業手順"></a>▼作業手順</h2><h3 id="1-Azure-ファイル共有の作成"><a href="#1-Azure-ファイル共有の作成" class="headerlink" title="(1) Azure ファイル共有の作成"></a>(1) Azure ファイル共有の作成</h3><p>(※すでに Azure ファイル共有を作成されている場合はこの手順は不要です。(2) へ進みます)</p><p>1-1. 対象のストレージアカウント「ファイル共有」へを押下します。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles02.png"></p><p>1-2. 「+ファイル共有」を押下し、「名前」「クォータ」「層」を入力し新しいファイル共有を作成します。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles03.png"></p><h3 id="2-Azure-ファイル共有に対するオンプレ-AD-DS-認証の有効化"><a href="#2-Azure-ファイル共有に対するオンプレ-AD-DS-認証の有効化" class="headerlink" title="(2) Azure ファイル共有に対するオンプレ AD DS 認証の有効化"></a>(2) Azure ファイル共有に対するオンプレ AD DS 認証の有効化</h3><p>2-1. AzFilesHybrid モジュールをダウンロードし解凍します。</p><p><a href="https://github.com/Azure-Samples/azure-files-samples/releases">https://github.com/Azure-Samples/azure-files-samples/releases</a></p><p>2-2. Azure ファイル共有のオンプレ AD DS 認証を有効化するスクリプトを実行します。</p><p>□参考：<a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-identity-ad-ds-enable#run-join-azstorageaccountforauth">Join-AzStorageAccountForAuth を実行する</a></p><p>▼スクリプト利用前提条件</p><ul><li><a href="https://github.com/Azure-Samples/azure-files-samples">AzureFilesActiveDirectoryUtilities.psm1</a> モジュールをダウンロードしていること</li><li>対象となる AD にサービス ログオン アカウントまたはコンピューター アカウントを作成するための権限を持つ AD 認証情報を用いて AD にドメイン参加している端末にモジュールをインストールして実行すること</li><li>ストレージアカウントに対して「所有者」または「共同作成者」の Azure RBAC ロールのいずれかを持つ Azure AD 資格情報でスクリプトを実行すること</li><li>対象のストレージアカウントがサポートされているリージョンに配置されていること</li></ul><p>Join-AzStorageAccountForAuth スクリプト例 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser</span><br><span class="line"></span><br><span class="line">.\CopyToPSPath.ps1 </span><br><span class="line"></span><br><span class="line">Import-Module -Name AzFilesHybrid</span><br><span class="line"></span><br><span class="line">Connect-AzAccount</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash">SubscriptionId = <span class="string">&quot;&lt;サブスクリプション ID&gt;&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">ResourceGroupName = <span class="string">&quot;&lt;リソースグループ名&gt;&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">StorageAccountName = <span class="string">&quot;&lt;ストレージアカウント名&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line">Select-AzSubscription -SubscriptionId $SubscriptionId </span><br><span class="line"></span><br><span class="line">Join-AzStorageAccountForAuth `</span><br><span class="line">        -ResourceGroupName $ResourceGroupName `</span><br><span class="line">        -StorageAccountName $StorageAccountName `</span><br><span class="line">        -DomainAccountType &quot;&lt;ComputerAccount/ServiceLogonAccount&gt;&quot; `</span><br><span class="line">        -OrganizationalUnitDistinguishedName &quot;&lt;ストレージアカウント用 OU 名&gt;&quot; `</span><br><span class="line">        -EncryptionType &quot;&lt;AES256/RC4/AES256,RC4&gt;&quot;</span><br><span class="line"></span><br><span class="line">Update-AzStorageAccountAuthForAES256 -ResourceGroupName $ResourceGroupName -StorageAccountName $StorageAccountName</span><br></pre></td></tr></table></figure><p>実行例<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles04.png"></p><p>2-3. 機能が有効になったことを確認します。</p><p>□参考：<a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-identity-ad-ds-enable#confirm-the-feature-is-enabled">機能が有効になっていることを確認する</a></p><p>実行例<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles05.png"></p><h3 id="3-ファイル共有レベルのアクセス権限を付与"><a href="#3-ファイル共有レベルのアクセス権限を付与" class="headerlink" title="(3)ファイル共有レベルのアクセス権限を付与"></a>(3)ファイル共有レベルのアクセス権限を付与</h3><p>□参考：<a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-identity-ad-ds-assign-permissions#share-level-permissions">共有レベルのアクセス許可</a></p><table><thead><tr><th>Azure RBAC</th><th>説明</th></tr></thead><tbody><tr><td>ストレージファイルデータの SMB 共有の管理者特権の共同作成者</td><td>SMB による Azure Storage ファイル共有に対する読み取り、書き込み、削除、および NTFS アクセス許可の変更のアクセスを許可します</td></tr><tr><td>記憶域ファイルデータの SMB 共有の共同作成者</td><td>SMB による Azure Storage ファイル共有に対する読み取り、書き込み、削除のアクセスを許可します</td></tr><tr><td>記憶域ファイルデータの SMB 共有の閲覧者</td><td>SMB による Azure ファイル共有に対する読み取りアクセスを許可します</td></tr></tbody></table><p>3-1. 対象の Azure ファイル共有 &gt; 「アクセス制御(IAM)」より上記必要なロールを付与します。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles06.png"></p><p>3-2. ロールが付与されたことを確認します。</p><p>(※ここでは例としてユーザー testuser0[1|2] に <strong>ストレージファイルデータの SMB 共有の管理者特権の共同作成者</strong> を付与しています)<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles07.png"></p><h3 id="4-Azure-ファイル共有マウント用コマンドをコピー"><a href="#4-Azure-ファイル共有マウント用コマンドをコピー" class="headerlink" title="(4) Azure ファイル共有マウント用コマンドをコピー"></a>(4) Azure ファイル共有マウント用コマンドをコピー</h3><p>Azure ファイル共有 [接続] より認証方法 [Active Directory] を選択し、表示されているコマンドをコピーします。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles08.png"></p><h3 id="5-手順-4-でロールを付与したユーザーでサインイン"><a href="#5-手順-4-でロールを付与したユーザーでサインイン" class="headerlink" title="(5) 手順(4) でロールを付与したユーザーでサインイン"></a>(5) 手順(4) でロールを付与したユーザーでサインイン</h3><p>ここでは例としてユーザー testuser01 でサインインしています。</p><p><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles11.png"></p><h3 id="6-手順-4-でコピーしたコマンドを実行"><a href="#6-手順-4-でコピーしたコマンドを実行" class="headerlink" title="(6) 手順(4) でコピーしたコマンドを実行"></a>(6) 手順(4) でコピーしたコマンドを実行</h3><p><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles09.png"></p><h3 id="7-マウントならびに-Azure-ファイル共有へアクセスできることを確認"><a href="#7-マウントならびに-Azure-ファイル共有へアクセスできることを確認" class="headerlink" title="(7) マウントならびに Azure ファイル共有へアクセスできることを確認"></a>(7) マウントならびに Azure ファイル共有へアクセスできることを確認</h3><p><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles10.png"></p><hr><p>なお、ストレージアカウントキーを使用してファイル共有をマウントすることで、Windows ACL (NTFS アクセス許可とも呼ばれます) を構成することも可能です。</p><p>□参考：<a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-identity-ad-ds-configure-permissions">パート 3: SMB 経由でディレクトリとファイル レベルのアクセス許可を構成する</a></p><p>ユーザー testuser01 にてストレージアカウントキーを使用しファイル共有をマウントします。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles18.png"></p><p>マウントしたドライブ内のフォルダに対してアクセス権限を設定します。</p><ul><li>フォルダ testuser01 はユーザー testuser01 にアクセス許可を付与</li><li>フォルダ testuser03 はユーザー testuser03 にアクセス許可を付与<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles19.png"></li></ul><p>アクセス権限の設定が適用されているか確認するため、ユーザー testuser03 でサインインし、認証方法 [Active Directory] のスクリプトにてファイル共有をマウントします。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles20.png"></p><p>アクセスを許可した testuser03 フォルダへはアクセスが可能です。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles21.png"></p><p>一方で、アクセスを許可していない testuser01 フォルダへはアクセスを行えません。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles22.png"></p><hr><p>ここまではドメインコントローラーに昇格した Windows Server にて Azure ファイル共有に対する AD DS 認証を有効化を実施し、ファイル共有のマウントならびにアクセスを行いました。<br>次は、上述のドメインに参加している Windows 10 端末にてファイル共有をマウントしアクセスが可能であるか確認します。</p><p>ドメイン参加している Windows 10 端末にサインインします。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles12.png"></p><p>Azure ファイル共有マウント用コマンドをコピーし実行します。<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles13.png"><br>ファイル共有へアクセスができることを確認できました。</p><hr><p>また、オンプレ AD DS 認証ではファイル共有へのアクセス元の端末がドメイン参加していない場合でも、オンプレ AD DS に参加しているドメインサーバーと通信できる状態であれば、認証に AD ユーザー資格情報を入力しファイル共有へアクセスすることも可能です。ご参考としていただけますと幸いです。</p><blockquote><p>□参考：<a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-identity-auth-active-directory-enable#prerequisites">概要 - SMB を使用した Azure ファイル共有へのオンプレミスの Active Directory Domain Services 認証 &gt; 前提条件</a></p><p>&lt;一部抜粋&gt;</p><p>オンプレミス マシンまたは Azure VM をオンプレミスの AD DS にドメイン参加させます。 ドメインに参加させる方法については、「コンピューターをドメインに参加させる」を参照してください。<br>マシンが AD DS にドメイン参加していない場合でも、マシンで AD ドメイン コントローラーが認識されていれば、認証に AD 資格情報を利用することはできます。</p></blockquote><p>ドメイン参加していない Windows 10 端末から、ドメイン参加済みアカウントの AD ユーザー資格情報を利用してファイル共有へアクセスしてみます。</p><p>環境</p><ul><li>ドメイン参加済みサーバー：win2016-adds-server-apts</li></ul><p>　　- ドメイン参加済みユーザー : <a href="mailto:&#119;&#x69;&#110;&#x31;&#x30;&#99;&#x6c;&#105;&#101;&#x6e;&#x74;&#x30;&#x31;&#x40;&#x63;&#111;&#110;&#116;&#111;&#115;&#111;&#46;&#99;&#x6f;&#109;">&#119;&#x69;&#110;&#x31;&#x30;&#99;&#x6c;&#105;&#101;&#x6e;&#x74;&#x30;&#x31;&#x40;&#x63;&#111;&#110;&#116;&#111;&#115;&#111;&#46;&#99;&#x6f;&#109;</a></p><ul><li>ドメイン未参加端末：win10-noadds-client-apts</li></ul><p>オンプレ AD DS に参加しているドメインサーバー (win2016-adds-server-apts)<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles16.png"></p><p>ドメイン参加していない Windows 10 端末 (win10-noadds-client-apts)</p><p>※ドメインサーバー (win10-adds-server-apts) と通信できる状態<br><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles14.png"></p><p>ドメイン参加していない Windows 10 端末 (win10-noadds-client-apts) のエクスプローラーに UNC (\\&lt;ストレージアカウント名&gt;.file.core.windows.net\&lt;ファイル共有名&gt;) を入力すると資格情報入力画面が表示されるため、AD ユーザー資格情報を入力しアクセスを行います。</p><p><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles15.png"></p><p>ここでは、ドメイン参加済みユーザー (<a href="mailto:&#x77;&#105;&#x6e;&#49;&#x30;&#99;&#x6c;&#x69;&#x65;&#110;&#x74;&#48;&#49;&#x40;&#x63;&#x6f;&#110;&#x74;&#x6f;&#x73;&#x6f;&#x2e;&#99;&#x6f;&#x6d;">&#x77;&#105;&#x6e;&#49;&#x30;&#99;&#x6c;&#x69;&#x65;&#110;&#x74;&#48;&#49;&#x40;&#x63;&#x6f;&#110;&#x74;&#x6f;&#x73;&#x6f;&#x2e;&#99;&#x6f;&#x6d;</a>) の AD ユーザー資格情報を利用しています。</p><p><img src="/blog/storage/addsAuthforAzureFiles/AzureFiles17.png"><br>ファイル共有へアクセスができることを確認できました。</p><hr><p>本稿は以上となりますが、いかがでしたでしょうか。 本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;/p&gt;
&lt;p&gt;Azure ファイル共有をマウントする場合、認証方法にはストレージ アカウント キーを使用した認証方法と ID ベース (Active Directory Domain Services / Azure Active Directory Domain Services)の認証方法があります。&lt;br&gt;その中でも今回はお問い合わせのよくある、オンプレ AD DS (Active Directory Domain Services) 認証によるファイル共有のマウント方法とアクセスについてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>Azure 環境における Windows Server 2016 にて日本語の言語パック適用ができない</title>
    <link href="https://jpaztech.github.io/blog/vm/win2016-jp-lpk-issue/"/>
    <id>https://jpaztech.github.io/blog/vm/win2016-jp-lpk-issue/</id>
    <published>2021-05-10T05:00:00.000Z</published>
    <updated>2021-06-04T13:16:36.717Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの大関です。 </p><p>2021 年 4 月より、Azure Market Place の Windows Server 2016 Datacenter イメージに含まれるトランザクションログの肥大化により、ゲスト OS の日本語化が失敗する事象が報告されております。<br>Azure Market Place より新規にデプロイした VM (Windows Server 2016 Datacenter) において、ゲスト OS の日本語化に失敗する事象が発生した事象の場合、こちらに該当している可能性が高いと考えられます。</p><p>本記事では、対処法についてご紹介いたしますので、下記手順をお試しいただき、言語パックの適用が完了するかをご確認ください。</p><span id="more"></span><p>なお、今回の問題は、Windows 2016 Datacenter イメージ自体の問題の可能性が高く、現在修正を実施しております。今月 (2021 年 5 月) 中には修正完了の予定ではございますが、 もし問題が発生しましたら本対処をご検討いただけますと幸いでございます。 </p><h2 id="対処策：TxR-配下のトランザクション-ログのリセット"><a href="#対処策：TxR-配下のトランザクション-ログのリセット" class="headerlink" title="対処策：TxR 配下のトランザクション ログのリセット"></a>対処策：TxR 配下のトランザクション ログのリセット</h2><p>TxR 配下のトランザクション ログは削除しようとしても、システム稼働時は常にシステム プロセスが参照しているため、削除しようとしてもエラーとなります。<br>このため、”PendMoves と MoveFile” という弊社の無償のサポート ツールを使ってトランザクション ログの削除をご検討ください。 </p><ol><li>“PendMoves と MoveFile” ツールの入手 <ul><li>以下の弊社サイトより “PendMoves.zip” をダウンロードし、解凍します。 </li><li>movefile.exeを対象マシンにコピーします。<br>(※pendmoves.exe は今回は使用いたしません) </li></ul></li></ol><blockquote><p>PendMoves v1.02 and MoveFile v1.01<br><a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/pendmoves">https://docs.microsoft.com/ja-jp/sysinternals/downloads/pendmoves</a> </p></blockquote><ol start="2"><li>attrib コマンドで隠し属性を解除します。<br>コマンド プロンプトを管理者として実行し以下のコマンドを実行します。 </li></ol><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\Windows\system32\config\txr </span><br><span class="line"><span class="built_in">attrib</span> -r -s -h * </span><br></pre></td></tr></table></figure><ol start="3"><li><p>CD コマンドで movefile.exe が保存されているディレクトリに移動します。 </p></li><li><p>movefile.exe コマンドで削除するファイルを登録するため、以下を1 行づつ実行してください。<br>※アスタリスクによるファイル指定ができないため、貴社環境に存在するファイルに基づきコマンドをご実施ください。<br>※”&lt;移動先&gt;” を空欄にすることで、次回再起動時にファイルの削除がスケジュールされます。 <br></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">movefile.exe /accepteula &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.<span class="number">0</span>.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.<span class="number">1</span>.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.<span class="number">2</span>.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.blf&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c5-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TM.blf&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c5-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TMContainer00000000000000000001.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c5-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TMContainer00000000000000000002.regtrans-ms&quot; &quot;&quot;</span><br></pre></td></tr></table></figure> <br> 下記と同様に表示されることをご確認後、システムの再起動を実施します。  <br> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Movefile v1.<span class="number">01</span> - copies over an <span class="keyword">in</span>-use file <span class="built_in">at</span> boot <span class="built_in">time</span> </span><br><span class="line"><span class="built_in">Move</span> successfully scheduled. </span><br></pre></td></tr></table></figure></li><li><p>改めて言語パックのインストールをご実施ください。 </p></li></ol><p>手順は以上となります。<br>上記情報が、少しでも皆様のご参考となれば幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの大関です。 &lt;/p&gt;
&lt;p&gt;2021 年 4 月より、Azure Market Place の Windows Server 2016 Datacenter イメージに含まれるトランザクションログの肥大化により、ゲスト OS の日本語化が失敗する事象が報告されております。&lt;br&gt;Azure Market Place より新規にデプロイした VM (Windows Server 2016 Datacenter) において、ゲスト OS の日本語化に失敗する事象が発生した事象の場合、こちらに該当している可能性が高いと考えられます。&lt;/p&gt;
&lt;p&gt;本記事では、対処法についてご紹介いたしますので、下記手順をお試しいただき、言語パックの適用が完了するかをご確認ください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法</title>
    <link href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/"/>
    <id>https://jpaztech.github.io/blog/vm/create-vm-using-vhd/</id>
    <published>2021-04-27T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.625Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの韓です。</p><p>Azure VM では、VM で利用している OS ディスクやデータ ディスクの VHD ファイルをエクスポートすることができます。<br>検証環境を作成するために別のサブスクリプション配下に複製 VM を作成したいときや既存の VM のリージョンを変更したいときには、エクスポートした VHD ファイルをストレージ アカウントにコピーし、新たに複製 VM を作成することで実現できます。</p><span id="more"></span><p>本記事では、<strong>ディスクの VHD ファイルをエクスポートしてストレージ アカウントにコピーする手順</strong>、および、<strong>エクスポートされた VHD ファイルから複製 VM を新規に作成する手順</strong>について紹介します。</p><p>なお、本記事の手順は ARM 環境にて管理ディスクを用いることを前提としています。<br>ASM 環境 (クラシック VM) や非管理ディスクをご利用の場合は対象としておりませんのでご注意ください。</p><hr><h2 id="■-ディスクの-VHD-ファイルをエクスポートしてストレージ-アカウントにコピーする手順"><a href="#■-ディスクの-VHD-ファイルをエクスポートしてストレージ-アカウントにコピーする手順" class="headerlink" title="■ ディスクの VHD ファイルをエクスポートしてストレージ アカウントにコピーする手順"></a>■ ディスクの VHD ファイルをエクスポートしてストレージ アカウントにコピーする手順</h2><h3 id="1-コピー先のストレージ-アカウントおよびコンテナ―を作成する"><a href="#1-コピー先のストレージ-アカウントおよびコンテナ―を作成する" class="headerlink" title="[1] コピー先のストレージ アカウントおよびコンテナ―を作成する"></a>[1] コピー先のストレージ アカウントおよびコンテナ―を作成する</h3><ol><li>Azure Portal より [Storage Account] を開き、[+ Create] をクリックします。<br>必須項目を適宜設定し、[Review ＋ create] – [Create] をクリックしてストレージ アカウントを作成します。</li></ol><ul><li>“Region” は、複製 VM を作成したいリージョンをご選択ください。</li><li>ストレージ アカウントのパフォーマンスは Standard (general-purpose v2 account) または Premium を選択する場合は、”Premium account type” は [Page blobs] を選択します。</li></ul><p><img src="/blog/vm/create-vm-using-vhd/1-1.jpg"></p><ol start="2"><li>Storage Account 作成後、[Storage Account] - [&lt;当該ストレージ アカウント名&gt;] を選択し、左メニュー “Blob service” から [Containers] を選択します。</li><li>[+ Containers] をクリックし [vhds] という名前でコンテナーを作成します。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/1-3.jpg"></p><h3 id="2-コピー先の-SAS-を発行する"><a href="#2-コピー先の-SAS-を発行する" class="headerlink" title="[2] コピー先の SAS を発行する"></a>[2] コピー先の SAS を発行する</h3><ol><li><p>手順 [1] - 3 で作成したコンテナ― [vhds] を選択し、左メニュー “Settings” から、[Shared Access Signature] を選択します。</p></li><li><p>[Shared Access Signature]の設定画面で、Permissionsに [Read] と [Write] を選択します。</p></li></ol><p><img src="/blog/vm/create-vm-using-vhd/2-2.jpg"></p><ol start="3"><li>Expiryに当該SASの有効期限を適宜に指定し、[Generate SAS token and URL] をクリックします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/2-3.jpg"></p><ol start="4"><li>[Blob SAS URL] をテキスト エディタ等にコピーします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/2-4.jpg"></p><ol start="5"><li>コピーした [Blob SAS URL] を以下の通り編集します。<br>※ VHD ファイル名は適宜設定してください。<br><strong><span style="color:red;">※ ここで作成した SAS URL は 後の手順 [4] - 3 にて、コピー先の URL として使います。</span></strong></li></ol><p>編集前:<br><strong>https://&lt;ストレージ アカウント名&gt;.blob.core.windows.net/vhds?&lt;’SAS URL’&gt;</strong></p><p>例:</p><blockquote><p><a href="https://xxxxxxxx.blob.core.windows.net/vhds?sp=rw&amp;st=2021-xx-xxTxx:xx:xxZ&amp;se=2021-xx-xxTxx:xx:xxZ&amp;spr=https&amp;sv=2020-02-10&amp;sr=c&amp;sig=xxxxxxxxxx">https://xxxxxxxx.blob.core.windows.net/vhds?sp=rw&amp;st=2021-xx-xxTxx:xx:xxZ&amp;se=2021-xx-xxTxx:xx:xxZ&amp;spr=https&amp;sv=2020-02-10&amp;sr=c&amp;sig=xxxxxxxxxx</a></p></blockquote><p>編集後:<br><strong>https://&lt;ストレージ アカウント名&gt;.blob.core.windows.net/vhds/&lt;コピー後の VHD ファイル名&gt;?&lt;’SAS URL’&gt;</strong></p><p>例:</p><blockquote><p><a href="https://xxxxxxxx.blob.core.windows.net/vhds/">https://xxxxxxxx.blob.core.windows.net/vhds/</a><span color="red">osdisk.vhd</span>?sp=rw&amp;st=2021-xx-xxTxx:xx:xxZ&amp;se=2021-xx-xxTxx:xx:xxZ&amp;spr=https&amp;sv=2020-02-10&amp;sr=c&amp;sig=xxxxxxxxxx</p></blockquote><h3 id="3-VHD-ファイルをエクスポートする"><a href="#3-VHD-ファイルをエクスポートする" class="headerlink" title="[3] VHD ファイルをエクスポートする"></a>[3] VHD ファイルをエクスポートする</h3><p>ディスクの VHD ファイルをエクスポートするには、後述の 2 つの方法 (A および B) があります。</p><p>方法 A は対象の OS ディスクにて直接エクスポートを行う方法であり、エクスポートのキャンセルを実施するまで、当該 OS ディスクが関連付けられている VM を起動することはできません。<br>ダウンタイムを最小にする必要がある場合には、ディスクのスナップショットを取得し、そのスナップショットをエクスポートする方法 B をお勧めします。</p><p>なお、下記の手順は OS ディスクのエクスポートについて記載しておりますが、データ ディスクをエクスポートいただく場合も同様となります。</p><h4 id="A-ディスクから直接-VHD-ファイルをエクスポートする場合"><a href="#A-ディスクから直接-VHD-ファイルをエクスポートする場合" class="headerlink" title="A: ディスクから直接 VHD ファイルをエクスポートする場合"></a>A: ディスクから直接 VHD ファイルをエクスポートする場合</h4><ol><li><p>複製元の VM を停止 (割り当て解除) します。<br>[Virtual Machines] - [&lt;当該 VM 名 (コピー元)&gt;] を選択し、[stop] をクリックします。<br>Statusが “Stopped (deallocated)” になったことを確認します。</p></li><li><p>左メニュー “Settings” より [Disks] を選択し、開いた画面 “OS disk” より、[&lt;当該 OS ディスク名&gt;] をクリックします。</p></li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-2a.jpg"></p><ol start="3"><li>左メニュー “Settings” から “Disk Export” をクリックします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-3a.jpg"></p><ol start="4"><li>“URL expires in (seconds)” を適宜多めに設定し、[Generate URL] をクリックします。<br>既定では 3600 秒 (1 時間) ですが、ネットワーク環境によりダウンロードに時間がかかることも予想されますので、適宜 86400 秒などにご調整ください。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-4a.jpg"></p><ol start="5"><li>表示された URL をテキスト エディタ等にコピーしておきます。</li></ol><p>  <strong><span style="color:red;">※ ここで作成した SAS URL は 後の手順 [4] - 3 にて、コピー元の URL として使います。</span></strong><br>  ※ コピー作業が完了したら、上記「Cancel export」ボタンで、SAS 発行を解除してください。<br>  ※ SAS 発行を解除しないと当該 VM は起動できません。</p><p><img src="/blog/vm/create-vm-using-vhd/3-5a.jpg"></p><h4 id="B-ディスクのスナップショットを取得し、そのスナップショットから-VHD-ファイルをエクスポートする場合"><a href="#B-ディスクのスナップショットを取得し、そのスナップショットから-VHD-ファイルをエクスポートする場合" class="headerlink" title="B: ディスクのスナップショットを取得し、そのスナップショットから VHD ファイルをエクスポートする場合"></a>B: ディスクのスナップショットを取得し、そのスナップショットから VHD ファイルをエクスポートする場合</h4><p>VM の長期にわたる停止が難しい場合には、取得いただいたディスクのスナップショットから VHD ファイルをエクスポートすることが可能です。</p><p>はじめに、ディスクのスナップショットを取得します。</p><ol><li>複製元の VM を停止 (割り当て解除) します。</li><li>左メニュー “Settings” より [Disks] を選択し、開いた画面 “OS disk” より、[&lt;当該 OS ディスク名&gt;] をクリックします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-2b.jpg"></p><ol start="3"><li>開いた画面にて [Create snapshot] をクリックします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-3b.jpg"></p><ol start="4"><li>必要項目を適宜入力し、[Review ＋ create] – [Create] をクリックします。<br>“Snapshot type” は [Full]、”Storage type” は、スナップショットを高パフォーマンスのディスクに保存する必要がある場合を除き、[Standard_HDD] を選択します。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-4b.jpg"></p><p>スナップショットの取得が完了したら、停止 (割り当て解除) いただいていた元 VM を起動いただいて問題ございません。<br>次に、VHD ファイルをエクスポートするための SAS を発行します。</p><ol start="5"><li>Azure Portal にて、[Snapshot] - [&lt;当該スナップショット&gt;] を選択します。</li><li>左メニュー “Settings” から “Snapshot export” をクリックします。</li><li>“URL expires in (seconds)” を適宜多めに設定し、[Generate URL] をクリックします。<br>既定では 3600 秒 (1 時間) ですが、ネットワーク環境によりダウンロードに時間がかかることも予想されますので、適宜 86400 秒などにご調整ください。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-8b.jpg"></p><ol start="8"><li>表示された URL をテキスト エディタ等にコピーしておきます。<br>   <strong><span style="color:red;">※ ここで作成した SAS URL は 後の手順 [4] - 3 にて、コピー元の URL として使います。</span></strong></li></ol><p><img src="/blog/vm/create-vm-using-vhd/3-9b.jpg"></p><h3 id="4-VHD-ファイルをストレージアカウントにコピーする"><a href="#4-VHD-ファイルをストレージアカウントにコピーする" class="headerlink" title="[4] VHD ファイルをストレージアカウントにコピーする"></a>[4] VHD ファイルをストレージアカウントにコピーする</h3><ol><li>ローカル環境に AzCopy コマンドをダウンロードします。<br>(Azure Portal にて、CloudShell をご利用いただいても問題ございません。)</li></ol><p>  ご参考：AzCopy を使ってみる<br>  <a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10</a></p><ol start="2"><li><p>管理者権限でコマンド プロンプトを起動し、AzCopy のフォルダに移動します。</p></li><li><p>以下のようにコマンドを実行し、VHD のコピーを行います。<br><strong>azcopy copy “&lt;手順 [3] でコピーしたURL (コピー元)&gt;” “手順 [2] の編集後の URL (コピー先)&gt;” –blob-type PageBlob</strong></p></li></ol><p>実行例：</p><blockquote><p>azcopy copy “<a href="https://xxxxxxxx.xxx.blob.storage.azure.net/xxxxxxxxxxxx/abcd?sv=2018-03-28&amp;sr=b&amp;si=%E7%95%A5&amp;sig=%E7%95%A5&quot;">https://xxxxxxxx.xxx.blob.storage.azure.net/xxxxxxxxxxxx/abcd?sv=2018-03-28&amp;sr=b&amp;si=略&amp;sig=略&quot;</a> “<a href="https://xxxxxxxx.blob.core.windows.net/vhds/osdisk.vhd?sp=rw&amp;st=2021-xx-xxTxx:xx:xxZ&amp;se=2021-xx-xxTxx:xx:xxZ&amp;spr=https&amp;sv=2020-02-10&amp;sr=c&amp;sig=%E7%95%A5&quot;">https://xxxxxxxx.blob.core.windows.net/vhds/osdisk.vhd?sp=rw&amp;st=2021-xx-xxTxx:xx:xxZ&amp;se=2021-xx-xxTxx:xx:xxZ&amp;spr=https&amp;sv=2020-02-10&amp;sr=c&amp;sig=略&quot;</a> –blob-type PageBlob</p></blockquote><p>  これにより、コピー先のリージョンのストレージアカウントにコピー元 VM の VHD ファイルをコピーすることができます。<br>  コピーが100% まで進行した後、少しおいて Job Summary が表示されます。<br>  Final Job Status: Completed と表示されていれば完了となります。</p><p>実行結果例 (途中省略)：<br><img src="/blog/vm/create-vm-using-vhd/4-3.jpg"></p><ol start="4"><li>VHDファイルのコピーが完了しますと、手順 [1] で作成したストレージ アカウントのコンテナー [vhds] にて、コピーされた VHD ファイルが確認できます。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/4-4.jpg"></p><hr><h2 id="■-エクスポートされた-VHD-ファイルから複製-VM-を新規に作成する手順"><a href="#■-エクスポートされた-VHD-ファイルから複製-VM-を新規に作成する手順" class="headerlink" title="■ エクスポートされた VHD ファイルから複製 VM を新規に作成する手順"></a>■ エクスポートされた VHD ファイルから複製 VM を新規に作成する手順</h2><h3 id="5-VHD-ファイルから管理ディスクを作成する"><a href="#5-VHD-ファイルから管理ディスクを作成する" class="headerlink" title="[5] VHD ファイルから管理ディスクを作成する"></a>[5] VHD ファイルから管理ディスクを作成する</h3><ol><li>Azure Portal より [Disk] を開き、[+ Create] をクリックします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/5-1.jpg"></p><ol start="2"><li>以下のとおり、適宜設定を行い、[Review + create] - [Create] をクリックします。<ul><li>手順 [1] のストレージ アカウントと同様の “Resource group” を選択します。</li><li>“Source type” は [Storage blob] を選択します。</li><li>“Source blob” は、[Browse] をクリックして、手順 [1] のストレージ アカウントのコンテナー [vhds] にコピーした VHD ファイルを選択します。</li><li>“OS の種類” は OS ディスクの場合にのみ、複製元 VM と同様のものを選択します。<ul><li>Windows の場合には [Windows] を、Linuxの場合、[Linux] を選択します。</li><li>データ ディスクの場合は [None] を選択します。</li></ul></li></ul></li></ol><p><img src="/blog/vm/create-vm-using-vhd/5-2.jpg"></p><h3 id="6-VHD-ファイルから作成したディスクで-VM-を作成する。"><a href="#6-VHD-ファイルから作成したディスクで-VM-を作成する。" class="headerlink" title="[6] VHD ファイルから作成したディスクで VM を作成する。"></a>[6] VHD ファイルから作成したディスクで VM を作成する。</h3><ol><li>Azure Portal より [Disk] を開き、手順 [5] で作成したDiskをクリックします。<br>ディスクのページ上部の [＋Create VM] をクリックし、コピーした VHD ファイルから作成した OS ディスクを使用した VM を作成します。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/6-1.jpg"></p><ol start="2"><li>適宜設定を行い、[Review + create] - [Create] をクリックします。</li></ol><p><img src="/blog/vm/create-vm-using-vhd/6-2.jpg"></p><p>手順は以上です。</p><p>なお、VHD ファイルをコピーするために作成したストレージ アカウントや VHD をエクスポートするために取得したスナップショットは、必要に応じて削除いただいて問題ございません。</p><hr><h2 id="■-ご参考"><a href="#■-ご参考" class="headerlink" title="■ ご参考"></a>■ ご参考</h2><ul><li>Azure から Windows VHD をダウンロードする<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/download-vhd">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/download-vhd</a></li><li>Azure から Linux VHD をダウンロードする<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/download-vhd">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/download-vhd</a></li><li>ポータルまたは PowerShell を使用してスナップショットを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk</a></li><li>AzCopy を使ってみる<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10</a></li><li>AzCopy v10 を使用して Azure ストレージ アカウント間で BLOB をコピーする<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-blobs-copy">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-blobs-copy</a></li><li>クイック スタート:Azure Portal で Windows 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal</a></li><li>クイック スタート:Azure portal で Linux 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの韓です。&lt;/p&gt;
&lt;p&gt;Azure VM では、VM で利用している OS ディスクやデータ ディスクの VHD ファイルをエクスポートすることができます。&lt;br&gt;検証環境を作成するために別のサブスクリプション配下に複製 VM を作成したいときや既存の VM のリージョンを変更したいときには、エクスポートした VHD ファイルをストレージ アカウントにコピーし、新たに複製 VM を作成することで実現できます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure Front Door を用いた App Service などへのセキュアな接続の構成</title>
    <link href="https://jpaztech.github.io/blog/network/AzureFrontDoor-LockDown/"/>
    <id>https://jpaztech.github.io/blog/network/AzureFrontDoor-LockDown/</id>
    <published>2021-04-01T15:00:00.000Z</published>
    <updated>2021-06-04T13:16:36.561Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム 箕輪 です。</p><p>Azure Front Door は、世界中に展開された Microsoft のリソースを用いて、レイヤー 7 (HTTP/HTTPS 層) で動作する負荷分散サービスとなります。<br>このブログでは、Azure Front Door についてよくお問い合わせをいただく、App Service などへのセキュアな接続の構成についてご紹介します。</p><span id="more"></span> <br><h2 id="Azure-Front-Door-の-概要"><a href="#Azure-Front-Door-の-概要" class="headerlink" title="Azure Front Door の 概要"></a>Azure Front Door の 概要</h2><p>Azure でご利用いただける負荷分散サービスやご選択いただく考え方としては、公開情報の <a href="https://docs.microsoft.com/ja-jp/azure/architecture/guide/technology-choices/load-balancing-overview">Azure 負荷分散を理解する</a> に記載があります。<br>この中で、Azure Front Door は、グローバル リージョンでご利用いただけるレイヤー 7 で動作する負荷分散サービスであり、公開情報では <a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-overview">Azure Front Door とは</a> に記載があります通り、下記の機能がご利用いただけます。</p><ul><li>スプリット TCP ベースの エニーキャスト プロトコル を使用したアプリケーションのパフォーマンスの高速化</li><li>インテリジェントな 正常性プローブ によるバックエンド リソースの監視</li><li>要求の URL パス ベース のルーティング</li><li>効率的なアプリケーション インフラストラクチャを実現する、複数の Web サイトのホスティング</li><li>Cookie ベースの セッション アフィニティ</li><li>SSL オフロード と証明書管理</li><li>独自の カスタム ドメイン の定義</li><li>Web Application Firewall (WAF) が統合されたアプリケーション セキュリティ</li><li>URL リダイレクト による、HTTPS への HTTP トラフィックのリダイレクト</li><li>URL 書き換え によるカスタム転送パス</li><li>エンド ツー エンドの IPv6 接続と HTTP/2 プロトコル のネイティブ サポート</li></ul><br><h2 id="Azure-Front-Door-におけるセキュアな構成"><a href="#Azure-Front-Door-におけるセキュアな構成" class="headerlink" title="Azure Front Door におけるセキュアな構成"></a>Azure Front Door におけるセキュアな構成</h2><p>Azure Front Door は上記の通り多くの機能を要しています。その中で、Azure Front Door の WAF (Web アプリケーション ファイアウォール) を利用いただければ、バックエンドに配置した Azure 仮想マシンや App Service 上の Web アプリケーションを、一般的な悪用や脆弱性を含んだリクエストから保護する構成がご利用いただけます。<br><br><br>Azure Front Door をご利用いただいているお客様からいただくご質問については、<a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-faq">Azure Front Door についてよく寄せられる質問</a> でご案内しておりますが、このブログではその中でもよくお問い合わせいただく、<a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-faq#how-do-i-lock-down-the-access-to-my-backend-to-only-azure-front-door">バックエンドへのアクセスを Azure Front Door のみにされたい構成</a> について、ご紹介いたします。</p><br><h2 id="Azure-Front-Door-で用いられる-IP-アドレス-FAQ"><a href="#Azure-Front-Door-で用いられる-IP-アドレス-FAQ" class="headerlink" title="Azure Front Door で用いられる IP アドレス FAQ"></a>Azure Front Door で用いられる IP アドレス FAQ</h2><p>Azure Front Door では、クライアントがAzure Front Door に接続するためのパブリック IP アドレスと、Azure Front Door からバックエンドのリソースに接続する際に用いられるパブリック IP アドレスは異なります。<br>Azure Fornt Door で用いられるパブリック IP アドレスは、<a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519">Azure IP 範囲とサービス タグ</a> で公開されています。<br>Azure Front Door が、バックエンドに構成されたリソースに接続する際のパブリック IP アドレスは、「AzureFrontDoor.Backend」セクションで公開されており、このパブリック IP アドレスの範囲の中から任意の IP アドレスが用いられます。<br><br><br>そのため、例えばバックエンドに Azure 仮想マシンを配置されている構成であれば、NSG のサービス タグで「AzureFrontDoor.Backend」からの HTTP/HTTPS 通信のみ許可することで、Azure Front Door のパブリック IP アドレス以外からの HTTP/HTTPS 接続を許可しない構成が可能です。</p><br><h2 id="Azure-Front-Door-の固有のリソース-ID"><a href="#Azure-Front-Door-の固有のリソース-ID" class="headerlink" title="Azure Front Door の固有のリソース ID"></a>Azure Front Door の固有のリソース ID</h2><p>Azure Front Door では、お客様のリソースに固有の ID 割り当てられており、バックエンドへの通信時の HTTP ヘッダーに “X-Azure-FDID” として追加されます。<br>IP アドレスでの制御に加えて、この HTTP ヘッダー “X-Azure FDID” を、バックエンドに配置したアプリケーション上でフィルター処理することで、構成いただいた Azure Front Door からの接続のみに限定することが可能です。<br><br><br>Azure Front Door のリソース ID は、Azure ポータルの Azure Front Door リソースの 概要 にある “フロント ドア ID” から確認できます。<br>コマンドであれば、下記のコマンドから “frontdoorId” を確認できます。<br><br></p><p><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.frontdoor/get-azfrontdoor?view=azps-5.7.0">Azure PowerShell (Get-AzFrontDoor)</a><br><br><br><a href="https://docs.microsoft.com/ja-jp/cli/azure/ext/front-door/network/front-door?view=azure-cli-latest#ext_front_door_az_network_front_door_show">Azure CLI (az network front-door show)</a></p><br><h2 id="App-Service-における制限設定"><a href="#App-Service-における制限設定" class="headerlink" title="App Service における制限設定"></a>App Service における制限設定</h2><p>Azure Front Door のバックエンドに App Service を配置している構成においては、上記で案内したパラメータを用いて、App Service の機能を用いてアクセス制限を構成することが可能です。<br>具体的な設定方法については、<a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-ip-restrictions#restrict-access-to-a-specific-azure-front-door-instance">Azure App Service のアクセス制限を設定する</a> で紹介しています。<br><br><br>設定値について抜粋すると下記の通りとなります。<br><br></p><ul><li>サービス タグにおいて、「AzureFrontDoor.Backend」を指定する</li><li>X-Azure-FDIDにおいて、Azure Front Door の固有のリソース ID を指定する<br></li></ul><p><img src="/blog/network/AzureFrontDoor-LockDown/AzureFrontDoor-AppService-LockDown.png" alt="参考 : App Service での設定例"> </p><br><h2 id="アプリケーション上のサンプル-IIS"><a href="#アプリケーション上のサンプル-IIS" class="headerlink" title="アプリケーション上のサンプル (IIS)"></a>アプリケーション上のサンプル (IIS)</h2><p>バックエンドの Web サーバー側での設定例として、web.config ファイルによる IIS (Internet Information Services) の構成設定例を以下にご案内いたします。お客様が構成された Web アプリケーションに適した形でご設定ください。<br><br><br>なお、Web サーバーやアプリケーション上での個別のフィルタリング方法については、お客様の構成範囲となりますため、Azure サポート担当では具体的なご支援ができない点はご理解いただきますようお願い申し上げます。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rewrite</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">&quot;Filter_X-Azure-FDID&quot;</span> <span class="attr">patternSyntax</span>=<span class="string">&quot;Wildcard&quot;</span> <span class="attr">stopProcessing</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">match</span> <span class="attr">url</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">conditions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">add</span> <span class="attr">input</span>=<span class="string">&quot;&#123;HTTP_X_AZURE_FDID&#125;&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span> <span class="attr">negate</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">conditions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">action</span> <span class="attr">type</span>=<span class="string">&quot;AbortRequest&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rewrite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><br><p>本ブログが皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チーム 箕輪 です。&lt;/p&gt;
&lt;p&gt;Azure Front Door は、世界中に展開された Microsoft のリソースを用いて、レイヤー 7 (HTTP/HTTPS 層) で動作する負荷分散サービスとなります。&lt;br&gt;このブログでは、Azure Front Door についてよくお問い合わせをいただく、App Service などへのセキュアな接続の構成についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="AzureFrontDoor" scheme="https://jpaztech.github.io/blog/tags/AzureFrontDoor/"/>
    
    <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Azure Firewall の各ルールの動作について</title>
    <link href="https://jpaztech.github.io/blog/network/firewall-rules/"/>
    <id>https://jpaztech.github.io/blog/network/firewall-rules/</id>
    <published>2021-03-31T03:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.569Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチーム檜山です。</p><p>今回は Azure Firewall の各ルールの動作についてよくあるお問い合わせを紹介させていただきます。</p><hr><p><span id="apprule-block"></span></p><h2 id="Azure-Firewall-のアプリケーションルールで許可されているように見える動作について"><a href="#Azure-Firewall-のアプリケーションルールで許可されているように見える動作について" class="headerlink" title="Azure Firewall のアプリケーションルールで許可されているように見える動作について"></a><a href="#apprule-block">Azure Firewall のアプリケーションルールで許可されているように見える動作について</a></h2><p>HTTP (80), HTTPS (443) の通信において、ネットワークルール、アプリケーションルールで明示的に拒否していない場合、ルールの処理順序に従って、Azure Firewall の既定の動作として、アプリケーションルールで拒否されることが想定される動作となります。</p><p>この動作について Windows の Test-Netconnection や Linux の curl, nc コマンド等 (以下に記載) で TCP の 3way handshake による接続確認を実施した場合はアプリケーションルールで許可していないにもかかわらず、3way handshake が確立され、許可されたように見える動作となります。この動作の詳細を以下に記載します。</p><ul><li>Powershell Test-NetConnection コマンド (Windows)</li></ul><blockquote><p>Test-NetConnection -port 443 <a href="http://www.micorosoft.com/">www.micorosoft.com</a></p><p>ComputerName     : <a href="http://www.micorosoft.com/">www.micorosoft.com</a><br>RemoteAddress    : 40.76.4.15<br>RemotePort       : 443<br>InterfaceAlias   : Ethernet 2<br>SourceAddress    : 10.0.1.5<br><span style="color: red">TcpTestSucceeded : True</span></p></blockquote><ul><li>nc コマンド (linux)</li></ul><blockquote><p>$ nc -vz <a href="http://www.microsoft.com/">www.microsoft.com</a> 443<br>Ncat: Version 7.50 ( <a href="https://nmap.org/ncat">https://nmap.org/ncat</a> )<br><span style="color: red">Ncat: Connected to 23.33.181.181:443.</span><br>Ncat: 0 bytes sent, 0 bytes received in 0.02 seconds.</p></blockquote><h3 id="Azure-Firewall-のアプリケーションルールの動作の詳細について"><a href="#Azure-Firewall-のアプリケーションルールの動作の詳細について" class="headerlink" title="Azure Firewall のアプリケーションルールの動作の詳細について"></a>Azure Firewall のアプリケーションルールの動作の詳細について</h3><p>上述の通り、TCP 80, 443 宛の通信について、ネットワークルールで明示的な拒否、許可がない場合、アプリケーションルールで評価され、許可ルールがない場合は既定の動作としてアプリケーションルールにて拒否されます。<br>アプリケーションルールでは HTTP のホストヘッダ、HTTPS の SNI の Server Name をもとにアプリケーションルール内の FQDN とマッチするかを確認して評価が行われます。</p><p>アプリケーションルールは L7 で動作しますので、内部的には クライアントと Azure Firewall 間で 3way handshake を確立し、HTTP , HTTPS の情報に基づいて通信を制御しますので、3way handshake が確立されることは想定される動作となります。</p><p>NSG にて接続が拒否されている Web サーバーにアクセスした際も、宛先アドレスと 3way handshake は確立可能で、HTTP, HTTPS のレイヤーで拒否されていることから、Azure Firewall が送信元を変換してパケットを返送するような動作であることが確認できます。</p><p><strong>そのため、アプリケーションルールで実際に通信が拒否されるかどうかを確認する際は、ブラウザや curl コマンド等で Web サイトへアクセスし、エラーによりクライアントへ期待される応答 (Status 200 等) が返らないことをご確認ください。</strong></p><p>アプリケーションルールにて拒否されている場合はブラウザや curl コマンドだと以下のような動作となります。</p><ul><li>Chrome [HTTP]</li></ul><table><thead><tr><th align="center"><img src="/blog/network/firewall-rules/http-deny-browser.png" alt="HTTP拒否"></th></tr></thead></table><ul><li>Chrome [HTTPS]</li></ul><table><thead><tr><th align="center"><img src="/blog/network/firewall-rules/https-deny-browser.png" alt="HTTPS拒否"></th></tr></thead></table><ul><li>curl コマンド (HTTP)</li></ul><blockquote><p>$ curl -v <a href="http://www.microsoft.com/">http://www.microsoft.com</a></p><p>About to connect() to <a href="http://www.microsoft.com/">www.microsoft.com</a> port 80 (#0)<br>   Trying 23.33.181.181…<br>Connected to <a href="http://www.microsoft.com/">www.microsoft.com</a> (23.33.181.181) port 80 (#0)<br>GET / HTTP/1.1<br>User-Agent: curl/7.29.0<br>Host: <a href="http://www.microsoft.com/">www.microsoft.com</a><br>Accept: <em>/</em></p><p>HTTP/1.1 470 status code 470<br>Date: Mon, 29 Mar 2021 04:29:57 GMT<br>Content-Length: 144<br>Content-Type: text/plain; charset=utf-8<br>Connection #0 to host <a href="http://www.microsoft.com/">www.microsoft.com</a> left intact<br><span style="color: red">HTTP  request from 10.0.1.4:53460 to <a href="http://www.microsoft.com/">www.microsoft.com:80</a>. Url: <a href="http://www.microsoft.com/">www.microsoft.com</a>. Action: Deny. No rule matched. Proceeding with default action</span></p></blockquote><ul><li>curl コマンド (HTTPS)</li></ul><blockquote><p>$ curl -v <a href="https://www.microsoft.com/">https://www.microsoft.com</a></p><p>About to connect() to <a href="http://www.microsoft.com/">www.microsoft.com</a> port 443 (#0)<br>  Trying 23.33.181.181…<br>Connected to <a href="http://www.microsoft.com/">www.microsoft.com</a> (23.33.181.181) port 443 (#0)<br>Initializing NSS with certpath: sql:/etc/pki/nssdb<br>  CAfile: /etc/pki/tls/certs/ca-bundle.crt<br>CApath: none<br><span style="color: red">NSS error -5938 (PR_END_OF_FILE_ERROR)</span><br><span style="color: red">Encountered end of file</span><br><span style="color: red">Closing connection 0</span><br><span style="color: red">curl: (35) Encountered end of file</span></p></blockquote><p><span id="difference-net-app"></span></p><h2 id="ネットワークルールと、アプリケーションルールの動作の違いについて"><a href="#ネットワークルールと、アプリケーションルールの動作の違いについて" class="headerlink" title="ネットワークルールと、アプリケーションルールの動作の違いについて"></a><a href="#difference-net-app">ネットワークルールと、アプリケーションルールの動作の違いについて</a></h2><h3 id="ネットワークルールの動作について"><a href="#ネットワークルールの動作について" class="headerlink" title="ネットワークルールの動作について"></a>ネットワークルールの動作について</h3><p>ネットワークルールは L4 で動作します。TCP の通信で宛先アドレス、宛先ポートが拒否されている場合、Azure Firewall は SYN/ACK を返しませんので、3way handshake に失敗し、通信が拒否される動作となります。</p><h3 id="アプリケーションルールとネットワークルールの動作の違いについて"><a href="#アプリケーションルールとネットワークルールの動作の違いについて" class="headerlink" title="アプリケーションルールとネットワークルールの動作の違いについて"></a>アプリケーションルールとネットワークルールの動作の違いについて</h3><p>上述の通り、ネットワークルールは L4 で動作し、アプリケーションルールは L7 で動作します。<br>どちらのルールを使用すべきかについては以下がベストプラクティスとなりますので、ご確認いただけますと幸いです。</p><ol><li>HTTP, HTTPS の通信において FQDN ベースで通信を制御できるものはアプリケーションルールを利用する</li><li>HTTP, HTTPS の通信において FQDN ベースで通信を制御できないものはネットワークルールを利用する</li><li>HTTP, HTTPS, MSSQL 以外の通信はネットワークルールを利用する</li></ol><h3 id="アプリケーションルールとネットワークルールの-FQDN-のフィルタリングについて"><a href="#アプリケーションルールとネットワークルールの-FQDN-のフィルタリングについて" class="headerlink" title="アプリケーションルールとネットワークルールの FQDN のフィルタリングについて"></a>アプリケーションルールとネットワークルールの FQDN のフィルタリングについて</h3><p>現在はアプリケーションルール、ネットワークルールどちらでも FQDN のフィルタリングが可能です。<br>ベストプラクティスは上述の通りとなりますが、HTTP, HTTPS の通信でアプリケーションルールの利用を推奨する理由としては以下もございます。</p><ul><li>IP アドレスが同一になるような FQDN でも制御可能 (CDN や AppService 等の同一 IP アドレスを複数のユーザーが利用する基盤が宛先となっている場合でも制御が可能)</li><li>ワイルドカードによる FQDN の指定が可能</li><li>DNS Proxy の利用が不要 (クライアント側の DNS の設定変更も不要)</li><li>Web トラフィックに対する今後の機能追加が優先的に行われる可能性がある </li></ul><p>ネットワークルールでの FQDN のフィルタリングは以下もご一読ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/fqdn-filtering-network-rules">ネットワーク ルールでの FQDN フィルタリング</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/dns-settings">Azure Firewall の DNS 設定</a></p><h2 id="Azure-Firewall-のルールの処理順序-フローチャート"><a href="#Azure-Firewall-のルールの処理順序-フローチャート" class="headerlink" title="Azure Firewall のルールの処理順序 (フローチャート)"></a>Azure Firewall のルールの処理順序 (フローチャート)</h2><p>Azure Firewall のルールの処理順序がわかりにくいというお問い合わせをいただくことがございます。以下のフローチャートにて詳細を記載しておりますのでご確認ください。</p><p><img src="/blog/network/firewall-rules/FWdefault-flow.png" alt="フローチャート"></p><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="設定変更時に既存接続への影響はありますか。"><a href="#設定変更時に既存接続への影響はありますか。" class="headerlink" title="- 設定変更時に既存接続への影響はありますか。"></a>- 設定変更時に既存接続への影響はありますか。</h4><p>DNAT ルール, ネットワークルール, アプリケーションルールの設定変更において、既存の接続に影響が出るような設定変更でなければ既存の接続に影響がでない動作となることを確認しております。</p><h4 id="戻りのパケットは診断ログに記録されますか。"><a href="#戻りのパケットは診断ログに記録されますか。" class="headerlink" title="- 戻りのパケットは診断ログに記録されますか。"></a>- 戻りのパケットは診断ログに記録されますか。</h4><p>ネットワークルールでは TCP の SYN パケットに対して許可/拒否が記録されますが、戻りのパケット (SYN/ACK) は診断ログには記録されない動作となります。</p><h4 id="「Action-Deny-Reason-SNI-TLS-extension-was-missing」で拒否される理由を教えてください。"><a href="#「Action-Deny-Reason-SNI-TLS-extension-was-missing」で拒否される理由を教えてください。" class="headerlink" title="- 「Action: Deny. Reason: SNI TLS extension was missing」で拒否される理由を教えてください。"></a>- 「Action: Deny. Reason: SNI TLS extension was missing」で拒否される理由を教えてください。</h4><p>アプリケーションルールでは TLS の通信を評価する際に Client Hello に含まれる SNI の Server Name を参照し、評価を行っております。そのため、SNI が利用されない通信はアプリケーションルールで制御することができません。</p><p>例えば、<a href="https://1.2.3.4/">https://1.2.3.4</a> のような IP アドレスでアクセスするような方法ですと、SNI が含まれるずにアプリケーションルールで拒否されることが想定されます。対応策としてはネットワークルールにて制御する必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview#known-issues">既知の問題</a></p><h4 id="NAT-ルールで拒否のログが記録されません。"><a href="#NAT-ルールで拒否のログが記録されません。" class="headerlink" title="- NAT ルールで拒否のログが記録されません。"></a>- NAT ルールで拒否のログが記録されません。</h4><p>NAT ルールで指定されている宛先ポート以外の通信のログは出力されない動作となります。NAT ルールが構成されている宛先ポートに対して通信を行い、拒否のログが出力されるかをご確認ください。</p><h4 id="NAT-ルールの処理順序をおしえてください。"><a href="#NAT-ルールの処理順序をおしえてください。" class="headerlink" title="- NAT ルールの処理順序をおしえてください。"></a>- NAT ルールの処理順序をおしえてください。</h4><ul><li>NAT ルールはネットワークルールより優先的に評価されます。</li><li>NAT ルールが適用されたトラフィックは暗黙的なネットワークルールにより許可されますが、この暗黙的なルールの優先度は明示的なネットワークルールの優先度よりも低くなります。</li></ul><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Firewall の概要や機能については以下にも記載がありますのでご一読ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview">Azure Firewall とは</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/features">Azure Firewall の機能</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/firewall-faq">Azure Firewall FAQ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Azure Firewall の各ルールの動作についてよくあるお問い合わせを紹介させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;span id=&quot;apprule-block&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>VM 複製方法について part.3/3 OS ディスクのスナップショットから複製する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-replica-3/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-replica-3/</id>
    <published>2021-03-29T05:00:03.000Z</published>
    <updated>2021-06-04T13:16:36.713Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は OS ディスクのスナップショットから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  </p><p>本記事は 3 部作の 3 記事目です。</p><ol><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a></li></ol><p>そのため 1 記事目の <a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a> をご覧いただいている前提で記載させていただきます。  </p><p>本記事では Azure ポータルで、OS ディスクのスナップショットから複製する手順について詳細に記載します。<br>また、マネージド ディスクの使用を前提とさせていただきますので、アンマネージド ディスクをご利用いただいている場合は、下記手順より VM をマネージドディスクに変換をお願いいたします。</p><ul><li>Azure VM を Azure Managed Disks に移行する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks</a></li></ul><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>Windows VM を複製しそれをご利用いただく場合、基本的には本手順はご利用いただけません。<br>詳細は <a href="https://jpaztech.github.io/blog/vm/vm-replica-1/#Windows-VM%E3%82%92%E8%A4%87%E8%A3%BD%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%96%B9%E3%81%B8%E3%81%AE%E6%B3%A8%E6%84%8F%E5%96%9A%E8%B5%B7">Windows-VM を複製しようとしている方への注意喚起</a> をご参照ください。  </p><p>また、スナップショットからの複製でご注意いただきたい点として、**<span style="color:red">スナップショットは VM 固有のファイルとデータは保持される</span>** 、**<span style="color:red">OS ディスクの完全読み取りコピーである</span>** ということがあります。<br>つまり、複製した VM は SID やホスト名が複製元と同一になります。 </p><p>そのため、完全複製による意図しない動作を防止するため、同一 VNET 上で元 VM と複製 VM を同時に起動しないようにしてください。<br>スナップショットからの複製する場合は <strong><span style="color:red">必ず別の VNET 上にデプロイするようにお願いいたします。</span></strong>    </p><p>なお、本記事では扱いませんが、Azure Backup をご利用いただいた場合も、複製 VM はバックアップ取得元の VM の完全複製となります。</p><h2 id="大まかな流れ"><a href="#大まかな流れ" class="headerlink" title="大まかな流れ"></a>大まかな流れ</h2><ol><li>複製元となる VM を用意する</li><li>VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得</li><li>作成した [スナップショット] より必要な数だけ [ディスク] を作成</li><li>作成した [ディスク] よりVM作成する</li></ol><h2 id="実際の手順"><a href="#実際の手順" class="headerlink" title="実際の手順"></a>実際の手順</h2><p>それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。  </p><hr><h3 id="1-複製元となる-VM-を作成する"><a href="#1-複製元となる-VM-を作成する" class="headerlink" title="1. 複製元となる VM を作成する"></a>1. 複製元となる VM を作成する</h3><p>複製元 (スナップショット取得元) となる仮想マシンを作成します。<br>詳細な手順は割愛させていただきますので、下記資料をご参照いただき VM を作成します。  </p><p>参考: クイック スタート:Azure Portal で Windows 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal</a></p><p>参考: クイック スタート:Azure portal で Linux 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal</a></p><hr><h3 id="2-VM-を停止-割り当て解除-し、OS-ディスクの-スナップショット-を取得"><a href="#2-VM-を停止-割り当て解除-し、OS-ディスクの-スナップショット-を取得" class="headerlink" title="2. VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得"></a>2. VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得</h3><p>Azure ポータルから、VM を停止 (割り当て解除) します。</p><p><img src="/blog/vm/vm-replica-3/snp-010.png"> </p><p>VM の [ディスク] ブレードより、OS ディスクを選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-020.png"> </p><p>上部にある [スナップショットの作成] を選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-030.png"> </p><p>スナップショット作成のオプションを選択します。<br>下記は一例とはなりますが、今回はスナップショットの種類は [フル] とし、記憶域の種類は [Standard HDD] としています。<br>設定が完了したら、[レビュー] を選択し、スナップショットを作成します。</p><p><img src="/blog/vm/vm-replica-3/snp-040.png"> </p><hr><h3 id="3-作成した-スナップショット-より必要な数だけ-ディスク-を作成"><a href="#3-作成した-スナップショット-より必要な数だけ-ディスク-を作成" class="headerlink" title="3.作成した [スナップショット] より必要な数だけ [ディスク] を作成"></a>3.作成した [スナップショット] より必要な数だけ [ディスク] を作成</h3><p>スナップショットからディスクを作成します。<br>なお、スナップショットからディスクは複数作成することができますが、ディスクから VM は 1 つしか作成できません。<br>そのため、Azure ポータルを用いて複数 VM を作成する場合はこの手順を繰り返し行うこととなります。</p><p>まずは、ポータル上部の検索ボックスで [スナップショット] を検索し、選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-050.png"></p><p>先ほど取得したスナップショットを一覧より選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-060.png"> </p><p>上部に表示される [ディスクの作成] を選択します。 </p><p><img src="/blog/vm/vm-replica-3/snp-070.png"></p><p>マネージドディスクを作成します。<br>基本的には、デフォルトの設定で問題無いかと思いますが、下記例ではサイズにて [Standard HDD] のディスクを作成するように設定しています。  </p><p>設定が完了したら [確認および作成] を選択し、マネージドディスクを作成します。</p><p><img src="/blog/vm/vm-replica-3/snp-080.png"> </p><h3 id="4-作成した-ディスク-より-VM-作成する"><a href="#4-作成した-ディスク-より-VM-作成する" class="headerlink" title="4.作成した [ディスク] より VM 作成する"></a>4.作成した [ディスク] より VM 作成する</h3><p>最後に作成したマネージド ディスクから VM を作成します。<br>まずはじめに、Azure ポータル上部の検索ボックスで [ディスク] を検索し、選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-090.png"> </p><p>先ほど作成したディスクを一覧より選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-100.png"> </p><p>上部に表示される [VM の作成] を選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-110.png"> </p><p>すると、VM 作成画面が表示されますので、新規 VM を作成するのと同じ要領で VM を作成します。</p><p><img src="/blog/vm/vm-replica-3/snp-120.png"> </p><p>以上が、Azure ポータルでのイメージを用いたスナップショットから VM を複製する手順となります。<br>もちろん PowerShell を用いた展開なども可能です。本記事が、基本的な手順としてお役に立てれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は OS ディスクのスナップショットから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  &lt;/p&gt;
&lt;p&gt;本記事は 3 部作の </summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>VM 複製方法について part.2/3 一般化したイメージから VM を複製する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-replica-2/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-replica-2/</id>
    <published>2021-03-29T05:00:02.000Z</published>
    <updated>2021-06-04T13:16:36.713Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は一般化したイメージから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  </p><p>本記事は 3 部作の 2 記事目です。</p><ol><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a></li></ol><p>そのため 1 記事目の <a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a> をご覧いただいている前提で記載させていただきます。  </p><p>本記事では Azure ポータルで、一般化したイメージを使用し、VM を複製する詳細な方法をご紹介します。<br>また、マネージド ディスクの使用を前提とさせていただきますので、アンマネージド ディスクをご利用いただいている場合は、下記手順より VM をマネージドディスクに変換をお願いいたします。</p><ul><li>Azure VM を Azure Managed Disks に移行する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks</a></li></ul><p>一般化をするにあたり、下記の点についてはバックアップが無い場合取り返しがつきませんのでご注意ください。<br>念のため、バックアップをご取得いただいてからご実施いただくことをお勧めいたします。</p><ul><li>一般化を行うとマシン固有のファイルとデータは削除されます</li><li>一般化を行ったVMは起動できなくなります</li></ul><h2 id="大まかな流れ"><a href="#大まかな流れ" class="headerlink" title="大まかな流れ"></a>大まかな流れ</h2><ol><li>複製元となる VM を作成する</li><li>作成した VM で必要なソフトウェアのインストールや設定を行う</li><li>VM を一般化（マシン固有のファイルとデータを削除）する</li><li>一般化した VM より [イメージ] を作成する</li><li>作成した [イメージ] より新規 VM を必要な数だけ作成する</li></ol><h2 id="実際の手順"><a href="#実際の手順" class="headerlink" title="実際の手順"></a>実際の手順</h2><p>それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。   </p><hr><h3 id="1-複製元となる-VM-を作成する"><a href="#1-複製元となる-VM-を作成する" class="headerlink" title="1. 複製元となる VM を作成する"></a>1. 複製元となる VM を作成する</h3><p>複製元となる VM を作成します。詳細な手順は下記公開情報を確認いただき、ご実施ください。</p><ul><li><p>参考: クイック スタート:Azure Portal で Windows 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal</a></p></li><li><p>参考: クイック スタート:Azure portal で Linux 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal</a></p></li></ul><hr><h3 id="2-作成したVMで必要なソフトウェアのインストールや各種設定を行う"><a href="#2-作成したVMで必要なソフトウェアのインストールや各種設定を行う" class="headerlink" title="2. 作成したVMで必要なソフトウェアのインストールや各種設定を行う"></a>2. 作成したVMで必要なソフトウェアのインストールや各種設定を行う</h3><p>VM を作成した後に、必要なソフトウェアをインストールしたり、各種設定を行います。こちらは、個々の要件に沿って実施してください。</p><hr><h3 id="3-VM-を一般化-マシン固有のファイルとデータを削除-する"><a href="#3-VM-を一般化-マシン固有のファイルとデータを削除-する" class="headerlink" title="3. VM を一般化 (マシン固有のファイルとデータを削除) する"></a>3. VM を一般化 (マシン固有のファイルとデータを削除) する</h3><p>一般化はゲスト OS 内部の操作で行うものとなります。<br>一般化の手順は Windows / Linux 両方とも公開情報にまとまっておりますので、下記をご参照の上、一般化を行い VM をシャットダウンします。  </p><hr><h4 id="3-1-Windows-VM-で一般化を行う方法"><a href="#3-1-Windows-VM-で一般化を行う方法" class="headerlink" title="3-1. Windows VM で一般化を行う方法"></a>3-1. Windows VM で一般化を行う方法</h4><ul><li>参考: Sysprep を使用して Windows VM を一般化する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep</a></li></ul><hr><h4 id="注意事項-Windows-の-Sysprep-の設定を間違えないこと！"><a href="#注意事項-Windows-の-Sysprep-の設定を間違えないこと！" class="headerlink" title="注意事項: Windows の Sysprep の設定を間違えないこと！"></a>注意事項: Windows の Sysprep の設定を間違えないこと！</h4><p>Windows OS では sysprep.exe を使って一般化を行いますが、最後の設定を間違えて、一般化したにもかかわらずその後複製した VM が正常に起動しないということがあります。</p><p>Sysprep.exe の画面は既定値ではなく、必ず下記スクリーンショットの設定になっていることを確認します。<br>Generalize（一般化）のチェック ボックスにチェックが入っており、<br>シャットダウン オプションが Shutdown（シャットダウン）となっている必要がありますのでご注意ください。</p><p>英語の場合:<br><img src="/blog/vm/vm-replica-2/sysprep-en.png"> </p><p>日本語の場合:<br><img src="/blog/vm/vm-replica-2/sysprep-jp.png"> </p><hr><h4 id="3-2-Linux-VM-で一般化を行う方法"><a href="#3-2-Linux-VM-で一般化を行う方法" class="headerlink" title="3-2. Linux VM で一般化を行う方法"></a>3-2. Linux VM で一般化を行う方法</h4><p>参考: 手順 1:VM のプロビジョニングを解除する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/capture-image#step-1-deprovision-the-vm">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/capture-image#step-1-deprovision-the-vm</a></p><p>今回はポータルからイメージを作成しますので、[手順 1:VM のプロビジョニングを解除する] が完了したら VM を停止しましょう。</p><hr><h3 id="4-一般化したVMより-イメージ-を作成する"><a href="#4-一般化したVMより-イメージ-を作成する" class="headerlink" title="4. 一般化したVMより [イメージ] を作成する"></a>4. 一般化したVMより [イメージ] を作成する</h3><p>ここまでの操作により、ゲスト OS 上で一般化が完了して VM は停止状態になりますので、[イメージ] を Azure ポータル上で作成します。  </p><p>まずは Azure ポータルにて、対象の VM の概要ブレードを開きます。概要ブレード上部の [キャプチャ] を選択します。</p><p><img src="/blog/vm/vm-replica-2/img-010.png"> </p><p>[キャプチャ] を選択すると、イメージを作成する画面が表示されます。<br>下記例では、ミニマムな設定にしているため、共有イメージ ギャラリーでのイメージ共有はしない設定にしています。<br>また、ゾーンの回復性についても、設定はしていません。</p><p>なお、一般化を行った VM は起動できなくなるため、[この仮想マシンを自動的に削除] にチェックを入れて一般化を行った VM は削除します。</p><p><img src="/blog/vm/vm-replica-2/img-020.png"> </p><p>各種オプションは、要件に合わせて変更してお使いください。<br>各種設定が完了したら、[確認および作成] - [作成] をクリックします。</p><hr><h3 id="5-作成した-イメージ-より新規VMを必要な数だけ作成する"><a href="#5-作成した-イメージ-より新規VMを必要な数だけ作成する" class="headerlink" title="5.作成した [イメージ] より新規VMを必要な数だけ作成する"></a>5.作成した [イメージ] より新規VMを必要な数だけ作成する</h3><p>ここまでの操作により [イメージ] が作成されましたので、この [イメージ] を用いて VM を作成（複製）します。  </p><p>まずは、Azure ポータル上部の検索ボックスよりイメージを検索します。</p><p><img src="/blog/vm/vm-replica-2/img-025.png"> </p><p>先ほど作成したイメージが表示されますので、これを選択します。</p><p><img src="/blog/vm/vm-replica-2/img-030.png"> </p><p>次に、上部に [VM の作成] がありますので、これを選択します。</p><p><img src="/blog/vm/vm-replica-2/img-040.png"> </p><p>すると、VM 作成画面が表示されますので、新規 VM を作成するのと同じ要領で VM を作成します。</p><p><img src="/blog/vm/vm-replica-2/img-050.png"> </p><p>以上が、Azure ポータルでのイメージを用いた VM 複製方法となります。<br>今回は説明のため、Azure ポータルを用いたミニマムな設定での説明となりましたが、もちろん PowerShell を用いた展開やイメージ作成時にイメージ共有などの設定も可能です。<br>本記事が、基本的な手順としてお役に立てれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は一般化したイメージから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  &lt;/p&gt;
&lt;p&gt;本記事は 3 部作の 2 記事目です。</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>VM 複製方法について part.1/3 2 つの方法の紹介</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-replica-1/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-replica-1/</id>
    <published>2021-03-29T05:00:01.000Z</published>
    <updated>2021-06-04T13:16:36.713Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回はご案内することの多い、VM 複製方法についてとなります。</p><p>本記事は 3 部作の 1 記事目です。</p><ol><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a></li></ol><p>VM 複製方法については多数の方法がありますが、こちらの記事では、よく使われる</p><ul><li>一般化を行いイメージを作成して、そのイメージから VM を複製する方法</li><li>OS ディスクのスナップショットを作成し、そのスナップショットから VM を複製する方法</li></ul><p>に絞って説明させていただきます。  </p><p>本記事ではマネージド ディスクの使用を前提とさせていただきますので、アンマネージド ディスクをご利用いただいている場合は、下記手順より VM をマネージドディスクに変換をお願いいたします。</p><ul><li>Azure VM を Azure Managed Disks に移行する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks</a></li></ul><p>詳細な手順は、part2 / part3 に記載いたしますので、まずは注意喚起および、それぞれの簡単な概要について紹介します。</p><hr><h2 id="Windows-VMを複製しようとしている方への注意喚起"><a href="#Windows-VMを複製しようとしている方への注意喚起" class="headerlink" title="Windows VMを複製しようとしている方への注意喚起"></a>Windows VMを複製しようとしている方への注意喚起</h2><p>重要な事のため、先に記載させていただきます。<br><strong><span style="color:red">Windows VM を複製しそれをご利用いただく場合、基本的には「一般化したイメージから VM を複製」いただく必要がございます。</span></strong><br>Windows VM の場合「OS ディスクのスナップショットから VM を複製」はバックアップ用途等でご利用いただけるものとなります。  </p><ul><li>参考: Windows インストールのディスク複製のための Microsoft ポリシー<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/windows-server/backup-and-storage/windows-installations-disk-duplication">https://docs.microsoft.com/ja-jp/troubleshoot/windows-server/backup-and-storage/windows-installations-disk-duplication</a></li></ul><blockquote><p>＝＝＝＝＝抜粋＝＝＝＝＝<br>複製またはイメージ化された Windows インストールを展開する場合は、イメージをキャプチャする前にシステム準備 (Sysprep) ツールを使用する必要があります。<br>＝＝＝＝＝＝＝＝＝＝＝＝  </p></blockquote><ul><li>参考: Azure Portal を使用して VHD から VM を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal</a></li></ul><blockquote><p>＝＝＝＝＝抜粋＝＝＝＝＝<br>複数の VM を作成する場合は、特殊化されたディスクを使用しないでください。<br>代わりに、より大規模なデプロイの場合は、イメージを作成してから、そのイメージを使用して複数の VM を作成します。<br>＝＝＝＝＝＝＝＝＝＝＝＝  </p></blockquote><hr><h2 id="一般化したイメージからVMを複製"><a href="#一般化したイメージからVMを複製" class="headerlink" title="一般化したイメージからVMを複製"></a>一般化したイメージからVMを複製</h2><p>こちらの手順では、一般化 (VM 内の固有のファイルやデータを削除) した後に、イメージを作成し、そのイメージから新規に VM を作成 (複製) いただくこととなります。</p><p>一般化したイメージから VM を複製いただく手順は基本的に下記の流れになります。</p><ol><li>複製元となる VM を作成する</li><li>作成した VM で必要なソフトウェアのインストールや設定を行う</li><li>VM を一般化 (マシン固有のファイルとデータを削除) する</li><li>一般化した VM より [イメージ] を作成する</li><li>作成した [イメージ] より新規 VM を必要な数だけ作成する</li></ol><p>一般化とは、VM を複製したりするための下準備として、マシン固有のファイルとデータを削除するものとなります。<br>削除されるデータの例として、VM の管理者アカウント(Built-in Administrator) や SID (Security Identifier) があります。  </p><p>つまり、これらの情報は削除されていますので、イメージから新しく VM を作成 (複製) する際に、VM の管理者アカウントを設定し、SID も新規に割り振られるということとなります。<br>また、**<span style="color:red">一般化した VM は起動不可となるため再利用不可</span>** となりますので、ご注意ください。</p><p>なお、Windows VM では一般化をする際 Sysprep というツールを用います。<br>そのため [一般化する] = [Sysprep する] と同義で言われることも多いです。</p><p>こちらの詳細な手順は <a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a> をご参照ください。</p><hr><h2 id="OSディスクのスナップショットからVMを複製"><a href="#OSディスクのスナップショットからVMを複製" class="headerlink" title="OSディスクのスナップショットからVMを複製"></a>OSディスクのスナップショットからVMを複製</h2><p>一般化したイメージから VM を複製いただく手順は基本的に下記の流れになります。</p><ol><li>複製元となるVMを用意する</li><li>VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得</li><li>作成した [スナップショット] より必要な数だけ [ディスク] を作成</li><li>作成した [ディスク] より VM 作成する</li></ol><p>スナップショットからの複製でご注意いただきたい点として、スナップショットは VM 固有のファイルとデータは保持される、OS ディスクの完全読み取りコピーであるという点がございます。<br>つまり、複製した VM は SID やホスト名が複製元と同一になります。   </p><p>完全複製による意図しない動作を防止するため、同一 VNET 上で元 VM と複製 VM を同時に起動しないようにしてください。<br>スナップショットからの複製する場合は <strong><span style="color:red">別の VNET 上にデプロイするようにお願いいたします。</span></strong>     </p><p>こちらの詳細な手順は <a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a> をご参照ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回はご案内することの多い、VM 複製方法についてとなります。&lt;/p&gt;
&lt;p&gt;本記事は 3 部作の 1 記事目です。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://jpaztech.git</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Tracking ID PLWV-BT0 と可用性について</title>
    <link href="https://jpaztech.github.io/blog/vm/plwv-bt0/"/>
    <id>https://jpaztech.github.io/blog/vm/plwv-bt0/</id>
    <published>2021-03-23T00:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.681Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの鳥越です。</p><p>先日 (2021/02/26)、Azure 弊社基盤の問題により、東日本で仮想マシンを含むストレージ サービスをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。</p><blockquote><p><strong>2/26</strong><br><strong>RCA - Azure Storage and dependent services - Japan East (Tracking ID PLWV-BT0)</strong></p><p>Azure status history<br><a href="https://status.azure.com/en-us/status/history/">https://status.azure.com/en-us/status/history/</a></p></blockquote><span id="more"></span><p>上記の障害ですが、単一のストレージスケールユニット (下記、Storage Cluster) で発生した問題であり、 仮想マシンの構成として、可用性セット + 管理ディスクの構成をとることにより、可用性セット内のすべての仮想マシンが同時に障害の影響を受けることを防ぐことが可能でした。</p><p>これは、下記の図のように、Storage Cluster についても適切に障害ドメインを分ける挙動を取るためです。</p><p><img src="/blog/vm/plwv-bt0/01.png"></p><p>※ Storage Cluster に対して FD0、FD1、FD2 として障害ドメインが分かれていることが確認可能かと存じます。</p><p>ただし、可用性セットを組む際に以下のように最初に作成した仮想マシンを、次の仮想マシンを作成する際に、事前に割り当て解除していた場合、障害ドメインが適切に分散されません。 </p><p><strong>1. 最初の仮想マシンをデプロイする</strong><br><strong>2. 最初の仮想マシンを停止 (割り当て解除) する</strong><br><strong>3. 次の仮想マシンをデプロイする</strong></p><p>この場合、更新ドメインは分かれていますが障害ドメインが同一となります。</p><p>&lt;参考イメージ&gt;<br><img src="/blog/vm/plwv-bt0/02.png"></p><p>これを図で表すと下記のようになります。<br>たとえ可用性セットを構成していたとしてもストレージ レイヤの障害で可用性セット内のすべての仮想マシンに影響が発生する可能性があることをご確認いただけるとかと存じます。</p><p><img src="/blog/vm/plwv-bt0/03.png"></p><p>そのため、障害ドメインが同一となっている仮想マシンについては障害ドメインの変更が必要となりますが、この障害ドメインは <span style="color:red;"><strong>可用性セットに仮想マシンを作成したタイミングで自動的に割り当てられるため仮想マシン作成後に変更いただくことは叶いません。</strong></span></p><p>そこで下記手順にて仮想マシンの再作成を行うことにより、障害ドメインの変更を実施いただけます。</p><p>障害ドメインが同一の状態からどのように障害ドメインを分けるか、またその結果どうなるかを含め下記に記載したいと思いますので、ご参考いただけますと幸いでございます。</p><ol><li><p>可用性セット内の仮想マシンで障害ドメインが同一であることを確認<br><img src="/blog/vm/plwv-bt0/04.png"></p></li><li><p>(参考) この時に OS ディスクがどのようになっているかを確認してみましょう。<br>ディスクのエクスポートを行うことで OS ディスクのストレージ アカウントとコンテナを確認することが可能です。<br>(ディスクのエクスポートは事前に仮想マシンの割り当て解除が必要です)<br><img src="/blog/vm/plwv-bt0/05.png"><br><img src="/blog/vm/plwv-bt0/06.png"></p></li></ol><blockquote><p>リンク: https://<span style="color:red;"><strong>md-dmxg3kx5tqjr</strong></span>.z43.blob.storage.azure.net/<span style="color:red;"><strong>4kthfmkhnglv</strong></span>/abcd?sv=2018-03-28&amp;sr=b&amp;si=048a5665-b278-4dd4-a6c5-fc3a661be840&amp;sig=ssM5KVUHxxxxxxxxxxcLxGNIkbGFucF4I6qsgw%2BAW5Zw%3D</p></blockquote><ol start="3"><li>以下のスクリプトを利用します。<br>このスクリプトを利用することで既存のリソースを利用して仮想マシンの再作成を行うことが可能です。<br>※ このスクリプトは仮想マシンがロード バランサーに接続されているかどうかは確認されません。<br>※ もしエラー等発生いたしましたらスクリプトの改変をご検討ください。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="variable">$resourceGroup</span> = <span class="string">&quot;AVSET&quot;</span> <span class="comment"># Resouce Group Name </span></span><br><span class="line">    <span class="variable">$vmName</span> = <span class="string">&quot;AV01&quot;</span>         <span class="comment"># VM Name </span></span><br><span class="line">    <span class="variable">$newAvailSetName</span> = <span class="string">&quot;AvailabilitySet&quot;</span> <span class="comment"># Availability Set Name  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the details of the VM to be moved to the Availability Set </span></span><br><span class="line">    <span class="variable">$originalVM</span> = <span class="built_in">Get-AzVM</span> ` </span><br><span class="line">        <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">        <span class="literal">-Name</span> <span class="variable">$vmName</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Create new availability set if it does not exist </span></span><br><span class="line">    <span class="variable">$availSet</span> = <span class="built_in">Get-AzAvailabilitySet</span> ` </span><br><span class="line">        <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">        <span class="literal">-Name</span> <span class="variable">$newAvailSetName</span> ` </span><br><span class="line">        <span class="literal">-ErrorAction</span> Ignore </span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">-Not</span> <span class="variable">$availSet</span>) &#123; </span><br><span class="line">        <span class="variable">$availSet</span> = <span class="built_in">New-AzAvailabilitySet</span> ` </span><br><span class="line">            <span class="literal">-Location</span> <span class="variable">$originalVM</span>.Location ` </span><br><span class="line">            <span class="literal">-Name</span> <span class="variable">$newAvailSetName</span> ` </span><br><span class="line">            <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">            <span class="literal">-PlatformFaultDomainCount</span> <span class="number">2</span> ` </span><br><span class="line">            <span class="literal">-PlatformUpdateDomainCount</span> <span class="number">2</span> ` </span><br><span class="line">            <span class="literal">-Sku</span> Aligned </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove the original VM </span></span><br><span class="line">    <span class="built_in">Remove-AzVM</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span>     </span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the basic configuration for the replacement VM.  </span></span><br><span class="line">    <span class="variable">$newVM</span> = <span class="built_in">New-AzVMConfig</span> ` </span><br><span class="line">        <span class="literal">-VMName</span> <span class="variable">$originalVM</span>.Name ` </span><br><span class="line">        <span class="literal">-VMSize</span> <span class="variable">$originalVM</span>.HardwareProfile.VmSize ` </span><br><span class="line">        <span class="literal">-AvailabilitySetId</span> <span class="variable">$availSet</span>.Id </span><br><span class="line"></span><br><span class="line"><span class="comment"># For a Linux VM, change the last parameter from -Windows to -Linux  </span></span><br><span class="line"><span class="comment"># Linux の場合は一番下のパラメータを -Linux としてください。 </span></span><br><span class="line">    <span class="built_in">Set-AzVMOSDisk</span> ` </span><br><span class="line">        <span class="literal">-VM</span> <span class="variable">$newVM</span> <span class="literal">-CreateOption</span> Attach ` </span><br><span class="line">        <span class="literal">-ManagedDiskId</span> <span class="variable">$originalVM</span>.StorageProfile.OsDisk.ManagedDisk.Id ` </span><br><span class="line">        <span class="literal">-Name</span> <span class="variable">$originalVM</span>.StorageProfile.OsDisk.Name ` </span><br><span class="line">        <span class="literal">-Windows</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Add Data Disks </span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$disk</span> <span class="keyword">in</span> <span class="variable">$originalVM</span>.StorageProfile.DataDisks) &#123;  </span><br><span class="line">        <span class="built_in">Add-AzVMDataDisk</span> <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">            <span class="literal">-Name</span> <span class="variable">$disk</span>.Name ` </span><br><span class="line">            <span class="literal">-ManagedDiskId</span> <span class="variable">$disk</span>.ManagedDisk.Id ` </span><br><span class="line">            <span class="literal">-Caching</span> <span class="variable">$disk</span>.Caching ` </span><br><span class="line">            <span class="literal">-Lun</span> <span class="variable">$disk</span>.Lun ` </span><br><span class="line">            <span class="literal">-DiskSizeInGB</span> <span class="variable">$disk</span>.DiskSizeGB ` </span><br><span class="line">            <span class="literal">-CreateOption</span> Attach </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add NIC(s) and keep the same NIC as primary; keep the Private IP too, if it exists.  </span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$nic</span> <span class="keyword">in</span> <span class="variable">$originalVM</span>.NetworkProfile.NetworkInterfaces) &#123;     </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$nic</span>.Primary <span class="operator">-eq</span> <span class="string">&quot;True&quot;</span>) &#123; </span><br><span class="line">            <span class="built_in">Add-AzVMNetworkInterface</span> ` </span><br><span class="line">                <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">                <span class="literal">-Id</span> <span class="variable">$nic</span>.Id <span class="literal">-Primary</span> </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="built_in">Add-AzVMNetworkInterface</span> ` </span><br><span class="line">                <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">                <span class="literal">-Id</span> <span class="variable">$nic</span>.Id  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># Recreate the VM </span></span><br><span class="line">    <span class="built_in">New-AzVM</span> ` </span><br><span class="line">       <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">       <span class="literal">-Location</span> <span class="variable">$originalVM</span>.Location ` </span><br><span class="line">       <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">       <span class="literal">-DisableBginfoExtension</span>  </span><br></pre></td></tr></table></figure><ol start="4"><li>可用性セット内で仮想マシンの障害ドメインが適切に分かれていることをご確認ください。</li></ol><p><img src="/blog/vm/plwv-bt0/07.png"></p><ol start="5"><li>(参考) 障害ドメインを変更した際に、管理ディスクがどのように変わるか確認してみましょう。こちらも 2. と同様に、ディスクのエクスポートにてストレージ アカウントとコンテナを確認いただけます。</li></ol><p><img src="/blog/vm/plwv-bt0/08.png"></p><blockquote><p>リンク: https://<span style="color:red;"><strong>md-szxnwvfc5gpr</strong></span>.z44.blob.storage.azure.net/<span style="color:red;"><strong>kz3p403l4zcs</strong></span>/abcd?sv=2018-03-28&amp;sr=b&amp;si=1435231a-850c-457a-b12a-3d0988036177&amp;sig=cHP3SMf0gKxxxxxxxxBmbp7GSnUgC2T63JB18V49s2c%3D</p></blockquote><p>2.の時からストレージ アカウントの変更が行われたことが確認いただけます。</p><p>つまり、この結果は、障害ドメインを分けたことによりストレージ レイヤの障害ドメインが適切に分かれるようにストレージ アカウントの変更が実施されたことを意味します。<br>このように、適切に更新ドメイン、障害ドメインを構成することにより、Azure 基盤での問題が発生したとしても多くのケースで業務を継続いただけます。</p><p>弊社といたしましては、可能な限りAzure 基盤側でのお客様の仮想マシンへの影響を無くすように日々改善を行っておりますが、この度のような障害は大変心苦しいのですが起こり得ることがございます。<br>そのため、事前の備えと致しましても、また、業務継続性といった観点からも可用性ゾーン、可用性セット、管理ディスクといった構成をご検討いただけますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの鳥越です。&lt;/p&gt;
&lt;p&gt;先日 (2021/02/26)、Azure 弊社基盤の問題により、東日本で仮想マシンを含むストレージ サービスをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;2/26&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;RCA - Azure Storage and dependent services - Japan East (Tracking ID PLWV-BT0)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Azure status history&lt;br&gt;&lt;a href=&quot;https://status.azure.com/en-us/status/history/&quot;&gt;https://status.azure.com/en-us/status/history/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Availability Zone" scheme="https://jpaztech.github.io/blog/tags/Availability-Zone/"/>
    
    <category term="Availability Set" scheme="https://jpaztech.github.io/blog/tags/Availability-Set/"/>
    
  </entry>
  
  <entry>
    <title>リソース グループ名の大文字・小文字について</title>
    <link href="https://jpaztech.github.io/blog/vm/resourcegroup-uppercase-lowercase/"/>
    <id>https://jpaztech.github.io/blog/vm/resourcegroup-uppercase-lowercase/</id>
    <published>2021-03-22T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.693Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は、お問い合わせいただくことの多い、リソース グループ名の大文字・小文字についてとなります。  </p><p>小文字でリソース グループ名を作成したのに Azure ポータル上では大文字で表示されるといったような、<br>お問い合わせいただくことがございます。<br>例としては下記のような表示となります。</p><table><thead><tr><th>作成したリソース グループ名</th><th>Azure ポータル上で表示されるリソース グループ名</th></tr></thead><tbody><tr><td>rgname</td><td>RGNAME</td></tr><tr><td>RGNAME</td><td>rgname</td></tr><tr><td>Rgname</td><td>RGNAME</td></tr><tr><td>Rgname</td><td>rgname</td></tr></tbody></table><p>結論から申し上げますと、これは現行の Azure においては想定される仕様の範囲内の動作であり、<br>残念ながら、現時点では回避策のご用意がございません。<br>ただし、本動作によって、Azure をお使い頂く上で問題が発生するものではございませんのでご安心ください。  </p><p>まず次のドキュメントにも記載がございますとおり、リソース グループにおいては<br>そのリソース名の大文字と小文字は区別されないものとなっております。  </p><p>参照: Azure リソースの名前付け規則と制限事項<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules</a></p><blockquote><p>＝＝＝＝＝抜粋＝＝＝＝＝<br>「有効な文字」列に特に明記されていない限り、リソース名では大文字と小文字は区別されません。<br>＝＝＝＝＝＝＝＝＝＝＝＝  </p></blockquote><p>したがいまして、リソース グループ名に大文字・小文字が混在している状態でありましても、<br>Azure の動作に影響を及ぼすものではございません。<br>上述の例を参考にしますと、</p><ul><li>rgname</li><li>RGNAME</li><li>Rgname</li></ul><p>これら3つの表記は区別されず同じリソース グループとして扱われることとなります。<br>Azure Powershell や Azure CLI のコマンドパラメータとしてリソースグループ名をご指定いただく際にも、<br>大文字・小文字が異なることへの配慮は不要でございます。  </p><p>また、 Azure ポータルでのリソース グループ名の表示において、大文字・小文字の名称が混在する<br>状況についても現行のAzureにおいて仕様となっております。  </p><p>仕様についてご意見やご要望がございます場合には、お手数ですが<br>下記のフィードバックサイト、もしくは Azure ポータル右上のフィードバックより、ご要望をご投稿いただけますと幸いです。   </p><ul><li>Azure Genaral Feedback<br><a href="https://feedback.azure.com/forums/34192--general-feedback">https://feedback.azure.com/forums/34192--general-feedback</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は、お問い合わせいただくことの多い、リソース グループ名の大文字・小文字についてとなります。  &lt;/p&gt;
&lt;p&gt;小文字でリソース グループ名を作成したのに Azure ポータル上では大文字で表示され</summary>
      
    
    
    
    
    <category term="Resource Group" scheme="https://jpaztech.github.io/blog/tags/Resource-Group/"/>
    
  </entry>
  
  <entry>
    <title>Azure File Sync よくあるお問合せ - FAQ</title>
    <link href="https://jpaztech.github.io/blog/storage/storageFileSyncFAQ/"/>
    <id>https://jpaztech.github.io/blog/storage/storageFileSyncFAQ/</id>
    <published>2021-03-18T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.605Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。</p><p>Azure File Sync に関して、たびたびお問合せいただくことがございます。<br>今回は、よくあるお問い合わせのうち下記 2 つの項目についてご紹介いたします。</p><p><strong>・ファイルの同期周期に関する FAQ</strong><br><strong>・同期の一時停止に関する FAQ</strong></p><span id="more"></span><h2 id="ファイルの同期周期に関する-FAQ"><a href="#ファイルの同期周期に関する-FAQ" class="headerlink" title="ファイルの同期周期に関する FAQ"></a>ファイルの同期周期に関する FAQ</h2><p><strong>Q1.</strong><br>Azure Portal から ファイルをアップロードしましたがサーバーエンドポイントに反映されません。原因を教えてください。</p><p><strong>A1.</strong><br>Azure Portal または SMB を使用して Azure ファイル共有に加えられた変更は<strong>即時反映されません</strong>。Azure File Sync には、”変更検出ジョブ” という 24 時間ごとに実行するようスケジュールされたジョブがあります。</p><p>その “変更検出ジョブ” によって Azure ファイル共有上のファイルに変更が加えられていることが検出された場合に、Azure File Sync が同期セッションを開始し、サーバーエンドポイントへ反映されることとなります。</p><blockquote><p>参考 )<br>□SMB またはポータルで Azure ファイル共有に直接ファイルを作成しました。<br>このファイルが同期グループのサーバーに同期されるまでどのくらいの時間がかかりますか。<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-faq">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-faq</a></p></blockquote><p>サーバーエンドポイントおよびクラウドエンドポイントでの同期周期は以下の通りです。</p><table><thead><tr><th>ファイル操作元</th><th>同期周期</th></tr></thead><tbody><tr><td>サーバーエンドポイント</td><td>即時</td></tr><tr><td>クラウドエンドポイント (Azure Portal または SMB)</td><td>約 24 時間ごと</td></tr></tbody></table><p>サーバーエンドポイント、クラウドエンドポイントから各々ファイルをアップロードした際の同期グループへの反映状況を確認してみます。</p><p><strong>■サーバーエンドポイントでファイルをアップロードした場合</strong></p><p>サーバーエンドポイント でファイルを追加します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage01.png"></p><p>サーバーエンドポイントで作成したファイルは Azure Portal 上の ファイル共有 内に即時反映されたことが確認できます。<br><img src="/blog/storage/storageFileSyncFAQ/Storage02.png"></p><p><strong>■クラウドエンドポイント (Azure Portal)でファイルをアップロードした場合</strong></p><p>Azure Portal &gt; ファイル共有 よりファイルをアップロードします。<br><img src="/blog/storage/storageFileSyncFAQ/Storage03.png"></p><p>サーバーエンドポイント側にはファイルが即時反映されていません。<br><img src="/blog/storage/storageFileSyncFAQ/Storage04.png"></p><p><strong>Q2.</strong><br>Azure Portal または SMB を使用して Azure ファイル共有に加えられた変更に関しては、24 時間ごとの変更検出ジョブを待つしかないのでしょうか。</p><p><strong>A2.</strong><br>いいえ、手動にはなりますが Azure ファイル共有上で変更されたファイルを即時でサーバーエンドポイントへ同期したい場合は、<strong>Invoke-AzStorageSyncChangeDetection</strong> PowerShell コマンドレットを使用いただくことで変更検出ジョブの実行を待つことなく、同期グループ上のサーバーエンドポイントへ反映させることが可能です。</p><p>例)<br>PowerShell より Invoke-AzStorageSyncChangeDetection を実行<br><img src="/blog/storage/storageFileSyncFAQ/Storage05.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Invoke-AzStorageSyncChangeDetection </span><br><span class="line"> -ResourceGroupName &quot;リソースグループ名&quot; </span><br><span class="line"> -StorageSyncServiceName &quot;ストレージ同期サービス名&quot; </span><br><span class="line"> -SyncGroupName &quot;同期グループ名&quot; </span><br><span class="line"> -CloudEndpointName &quot;クラウドエンドポイント名&quot; </span><br><span class="line"> -DirectoryPath &quot;ディレクトリパス名&quot;</span><br></pre></td></tr></table></figure><p>サーバーエンドポイントへ反映されたことを確認します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage06.png"></p><blockquote><p>&lt;ご参考&gt;<br>□Invoke-AzStorageSyncChangeDetection<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/invoke-azstoragesyncchangedetection?view=azps-5.5.0">https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/invoke-azstoragesyncchangedetection?view=azps-5.5.0</a><br>□Get-AzStorageSyncCloudEndpoint<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/get-azstoragesynccloudendpoint?view=azps-5.5.0">https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/get-azstoragesynccloudendpoint?view=azps-5.5.0</a></p></blockquote><h2 id="同期の一時停止に関する-FAQ"><a href="#同期の一時停止に関する-FAQ" class="headerlink" title="同期の一時停止に関する FAQ"></a>同期の一時停止に関する FAQ</h2><p><strong>Q.</strong><br>Azure File Sync の同期を一時停止させることはできますか。</p><p><strong>A.</strong><br>はい、同期グループ内のサーバーエンドポイント側で設定を行っていただくことで一時的に同期を停止させることが可能です。</p><p><strong>■サーバーエンドポイントにて同期を一時停止する手順</strong></p><ol><li>対象のサーバーエンドポイント側のレジストリで以下の値を作成します。<br>#既定では “Settings” はないため手動で作成してください。<br><img src="/blog/storage/storageFileSyncFAQ/Storage07.png"></li></ol><p><img src="/blog/storage/storageFileSyncFAQ/Storage08.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Key: [HKLM(HKEY_LOCAL_MACHINE)]\SYSTEM\CurrentControlSet\Services\FileSyncSvc\Settings</span><br><span class="line">Type: REG_DWORD</span><br><span class="line">Value name: StopSync</span><br><span class="line">Value: 1</span><br></pre></td></tr></table></figure><ol start="2"><li><p>サービスから “Storage Sync Agent” を再起動します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage09.png"></p></li><li><p>サーバーエンドポイント側でアップロードしたファイルが Azure Portal 上へ反映されていないことを確認します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage10.png"></p></li></ol><p><img src="/blog/storage/storageFileSyncFAQ/Storage11.png"></p><blockquote><p>注意)<br>この操作では同期のみが停止され、ファイルの変更検出や階層化の呼び戻しは実行されますのでご留意ください。</p></blockquote><p>同期を再開いただく場合には、レジストリより “StopSync” を削除のうえ再度サービスより “Storage Sync Agent” の再起動を行ってください。<br><img src="/blog/storage/storageFileSyncFAQ/Storage12.png"></p><p>StopSync を削除しStorage Sync Agent の再起動を行うと Azure Portal 上へファイルの同期が再開されます。<br><img src="/blog/storage/storageFileSyncFAQ/Storage13.png"></p><blockquote><p>注意)<br>サーバーエンドポイントの削除、Storage Sync Agent の停止は基本的に推奨されない手順となります。<br>上記一時停止がご要望に沿わない場合、まずは対応方針について弊社サポート部門までお問い合わせください。</p></blockquote><p>本稿は以上となりますが、いかがでしたでしょうか。 本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;/p&gt;
&lt;p&gt;Azure File Sync に関して、たびたびお問合せいただくことがございます。&lt;br&gt;今回は、よくあるお問い合わせのうち下記 2 つの項目についてご紹介いたします。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;・ファイルの同期周期に関する FAQ&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;・同期の一時停止に関する FAQ&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>特定の AKS ノードを再起動または削除したい</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-maintenance-for-node/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-maintenance-for-node/</id>
    <published>2021-02-10T03:00:00.000Z</published>
    <updated>2021-06-04T13:16:36.561Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは- Azure テクニカルサポートチームの大野です。<br>今回は良くお問合せいただく内容として、特定の AKS ノードの再起動または削除についてご案内したいと思います。</p><h2 id="そもそもサポート外の操作ですか？"><a href="#そもそもサポート外の操作ですか？" class="headerlink" title="そもそもサポート外の操作ですか？"></a>そもそもサポート外の操作ですか？</h2><p>Azure Kubernetes Service (AKS) についてよく寄せられる質問でも下記の通り、サポートされない操作と記載があります。</p><blockquote><p><a href="https://docs.microsoft.com/ja-jp/azure/aks/faq#can-i-stop-or-de-allocate-all-my-vms">すべての VM を停止したり、その割り当てを解除したりできますか?</a> より引用</p><p>これは、直接 AKS のリソースの操作を行うことにより、AKS として管理している情報と不整合 (例えば、仮想マシ<br>ンを直接削除したが、AKS のノードとしてまだ残っている状態、等) が起きる恐れがあるため、このような記載が<br>されています。</p></blockquote><p>これは、Azure のリソースを直接操作した場合に、AKS (Kubernetes) から見たときに情報の整合性が取れなくなるためになります。<br>ただ、特定のノードがおかしい等により再起動や削除されたいといったご要望があるかと思いますので、以下、実行例を交えて手順について纏めてみました。</p><p>なお、ノードの不調については、Azure 基盤の自動修復をはじめ、AKS の自動修復により改善されることがあります。<br>この話はまた別の機会にでも。</p><h2 id="特定のノードを再起動"><a href="#特定のノードを再起動" class="headerlink" title="特定のノードを再起動"></a>特定のノードを再起動</h2><p>まずは、特定のノードを再起動する場合の操作手順になります。<br>流れとしては、以下になります。</p><ol><li>該当ノードからワークロードを退避し、新たに Pod がスケジュールされないように対象から除外</li><li>再起動を実施</li><li>該当ノードを再度 AKS クラスターのスケジュールに組み込むよう設定</li></ol><hr><ol><li>該当ノードからワークロードを退避し、新たに Pod がスケジュールされないように対象から除外</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE   VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready    agent   24h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready    agent   24h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready    agent   24h   v1.18.10</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl drain &lt;ノード名&gt; --ignore-daemonsets --delete-local-data --force</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードが <span class="string">&quot;SchedulingDisabled&quot;</span> になっていることを確認</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS                     ROLES   AGE     VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready,SchedulingDisabled   agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready                      agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready                      agent   4d17h   v1.18.10</span><br></pre></td></tr></table></figure><ol start="2"><li>再起動を実施</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> VMSS の場合</span></span><br><span class="line">az vmss restart -g MC_labvmssaks_labvmssaks_japaneast -n aks-nodepool1-40771167-vmss --instance-ids 0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用性セットの場合</span></span><br><span class="line">az vm restart -g MC_labasaks_labasaks_japaneast -n aks-nodepool1-19417627-0</span><br></pre></td></tr></table></figure><ol start="3"><li>該当ノードを再度 AKS クラスターのスケジュールに組み込むよう設定</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl uncordon aks-nodepool1-40771167-vmss000000</span></span><br><span class="line">node/aks-nodepool1-40771167-vmss000000 uncordoned</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードの STATUS が <span class="string">&quot;Ready&quot;</span> になっていることを確認</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE     VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready    agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready    agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready    agent   4d17h   v1.18.10</span><br></pre></td></tr></table></figure><p>注意点としては、ノードを組み込んだ後に、Pod の配置の平滑化は行なわれることはありませんので、<br>必要に応じて、<a href="https://github.com/kubernetes-sigs/descheduler">Descheduler</a> 等による平滑化をご検討ください。</p><h2 id="特定のノードを削除"><a href="#特定のノードを削除" class="headerlink" title="特定のノードを削除"></a>特定のノードを削除</h2><p>特定のノードの削除時も <code>kubectl drain</code> により退避させてから行う点は同じになります。<br>加えて、<code>kubectl delete node</code> により、Kubernetes におけるノードリソースの削除を行います。</p><ol><li>該当ノードからワークロードを退避し、新たに Pod がスケジュールされないように対象から除外</li><li>該当ノードを AKS の管理情報から削除</li><li>対象ノードやリソースを削除</li><li>必要に応じてスケールアウトを実施</li></ol><hr><ol><li>該当ノードで稼働するワークロードを別のノードに退避</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードを確認</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE     VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready    agent   5d15h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready    agent   5d15h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready    agent   5d15h   v1.18.10</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードからワークロードを退避し、スケジュールから除外 (drain)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl drain aks-nodepool1-40771167-vmss000000 --ignore-daemonsets --delete-emptydir-data</span></span><br></pre></td></tr></table></figure><ol start="2"><li>該当ノードを AKS の管理情報から削除</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node aks-nodepool1-40771167-vmss000000</span><br></pre></td></tr></table></figure><p>次にノードにあたる仮想マシン/仮想マシンスケールセット インスタンスや関連するリソースを Azure ポータルまたは CLI 操作により削除します。</p><ol start="3"><li>対象ノードやリソースを削除</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可用性セットの場合 (AvailabilitySet)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> az vm delete -g MC_LABASAKS_LABASAKS_JAPANEAST -n aks-nodepool1-19417627-0</span></span><br><span class="line">Are you sure you want to perform this operation? (y/n): y</span><br><span class="line"><span class="meta">$</span><span class="bash"> az network nic delete -g MC_labasaks_labasaks_japaneast -n aks-nodepool1-19417627-nic-0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> az disk delete -g MC_LABASAKS_LABASAKS_JAPANEAST -n aks-nodepool1-19417627-0_OsDisk_1_17ecc8db96374f15a4b91dfc9ce17749</span></span><br><span class="line">Are you sure you want to perform this operation? (y/n): y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 仮想マシンスケールセットの場合 (VirtualMachineScaleSets)</span></span><br><span class="line">az vmss delete-instances -g MC_labvmssaks_labvmssaks_japaneast -n aks-nodepool1-40771167-vmss --instance-ids 0</span><br></pre></td></tr></table></figure><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong><br>上記のように Azure のリソースを削除しない場合に、スケーリング操作を行なうと、まだノードがあると認識され、<br>正しくスケーリング操作が行なわれません。</p><p>例えば、3台ノードがあった場合に、1台ノードを <code>kubectl delete</code> により削除後、Azure のリソースを削除を行わないで、<br>スケールイン (2 台) を行なった場合、先のノードが存在すると認識され、別の仮想マシンまたは仮想マシンスケールセット インスタンスが削除されてしまいます。</p><p>そのため、本操作を実施される場合には、必ず Azure のリソースも併せて削除してください。</p></div><ol start="4"><li>必要に応じてスケールアウトを実施</li></ol><p>最後に必要に応じまして、台数の調整を実施してください。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az aks scale -g labasaks -n labasaks --node-count 3</span></span><br></pre></td></tr></table></figure><h2 id="PodDisruptionBudget-による可用性の向上"><a href="#PodDisruptionBudget-による可用性の向上" class="headerlink" title="PodDisruptionBudget による可用性の向上"></a>PodDisruptionBudget による可用性の向上</h2><p><code>kubectl drain</code> は内部で、Eviction (退避) API が呼ばれますが、この Eviction API は Pod を削除する動作となります。<br>(ReplicaSet を組んでいない Pod は単純に削除されることになります。)</p><blockquote><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/#eviction-api">The Eviction API</a> より引用</p><p>The eviction subresource of a Pod can be thought of as a kind of policy-controlled DELETE operation on the Pod itself</p></blockquote><p>そのため、連続してノードを Drain を実施されたとき、Pod がまだ正常に起動しておらず、サービス断が発生する恐れがあります。</p><p>PodDisruptionBudget 設定されておりますと、Eviction API が呼ばれたときに、設定された Pod 数の稼働状況を見て、Pod を削除するか判断されますので、ワークロードの可用性に考慮して設定いただければと思います。</p><blockquote><p>ご参考情報;</p><ul><li><a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/">Safely Drain a Node - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">Disruption - Kubernetess</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/aks/operator-best-practices-scheduler#plan-for-availability-using-pod-disruption-budgets">ポッド中断バジェットを使用して可用性を計画する - Azure Kubernetes Service (AKS) での基本的なスケジューラ機能に関するベスト プラクティス</a></li></ul></blockquote><br>以上で、特定のノードを再起動/削除する手順を紹介させていただきました。本稿がお役に立てれば幸いです。]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは- Azure テクニカルサポートチームの大野です。&lt;br&gt;今回は良くお問合せいただく内容として、特定の AKS ノードの再起動または削除についてご案内したいと思います。&lt;/p&gt;
&lt;h2 id=&quot;そもそもサポート外の操作ですか？&quot;&gt;&lt;a href=&quot;#そもそもサポ</summary>
      
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Windows VM で記憶域スペースを拡張する</title>
    <link href="https://jpaztech.github.io/blog/vm/extend-storage-space-on-azure-windows-vm/"/>
    <id>https://jpaztech.github.io/blog/vm/extend-storage-space-on-azure-windows-vm/</id>
    <published>2021-02-05T07:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.653Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>Azure Windows VM において記憶域スペースをご構成いただいているお客様や、SQL VM (SQL Server on Windows Server) をご利用いただいているお客様より、ディスクの拡張方法に関してお問い合わせをいただくことが多いので、手順についてご紹介します。</p><span id="more"></span><div style="background-color:#d2f9d2 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>ご参考</strong><br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/overview">記憶域スペースの概要</a></p><p>対象サーバー OS:<br>Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、Windows Server 2012</p></div><h2 id="■-通常の-Windows-VM-に関して"><a href="#■-通常の-Windows-VM-に関して" class="headerlink" title="■ 通常の Windows VM に関して"></a>■ 通常の Windows VM に関して</h2><h3 id="□-作業概要"><a href="#□-作業概要" class="headerlink" title="□ 作業概要"></a>□ 作業概要</h3><p>記憶域スペースを拡張いただく場合には、下記の 2 方法があります。それぞれの方法について、シンプル レイアウトの記憶域スペースを用いた検証結果を踏まえてご紹介します。</p><ol><li>記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する。</li><li>記憶域スペースを再作成する。<br>仮想ディスク上のデータを別ディスクなどに退避いただき、仮想ディスクならびに記憶域プールを削除する。<br>その後、記憶域プールを構成していたディスクを拡張し、再度記憶域プールならびに仮想ディスクを作成する。</li></ol><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong><br>記憶域プールは複数のディスクを 1 つの記憶域としてまとめて、まとめられた記憶域から仮想ディスクの領域を切り出します。<br>記憶域プール自体に新たに領域を足すことは想定されておりますが、すでに仮想ディスクとして切り出された土台となる領域 (記憶域プールを構成しているディスク) を拡張することは想定されておりません。</p><p>例えば、1TB × 3 本のディスクで記憶域プールを構成している場合、この既に構成している 1 TB を 2 TB にすることで拡張することは想定しておりません。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/19.png"></p><p>なお、Azure ディスク リソースは縮小いただくことがご実施いただけません。<br>公開情報:  <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/find-unattached-disks">Azure IaaS VM ディスクと Premium マネージド ディスクおよびアンマネージド ディスクについてよく寄せられる質問</a></p></div><h3 id="□-方法-1-記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する"><a href="#□-方法-1-記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する" class="headerlink" title="□ 方法 1 : 記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する"></a>□ 方法 1 : 記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する</h3><p>方法 1 では、すでに構成されている記憶域プールにディスクを追加し、仮想ディスクおよびボリュームを拡張する方法をご紹介します。</p><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong><br>Windows Server 2012、2012R2 においては、記憶域プールにディスクを追加する場合、「<span style="color:red;">列の数 (NumberOfColumns) × データのコピーの数 (NumberOfDataCopies)</span>」の台数分のディスクを増設する必要があります。</p><p>記憶域プールには、仮想ディスクの 1 データ (ストライプ: ディスクに書き込む 1 トランザクションの単位) が、仮想ディスクを構成する物理ディスクのうち、何本の物理ディスクに分散して書き込まれるかを決定する、Numberofcolumns という値があります。<br>仮想ディスクを構成する物理ディスクを追加し、仮想ディスクを拡張する場合、データのコピーの数 (NumberOfDataCopies) を維持するため、NumberOfColumns の数の単位の利用可能なディスクが必要となります。</p><p>公開情報: <a href="https://blogs.technet.microsoft.com/askcorejp/2017/06/22/numberofcolumns-of-storagespace/">公開情報記憶域スペースの NumberOfColumns と仮想ディスクの拡張について</a></p><p>例:<br>はじめに 3 本の物理ディスクの存在する記憶域プール内に作成した仮想ディスクは、NumberOfColumns が 3 で作成されているため、ディスクの拡張のためにも 3 本単位での利用可能な物理ディスクが必要になります。</p><p>以下の PowerShell コマンドレットを実施することで仮想ディスクの現在の NumberOfColumns の値を確認することができます。</p><blockquote><p>Get-VirtualDisk –FriendlyName “&lt;仮想ディスク名&gt;” | FL NumberOfColumns</p></blockquote><p>なお、Windows Server 2016 以降の記憶域スペースにおいては、記憶域プールに割り当てられた領域をリバランス (再配置) するためのコマンド Optimize-StoragePool が用意されています。</p><blockquote><p>Optimize-StoragePool -FriendlyName “&lt;記憶域プール名&gt;”</p></blockquote><p>公開情報: <a href="https://docs.microsoft.com/en-us/powershell/module/storage/optimize-storagepool?view=win10-ps">Optimize-StoragePool</a></p></div><p><strong>1. 既存の VM に新規ディスクを追加します</strong><br>管理ディスクを護衛用の場合は下記の公開情報をご参照いただき、Azure Portal または Azure PowerShell より VM に新規ディスク リソースを追加します。</p><p>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/attach-managed-disk-portal#add-a-data-disk">Azure portal を使用して Windows VM にマネージド データ ディスクを接続する - データ ディスクの追加</a><br>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/attach-disk-ps">PowerShell を使用して Windows VM にデータ ディスクを接続する</a></p><p>非管理ディスクをご利用の場合は、下記をご参照ください。</p><p>Azure Portal の場合 :<br>Azure Portal より、[Virtual Machines] - [&lt;対象 VM 名&gt;] を選択し、開いた画面の左メニュー [ディスク] を選択します。開いた画面にて [+ データ ディスクの追加] をクリックします。<br>“アンマネージド ディスクの接続” 画面にて適宜値を設定し、[OK] をクリックします。値設定時に、”ソースの種類” は [新規 (空のディスク)] を選択します。</p><p>Azure PowerShell の場合 :<br>下記公開情報のコマンド例をご参照ください。<br>公開情報: <a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/add-azvmdatadisk?view=azps-5.4.0#example-2--add-a-data-disk-to-an-existing-virtual-machine">Add-AzVMDataDisk - Example 2: Add a data disk to an existing virtual machine</a></p><p><strong>2. VM に RDP 接続を行います。</strong></p><p><strong>3. 記憶域プールにディスクを追加します</strong><br>[サーバー マネージャー] より、[ファイル サービスと記憶域サービス] - [ボリューム] - [記憶域プール] を開き、[&lt;対象の記憶域プール&gt;] を選択します。<br>“物理ディスク” の [タスク] - [物理ディスクの追加] をクリックします。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/2.png"></p><p>追加するディスク (追加した新規ディスク) を選択し、[OK] をクリックします。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/3.png"></p><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong></p><ul><li>Windows Server 2012R2 以前では、仮想ディスク作成時の物理ディスク数単位で物理ディスクを追加します。</li><li>Windows Server 2016 以降では、ディスク追加後に Optimize-StoragePool コマンドを実行します。<blockquote><p>Optimize-StoragePool -FriendlyName “&lt;記憶域プール名&gt;”</p></blockquote></li></ul></div><p><strong>4. 仮想ディスクを拡張します</strong><br>記憶域プールにディスクを追加後、”仮想ディスク” の [対象仮想ディスク] を右クリックし、[仮想ディスクの拡張] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/4.png"></p><p>拡張するサイズを指定し、[OK] をクリックします。以下の例では、拡張可能な最大サイズを選択し、拡張を実施しています。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/5.png"></p><p>仮想ディスクの拡張が完了すると、以下の通り容量が増えます。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/6.png"></p><p><strong>5. 仮想ディスク上のボリュームを拡張します</strong><br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/disk-management/extend-a-basic-volume">ベーシック ボリュームを拡張する</a></p><p>[スタート] を右クリックし、[ディスクの管理] をクリックします。<br>開いた画面にて、仮想ディスク上の対象のボリュームを右クリックし、[ボリュームの拡張] をクリックします。<br>“ボリュームの拡張ウィザード” に沿って進み、拡張したいサイズを指定して [完了] をクリックします。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/8.png"></p><p>ボリュームの拡張が完了すると、以下の通り容量が増えます。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/9.png"></p><h3 id="□-方法-2-記憶域スペースを再作成する"><a href="#□-方法-2-記憶域スペースを再作成する" class="headerlink" title="□ 方法 2 : 記憶域スペースを再作成する"></a>□ 方法 2 : 記憶域スペースを再作成する</h3><p><strong>1. 仮想ディスクにあるデータを別領域に退避します</strong><br>拡張したいディスクにて構成している記憶域プール上の全仮想ディスクにあるデータを、仮想ディスク以外の領域 (退避用に新規ディスクを追加する、Azure Storage を利用するなど) にデータを退避 (コピーまたは移動) します。</p><p><strong>2. 仮想ディスクを削除します</strong><br>[サーバー マネージャー] より、[ファイル サービスと記憶域サービス] - [ボリューム] - [記憶域プール] を開きます。<br>[&lt;対象の記憶域プール&gt;] を選択し、”仮想ディスク” の [対象仮想ディスク] を右クリックし、[仮想ディスクのデタッチ] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/10.png"></p><p>デタッチが完了すると、仮想ディスク名の横に “!” が表示されます。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/11.png"></p><p>再度 [対象仮想ディスク] を右クリックし、[仮想ディスクの削除] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/12.png"></p><p><strong>3. 記憶域プールを削除します</strong><br>[対象記憶域プール] を右クリックし、[記憶域プールの削除] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/13.png"></p><p><strong>4. 対象ディスクを拡張します</strong><br>Azure Portal または Azure PowerShell より、対象のディスク リソースを拡張します。</p><p>Azure Portal の場合 :<br>ディスクのサイズ変更を行う際には、VM が停止済み (割り当て解除) の状態である必要があります。</p><ol><li>Azure Portal にアクセスし、[&lt;当該 VM 名&gt;] - [ディスク] をクリックします。</li><li>“OS ディスク” または “データ ディスク” よりサイズを変更したいディスク名をクリックします。</li><li>管理ディスクの場合は [構成] をクリックし、”サイズ” に任意の値を入力します。<br>非管理ディスクの場合は、”サイズ” に任意の値を入力します。</li><li>保存をクリックします。</li></ol><p>Azure PowerShell の場合 :<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/expend-os-disk#resizing-data-disks">データ ディスクのサイズを変更する</a> </p><p><strong>5. VM を起動し、RDP 接続を行います</strong></p><p><strong>6. 記憶域プールを作成します</strong><br>公開情報をご参照の上、記憶域プールを作成します。<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/deploy-standalone-storage-spaces#step-1-create-a-storage-pool">スタンドアロン サーバーに記憶域スペースを展開する - 手順 1: 記憶域プールを作成する</a></p><p><strong>7. 仮想ディスクを作成します</strong><br>公開情報をご参照の上、仮想ディスクを作成します。<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/deploy-standalone-storage-spaces#step-2-create-a-virtual-disk">スタンドアロン サーバーに記憶域スペースを展開する - 手順 2: 仮想ディスクを作成する</a></p><p><strong>8. ボリュームを作成します</strong><br>公開情報をご参照の上、ボリュームを作成します。<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/deploy-standalone-storage-spaces#step-3-create-a-volume">スタンドアロン サーバーに記憶域スペースを展開する - 手順 3: ボリュームを作成する</a></p><h2 id="■-余談-SQL-VM-に関して"><a href="#■-余談-SQL-VM-に関して" class="headerlink" title="■ (余談) SQL VM に関して"></a>■ (余談) SQL VM に関して</h2><p>SQL ギャラリー イメージ にて VM を作成いただき構成された記憶域プールについては、Azure ポータルにて一部のストレージ設定を変更することが可能です。詳細は下記の公開情報をご参照ください。</p><p>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/azure-sql/virtual-machines/windows/storage-configuration">SQL Server VM のストレージの構成</a></p><br>本稿は以上となりますが、いかがでしたでしょうか。本稿が皆様のお役に立てれば幸いです。<hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;Azure Windows VM において記憶域スペースをご構成いただいているお客様や、SQL VM (SQL Server on Windows Server) をご利用いただいているお客様より、ディスクの拡張方法に関してお問い合わせをいただくことが多いので、手順についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Storage Space" scheme="https://jpaztech.github.io/blog/tags/Storage-Space/"/>
    
  </entry>
  
  <entry>
    <title>403 エラーが発生し Azure ストレージ アカウント内のコンテンツにアクセスできない</title>
    <link href="https://jpaztech.github.io/blog/storage/storageFirewall-403Error/"/>
    <id>https://jpaztech.github.io/blog/storage/storageFirewall-403Error/</id>
    <published>2021-01-29T08:30:00.000Z</published>
    <updated>2021-06-04T13:16:36.613Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。</p><p>今回は Azure ストレージ アカウント内コンテンツへのアクセス時に 403 エラーが発生した<br>場合の対処法をストレージファイアウォール観点でエラー事例とともにご紹介いたします。</p><span id="more"></span><p>まずは 403 エラー発生時の事例を 5 つご紹介いたします。</p><p><strong>事例1)</strong><br>Azure ストレージ アカウント &gt; ファイル共有 画面でのアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage01.png"></p><p><strong>事例2)</strong><br>Azure ストレージ アカウント &gt; Storage Explorer (プレビュー) 画面でのアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage02.png"></p><p><strong>事例3)</strong><br>Azure Storage Explorer ツール画面でのアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage03.png"></p><p><strong>事例4)</strong><br>AzCopy コマンドにてオンプレミス / Azure VM から Azure Storage Blob コンテナーへのファイルコピー時のエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage04.png"></p><p><strong>事例5)</strong><br>オンプレミス / Azure VM からファイル共有をマウントした時のアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage05.png"></p><p>事例1-5 のエラーの場合、ストレージファイアウォールが有効化されており設定に不備不足が<br>ある可能性が考えられます。原因がストレージファイアウォールであるか切り分けるため、<br>ストレージファイアウォールを一度無効にしエラーが解消されるかを確認します。</p><font color="LightSalmon"><h2 id="■ストレージファイアウォール無効化の手順"><a href="#■ストレージファイアウォール無効化の手順" class="headerlink" title="■ストレージファイアウォール無効化の手順"></a>■ストレージファイアウォール無効化の手順</h2></font><ol><li>対象のストレージアカウント「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」より「すべてのネットワーク」を選択し「保存」します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage06.png"></p><p>「すべてのネットワーク」が選択されている場合、ストレージファイアウォールの設定は<b>無効</b>状態となります。</p><blockquote><p>参考 )<br>□Azure Storage ファイアウォールおよび仮想ネットワークを構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security#azure-portal">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security#azure-portal</a></p></blockquote><p>「すべてのネットワーク」が選択されている状態に変更が完了したら、事例1-5 の状態が解消されるか確認してください。<br>事例1-5 の状態が解消されていれば、ストレージファイアウォールの設定に問題があると判断できます。</p><p>もし、このままストレージファイアウォールを無効としても運用上差し支えなければ無効の状態でご利用ください。<br>アクセス元を制限したい場合は、以下に沿ってファイアウォール有効化の設定をご確認ください。</p><font color="LightSalmon"><h2 id="■ストレージファイアウォール有効化の手順"><a href="#■ストレージファイアウォール有効化の手順" class="headerlink" title="■ストレージファイアウォール有効化の手順"></a>■ストレージファイアウォール有効化の手順</h2></font><h3 id="1-インターネットまたはオンプレミスのネットワークからのアクセスを許可する"><a href="#1-インターネットまたはオンプレミスのネットワークからのアクセスを許可する" class="headerlink" title="(1) インターネットまたはオンプレミスのネットワークからのアクセスを許可する"></a>(1) インターネットまたはオンプレミスのネットワークからのアクセスを許可する</h3><p>事例1-3 と 事例4-5 (※オンプレミス からの実施の場合のみ) はいずれもインターネットまたはオンプレミスからの<br>アクセスになりますが、ストレージファイアウォール側でアクセス元のパブリック IP アドレスが許可されていないことにより<br>エラーが出ている状態になります。そのため、アクセス元のクライアント端末のグローバル IP アドレスを追加してください。</p><ol><li>対象のストレージアカウント「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」のクライアント端末の IP アドレスを追加し「保存」します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage10.png"></p><blockquote><p>注意)<br>Express Route をご利用されており、Microsoft Peering または Public Peering を用いて Azure ストレージに接続する構成の場合、<br>Azure ストレージに側の接続元の IP アドレスはオンプレミスのプライベート IP アドレスではなく、Microsoft Peering または<br>Public Peering で構成したパブリック IP アドレスとなります。そのため、Express Route 経由後のパブリック IP アドレスを追加<br>していただく必要があることをあらかじめご留意ください。</p></blockquote><p>アクセス許可を行いたいアクセス元の IP アドレスが分からない状態の場合、Azure ストレージの<br>診断ログを取得し、403 エラーを検知しているログより IP アドレスを特定します。</p><h4 id="・Azure-ストレージの診断ログの設定およびアクセス元-IP-アドレスの特定"><a href="#・Azure-ストレージの診断ログの設定およびアクセス元-IP-アドレスの特定" class="headerlink" title="・Azure ストレージの診断ログの設定およびアクセス元 IP アドレスの特定"></a>・Azure ストレージの診断ログの設定およびアクセス元 IP アドレスの特定</h4><ol><li>Azure ポータル ( <a href="https://portal.azure.com/">https://portal.azure.com/</a> ) にログインし、ストレージアカウントを選択します。</li><li>「監視 (クラシック)」内 「診断設定 (クラシック)」を選択します。</li><li>「BLOBのプロパティ」を選択します。</li><li>状態を「オン」にし、「ログ記録」にて、「読み取り」「書き込み」「削除」のすべてにチェックを入れ「保存」します。<br><img src="/blog/storage/storageFirewall-403Error/Storage16.png"></li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage17.png"></p><blockquote><p>注意 )<br>上記設定を有効化いただくと、BLOB サービスに対するリクエストごとの診断ログが<br>ストレージ内に保持され、その BLOB ファイルに応じた料金が発生いたします。</p><p>また Azure Files は診断ログの記録は現在サポートされておりませんのでご了承ください。<br>□ログの構成<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-logging">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-logging</a></p></blockquote><p>対象ストレージアカウントのコンテナー内に $logs が作成されるため、取得されたログよりアクセスに失敗した時刻を<br>対象に 403 エラーが記録されているログを探し、該当のログ内にある IP アドレスを特定します。<br>※診断ログに表記される時刻は UTC となりますのでご留意ください。</p><p>下記ログは、192.100.0.102 からのアクセスが失敗した例となります。<br>ストレージファイアウォールにて 192.100.0.102 を許可しアクセスが可能となるかご確認ください。<br>例)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.0;202Y-MM-DDTHH:MM:SS.ZZZZZZZ;PutBlob;OAuthIpAuthorizationError;403;XX;XX;bearer;XXXXXXXXX;XXXXXXXXX;blob;</span><br><span class="line">&quot;https://XXXXXXXXX.blob.core.windows.net:443/XXXXXXXXX/XXXXXXXXX.txt?timeout=901&quot;;&quot;/&quot;;XXXXXXXXXXXXXXXXXX;0;</span><br><span class="line">192.100.0.102:4362;202Y-MM-DD;XXXX;0;XXX;XXX;XX;;;;;;&quot;AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)&quot;;;&quot;XXXXXXXXXXXXXXXXXX&quot;</span><br><span class="line"></span><br><span class="line">※ SASIpAuthorizationError : ID 認証を使用してアクセスした際のステータスメッセージ</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.0;202Y-MM-DDTHH:MM:SS.ZZZZZZZ;PutBlob;SASIpAuthorizationError;403;X;X;sas;;XXXXXXXXX;blob;</span><br><span class="line">&quot;https://XXXXXXXXX.blob.core.windows.net:443/XXXXXXXXX/XXXXXXXXX.txt?XXXXXXXXX;timeout=901&quot;;&quot;/&quot;;XXXXXXXXX;0;</span><br><span class="line">192.100.0.102:4362;202Y-MM-DD;XXXX;0;XXX;XXX;XX;;;;;;&quot;AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)&quot;;;&quot;XXXXXXXXXXXXXXXXXX&quot;</span><br><span class="line"></span><br><span class="line">※ OAuthIpAuthorizationError : SAS を使用してアクセスした際のステータスメッセージ</span><br></pre></td></tr></table></figure><blockquote><p>参考 )<br>□ストレージ アカウントの監視の設定<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-monitoring-for-a-storage-account">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-monitoring-for-a-storage-account</a><br>□バージョン 1.0 のサンプル ログ エントリ<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format#sample-log-entries-for-version-10">https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format#sample-log-entries-for-version-10</a><br>□ログに記録される要求ステータス メッセージ<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages#logged-request-status-messages">https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages#logged-request-status-messages</a></p></blockquote><h3 id="2-特定の仮想ネットワークおよびサブネットからのアクセスを許可する"><a href="#2-特定の仮想ネットワークおよびサブネットからのアクセスを許可する" class="headerlink" title="(2) 特定の仮想ネットワークおよびサブネットからのアクセスを許可する"></a>(2) 特定の仮想ネットワークおよびサブネットからのアクセスを許可する</h3><p>事例4-5 (※ Azure VM からの実施の場合のみ) はいずれもストレージファイアウォール側で Azure VM が<br>所属している仮想ネットワークからのアクセスが許可されていないことによりにエラーが発生している状態です。<br>そのため、対象の Azure VM が所属している仮想ネットワークおよびサブネットを追加する必要があります。</p><ol><li>対象のストレージアカウント「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」の「仮想ネットワーク」に許可する仮想ネットワークおよびサブネットを追加します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage07.png"></p><p>　#すでに利用したい仮想ネットワークがある場合は「既存の仮想ネットワークを追加する」から追加します。<br>　 仮想ネットワークが未作成の場合は「新しい仮想ネットワークを追加する」より作成追加してください。</p><p>　#異なるサブスクリプションの仮想ネットワークを追加する場合は、「サブスクリプション」項目のプルダウンより<br>　 対象のサブスクリプション内の仮想ネットワークおよびサブネットを選択し有効化します。<br>　 (有効化が完了するまで最大 15 分かかる場合があります) 有効化が完了したら「追加」をクリックします。<br><img src="/blog/storage/storageFirewall-403Error/Storage18.png"><br>　<br>3. 追加した仮想ネットワークおよびサブネットが表示されエンドポイントの状態が有効となっていることを確認し「保存」します。</p><p><img src="/blog/storage/storageFirewall-403Error/Storage08.png"></p><p>仮想ネットワークおよびサブネットの追加が完了しましたら、許可したアクセス元よりアクセスし、<br>事例4-5  (※ Azure VM からの実施の場合のみ) の状態が解消されるかご確認ください。<br>解消されない場合は追加した仮想ネットワークやサブネットの範囲が正しいかご確認をお願いします。</p><blockquote><p>注意)<br>ストレージファイアウォール設定で「すべてのネットワーク」と「選択されたネットワーク」の切り替えを行う場合や<br>登録しているサブネットが仮想ネットワーク上で一度削除され、新たに同名でサブネットが作成された場合などにより<br>古い情報が残存した状態となりエンドポイントの状態が「見つかりません」というようなエラーが表示されることがあります。</p><p>その場合は、一度ストレージファイアウォール「仮想ネットワーク」項目からエラーが表示されているサブネットを削除し、<br>上述の手順で仮想ネットワークおよびサブネットの追加をお試しいただきますようお願いいたします。</p></blockquote><p><img src="/blog/storage/storageFirewall-403Error/Storage09.png"></p><p>ストレージファイアウォール設定を有効化し、許可したいアクセス元の追加が完了しますと、<br>各々エラーが解消し Azure ストレージ内コンテンツへのアクセスが可能となります。</p><p><strong>事例1)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage11.png"><br><strong>事例2)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage12.png"><br><strong>事例3)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage13.png"><br><strong>事例4)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage14.png"><br><strong>事例5)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage15.png"></p><p>本手順でエラーが解消しない場合、ストレージファイアウォール以外の設定に問題がある可能性もございます。<br>ストレージ内コンテンツへのアクセス権限は不足していないか等含めご確認くださいませ。</p><p>本稿が皆様のお役に立ちましたら幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;/p&gt;
&lt;p&gt;今回は Azure ストレージ アカウント内コンテンツへのアクセス時に 403 エラーが発生した&lt;br&gt;場合の対処法をストレージファイアウォール観点でエラー事例とともにご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
</feed>
